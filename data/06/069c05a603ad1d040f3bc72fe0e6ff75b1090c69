<h2 id="contents">Contents</h2>

<ul>
  <li><a href="https://nmunro.github.io/2024/12/29/ningle-1.html">Part 1 (Hello World)</a></li>
  <li><a href="https://nmunro.github.io/2024/12/30/ningle-2.html">Part 2 (Basic Templates)</a></li>
  <li><a href="https://nmunro.github.io/2025/01/30/ningle-3.html">Part 3 (Introduction to middleware and Static File management)</a></li>
  <li><a href="https://nmunro.github.io/2025/02/28/ningle-4.html">Part 4 (Forms)</a></li>
  <li><a href="https://nmunro.github.io/2025/03/31/ningle-5.html">Part 5 (Environmental Variables)</a></li>
  <li><a href="https://nmunro.github.io/2025/04/30/ningle-6.html">Part 6 (Database Connections)</a></li>
  <li><a href="https://nmunro.github.io/2025/05/31/ningle-7.html">Part 7 (Envy Configuation Switching)</a></li>
  <li><a href="https://nmunro.github.io/2025/06/29/ningle-8.html">Part 8 (Mounting Middleware)</a></li>
  <li><a href="https://nmunro.github.io/2025/07/31/ningle-9.html">Part 9 (Authentication System)</a></li>
  <li><a href="https://nmunro.github.io/2025/08/28/ningle-10.html">Part 10 (Email)</a></li>
  <li>Part 11 (Posting Tweets &amp; Advanced Database Queries)</li>
</ul>

<h2 id="introduction">Introduction</h2>

<p>Welcome back! I hope you are well, this tutorial will be have us writing code to integrate the concept of "posts" into our tutorial app, up until now we had a list of posts displayed as an example of how the page <em>might</em> look, well, this changes now. In the course of this tutorial we will be adding new models and forms (like we did in <a href="https://nmunro.github.io/2025/07/31/ningle-9.html">Part 9 (Authentication System)</a>), we will be exploring a new concept in <a href="https://github.com/fukamachi/ningle">Ningle</a> that allows us to define and use our own requirements, we will also be using some advanced <a href="https://github.com/fukamachi/sxql">SXQL</a> to perform somewhat more complicated collection of data than we have previously used, and finally, we can add an honest to goodness json library for returning some responses as something other than html.</p>

<p>With any luck that all sounds exciting! We can broadly split our work this month into three sections, which should make the task easier.</p>

<h3 id="db-schema-and-forms">DB Schema and forms</h3>

<p>Here we will be defining our new models, but unlike before, not every model will be getting a form, some models will be used behind the scenes and users wont <em>directly</em> interact with. This is one of those areas where data has to be very carefully thought of, the example here is <code class="language-plaintext highlighter-rouge">likes</code>, in social media platforms, each <code class="language-plaintext highlighter-rouge">post</code> has some sort of interaction (likes, reactions, thumbsup, etc), and it <em>looks</em> like this is a property of a <code class="language-plaintext highlighter-rouge">post</code>, and indeed it might make sense to assume that a <code class="language-plaintext highlighter-rouge">post</code> "has" likes, but this isn't actually true, what we will have is a <code class="language-plaintext highlighter-rouge">likes model</code> that relates to both a <code class="language-plaintext highlighter-rouge">post</code> and a <code class="language-plaintext highlighter-rouge">user</code>. The user is just presented with visual information that makes it <em>look</em> like <code class="language-plaintext highlighter-rouge">likes</code> are something a <code class="language-plaintext highlighter-rouge">post</code> <em>has</em>.</p>

<h4 id="srcmodelslisp">src/models.lisp</h4>

<p>Our models file will include more than just model definitions, we have some methods and functions we need to write to access or alter our data, we will have two models our <code class="language-plaintext highlighter-rouge">posts</code> and <code class="language-plaintext highlighter-rouge">likes</code>, we will use <code class="language-plaintext highlighter-rouge">likes</code> to link a <code class="language-plaintext highlighter-rouge">post</code> to a <code class="language-plaintext highlighter-rouge">user</code> (from our ningle-auth package).</p>

<p>Let's start by defining our package and models, we will look at the other methods and functions we are exporting a little further down.</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="p">(</span><span class="nb">defpackage</span> <span class="nv">ningle-tutorial-project/models</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="ss">:cl</span> <span class="ss">:mito</span> <span class="ss">:sxql</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:import-from</span> <span class="ss">:ningle-auth/models</span> <span class="ss">#:user</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:export</span> <span class="ss">#:post</span>
           <span class="ss">#:id</span>
           <span class="ss">#:content</span>
           <span class="ss">#:likes</span>
           <span class="ss">#:user</span>
           <span class="ss">#:liked-post-p</span>
           <span class="ss">#:logged-in-posts</span>
           <span class="ss">#:not-logged-in-posts</span>
           <span class="ss">#:toggle-like</span><span class="p">))</span>

<span class="p">(</span><span class="nb">in-package</span> <span class="nv">ningle-tutorial-project/models</span><span class="p">)</span>

<span class="p">(</span><span class="nv">deftable</span> <span class="nv">post</span> <span class="p">()</span>
  <span class="p">((</span><span class="nv">user</span>    <span class="ss">:col-type</span> <span class="nv">ningle-auth/models:user</span> <span class="ss">:initarg</span> <span class="ss">:user</span>    <span class="ss">:accessor</span> <span class="nv">user</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">content</span> <span class="ss">:col-type</span> <span class="p">(</span><span class="ss">:varchar</span> <span class="mi">140</span><span class="p">)</span>          <span class="ss">:initarg</span> <span class="ss">:content</span> <span class="ss">:accessor</span> <span class="nv">content</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">deftable</span> <span class="nv">likes</span> <span class="p">()</span>
  <span class="p">((</span><span class="nv">user</span> <span class="ss">:col-type</span> <span class="nv">ningle-auth/models:user</span> <span class="ss">:initarg</span> <span class="ss">:user</span> <span class="ss">:reader</span> <span class="nv">user</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">post</span> <span class="ss">:col-type</span> <span class="nv">post</span>                    <span class="ss">:initarg</span> <span class="ss">:post</span> <span class="ss">:reader</span> <span class="nv">post</span><span class="p">))</span>
  <span class="p">(</span><span class="ss">:unique-keys</span> <span class="p">(</span><span class="nv">user</span> <span class="nv">post</span><span class="p">)))</span></code></pre></figure>

<p>Our post has a user and some content, we don't have comments or reposts or anything (this is a tutorial after all!), what we want to ensure with the <code class="language-plaintext highlighter-rouge">likes</code> model though, is that there's a unique constraint between user and post, this ensures that a user can like a specific post only once. Otherwise our like count would be unreliable.</p>

<p>In our exports list you will see we export the id, user, content, likes, post etc, but there's more!</p>

<p>Recall that Common Lisp is a <a href="https://en.wikipedia.org/wiki/Common_Lisp#The_function_namespace">lisp-2</a> and as such we can have function/method names as the same as objects, and because of this, we will defined some methods with the name "likes" which are different from our <code class="language-plaintext highlighter-rouge">class</code> called "likes".</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="p">(</span><span class="nb">defgeneric</span> <span class="nv">likes</span> <span class="p">(</span><span class="nv">post</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:documentation</span> <span class="s">"Returns the number of likes a post has"</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">likes</span> <span class="p">((</span><span class="nv">post</span> <span class="nv">post</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">mito:count-dao</span> <span class="ss">'likes</span> <span class="ss">:post</span> <span class="nv">post</span><span class="p">))</span></code></pre></figure>

<p>Here we define a method that will accept a post and return the total number of likes it has, which will give us our likes count when we render the main page.</p>

<p>The next method we are going to write is a way to toggle the user like of a post, if they don't like it, clicking it will like the post, if they do already like the post, clicking the like button will undo the like.</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="p">(</span><span class="nb">defmethod</span> <span class="nv">toggle-like</span> <span class="p">((</span><span class="nv">ningle-auth/models:user</span> <span class="nv">user</span><span class="p">)</span> <span class="p">(</span><span class="nv">post</span> <span class="nv">post</span><span class="p">))</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">liked-post</span> <span class="p">(</span><span class="nv">liked-post-p</span> <span class="nv">user</span> <span class="nv">post</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="nv">liked-post</span>
        <span class="p">(</span><span class="nv">mito:delete-dao</span> <span class="nv">liked-post</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">mito:create-dao</span> <span class="ss">'likes</span> <span class="ss">:post</span> <span class="nv">post</span> <span class="ss">:user</span> <span class="nv">user</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">not</span> <span class="nv">liked-post</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defgeneric</span> <span class="nv">liked-post-p</span> <span class="p">(</span><span class="nv">user</span> <span class="nv">post</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:documentation</span> <span class="s">"Returns true if a user likes a given post"</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">liked-post-p</span> <span class="p">((</span><span class="nv">ningle-auth/models:user</span> <span class="nv">user</span><span class="p">)</span> <span class="p">(</span><span class="nv">post</span> <span class="nv">post</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">mito:find-dao</span> <span class="ss">'likes</span> <span class="ss">:user</span> <span class="nv">user</span> <span class="ss">:post</span> <span class="nv">post</span><span class="p">))</span></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">toggle-like</code> tries to be as simple as possible, by calling the <code class="language-plaintext highlighter-rouge">liked-post-p</code> method to query if a user likes a post, and if the post <em>is</em> liked, the record of the like is deleted, if not it is created. The final thing the function does is return the <code class="language-plaintext highlighter-rouge">not</code> of <code class="language-plaintext highlighter-rouge">liked-post-p</code>, so if the post was liked at first, it will return <code class="language-plaintext highlighter-rouge">nil</code>, if the post wasn't liked, it'll return <code class="language-plaintext highlighter-rouge">t</code>. This will become important later, but if your function can be written in a way that can return helpful information, I suggest doing so, you may not always, or ever use the data it returns, but it's there if you need to, it forms a usable interface.</p>

<p>Now to SQL!</p>

<p>If you are unfamiliar with SQL this part might look complicated, but in terms of SQL, it isn't, SQL is a language used for a very specific purpose; querying and manipulating data! If you have not used SQL before/much, I highly encourage you to do so, it's nearly 50 years old, it's a very well tested and proven technology. It's not going anywhere (despite what you may read online NoSQL isn't going to replace it), and will be great for your career.</p>

<p><a href="https://github.com/fukamachi/mito">Mito</a> is a pretty thin wrapper around SQL, unlike something like Django, Rails, or Larvel (comprehensive web frameworks), Mito doesn't have a complex <a href="https://en.wikipedia.org/wiki/Domain-specific_language">DSL</a> for abstracting the SQL details away, instead it has the user use an SQL generator <a href="https://github.com/fukamachi/sxql">SXQL</a>, so, for things beyond the simplest of things, we're gonna have to get into SQL, which is fine.</p>

<p>We have two things we want to do:</p>

<ol>
  <li>Retrieve 50 posts ordered in descending order, with an extra column for the like count.</li>
  <li>Retrieve 50 posts ordered in descending order, with two extra columns, one for the like count, and a second indicating if the logged in user liked the post.</li>
</ol>

<p>Let's start with the first case, a user has loaded the website, but they are not logged in. The best place to start is with the SQL query we want to run:</p>

<figure class="highlight"><pre><code class="language-sql"><span class="k">SELECT</span> <span class="n">post</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">likes</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">like_count</span>
    <span class="k">FROM</span> <span class="n">post</span>
    <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">likes</span> <span class="k">ON</span> <span class="p">(</span><span class="n">post</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">likes</span><span class="p">.</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">post</span><span class="p">.</span><span class="n">id</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">post</span><span class="p">.</span><span class="n">created_at</span> <span class="k">DESC</span>
    <span class="k">LIMIT</span> <span class="mi">50</span><span class="p">;</span></code></pre></figure>

<p>This will give us a structure like this:</p>

<table>
  <thead>
    <tr>
      <th>id</th>
      <th>user_id</th>
      <th>content</th>
      <th>created_at</th>
      <th>updated_at</th>
      <th>like_count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>4</td>
      <td>"hi"</td>
      <td>2025-09-13 19:43:16.718416Z</td>
      <td>2025-09-13 19:43:16.718416Z</td>
      <td>5</td>
    </tr>
  </tbody>
</table>

<p>This query works by using <a href="https://www.geeksforgeeks.org/dbms/joins-in-dbms/">joins</a>, we want to get each post record and its like count, so we must join <code class="language-plaintext highlighter-rouge">post</code> and <code class="language-plaintext highlighter-rouge">likes</code> on the intersection of <code class="language-plaintext highlighter-rouge">post.id</code> and <code class="language-plaintext highlighter-rouge">likes.post.id</code>. This will allow us to iterate over the combined results and use them in our templates later.</p>

<p>We also use the <code class="language-plaintext highlighter-rouge">GROUP BY</code> clause to ensure that there is only one result per post, and that each like for a given post is summed together, so we have one post with many likes, rather than many copies of the same post each with one like.</p>

<p>We use the <code class="language-plaintext highlighter-rouge">retrieve-by-sql</code> function from <code class="language-plaintext highlighter-rouge">mito</code> which allows us to run SQL explicitly, but as previously mentioned we will use SXQL to more easily generate the SQL we might want within Common Lisp.</p>

<p>We will also use the <code class="language-plaintext highlighter-rouge">yield</code> function (from <code class="language-plaintext highlighter-rouge">SXQL</code>) to actually convert the Common Lisp representation into a string SQL can use, within that we will begin with <code class="language-plaintext highlighter-rouge">select</code> (also from <code class="language-plaintext highlighter-rouge">SXQL</code>).</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">not-logged-in-posts</span> <span class="p">()</span>
    <span class="p">(</span><span class="nv">mito:retrieve-by-sql</span>
        <span class="p">(</span><span class="nv">sxql:yield</span>
            <span class="p">(</span><span class="nv">sxql:select</span>
                <span class="p">(</span><span class="ss">:post.*</span> <span class="p">(</span><span class="ss">:as</span> <span class="p">(</span><span class="ss">:count</span> <span class="ss">:likes.id</span><span class="p">)</span> <span class="ss">:like_count</span><span class="p">))</span>
                <span class="p">(</span><span class="nv">sxql:from</span> <span class="ss">:post</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">sxql:left-join</span> <span class="ss">:likes</span> <span class="ss">:on</span> <span class="p">(</span><span class="ss">:=</span> <span class="ss">:post.id</span> <span class="ss">:likes.post_id</span><span class="p">))</span>
                <span class="p">(</span><span class="nv">sxql:group-by</span> <span class="ss">:post.id</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">sxql:order-by</span> <span class="p">(</span><span class="ss">:desc</span> <span class="ss">:post.created_at</span><span class="p">))</span>
                <span class="p">(</span><span class="nv">sxql:limit</span> <span class="mi">50</span><span class="p">)))))</span></code></pre></figure>

<p>You should be able to see that our original SQL is represented quite similarly in the SXQL, here's a table to clearly show the minor differences.</p>

<table>
<tr>
<th>SQL</th>
<th>SXQL</th>
</tr>
<tr>
<td>
<pre>SELECT post.*, COUNT(likes.id) AS like_count
    FROM post
    LEFT JOIN likes ON (post.id = likes.post_id)
    GROUP BY post.id
    ORDER BY post.created_at DESC
    LIMIT 50;</pre>
</td>
<td>
<pre>(sxql:select (:post.* (:as (:count :likes.id) :like_count))
    (sxql:from :post)
    (sxql:left-join :likes :on (:= :post.id :likes.post_id))
    (sxql:group-by :post.id)
    (sxql:order-by (:desc :post.created_at))
    (sxql:limit 50))</pre>
</td>
</tr>
</table>

<p>The next query we need to construct is that of the logged in user, which includes a column denoting likes for any specific post, this will be our second function <code class="language-plaintext highlighter-rouge">logged-in-posts</code>. As before, let's start with what the SQL will be:</p>

<figure class="highlight"><pre><code class="language-sql"><span class="k">SELECT</span> <span class="n">post</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">likes</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">like_count</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">user_likes</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">liked_by_user</span>
<span class="k">FROM</span> <span class="n">post</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">likes</span> <span class="k">ON</span> <span class="p">(</span><span class="n">post</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">likes</span><span class="p">.</span><span class="n">post_id</span><span class="p">)</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">likes</span> <span class="k">AS</span> <span class="n">user_likes</span> <span class="k">ON</span> <span class="p">((</span><span class="n">post</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">user_likes</span><span class="p">.</span><span class="n">post_id</span><span class="p">)</span> <span class="k">AND</span> <span class="p">(</span><span class="n">user_likes</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="o">?</span><span class="p">))</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">post</span><span class="p">.</span><span class="n">id</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">post</span><span class="p">.</span><span class="n">created_at</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">50</span><span class="p">;</span></code></pre></figure>

<p>Please note that we have a <code class="language-plaintext highlighter-rouge">?</code> where the user id would go, we do not wish to be subject to SQL injection attacks, so mito allows us to bind values, but we will keep the <code class="language-plaintext highlighter-rouge">?</code> as it's what we will use in the SXQL too.</p>

<p>Which will generate the following table structure.</p>

<table>
  <thead>
    <tr>
      <th>id</th>
      <th>user_id</th>
      <th>content</th>
      <th>created_at</th>
      <th>updated_at</th>
      <th>like_count</th>
      <th>liked_by_user</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>4</td>
      <td>"hi"</td>
      <td>2025-09-13 19:43:16.718416Z</td>
      <td>2025-09-13 19:43:16.718416Z</td>
      <td>5</td>
      <td>1</td>
    </tr>
  </tbody>
</table>

<p>The extra column is only a small change on the first query, by adding a new call to <code class="language-plaintext highlighter-rouge">COUNT</code> in the <code class="language-plaintext highlighter-rouge">SELECT</code> line, we prepare the column, and we get the data from the second <code class="language-plaintext highlighter-rouge">LEFT JOIN</code> which will join (using a new alias; <code class="language-plaintext highlighter-rouge">user_likes</code>) where the post id is the same as the user likes post id and where the user likes user id is the same as the logged in user, this will either return a record or null. When we call count on the record returned, it becomes 1 or 0, effectively a boolean check.</p>

<p>We can see the differences between the SQL and the SXQL here.</p>

<p>SQL</p>

<figure class="highlight"><pre><code class="language-sql"><span class="k">SELECT</span> <span class="n">post</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">likes</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">like_count</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">user_likes</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">liked_by_user</span>
<span class="k">FROM</span> <span class="n">post</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">likes</span> <span class="k">ON</span> <span class="p">(</span><span class="n">post</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">likes</span><span class="p">.</span><span class="n">post_id</span><span class="p">)</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">likes</span> <span class="k">AS</span> <span class="n">user_likes</span> <span class="k">ON</span> <span class="p">((</span><span class="n">post</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">user_likes</span><span class="p">.</span><span class="n">post_id</span><span class="p">)</span> <span class="k">AND</span> <span class="p">(</span><span class="n">user_likes</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="o">?</span><span class="p">))</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">post</span><span class="p">.</span><span class="n">id</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">post</span><span class="p">.</span><span class="n">created_at</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">50</span><span class="p">;</span></code></pre></figure>

<p>SXQL</p>

<figure class="highlight"><pre><code class="language-sql"><span class="p">(</span><span class="n">sxql</span><span class="p">:</span><span class="k">select</span> <span class="p">(:</span><span class="n">post</span><span class="p">.</span><span class="o">*</span> <span class="p">(:</span><span class="k">as</span> <span class="p">(:</span><span class="k">count</span> <span class="p">:</span><span class="n">likes</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">:</span><span class="n">like_count</span><span class="p">)</span> <span class="p">(:</span><span class="k">as</span> <span class="p">(:</span><span class="k">count</span> <span class="p">:</span><span class="n">user_likes</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">:</span><span class="n">liked_by_user</span><span class="p">))</span>
<span class="p">(</span><span class="n">sxql</span><span class="p">:</span><span class="k">from</span> <span class="p">:</span><span class="n">post</span><span class="p">)</span>
<span class="p">(</span><span class="n">sxql</span><span class="p">:</span><span class="k">left</span><span class="o">-</span><span class="k">join</span> <span class="p">:</span><span class="n">likes</span> <span class="p">:</span><span class="k">on</span> <span class="p">(:</span><span class="o">=</span> <span class="p">:</span><span class="n">post</span><span class="p">.</span><span class="n">id</span> <span class="p">:</span><span class="n">likes</span><span class="p">.</span><span class="n">post_id</span><span class="p">))</span>
<span class="p">(</span><span class="n">sxql</span><span class="p">:</span><span class="k">left</span><span class="o">-</span><span class="k">join</span> <span class="p">(:</span><span class="k">as</span> <span class="p">:</span><span class="n">likes</span> <span class="p">:</span><span class="n">user_likes</span><span class="p">)</span> <span class="p">:</span><span class="k">on</span> <span class="p">(:</span><span class="k">and</span> <span class="p">(:</span><span class="o">=</span> <span class="p">:</span><span class="n">post</span><span class="p">.</span><span class="n">id</span> <span class="p">:</span><span class="n">user_likes</span><span class="p">.</span><span class="n">post_id</span><span class="p">)</span> <span class="p">(:</span><span class="o">=</span> <span class="p">:</span><span class="n">user_likes</span><span class="p">.</span><span class="n">user_id</span> <span class="p">:</span><span class="o">?</span><span class="p">)))</span>
<span class="p">(</span><span class="n">sxql</span><span class="p">:</span><span class="k">group</span><span class="o">-</span><span class="k">by</span> <span class="p">:</span><span class="n">post</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">(</span><span class="n">sxql</span><span class="p">:</span><span class="k">order</span><span class="o">-</span><span class="k">by</span> <span class="p">(:</span><span class="k">desc</span> <span class="p">:</span><span class="n">post</span><span class="p">.</span><span class="n">created_at</span><span class="p">))</span>
<span class="p">(</span><span class="n">sxql</span><span class="p">:</span><span class="k">limit</span> <span class="mi">50</span><span class="p">)))</span></code></pre></figure>

<p>So this SXQL will be used in our function like so:</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="p">(</span><span class="nb">defmethod</span> <span class="nv">logged-in-posts</span> <span class="p">((</span><span class="nv">user</span> <span class="nv">user</span><span class="p">))</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">uid</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">user</span> <span class="ss">'mito.dao.mixin::id</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">mito:retrieve-by-sql</span>
        <span class="p">(</span><span class="nv">sxql:yield</span>
            <span class="p">(</span><span class="nv">sxql:select</span>
                <span class="p">(</span><span class="ss">:post.*</span> <span class="p">(</span><span class="ss">:as</span> <span class="p">(</span><span class="ss">:count</span> <span class="ss">:likes.id</span><span class="p">)</span> <span class="ss">:like_count</span><span class="p">)</span> <span class="p">(</span><span class="ss">:as</span> <span class="p">(</span><span class="ss">:count</span> <span class="ss">:user_likes.id</span><span class="p">)</span> <span class="ss">:liked_by_user</span><span class="p">))</span>
                <span class="p">(</span><span class="nv">sxql:from</span> <span class="ss">:post</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">sxql:left-join</span> <span class="ss">:likes</span> <span class="ss">:on</span> <span class="p">(</span><span class="ss">:=</span> <span class="ss">:post.id</span> <span class="ss">:likes.post_id</span><span class="p">))</span>
                <span class="p">(</span><span class="nv">sxql:left-join</span> <span class="p">(</span><span class="ss">:as</span> <span class="ss">:likes</span> <span class="ss">:user_likes</span><span class="p">)</span>
                                <span class="ss">:on</span> <span class="p">(</span><span class="ss">:and</span> <span class="p">(</span><span class="ss">:=</span> <span class="ss">:post.id</span> <span class="ss">:user_likes.post_id</span><span class="p">)</span>
                                          <span class="p">(</span><span class="ss">:=</span> <span class="ss">:user_likes.user_id</span> <span class="ss">:?</span><span class="p">)))</span>
                <span class="p">(</span><span class="nv">sxql:group-by</span> <span class="ss">:post.id</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">sxql:order-by</span> <span class="p">(</span><span class="ss">:desc</span> <span class="ss">:post.created_at</span><span class="p">))</span>
                <span class="p">(</span><span class="nv">sxql:limit</span> <span class="mi">50</span><span class="p">)))</span>
            <span class="ss">:binds</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">uid</span><span class="p">))))</span></code></pre></figure>

<p>As mentioned before, you can see the <code class="language-plaintext highlighter-rouge">:binds</code> which will insert the user id into the SXQL query for safety.</p>

<p>So with these two complex functions in place now, we have everything we need, for clarity the complete listing of the models.lisp file is as follows:</p>

<figure class="highlight"><pre><code class="language-common_lisp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">defpackage</span> <span class="nv">ningle-tutorial-project/models</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="ss">:cl</span> <span class="ss">:mito</span> <span class="ss">:sxql</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:import-from</span> <span class="ss">:ningle-auth/models</span> <span class="ss">#:user</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:export</span> <span class="ss">#:post</span>
           <span class="ss">#:id</span>
           <span class="ss">#:content</span>
           <span class="ss">#:likes</span>
           <span class="ss">#:user</span>
           <span class="ss">#:liked-post-p</span>
           <span class="ss">#:logged-in-posts</span>
           <span class="ss">#:not-logged-in-posts</span>
           <span class="ss">#:toggle-like</span><span class="p">))</span>

<span class="p">(</span><span class="nb">in-package</span> <span class="nv">ningle-tutorial-project/models</span><span class="p">)</span>

<span class="p">(</span><span class="nv">deftable</span> <span class="nv">post</span> <span class="p">()</span>
  <span class="p">((</span><span class="nv">user</span>    <span class="ss">:col-type</span> <span class="nv">ningle-auth/models:user</span> <span class="ss">:initarg</span> <span class="ss">:user</span>    <span class="ss">:accessor</span> <span class="nv">user</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">content</span> <span class="ss">:col-type</span> <span class="p">(</span><span class="ss">:varchar</span> <span class="mi">140</span><span class="p">)</span>          <span class="ss">:initarg</span> <span class="ss">:content</span> <span class="ss">:accessor</span> <span class="nv">content</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">deftable</span> <span class="nv">likes</span> <span class="p">()</span>
  <span class="p">((</span><span class="nv">user</span> <span class="ss">:col-type</span> <span class="nv">ningle-auth/models:user</span> <span class="ss">:initarg</span> <span class="ss">:user</span> <span class="ss">:reader</span> <span class="nv">user</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">post</span> <span class="ss">:col-type</span> <span class="nv">post</span>                    <span class="ss">:initarg</span> <span class="ss">:post</span> <span class="ss">:reader</span> <span class="nv">post</span><span class="p">))</span>
  <span class="p">(</span><span class="ss">:unique-keys</span> <span class="p">(</span><span class="nv">user</span> <span class="nv">post</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defgeneric</span> <span class="nv">likes</span> <span class="p">(</span><span class="nv">post</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:documentation</span> <span class="s">"Returns the number of likes a post has"</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">likes</span> <span class="p">((</span><span class="nv">post</span> <span class="nv">post</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">mito:count-dao</span> <span class="ss">'likes</span> <span class="ss">:post</span> <span class="nv">post</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defgeneric</span> <span class="nv">toggle-like</span> <span class="p">(</span><span class="nv">user</span> <span class="nv">post</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:documentation</span> <span class="s">"Toggles the like of a user to a given post"</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">toggle-like</span> <span class="p">((</span><span class="nv">ningle-auth/models:user</span> <span class="nv">user</span><span class="p">)</span> <span class="p">(</span><span class="nv">post</span> <span class="nv">post</span><span class="p">))</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">liked-post</span> <span class="p">(</span><span class="nv">liked-post-p</span> <span class="nv">user</span> <span class="nv">post</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="nv">liked-post</span>
        <span class="p">(</span><span class="nv">mito:delete-dao</span> <span class="nv">liked-post</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">mito:create-dao</span> <span class="ss">'likes</span> <span class="ss">:post</span> <span class="nv">post</span> <span class="ss">:user</span> <span class="nv">user</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">not</span> <span class="nv">liked-post</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defgeneric</span> <span class="nv">liked-post-p</span> <span class="p">(</span><span class="nv">user</span> <span class="nv">post</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:documentation</span> <span class="s">"Returns true if a user likes a given post"</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">liked-post-p</span> <span class="p">((</span><span class="nv">ningle-auth/models:user</span> <span class="nv">user</span><span class="p">)</span> <span class="p">(</span><span class="nv">post</span> <span class="nv">post</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">mito:find-dao</span> <span class="ss">'likes</span> <span class="ss">:user</span> <span class="nv">user</span> <span class="ss">:post</span> <span class="nv">post</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defgeneric</span> <span class="nv">logged-in-posts</span> <span class="p">(</span><span class="nv">user</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:documentation</span> <span class="s">"Gets the posts for a logged in user"</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">logged-in-posts</span> <span class="p">((</span><span class="nv">user</span> <span class="nv">user</span><span class="p">))</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">uid</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">user</span> <span class="ss">'mito.dao.mixin::id</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">mito:retrieve-by-sql</span>
        <span class="p">(</span><span class="nv">sxql:yield</span>
            <span class="p">(</span><span class="nv">sxql:select</span>
                <span class="p">(</span><span class="ss">:post.*</span>
                <span class="p">(</span><span class="ss">:as</span> <span class="p">(</span><span class="ss">:count</span> <span class="ss">:likes.id</span><span class="p">)</span> <span class="ss">:like_count</span><span class="p">)</span>
                <span class="p">(</span><span class="ss">:as</span> <span class="p">(</span><span class="ss">:count</span> <span class="ss">:user_likes.id</span><span class="p">)</span> <span class="ss">:liked_by_user</span><span class="p">))</span>
                <span class="p">(</span><span class="nv">sxql:from</span> <span class="ss">:post</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">sxql:left-join</span> <span class="ss">:likes</span> <span class="ss">:on</span> <span class="p">(</span><span class="ss">:=</span> <span class="ss">:post.id</span> <span class="ss">:likes.post_id</span><span class="p">))</span>
                <span class="p">(</span><span class="nv">sxql:left-join</span> <span class="p">(</span><span class="ss">:as</span> <span class="ss">:likes</span> <span class="ss">:user_likes</span><span class="p">)</span>
                                <span class="ss">:on</span> <span class="p">(</span><span class="ss">:and</span> <span class="p">(</span><span class="ss">:=</span> <span class="ss">:post.id</span> <span class="ss">:user_likes.post_id</span><span class="p">)</span>
                                          <span class="p">(</span><span class="ss">:=</span> <span class="ss">:user_likes.user_id</span> <span class="ss">:?</span><span class="p">)))</span>
                <span class="p">(</span><span class="nv">sxql:group-by</span> <span class="ss">:post.id</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">sxql:order-by</span> <span class="p">(</span><span class="ss">:desc</span> <span class="ss">:post.created_at</span><span class="p">))</span>
                <span class="p">(</span><span class="nv">sxql:limit</span> <span class="mi">50</span><span class="p">)))</span>
            <span class="ss">:binds</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">uid</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">not-logged-in-posts</span> <span class="p">()</span>
    <span class="p">(</span><span class="nv">mito:retrieve-by-sql</span>
        <span class="p">(</span><span class="nv">sxql:yield</span>
        <span class="p">(</span><span class="nv">sxql:select</span>
            <span class="p">(</span><span class="ss">:post.*</span> <span class="p">(</span><span class="ss">:as</span> <span class="p">(</span><span class="ss">:count</span> <span class="ss">:likes.id</span><span class="p">)</span> <span class="ss">:like_count</span><span class="p">))</span>
            <span class="p">(</span><span class="nv">sxql:from</span> <span class="ss">:post</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">sxql:left-join</span> <span class="ss">:likes</span> <span class="ss">:on</span> <span class="p">(</span><span class="ss">:=</span> <span class="ss">:post.id</span> <span class="ss">:likes.post_id</span><span class="p">))</span>
            <span class="p">(</span><span class="nv">sxql:group-by</span> <span class="ss">:post.id</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">sxql:order-by</span> <span class="p">(</span><span class="ss">:desc</span> <span class="ss">:post.created_at</span><span class="p">))</span>
            <span class="p">(</span><span class="nv">sxql:limit</span> <span class="mi">50</span><span class="p">)))))</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h4 id="srcformslisp">src/forms.lisp</h4>

<p>Our forms are much simpler, we only have one form, the post. While we do have the likes model, our users will not be directly using that, and thus we don't need to render a form for this.</p>

<figure class="highlight"><pre><code class="language-common_lisp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">defpackage</span> <span class="nv">ningle-tutorial-project/forms</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="ss">:cl</span> <span class="ss">:cl-forms</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:export</span> <span class="ss">#:post</span>
           <span class="ss">#:content</span>
           <span class="ss">#:submit</span><span class="p">))</span>

<span class="p">(</span><span class="nb">in-package</span> <span class="nv">ningle-tutorial-project/forms</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*post-validator*</span> <span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="nv">clavier:not-blank</span><span class="p">)</span>
                                     <span class="p">(</span><span class="nv">clavier:is-a-string</span><span class="p">)</span>
                                     <span class="p">(</span><span class="nv">clavier:len</span> <span class="ss">:max</span> <span class="mi">140</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">defform</span> <span class="nv">post</span> <span class="p">(</span><span class="ss">:id</span> <span class="s">"post"</span> <span class="ss">:csrf-protection</span> <span class="no">t</span> <span class="ss">:csrf-field-name</span> <span class="s">"csrftoken"</span> <span class="ss">:action</span> <span class="s">"/post"</span><span class="p">)</span>
  <span class="p">((</span><span class="nv">content</span>  <span class="ss">:string</span>   <span class="ss">:value</span> <span class="s">""</span> <span class="ss">:constraints</span> <span class="vg">*post-validator*</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">submit</span>   <span class="ss">:submit</span>   <span class="ss">:label</span> <span class="s">"Post"</span><span class="p">)))</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Like we used in a previous tutorial, we use the <code class="language-plaintext highlighter-rouge">clavier</code> validation library to ensure that our users post things that fit within the constraints of our system, we also want to make sure we are using CSRF tokens for security.</p>

<p>We will style this form using CSS later.</p>

<h4 id="srcmigrationslisp">src/migrations.lisp</h4>

<p>Now, our main project now contains its own migrations, we perhaps should have written the code to perform migrations in another file and reserved this for specific migrations, but we can work with things the way they are.</p>

<p>We are going to start by adding a function to the top of our <code class="language-plaintext highlighter-rouge">migrations.lisp</code> file.</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">migrate</span> <span class="p">()</span>
  <span class="s">"Explicitly apply migrations when called."</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">"Applying migrations...~%"</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">mito:ensure-table-exists</span> <span class="ss">'ningle-tutorial-project/models:post</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">mito:ensure-table-exists</span> <span class="ss">'ningle-tutorial-project/models:likes</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">mito:migrate-table</span> <span class="ss">'ningle-tutorial-project/models:post</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">mito:migrate-table</span> <span class="ss">'ningle-tutorial-project/models:likes</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">"Migrations complete.~%"</span><span class="p">))</span></code></pre></figure>

<p>These will be the project specific migrations, however we still need a way to trigger them, and since we wrote a way to apply specific apps only, we need a way to exclude these if we do not wish to run these migrations.</p>

<p>The next thing we need to do is to extend the <code class="language-plaintext highlighter-rouge">migrate-apps</code> function we previously wrote. We will add a parameter to the function:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(defun migrate-apps (&amp;optional (apps nil) &amp;key skip-root)
</code></pre></div></div>

<p>And within the <code class="language-plaintext highlighter-rouge">macro</code> call:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(with-db-connection
    ...)
</code></pre></div></div>

<p>We add:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(unless skip-root
    (format t "Running root project migrations...~%")
    (migrate))
</code></pre></div></div>

<p>There is also a small correction we need to make, this line.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(error "Migrate function not found in package ~A." migrations-pkg-name)
</code></pre></div></div>

<p>Needs to be corrected to:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(error (format nil "Migrate function not found in package ~A." migrations-pkg-name))
</code></pre></div></div>

<p>Full listing:</p>

<figure class="highlight"><pre><code class="language-common_lisp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">defpackage</span> <span class="nv">ningle-tutorial-project/migrations</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="ss">:cl</span> <span class="ss">:ningle-tutorial-project/contrib</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:export</span> <span class="ss">#:migrate-apps</span><span class="p">))</span>

<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:ningle-tutorial-project/migrations</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">migrate</span> <span class="p">()</span>
  <span class="s">"Explicitly apply migrations when called."</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">"Applying migrations...~%"</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">mito:ensure-table-exists</span> <span class="ss">'ningle-tutorial-project/models:post</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">mito:ensure-table-exists</span> <span class="ss">'ningle-tutorial-project/models:likes</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">mito:migrate-table</span> <span class="ss">'ningle-tutorial-project/models:post</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">mito:migrate-table</span> <span class="ss">'ningle-tutorial-project/models:likes</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">"Migrations complete.~%"</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">migrate-apps</span> <span class="p">(</span><span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">apps</span> <span class="no">nil</span><span class="p">)</span> <span class="k">&amp;key</span> <span class="nv">skip-root</span><span class="p">)</span>
  <span class="s">"Run migrate function for each app in APPS list. If APPS is nil, migrate all apps listed in *config* :installed-apps."</span>

  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">apps</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">apps</span> <span class="p">(</span><span class="nb">getf</span> <span class="p">(</span><span class="nv">envy:config</span> <span class="ss">:ningle-tutorial-project/config</span><span class="p">)</span> <span class="ss">:installed-apps</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">unless</span> <span class="nv">apps</span>
      <span class="p">(</span><span class="nb">error</span> <span class="s">"No apps specified and no :installed-apps found in config."</span><span class="p">))</span>

    <span class="p">(</span><span class="nv">with-db-connection</span>
        <span class="p">(</span><span class="nb">unless</span> <span class="nv">skip-root</span>
          <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">"Running root project migrations...~%"</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">migrate</span><span class="p">))</span>

        <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">app</span> <span class="nv">apps</span><span class="p">)</span>
            <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">migrations-pkg-name</span> <span class="p">(</span><span class="nb">string-upcase</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">"~A/MIGRATIONS"</span> <span class="p">(</span><span class="nb">string-upcase</span> <span class="p">(</span><span class="nb">symbol-name</span> <span class="nv">app</span><span class="p">)))))</span>
                   <span class="p">(</span><span class="nv">migrations-pkg</span> <span class="p">(</span><span class="nb">find-package</span> <span class="nv">migrations-pkg-name</span><span class="p">)))</span>
                <span class="p">(</span><span class="nb">unless</span> <span class="nv">migrations-pkg</span>
                    <span class="p">(</span><span class="nb">error</span> <span class="s">"Migrations package ~A not found."</span> <span class="nv">migrations-pkg-name</span><span class="p">))</span>

                <span class="c1">;; Set app-specific config before calling migrate</span>
                <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">migrate-fn</span> <span class="p">(</span><span class="nb">find-symbol</span> <span class="s">"MIGRATE"</span> <span class="nv">migrations-pkg</span><span class="p">)))</span> <span class="c1">;; Name known to project</span>
                    <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">and</span> <span class="nv">migrate-fn</span> <span class="p">(</span><span class="nb">fboundp</span> <span class="nv">migrate-fn</span><span class="p">))</span>
                        <span class="p">(</span><span class="nb">error</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">"Migrate function not found in package ~A."</span> <span class="nv">migrations-pkg-name</span><span class="p">)))</span>
                    <span class="p">(</span><span class="nb">funcall</span> <span class="nv">migrate-fn</span><span class="p">)))))))</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h4 id="ningle-tutorial-projectasd">ningle-tutorial-project.asd</h4>

<p>With these files added, we need to remember to add them to our project.asd file.</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="ss">:components</span> <span class="p">((</span><span class="ss">:module</span> <span class="s">"src"</span>
                <span class="ss">:components</span>
                <span class="p">((</span><span class="ss">:file</span> <span class="s">"contrib"</span><span class="p">)</span>
                 <span class="p">(</span><span class="ss">:file</span> <span class="s">"middleware"</span><span class="p">)</span>
                 <span class="p">(</span><span class="ss">:file</span> <span class="s">"config"</span><span class="p">)</span>
                 <span class="p">(</span><span class="ss">:file</span> <span class="s">"models"</span><span class="p">)</span>  <span class="c1">; add this line</span>
                 <span class="p">(</span><span class="ss">:file</span> <span class="s">"forms"</span><span class="p">)</span>   <span class="c1">; add this line</span>
                 <span class="p">(</span><span class="ss">:file</span> <span class="s">"migrations"</span><span class="p">)</span>
                 <span class="p">(</span><span class="ss">:file</span> <span class="s">"main"</span><span class="p">))))</span></code></pre></figure>

<h3 id="controller-logic">Controller Logic</h3>

<h4 id="srcmainlisp">src/main.lisp</h4>

<p>We will now look at the controller logic to handle posting, well, posts. We will introduce a feature of <code class="language-plaintext highlighter-rouge">Ningle</code> we have not yet looked into that can help us create smaller, more specialised, logical units of work, <code class="language-plaintext highlighter-rouge">requirements</code>. Ningle has the ability to define conditions that can be passed as keyword arguments to a controller, if the condition is true, the controller is triggered. In our controllers previously we have had <code class="language-plaintext highlighter-rouge">if</code> checks for if a user is logged in, or if a request is a <code class="language-plaintext highlighter-rouge">GET</code> or a <code class="language-plaintext highlighter-rouge">POST</code>, these requirements allow us to write smaller functions to help us focus on one specific type of request (even if on the same route). I find this helps me, personally, if I can reduce the number of things I have to be remembering when I am working on a function.</p>

<p>Before we do, however, we will allow our main code to use the forms we defined in the previous section.</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="p">(</span><span class="nb">defpackage</span> <span class="nv">ningle-tutorial-project</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="ss">:cl</span> <span class="ss">:sxql</span> <span class="ss">:ningle-tutorial-project/forms</span><span class="p">)</span> <span class="c1">; Add the :ningle-tutorial-project/forms bit!</span>
  <span class="p">(</span><span class="ss">:export</span> <span class="ss">#:start</span>
           <span class="ss">#:stop</span><span class="p">))</span>

<span class="p">(</span><span class="nb">in-package</span> <span class="nv">ningle-tutorial-project</span><span class="p">)</span></code></pre></figure>

<p>Now with that in place we can begin in earnest! We already use these requirements already with our <code class="language-plaintext highlighter-rouge">:method '(:GET :POST)</code> that we used previously, but we can define our own! We will define a requirement that there is a logged in user. In our <code class="language-plaintext highlighter-rouge">src/main.lisp</code> file, before the routes we previously defined, we will add this:</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:requirement</span> <span class="vg">*app*</span> <span class="ss">:logged-in-p</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">value</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">cu-sith:logged-in-p</span><span class="p">)</span> <span class="nv">value</span><span class="p">)))</span></code></pre></figure>

<p>Since this will be used as a keyword argument, the <code class="language-plaintext highlighter-rouge">lambda</code> function will always define a parameter, this will be the value found to the key word argument later when this is used in a route definition. We will use this <code class="language-plaintext highlighter-rouge">requirement</code> in a few places here, starting with our "/" route.</p>

<p>Previously we just had a dummy response that returned what we thought the posts might look like, but now we have the capability to store and retrieve posts from a database we can change this now.</p>

<p>We have different database queries too, a query to run when a user is not logged in, and a query to run when they are, this this helps split our controllers into a logged in view, and a not logged in view.</p>

<p>A quick word on controller definitions, if you have multiple controllers, you must define the most specific ones first! So we will start by defining a view that matches on "/" and when <code class="language-plaintext highlighter-rouge">logged-in-p</code> is <code class="language-plaintext highlighter-rouge">t</code>, because if we try to match on "/" first, then it matches every controller for that route, ignoring any other specific requirements of it, so we must define our logged in view first!</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/"</span> <span class="ss">:logged-in-p</span> <span class="no">t</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">user</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:user</span> <span class="nv">ningle:*session*</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">form</span> <span class="p">(</span><span class="nv">cl-forms:find-form</span> <span class="ss">'post</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">posts</span> <span class="p">(</span><span class="nv">ningle-tutorial-project/models:logged-in-posts</span> <span class="nv">user</span><span class="p">)))</span>
          <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"main/index.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Home"</span> <span class="ss">:user</span> <span class="nv">user</span> <span class="ss">:posts</span> <span class="nv">posts</span> <span class="ss">:form</span> <span class="nv">form</span><span class="p">))))</span></code></pre></figure>

<p>In this controller we ensure that there is a user that is logged in using <code class="language-plaintext highlighter-rouge">:logged-in-p t</code>, and another change this controller handles if a user is logged in, is permitting them to post! So this controller grabs the logged in user, the form for posting content and the first 50 posts (which is what <code class="language-plaintext highlighter-rouge">logged-in-posts</code> does) and renders them in the template.</p>

<p>Then we can define a more general "/" controller after it.</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/"</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">posts</span> <span class="p">(</span><span class="nv">ningle-tutorial-project/models:not-logged-in-posts</span><span class="p">)))</span>
          <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"main/index.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Home"</span> <span class="ss">:user</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:user</span> <span class="nv">ningle:*session*</span><span class="p">)</span> <span class="ss">:posts</span> <span class="nv">posts</span><span class="p">))))</span></code></pre></figure>

<p>This is simpler, by not needing a user or post form, we can forgo these and simply get a list of posts with <code class="language-plaintext highlighter-rouge">not-logged-in-posts</code>. Although, now I think about it, I could have written a helper method that takes a user object and runs these functions depending on if the user is <code class="language-plaintext highlighter-rouge">nil</code> or not, you live and learn!</p>

<p>Please note that these two controllers will replace the previous "/" controller we had.</p>

<p>With these in place we need a controller to toggle the <code class="language-plaintext highlighter-rouge">liked</code> status of a post.</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/post/:id/likes"</span> <span class="ss">:method</span> <span class="ss">:POST</span> <span class="ss">:logged-in-p</span> <span class="no">t</span><span class="p">)</span>
     <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">user</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:user</span> <span class="nv">ningle:*session*</span><span class="p">))</span>
              <span class="p">(</span><span class="nv">post</span> <span class="p">(</span><span class="nv">mito:find-dao</span> <span class="ss">'ningle-tutorial-project/models:post</span> <span class="ss">:id</span> <span class="p">(</span><span class="nb">parse-integer</span> <span class="p">(</span><span class="nv">ingle:get-param</span> <span class="ss">:id</span> <span class="nv">params</span><span class="p">))))</span>
              <span class="p">(</span><span class="nv">res</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="ss">'equal</span><span class="p">)))</span>
           <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:post</span> <span class="nv">res</span><span class="p">)</span> <span class="p">(</span><span class="nv">ingle:get-param</span> <span class="ss">:id</span> <span class="nv">params</span><span class="p">))</span>
           <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:likes</span> <span class="nv">res</span><span class="p">)</span> <span class="p">(</span><span class="nv">ningle-tutorial-project/models:likes</span> <span class="nv">post</span><span class="p">))</span>
           <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:liked</span> <span class="nv">res</span><span class="p">)</span> <span class="p">(</span><span class="nv">ningle-tutorial-project/models:toggle-like</span> <span class="nv">user</span> <span class="nv">post</span><span class="p">))</span>
           <span class="p">(</span><span class="nv">com.inuoe.jzon:stringify</span> <span class="nv">res</span><span class="p">))))</span></code></pre></figure>

<p>Here, this controller is permitted to <code class="language-plaintext highlighter-rouge">POST</code> only and requires that a user is logged in, we obviously don't want users that aren't logged in to be able to like posts. So we grab the user, the post that is to be liked and we create a <code class="language-plaintext highlighter-rouge">hash-table</code> for creating our response because here, we actually use the <code class="language-plaintext highlighter-rouge">jzon</code> package to return a valid json response. This controller sets the <code class="language-plaintext highlighter-rouge">:post</code>, <code class="language-plaintext highlighter-rouge">:likes</code>, and <code class="language-plaintext highlighter-rouge">:liked</code> fields and stringifies the <code class="language-plaintext highlighter-rouge">hash-table</code> so it can be read as json. We need to grab the post id from the url, but we have seen this before.</p>

<p>Our next controller simply directs the user to a specific post.</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/post/:id"</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">handler-case</span>
          <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">post</span> <span class="p">(</span><span class="nv">mito:find-dao</span> <span class="ss">'ningle-tutorial-project/models:post</span> <span class="ss">:id</span> <span class="p">(</span><span class="nb">parse-integer</span> <span class="p">(</span><span class="nv">ingle:get-param</span> <span class="ss">:id</span> <span class="nv">params</span><span class="p">)))))</span>
              <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"main/post.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Post"</span> <span class="ss">:post</span> <span class="nv">post</span><span class="p">))</span>

          <span class="p">(</span><span class="kt">parse-error</span> <span class="p">(</span><span class="nv">err</span><span class="p">)</span>
                <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">lack.response:response-status</span> <span class="nv">ningle:*response*</span><span class="p">)</span> <span class="mi">404</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"error.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Error"</span> <span class="ss">:error</span> <span class="nv">err</span><span class="p">)))))</span></code></pre></figure>

<p>We set up a <code class="language-plaintext highlighter-rouge">handler-case</code> to attempt to load a specific post and render the template, if that fails, we set a 404 response code and render the error page.</p>

<p>Moving on now to actually posting some content! Once again this controller should only be permitted to serve <code class="language-plaintext highlighter-rouge">POST</code> requests and require that a user is logged in. As we have seen previously in this series we need to grab the user object and the form that was submitted. From there we do the error handling <code class="language-plaintext highlighter-rouge">handler-case</code> by handling the loading of the form, we handle the values of <code class="language-plaintext highlighter-rouge">valid</code>, or <code class="language-plaintext highlighter-rouge">errors</code> and enter the content of a post into the database if there's no errors, if there are, a 403 is set and the error is rendered.</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/post"</span> <span class="ss">:method</span> <span class="ss">:POST</span> <span class="ss">:logged-in-p</span> <span class="no">t</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">user</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:user</span> <span class="nv">ningle:*session*</span><span class="p">))</span>
              <span class="p">(</span><span class="nv">form</span> <span class="p">(</span><span class="nv">cl-forms:find-form</span> <span class="ss">'post</span><span class="p">)))</span>
          <span class="p">(</span><span class="nb">handler-case</span>
            <span class="p">(</span><span class="k">progn</span>
              <span class="p">(</span><span class="nv">cl-forms:handle-request</span> <span class="nv">form</span><span class="p">)</span> <span class="c1">; Can throw an error if CSRF fails</span>

              <span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">valid</span> <span class="nv">errors</span><span class="p">)</span>
                  <span class="p">(</span><span class="nv">cl-forms:validate-form</span> <span class="nv">form</span><span class="p">)</span>

                <span class="p">(</span><span class="nb">when</span> <span class="nv">errors</span>
                  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">"Errors: ~A~%"</span> <span class="nv">errors</span><span class="p">))</span>

                <span class="p">(</span><span class="nb">when</span> <span class="nv">valid</span>
                  <span class="p">(</span><span class="nv">cl-forms:with-form-field-values</span> <span class="p">(</span><span class="nv">content</span><span class="p">)</span> <span class="nv">form</span>
                    <span class="p">(</span><span class="nv">mito:create-dao</span> <span class="ss">'ningle-tutorial-project/models:post</span> <span class="ss">:content</span> <span class="nv">content</span> <span class="ss">:user</span> <span class="nv">user</span><span class="p">)</span>
                    <span class="p">(</span><span class="nv">ingle:redirect</span> <span class="s">"/"</span><span class="p">)))))</span>

            <span class="p">(</span><span class="kt">simple-error</span> <span class="p">(</span><span class="nv">err</span><span class="p">)</span>
              <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">lack.response:response-status</span> <span class="nv">ningle:*response*</span><span class="p">)</span> <span class="mi">403</span><span class="p">)</span>
              <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"error.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Error"</span> <span class="ss">:error</span> <span class="nv">err</span><span class="p">))))))</span></code></pre></figure>

<p>Finally we now look to replace the "/profile" controllers, we have already explored the new concepts but this serves as a simple, clear example, and it helps we need to work on this further anyway!</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/profile"</span> <span class="ss">:logged-in-p</span> <span class="no">t</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">user</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:user</span> <span class="nv">ningle:*session*</span><span class="p">)))</span>
            <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"main/profile.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Profile"</span> <span class="ss">:user</span> <span class="nv">user</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/profile"</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">lack.response:response-status</span> <span class="nv">ningle:*response*</span><span class="p">)</span> <span class="mi">403</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"error.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Error"</span> <span class="ss">:error</span> <span class="s">"Unauthorized"</span><span class="p">)))</span></code></pre></figure>

<p>Full listing:</p>

<figure class="highlight"><pre><code class="language-common_lisp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">defpackage</span> <span class="nv">ningle-tutorial-project</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="ss">:cl</span> <span class="ss">:sxql</span> <span class="ss">:ningle-tutorial-project/forms</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:export</span> <span class="ss">#:start</span>
           <span class="ss">#:stop</span><span class="p">))</span>

<span class="p">(</span><span class="nb">in-package</span> <span class="nv">ningle-tutorial-project</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*app*</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">'ningle:app</span><span class="p">))</span>

<span class="c1">;; requirements</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:requirement</span> <span class="vg">*app*</span> <span class="ss">:logged-in-p</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">value</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">cu-sith:logged-in-p</span><span class="p">)</span> <span class="nv">value</span><span class="p">)))</span>

<span class="c1">;; routes</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/"</span> <span class="ss">:logged-in-p</span> <span class="no">t</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">user</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:user</span> <span class="nv">ningle:*session*</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">form</span> <span class="p">(</span><span class="nv">cl-forms:find-form</span> <span class="ss">'post</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">posts</span> <span class="p">(</span><span class="nv">ningle-tutorial-project/models:logged-in-posts</span> <span class="nv">user</span><span class="p">)))</span>
          <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"main/index.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Home"</span> <span class="ss">:user</span> <span class="nv">user</span> <span class="ss">:posts</span> <span class="nv">posts</span> <span class="ss">:form</span> <span class="nv">form</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/"</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">posts</span> <span class="p">(</span><span class="nv">ningle-tutorial-project/models:not-logged-in-posts</span><span class="p">)))</span>
          <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"main/index.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Home"</span> <span class="ss">:user</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:user</span> <span class="nv">ningle:*session*</span><span class="p">)</span> <span class="ss">:posts</span> <span class="nv">posts</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/post/:id/likes"</span> <span class="ss">:method</span> <span class="ss">:POST</span> <span class="ss">:logged-in-p</span> <span class="no">t</span><span class="p">)</span>
     <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">user</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:user</span> <span class="nv">ningle:*session*</span><span class="p">))</span>
              <span class="p">(</span><span class="nv">post</span> <span class="p">(</span><span class="nv">mito:find-dao</span> <span class="ss">'ningle-tutorial-project/models:post</span> <span class="ss">:id</span> <span class="p">(</span><span class="nb">parse-integer</span> <span class="p">(</span><span class="nv">ingle:get-param</span> <span class="ss">:id</span> <span class="nv">params</span><span class="p">))))</span>
              <span class="p">(</span><span class="nv">res</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="ss">'equal</span><span class="p">)))</span>
           <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:post</span> <span class="nv">res</span><span class="p">)</span> <span class="p">(</span><span class="nv">ingle:get-param</span> <span class="ss">:id</span> <span class="nv">params</span><span class="p">))</span>
           <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:likes</span> <span class="nv">res</span><span class="p">)</span> <span class="p">(</span><span class="nv">ningle-tutorial-project/models:likes</span> <span class="nv">post</span><span class="p">))</span>
           <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:liked</span> <span class="nv">res</span><span class="p">)</span> <span class="p">(</span><span class="nv">ningle-tutorial-project/models:toggle-like</span> <span class="nv">user</span> <span class="nv">post</span><span class="p">))</span>
           <span class="p">(</span><span class="nv">com.inuoe.jzon:stringify</span> <span class="nv">res</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/post/:id"</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">handler-case</span>
          <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">post</span> <span class="p">(</span><span class="nv">mito:find-dao</span> <span class="ss">'ningle-tutorial-project/models:post</span> <span class="ss">:id</span> <span class="p">(</span><span class="nb">parse-integer</span> <span class="p">(</span><span class="nv">ingle:get-param</span> <span class="ss">:id</span> <span class="nv">params</span><span class="p">)))))</span>
              <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"main/post.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Post"</span> <span class="ss">:post</span> <span class="nv">post</span><span class="p">))</span>

          <span class="p">(</span><span class="kt">parse-error</span> <span class="p">(</span><span class="nv">err</span><span class="p">)</span>
                <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">lack.response:response-status</span> <span class="nv">ningle:*response*</span><span class="p">)</span> <span class="mi">404</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"error.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Error"</span> <span class="ss">:error</span> <span class="nv">err</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/post"</span> <span class="ss">:method</span> <span class="ss">:POST</span> <span class="ss">:logged-in-p</span> <span class="no">t</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">user</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:user</span> <span class="nv">ningle:*session*</span><span class="p">))</span>
              <span class="p">(</span><span class="nv">form</span> <span class="p">(</span><span class="nv">cl-forms:find-form</span> <span class="ss">'post</span><span class="p">)))</span>
          <span class="p">(</span><span class="nb">handler-case</span>
            <span class="p">(</span><span class="k">progn</span>
              <span class="p">(</span><span class="nv">cl-forms:handle-request</span> <span class="nv">form</span><span class="p">)</span> <span class="c1">; Can throw an error if CSRF fails</span>

              <span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">valid</span> <span class="nv">errors</span><span class="p">)</span>
                  <span class="p">(</span><span class="nv">cl-forms:validate-form</span> <span class="nv">form</span><span class="p">)</span>

                <span class="p">(</span><span class="nb">when</span> <span class="nv">errors</span>
                  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">"Errors: ~A~%"</span> <span class="nv">errors</span><span class="p">))</span>

                <span class="p">(</span><span class="nb">when</span> <span class="nv">valid</span>
                  <span class="p">(</span><span class="nv">cl-forms:with-form-field-values</span> <span class="p">(</span><span class="nv">content</span><span class="p">)</span> <span class="nv">form</span>
                    <span class="p">(</span><span class="nv">mito:create-dao</span> <span class="ss">'ningle-tutorial-project/models:post</span> <span class="ss">:content</span> <span class="nv">content</span> <span class="ss">:user</span> <span class="nv">user</span><span class="p">)</span>
                    <span class="p">(</span><span class="nv">ingle:redirect</span> <span class="s">"/"</span><span class="p">)))))</span>

            <span class="p">(</span><span class="kt">simple-error</span> <span class="p">(</span><span class="nv">err</span><span class="p">)</span>
              <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">lack.response:response-status</span> <span class="nv">ningle:*response*</span><span class="p">)</span> <span class="mi">403</span><span class="p">)</span>
              <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"error.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Error"</span> <span class="ss">:error</span> <span class="nv">err</span><span class="p">))))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/profile"</span> <span class="ss">:logged-in-p</span> <span class="no">t</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">user</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:user</span> <span class="nv">ningle:*session*</span><span class="p">)))</span>
            <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"main/profile.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Profile"</span> <span class="ss">:user</span> <span class="nv">user</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/profile"</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">lack.response:response-status</span> <span class="nv">ningle:*response*</span><span class="p">)</span> <span class="mi">403</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"error.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Error"</span> <span class="ss">:error</span> <span class="s">"Unauthorized"</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/people"</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">users</span> <span class="p">(</span><span class="nv">mito:retrieve-dao</span> <span class="ss">'ningle-auth/models:user</span><span class="p">)))</span>
          <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"main/people.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"People"</span> <span class="ss">:users</span> <span class="nv">users</span> <span class="ss">:user</span> <span class="p">(</span><span class="nv">cu-sith:logged-in-p</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">ningle:route</span> <span class="vg">*app*</span> <span class="s">"/people/:person"</span><span class="p">)</span>
      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">params</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">username-or-email</span> <span class="p">(</span><span class="nv">ingle:get-param</span> <span class="ss">:person</span> <span class="nv">params</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">person</span> <span class="p">(</span><span class="nb">first</span> <span class="p">(</span><span class="nv">mito:select-dao</span>
                              <span class="ss">'ningle-auth/models:user</span>
                              <span class="p">(</span><span class="nv">where</span> <span class="p">(</span><span class="ss">:or</span> <span class="p">(</span><span class="ss">:=</span> <span class="ss">:username</span> <span class="nv">username-or-email</span><span class="p">)</span>
                                          <span class="p">(</span><span class="ss">:=</span> <span class="ss">:email</span> <span class="nv">username-or-email</span><span class="p">)))))))</span>
          <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"main/person.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Person"</span> <span class="ss">:person</span> <span class="nv">person</span> <span class="ss">:user</span> <span class="p">(</span><span class="nv">cu-sith:logged-in-p</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">ningle:not-found</span> <span class="p">((</span><span class="nv">app</span> <span class="nv">ningle:&lt;app&gt;</span><span class="p">))</span>
    <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">app</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">lack.response:response-status</span> <span class="nv">ningle:*response*</span><span class="p">)</span> <span class="mi">404</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">djula:render-template*</span> <span class="s">"error.html"</span> <span class="no">nil</span> <span class="ss">:title</span> <span class="s">"Error"</span> <span class="ss">:error</span> <span class="s">"Not Found"</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">start</span> <span class="p">(</span><span class="k">&amp;key</span> <span class="p">(</span><span class="nv">server</span> <span class="ss">:woo</span><span class="p">)</span> <span class="p">(</span><span class="nv">address</span> <span class="s">"127.0.0.1"</span><span class="p">)</span> <span class="p">(</span><span class="nv">port</span> <span class="mi">8000</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">djula:add-template-directory</span> <span class="p">(</span><span class="nv">asdf:system-relative-pathname</span> <span class="ss">:ningle-tutorial-project</span> <span class="s">"src/templates/"</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">djula:set-static-url</span> <span class="s">"/public/"</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">clack:clackup</span>
     <span class="p">(</span><span class="nv">lack.builder:builder</span> <span class="p">(</span><span class="nv">envy-ningle:build-middleware</span> <span class="ss">:ningle-tutorial-project/config</span> <span class="vg">*app*</span><span class="p">))</span>
     <span class="ss">:server</span> <span class="nv">server</span>
     <span class="ss">:address</span> <span class="nv">address</span>
     <span class="ss">:port</span> <span class="nv">port</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">stop</span> <span class="p">(</span><span class="nv">instance</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">clack:stop</span> <span class="nv">instance</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h4 id="ningle-tutorial-projectasd-1">ningle-tutorial-project.asd</h4>

<p>There's one final thing to add before we look at the aesthetic changes we will be applying, we need to ensure we add the <code class="language-plaintext highlighter-rouge">jzon</code> package to our project dependencies.</p>

<figure class="highlight"><pre><code class="language-common_lisp"><span class="ss">:depends-on</span> <span class="p">(</span><span class="ss">:cl-dotenv</span>
               <span class="ss">:clack</span>
               <span class="ss">:djula</span>
               <span class="ss">:cl-forms</span>
               <span class="ss">:cl-forms.djula</span>
               <span class="ss">:cl-forms.ningle</span>
               <span class="ss">:envy</span>
               <span class="ss">:envy-ningle</span>
               <span class="ss">:ingle</span>
               <span class="ss">:com.inuoe.jzon</span> <span class="c1">; &lt;- Add this line</span>
               <span class="ss">:mito</span>
               <span class="ss">:mito-auth</span>
               <span class="ss">:ningle</span>
               <span class="ss">:ningle-auth</span><span class="p">)</span></code></pre></figure>

<h3 id="html-changes">HTML Changes</h3>

<p>We make some changes to our html, sadly the biggest part of it is JavaScript, but nevermind!</p>

<h4 id="srctemplatebasehtml">src/template/base.html</h4>

<p>In our base template we only make a couple of changes, in our <code class="language-plaintext highlighter-rouge">&lt;head&gt;&lt;/head&gt;</code> section, prior to loading our own css, we must include the bootstrap icons package.</p>

<figure class="highlight"><pre><code class="language-html"><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"</span><span class="nt">&gt;</span> <span class="nt">&lt;</span><span class="err">!</span> <span class="na">--</span> <span class="na">add</span> <span class="na">this</span> <span class="na">line</span><span class="err">!</span> <span class="na">--</span><span class="nt">&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"{% static "</span><span class="na">css</span><span class="err">/</span><span class="na">main.css</span><span class="err">"</span> <span class="err">%}"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>Next, right at the bottom, we include a way to add JS to templates, if we need to.</p>

<figure class="highlight"><pre><code class="language-html"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script&gt;</span>
    <span class="p">{</span><span class="o">%</span> <span class="nx">block</span> <span class="nx">js</span> <span class="o">%</span><span class="p">}</span>
    <span class="p">{</span><span class="o">%</span> <span class="nx">endblock</span> <span class="o">%</span><span class="p">}</span>
<span class="nt">&lt;/script&gt;</span></code></pre></figure>

<p>Full listing:</p>

<figure class="highlight"><pre><code class="language-html"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="code"><pre><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        {% if title %}
            <span class="nt">&lt;title&gt;</span>{{ title }} - Y<span class="nt">&lt;/title&gt;</span>
        {% else %}
            <span class="nt">&lt;title&gt;</span>Welcome to Y<span class="nt">&lt;/title&gt;</span>
        {% endif %}
        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"{% static "</span><span class="na">css</span><span class="err">/</span><span class="na">main.css</span><span class="err">"</span> <span class="err">%}"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-expand-lg navbar-dark bg-dark"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"{% static "</span><span class="na">images</span><span class="err">/</span><span class="na">logo.jpg</span><span class="err">"</span> <span class="err">%}"</span> <span class="na">alt=</span><span class="s">"Logo"</span> <span class="na">class=</span><span class="s">"d-inline-block align-text-top logo"</span><span class="nt">&gt;</span>
                    Y
                <span class="nt">&lt;/a&gt;</span>

                <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"navbar-toggler"</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">data-bs-toggle=</span><span class="s">"collapse"</span> <span class="na">data-bs-target=</span><span class="s">"#navbarSupportedContent"</span> <span class="na">aria-controls=</span><span class="s">"navbarSupportedContent"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span> <span class="na">aria-label=</span><span class="s">"Toggle navigation"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"navbar-toggler-icon"</span><span class="nt">&gt;&lt;/span&gt;</span>
                <span class="nt">&lt;/button&gt;</span>

                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id=</span><span class="s">"navbarSupportedContent"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"navbar-nav me-auto"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item {% ifequal title "</span><span class="na">Home</span><span class="err">"</span> <span class="err">%}</span><span class="na">disabled</span><span class="err">{%</span> <span class="na">endifequal</span> <span class="err">%}"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link"</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>Home<span class="nt">&lt;/a&gt;</span>
                        <span class="nt">&lt;/li&gt;</span>
                        <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item {% ifequal title "</span><span class="na">People</span><span class="err">"</span> <span class="err">%}</span><span class="na">disabled</span><span class="err">{%</span> <span class="na">endifequal</span> <span class="err">%}"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link"</span> <span class="na">href=</span><span class="s">"/people"</span><span class="nt">&gt;</span>People<span class="nt">&lt;/a&gt;</span>
                        <span class="nt">&lt;/li&gt;</span>
                    <span class="nt">&lt;/ul&gt;</span>

                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"d-flex ms-auto"</span><span class="nt">&gt;</span>
                        {% if user %}
                            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/profile"</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span><span class="nt">&gt;</span>{{ user.username }}<span class="nt">&lt;/a&gt;</span>
                            <span class="ni">&amp;nbsp;</span>|<span class="ni">&amp;nbsp;</span>
                            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/auth/logout"</span> <span class="na">class=</span><span class="s">"btn btn-secondary"</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/a&gt;</span>
                        {% else %}
                            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/auth/register"</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span><span class="nt">&gt;</span>Register<span class="nt">&lt;/a&gt;</span>
                            <span class="ni">&amp;nbsp;</span>|<span class="ni">&amp;nbsp;</span>
                            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/auth/login"</span> <span class="na">class=</span><span class="s">"btn btn-success"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/a&gt;</span>
                        {% endif %}
                    <span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/nav&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container mt-4"</span><span class="nt">&gt;</span>
            {% block content %}
            {% endblock %}
        <span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script&gt;</span>
            <span class="p">{</span><span class="o">%</span> <span class="nx">block</span> <span class="nx">js</span> <span class="o">%</span><span class="p">}</span>
            <span class="p">{</span><span class="o">%</span> <span class="nx">endblock</span> <span class="o">%</span><span class="p">}</span>
        <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h4 id="srctemplatemainindexhtml">src/template/main/index.html</h4>

<p>Our index page will need to include some JavaScript, this will be with the intention of sending a request to the controller to increment/decrement the <code class="language-plaintext highlighter-rouge">like</code> count of a post. Again since this tutorial is about Common Lisp, I won't really be explaining the JS.</p>

<p>In the first part of the container div, we will add our form to post content:</p>

<figure class="highlight"><pre><code class="language-html">{% block content %}
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- Post form --&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row mb-4"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col"</span><span class="nt">&gt;</span>
            {% if form %}
                {% form form %}
            {% endif %}
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    ...</code></pre></figure>

<p>This displays the full form, including labels we don't necessarily need, so we hide this using the css that was written, but this will only show when a user is logged in and will post content for the logged in user.</p>

<p>Next we will be changing the structure of the contents of our posts <code class="language-plaintext highlighter-rouge">for</code> loop, nothing major, but since we have better CSS we might want to ensure our HTML matches it.</p>

<figure class="highlight"><pre><code class="language-html">{% for post in posts %}
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card post mb-3"</span> <span class="na">data-href=</span><span class="s">"/post/{{ post.id }}"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-body"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h5</span> <span class="na">class=</span><span class="s">"card-title mb-2"</span><span class="nt">&gt;</span>{{ post.content }}<span class="nt">&lt;/h5&gt;</span>
      <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"card-subtitle text-muted mb-0"</span><span class="nt">&gt;</span>@{{ post.user.username }}<span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;/div&gt;</span>

      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-footer d-flex justify-content-between align-items-center"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span>
                <span class="na">class=</span><span class="s">"btn btn-sm btn-outline-primary like-button"</span>
                <span class="na">data-post-id=</span><span class="s">"{{ post.id }}"</span>
                <span class="na">data-logged-in=</span><span class="s">"{% if user.username != "</span><span class="err">"</span> <span class="err">%}</span><span class="na">true</span><span class="err">{%</span> <span class="na">else</span> <span class="err">%}</span><span class="na">false</span><span class="err">{%</span> <span class="na">endif</span> <span class="err">%}"</span>
                <span class="na">data-liked=</span><span class="s">"{% if post.liked-by-user == 1 %}true{% else %}false{% endif %}"</span>
                <span class="na">aria-label=</span><span class="s">"Like post {{ post.id }}"</span><span class="nt">&gt;</span>
            {% if post.liked-by-user == 1 %}
              <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"bi bi-hand-thumbs-up-fill text-primary"</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;&lt;/i&gt;</span>
            {% else %}
              <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"bi bi-hand-thumbs-up text-muted"</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;&lt;/i&gt;</span>
            {% endif %}
            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"ms-1 like-count"</span><span class="nt">&gt;</span>{{ post.like-count }}<span class="nt">&lt;/span&gt;</span>
        <span class="nt">&lt;/button&gt;</span>

        <span class="nt">&lt;small</span> <span class="na">class=</span><span class="s">"text-muted"</span><span class="nt">&gt;</span>Posted on: {{ post.created-at }}<span class="nt">&lt;/small&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
{% endfor %}</code></pre></figure>

<p>Then in the case where we do not have any posts!</p>

<figure class="highlight"><pre><code class="language-html">{% if not posts %}
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"text-center"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-muted"</span><span class="nt">&gt;</span>No posts to display.<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
{% endif %}</code></pre></figure>

<p>Finally the dreaded JS!</p>

<figure class="highlight"><pre><code class="language-javascript"><span class="p">{</span><span class="o">%</span> <span class="nx">block</span> <span class="nx">js</span> <span class="o">%</span><span class="p">}</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="dl">"</span><span class="s2">.like-button</span><span class="dl">"</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">btn</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">btn</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="c1">// Check login</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">btn</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">loggedIn</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">true</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">You must be logged in to like posts.</span><span class="dl">"</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">btn</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">postId</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">countSpan</span> <span class="o">=</span> <span class="nx">btn</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">.like-count</span><span class="dl">"</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">icon</span> <span class="o">=</span> <span class="nx">btn</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">i</span><span class="dl">"</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">liked</span> <span class="o">=</span> <span class="nx">btn</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">liked</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">true</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">previous</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">countSpan</span><span class="p">.</span><span class="nx">textContent</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`/post/</span><span class="p">${</span><span class="nx">postId</span><span class="p">}</span><span class="s2">/likes`</span><span class="p">;</span>

    <span class="c1">// Optimistic UI toggle</span>
    <span class="nx">countSpan</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">liked</span> <span class="p">?</span> <span class="nx">previous</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="nx">previous</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">btn</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">liked</span> <span class="o">=</span> <span class="nx">liked</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">false</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">true</span><span class="dl">"</span><span class="p">;</span>

    <span class="c1">// Toggle icon classes optimistically</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">liked</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Currently liked, so unlike it</span>
      <span class="nx">icon</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">bi bi-hand-thumbs-up text-muted</span><span class="dl">"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Currently not liked, so like it</span>
      <span class="nx">icon</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">bi bi-hand-thumbs-up-fill text-primary</span><span class="dl">"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">csrfTokenMeta</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">meta[name="csrf-token"]</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span> <span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">csrfTokenMeta</span><span class="p">)</span> <span class="nx">headers</span><span class="p">[</span><span class="dl">"</span><span class="s2">X-CSRF-Token</span><span class="dl">"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">csrfTokenMeta</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">);</span>

    <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">headers</span><span class="p">:</span> <span class="nx">headers</span><span class="p">,</span>
      <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="na">toggle</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">resp</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Revert optimistic changes on error</span>
        <span class="nx">countSpan</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">previous</span><span class="p">;</span>
        <span class="nx">btn</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">liked</span> <span class="o">=</span> <span class="nx">liked</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">true</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">false</span><span class="dl">"</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">liked</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">icon</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">bi bi-hand-thumbs-up-fill text-primary</span><span class="dl">"</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">icon</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">bi bi-hand-thumbs-up text-muted</span><span class="dl">"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Network response was not ok</span><span class="dl">"</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">likes</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">undefined</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">countSpan</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">likes</span><span class="p">;</span>
        <span class="nx">btn</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">liked</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">liked</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">true</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">false</span><span class="dl">"</span><span class="p">;</span>

        <span class="c1">// Update icon based on server response</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">liked</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">icon</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">bi bi-hand-thumbs-up-fill text-primary</span><span class="dl">"</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">icon</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">bi bi-hand-thumbs-up text-muted</span><span class="dl">"</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Like failed:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
      <span class="c1">// Revert optimistic changes on error</span>
      <span class="nx">countSpan</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">previous</span><span class="p">;</span>
      <span class="nx">btn</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">liked</span> <span class="o">=</span> <span class="nx">liked</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">true</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">false</span><span class="dl">"</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">liked</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">icon</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">bi bi-hand-thumbs-up-fill text-primary</span><span class="dl">"</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">icon</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">bi bi-hand-thumbs-up text-muted</span><span class="dl">"</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="dl">"</span><span class="s2">.card.post</span><span class="dl">"</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">card</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">card</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">href</span> <span class="o">=</span> <span class="nx">card</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">href</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">href</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">});</span>
<span class="p">{</span><span class="o">%</span> <span class="nx">endblock</span> <span class="o">%</span><span class="p">}</span></code></pre></figure>

<p>Full listing:</p>

<figure class="highlight"><pre><code class="language-html"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
</pre></td><td class="code"><pre>{% extends "base.html" %}

{% block content %}
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- Post form --&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row mb-4"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col"</span><span class="nt">&gt;</span>
            {% if form %}
                {% form form %}
            {% endif %}
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="c">&lt;!-- Posts Section --&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-12"</span><span class="nt">&gt;</span>
            {% for post in posts %}
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card post mb-3"</span> <span class="na">data-href=</span><span class="s">"/post/{{ post.id }}"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-body"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;h5</span> <span class="na">class=</span><span class="s">"card-title mb-2"</span><span class="nt">&gt;</span>{{ post.content }}<span class="nt">&lt;/h5&gt;</span>
                  <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"card-subtitle text-muted mb-0"</span><span class="nt">&gt;</span>@{{ post.user.username }}<span class="nt">&lt;/p&gt;</span>
                <span class="nt">&lt;/div&gt;</span>

                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-footer d-flex justify-content-between align-items-center"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span>
                        <span class="na">class=</span><span class="s">"btn btn-sm btn-outline-primary like-button"</span>
                        <span class="na">data-post-id=</span><span class="s">"{{ post.id }}"</span>
                        <span class="na">data-logged-in=</span><span class="s">"{% if user.username != "</span><span class="err">"</span> <span class="err">%}{%</span> <span class="na">endraw</span> <span class="err">%</span><span class="na">true</span><span class="err">{%</span> <span class="na">endraw</span> <span class="err">%</span><span class="na">true</span><span class="err">{%</span> <span class="na">raw</span> <span class="err">%}{%</span> <span class="na">else</span> <span class="err">%}</span><span class="na">false</span><span class="err">{%</span> <span class="na">endif</span> <span class="err">%}"</span>
                        <span class="na">data-liked=</span><span class="s">"{% if post.liked-by-user == 1 %}true{% else %}false{% endif %}"</span>
                        <span class="na">aria-label=</span><span class="s">"Like post {{ post.id }}"</span><span class="nt">&gt;</span>
                    {% if post.liked-by-user == 1 %}
                      <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"bi bi-hand-thumbs-up-fill text-primary"</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;&lt;/i&gt;</span>
                    {% else %}
                      <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"bi bi-hand-thumbs-up text-muted"</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;&lt;/i&gt;</span>
                    {% endif %}
                    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"ms-1 like-count"</span><span class="nt">&gt;</span>{{ post.like-count }}<span class="nt">&lt;/span&gt;</span>
                <span class="nt">&lt;/button&gt;</span>

                <span class="nt">&lt;small</span> <span class="na">class=</span><span class="s">"text-muted"</span><span class="nt">&gt;</span>Posted on: {{ post.created-at }}{% raw %}<span class="nt">&lt;/small&gt;</span>
                <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
            {% raw %}{% endfor %}

            {% if not posts %}
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"text-center"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-muted"</span><span class="nt">&gt;</span>No posts to display.<span class="nt">&lt;/p&gt;</span>
                <span class="nt">&lt;/div&gt;</span>
            {% endif %}
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
{% endblock %}

{% block js %}
document.querySelectorAll(".like-button").forEach(btn =&gt; {
  btn.addEventListener("click", function (e) {
    e.stopPropagation();
    e.preventDefault();

    // Check login
    if (btn.dataset.loggedIn !== "true") {
      alert("You must be logged in to like posts.");
      return;
    }

    const postId = btn.dataset.postId;
    const countSpan = btn.querySelector(".like-count");
    const icon = btn.querySelector("i");
    const liked = btn.dataset.liked === "true";
    const previous = parseInt(countSpan.textContent, 10) || 0;
    const url = `/post/${postId}/likes`;

    // Optimistic UI toggle
    countSpan.textContent = liked ? previous - 1 : previous + 1;
    btn.dataset.liked = liked ? "false" : "true";

    // Toggle icon classes optimistically
    if (liked) {
      // Currently liked, so unlike it
      icon.className = "bi bi-hand-thumbs-up text-muted";
    } else {
      // Currently not liked, so like it
      icon.className = "bi bi-hand-thumbs-up-fill text-primary";
    }

    const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
    const headers = { "Content-Type": "application/json" };
    if (csrfTokenMeta) headers["X-CSRF-Token"] = csrfTokenMeta.getAttribute("content");

    fetch(url, {
      method: "POST",
      headers: headers,
      body: JSON.stringify({ toggle: true })
    })
    .then(resp =&gt; {
      if (!resp.ok) {
        // Revert optimistic changes on error
        countSpan.textContent = previous;
        btn.dataset.liked = liked ? "true" : "false";
        if (liked) {
          icon.className = "bi bi-hand-thumbs-up-fill text-primary";
        } else {
          icon.className = "bi bi-hand-thumbs-up text-muted";
        }
        throw new Error("Network response was not ok");
      }
      return resp.json();
    })
    .then(data =&gt; {
      if (data <span class="err">&amp;&amp;</span> typeof data.likes !== "undefined") {
        countSpan.textContent = data.likes;
        btn.dataset.liked = data.liked ? "true" : "false";

        // Update icon based on server response
        if (data.liked) {
          icon.className = "bi bi-hand-thumbs-up-fill text-primary";
        } else {
          icon.className = "bi bi-hand-thumbs-up text-muted";
        }
      }
    })
    .catch(err =&gt; {
      console.error("Like failed:", err);
      // Revert optimistic changes on error
      countSpan.textContent = previous;
      btn.dataset.liked = liked ? "true" : "false";
      if (liked) {
        icon.className = "bi bi-hand-thumbs-up-fill text-primary";
      } else {
        icon.className = "bi bi-hand-thumbs-up text-muted";
      }
    });
  });
});

document.querySelectorAll(".card.post").forEach(card =&gt; {
  card.addEventListener("click", function () {
    const href = card.dataset.href;
    if (href) {
      window.location.href = href;
    }
  });
});
{% endblock %}
</pre></td></tr></tbody></table></code></pre></figure>

<h4 id="srctemplatemainposthtml">src/template/main/post.html</h4>

<p>We will add a new post template, this isn't actually for creating a post, as we saw above we integrated that form into the index page, but rather this is the template for showing an individual post. In the future we might introduce comments etc and this would make it easier to see all of that content in one page.</p>

<figure class="highlight"><pre><code class="language-html"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre>{% extends "base.html" %}

{% block content %}
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-12"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;h2&gt;</span>{{ post.user.username }}<span class="nt">&lt;/h2&gt;</span>
            <span class="nt">&lt;p&gt;</span>{{ post.content }}<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
{% endblock %}
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="css-changes">CSS Changes</h3>

<p>I made a number of css changes (with the help of AI, cos I hate writing CSS!), and I wanted to include them here, but since the objective of this tutorial is Lisp not the nuances of selectors, I will just include the full listing without comments.</p>

<h4 id="srcstaticcssmaincss">src/static/css/main.css</h4>

<figure class="highlight"><pre><code class="language-css"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
</pre></td><td class="code"><pre><span class="nc">.logo</span> <span class="p">{</span>
    <span class="nl">height</span><span class="p">:</span> <span class="m">30px</span><span class="p">;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">30px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.error-404</span> <span class="p">{</span>
    <span class="nl">height</span><span class="p">:</span> <span class="m">75vh</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#signup</span> <span class="nt">input</span> <span class="p">{</span>
    <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>  <span class="c">/* Ensure inputs take up the full width */</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span> <span class="cp">!important</span><span class="p">;</span> <span class="c">/* Override any conflicting styles */</span>
    <span class="nl">max-width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span> <span class="c">/* Ensure no unnecessary constraints */</span>
    <span class="nl">box-sizing</span><span class="p">:</span> <span class="n">border-box</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#signup</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s1">"email"</span><span class="o">],</span>
<span class="nt">form</span><span class="nf">#signup</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s1">"text"</span><span class="o">],</span>
<span class="nt">form</span><span class="nf">#signup</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s1">"password"</span><span class="o">]</span> <span class="p">{</span>
    <span class="err">@extend</span> <span class="err">.form-control;</span> <span class="c">/* Apply Bootstrap's .form-control */</span>
    <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span> <span class="c">/* Ensure they are block-level elements */</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span> <span class="c">/* Make the input full width */</span>
    <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">1rem</span><span class="p">;</span> <span class="c">/* Spacing */</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#signup</span> <span class="nt">select</span> <span class="p">{</span>
    <span class="err">@extend</span> <span class="err">.form-select;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#signup</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s1">"submit"</span><span class="o">]</span> <span class="p">{</span>
    <span class="err">@extend</span> <span class="err">.btn;</span>
    <span class="err">@extend</span> <span class="err">.btn-primary;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#signup</span> <span class="nt">div</span> <span class="p">{</span>
    <span class="err">@extend</span> <span class="err">.mb-3;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#signup</span> <span class="nt">label</span> <span class="p">{</span>
    <span class="err">@extend</span> <span class="err">.form-label;</span>
    <span class="nl">font-weight</span><span class="p">:</span> <span class="nb">bold</span><span class="p">;</span>
    <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">0.5rem</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#login</span> <span class="nt">input</span> <span class="p">{</span>
    <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>  <span class="c">/* Ensure inputs take up the full width */</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span> <span class="cp">!important</span><span class="p">;</span> <span class="c">/* Override any conflicting styles */</span>
    <span class="nl">max-width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span> <span class="c">/* Ensure no unnecessary constraints */</span>
    <span class="nl">box-sizing</span><span class="p">:</span> <span class="n">border-box</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#login</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s1">"text"</span><span class="o">],</span>
<span class="nt">form</span><span class="nf">#login</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s1">"password"</span><span class="o">]</span> <span class="p">{</span>
    <span class="err">@extend</span> <span class="err">.form-control;</span> <span class="c">/* Apply Bootstrap's .form-control */</span>
    <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span> <span class="c">/* Ensure they are block-level elements */</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span> <span class="c">/* Make the input full width */</span>
    <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">1rem</span><span class="p">;</span> <span class="c">/* Spacing */</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#login</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s1">"submit"</span><span class="o">]</span> <span class="p">{</span>
    <span class="err">@extend</span> <span class="err">.btn;</span>
    <span class="err">@extend</span> <span class="err">.btn-primary;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#login</span> <span class="nt">div</span> <span class="p">{</span>
    <span class="err">@extend</span> <span class="err">.mb-3;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#post</span> <span class="nt">div</span> <span class="p">{</span>
    <span class="err">@extend</span> <span class="err">.mb-3;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#post</span> <span class="p">{</span>
    <span class="nl">display</span><span class="p">:</span> <span class="n">flex</span> <span class="cp">!important</span><span class="p">;</span>
    <span class="nl">align-items</span><span class="p">:</span> <span class="nb">center</span> <span class="cp">!important</span><span class="p">;</span>
    <span class="py">gap</span><span class="p">:</span> <span class="m">0.5rem</span><span class="p">;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span> <span class="cp">!important</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* Make the input wrapper expand */</span>
<span class="nt">form</span><span class="nf">#post</span> <span class="o">&gt;</span> <span class="nt">div</span><span class="nd">:first-of-type</span> <span class="p">{</span>
    <span class="nl">flex</span><span class="p">:</span> <span class="m">1</span> <span class="m">1</span> <span class="nb">auto</span> <span class="cp">!important</span><span class="p">;</span>
    <span class="nl">min-width</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>  <span class="c">/* allow shrinking */</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#post</span> <span class="nt">label</span> <span class="p">{</span>
    <span class="nl">display</span><span class="p">:</span> <span class="nb">none</span> <span class="cp">!important</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#post</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s1">"text"</span><span class="o">]</span> <span class="p">{</span>
    <span class="nl">flex</span><span class="p">:</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0%</span> <span class="cp">!important</span><span class="p">;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span> <span class="cp">!important</span><span class="p">;</span>
    <span class="nl">min-width</span><span class="p">:</span> <span class="m">0</span> <span class="cp">!important</span><span class="p">;</span>
    <span class="c">/* Bootstrap .form-control styles */</span>
    <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">0.375rem</span> <span class="m">0.75rem</span><span class="p">;</span>
    <span class="nl">font-size</span><span class="p">:</span> <span class="m">1rem</span><span class="p">;</span>
    <span class="nl">font-weight</span><span class="p">:</span> <span class="m">400</span><span class="p">;</span>
    <span class="nl">line-height</span><span class="p">:</span> <span class="m">1.5</span><span class="p">;</span>
    <span class="nl">color</span><span class="p">:</span> <span class="m">#212529</span><span class="p">;</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="m">#fff</span><span class="p">;</span>
    <span class="nl">background-clip</span><span class="p">:</span> <span class="n">padding-box</span><span class="p">;</span>
    <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#ced4da</span><span class="p">;</span>
    <span class="nl">border-radius</span><span class="p">:</span> <span class="m">0.375rem</span><span class="p">;</span>
    <span class="nl">transition</span><span class="p">:</span> <span class="n">border-color</span> <span class="m">.15s</span> <span class="n">ease-in-out</span><span class="p">,</span> <span class="n">box-shadow</span> <span class="m">.15s</span> <span class="n">ease-in-out</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nf">#post</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s1">"submit"</span><span class="o">]</span> <span class="p">{</span>
    <span class="nl">flex</span><span class="p">:</span> <span class="m">0</span> <span class="m">0</span> <span class="nb">auto</span> <span class="cp">!important</span><span class="p">;</span>
    <span class="c">/* Bootstrap .btn + .btn-primary styles */</span>
    <span class="nl">display</span><span class="p">:</span> <span class="n">inline-block</span><span class="p">;</span>
    <span class="nl">font-weight</span><span class="p">:</span> <span class="m">400</span><span class="p">;</span>
    <span class="nl">color</span><span class="p">:</span> <span class="m">#fff</span><span class="p">;</span>
    <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
    <span class="nl">vertical-align</span><span class="p">:</span> <span class="nb">middle</span><span class="p">;</span>
    <span class="py">user-select</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="m">#0d6efd</span><span class="p">;</span>
    <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#0d6efd</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">0.375rem</span> <span class="m">0.75rem</span><span class="p">;</span>
    <span class="nl">font-size</span><span class="p">:</span> <span class="m">1rem</span><span class="p">;</span>
    <span class="nl">line-height</span><span class="p">:</span> <span class="m">1.5</span><span class="p">;</span>
    <span class="nl">border-radius</span><span class="p">:</span> <span class="m">0.375rem</span><span class="p">;</span>
    <span class="nl">transition</span><span class="p">:</span> <span class="n">color</span> <span class="m">.15s</span> <span class="n">ease-in-out</span><span class="p">,</span> <span class="n">background-color</span> <span class="m">.15s</span> <span class="n">ease-in-out</span><span class="p">,</span>
                <span class="n">border-color</span> <span class="m">.15s</span> <span class="n">ease-in-out</span><span class="p">,</span> <span class="n">box-shadow</span> <span class="m">.15s</span> <span class="n">ease-in-out</span><span class="p">;</span>
    <span class="nl">cursor</span><span class="p">:</span> <span class="nb">pointer</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">form</span><span class="nf">#post</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s1">"submit"</span><span class="o">]</span><span class="nd">:hover</span> <span class="p">{</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="m">#0b5ed7</span><span class="p">;</span>
    <span class="nl">border-color</span><span class="p">:</span> <span class="m">#0a58ca</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* Post container styling */</span>
<span class="nc">.post</span> <span class="p">{</span>
    <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>                <span class="c">/* Makes the whole card clickable */</span>
    <span class="nl">text-decoration</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>         <span class="c">/* Remove underline from link */</span>
    <span class="nl">color</span><span class="p">:</span> <span class="nb">inherit</span><span class="p">;</span>                <span class="c">/* Use normal text color */</span>
    <span class="nl">background</span><span class="p">:</span> <span class="m">#fff</span><span class="p">;</span>              <span class="c">/* White card background */</span>
    <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#dee2e6</span><span class="p">;</span>     <span class="c">/* Subtle border */</span>
    <span class="nl">border-radius</span><span class="p">:</span> <span class="m">0.5rem</span><span class="p">;</span>         <span class="c">/* Rounded corners */</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">1rem</span><span class="p">;</span>                 <span class="c">/* Inner spacing */</span>
    <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">1rem</span><span class="p">;</span>           <span class="c">/* Space between posts */</span>
    <span class="nl">transition</span><span class="p">:</span> <span class="n">box-shadow</span> <span class="m">0.2s</span> <span class="n">ease</span><span class="p">,</span> <span class="n">transform</span> <span class="m">0.1s</span> <span class="n">ease</span><span class="p">;</span>
    <span class="nl">cursor</span><span class="p">:</span> <span class="nb">pointer</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* Hover/active effect */</span>
<span class="nc">.post</span><span class="nd">:hover</span> <span class="p">{</span>
    <span class="nl">box-shadow</span><span class="p">:</span> <span class="m">0</span> <span class="m">4px</span> <span class="m">12px</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0.08</span><span class="p">);</span>
    <span class="nl">transform</span><span class="p">:</span> <span class="n">translateY</span><span class="p">(</span><span class="m">-2px</span><span class="p">);</span>
    <span class="nl">text-decoration</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>   <span class="c">/* still no underline on hover */</span>
<span class="p">}</span>

<span class="c">/* Post title/content */</span>
<span class="nc">.post-title</span> <span class="p">{</span>
    <span class="nl">font-weight</span><span class="p">:</span> <span class="m">600</span><span class="p">;</span>
    <span class="nl">font-size</span><span class="p">:</span> <span class="m">1.1rem</span><span class="p">;</span>
    <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">0.25rem</span><span class="p">;</span>
    <span class="nl">color</span><span class="p">:</span> <span class="m">#0d6efd</span><span class="p">;</span>  <span class="c">/* bootstrap primary link color */</span>
<span class="p">}</span>

<span class="c">/* Post meta info */</span>
<span class="nc">.post-meta</span> <span class="p">{</span>
    <span class="nl">font-size</span><span class="p">:</span> <span class="m">0.875rem</span><span class="p">;</span>
    <span class="nl">color</span><span class="p">:</span> <span class="m">#6c757d</span><span class="p">;</span>  <span class="c">/* muted gray */</span>
    <span class="nl">margin-top</span><span class="p">:</span> <span class="m">0.5rem</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="conclusion">Conclusion</h3>

<p>Phew! That was another big one, but the good news is that most of the key pieces of building an application with <code class="language-plaintext highlighter-rouge">Ningle</code> and <code class="language-plaintext highlighter-rouge">Mito</code> are in place, next month we will look at tidying up our project. We are far from done with this tutorial series though, as we will still need to look at hosting our applications, testing, and developing good practices.</p>

<p>Thank you for following this tutorial series, I hope you are finding it as interesting/helpful to read as I am finding it interesting/helpful to write.</p>

<h3 id="learning-outcomes">Learning Outcomes</h3>

<table>
  <thead>
    <tr>
      <th>Level</th>
      <th>Learning Outcome</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Remember</strong></td>
      <td>Define the purpose of post and likes models in Ningle. Recall the role of SXQL in generating SQL queries.</td>
    </tr>
    <tr>
      <td><strong>Understand</strong></td>
      <td>Explain how toggle-like manages user interactions with posts. Describe how requirements (e.g., :logged-in-p) simplify route definitions. Interpret SQL queries that use JOIN and GROUP BY to aggregate like counts. Summarize how SXQL represents SQL constructs such as LEFT JOIN, COUNT, and AS. Explain why COUNT(user_likes.id) can be used to represent a boolean "liked by user" column.</td>
    </tr>
    <tr>
      <td><strong>Apply</strong></td>
      <td>Use cl-forms to create a validated post submission form with CSRF protection. Implement not-logged-in-posts and logged-in-posts to retrieve posts with like counts.</td>
    </tr>
    <tr>
      <td><strong>Analyse</strong></td>
      <td>Compare the differences between raw SQL and SXQL representations for joins and counts. Distinguish between logged-in and non-logged-in query results.</td>
    </tr>
  </tbody>
</table>

<h2 id="github">Github</h2>

<ul>
  <li>The link for this tutorials code is available <a href="https://github.com/nmunro/ningle-tutorial-project/releases/tag/tutorial-11">here</a>.</li>
</ul>

<h2 id="resources">Resources</h2>

<h3 id="common-lisp-hyperspec">Common Lisp HyperSpec</h3>

<ul>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_defpkg.htm">defpackage</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_in_pkg.htm">in-package</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_defvar.htm">defvar</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_defpar.htm">defparameter</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_defun.htm">defun</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_defgen.htm">defgeneric</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_defmet.htm">defmethod</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/s_fn.htm">lambda</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_setf.htm">setf</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/s_let_l.htm">let</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/s_let_l.htm">let*</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/s_if.htm">if</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_when.htm">when</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_unless.htm">unless</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_not.htm">not</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/a_and.htm">and</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/a_or.htm">or</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eq.htm">eq</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_equal.htm">equal</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_format.htm">format</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_multip.htm">multiple-value-bind</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_slotva.htm">slot-value</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_symb_2.htm">find-symbol</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_stg_up.htm">string-upcase</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_symb_1.htm">symbol-name</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_firstc.htm">first</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_list.htm">list</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_error.htm">error</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_handle.htm">handler-case</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_parse_.htm">parse-integer</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_mk_has.htm">make-hash-table</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_gethas.htm">gethash</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_dolist.htm">dolist</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/d_ignore.htm">ignore</a></li>
  <li><a href="http://www.lispworks.com/documentation/HyperSpec/Body/s_declar.htm">declare</a></li>
</ul>