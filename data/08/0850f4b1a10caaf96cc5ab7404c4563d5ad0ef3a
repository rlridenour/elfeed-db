
	
<p>
Euler Problem 14 looks at the Collatz Conjecture. These playful sequences, named after German mathematician Lothar Collatz (1910–1990), cause mathematicians a lot of headaches. What is most interesting about this problem is how a simple set of rules can create intricate complexity.</p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
Project Euler 14 Definition
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>The following iterative sequence is defined for the set of positive integers:</p>
<p>
$f(n) = \begin{cases} \frac{n}{2} &amp;\text{if } n \equiv 0 \pmod{2}\\[4px] 3n+1 &amp; \text{if } n\equiv 1 \pmod{2} .\end{cases}$</p>
<p>
Using the rule above, and starting with 13, we generate the following sequence:</p>
<p>
$$13 \rightarrow 40 \rightarrow 20 \rightarrow 10 \rightarrow 5 \rightarrow 16 \rightarrow 8 \rightarrow 4 \rightarrow 2 \rightarrow 1 $$</p>
<p>
It can be seen that this sequence (starting at 13 and finishing at 1) contains 10 terms. Although it has not been proved yet (Collatz Problem), it is thought that all starting numbers finish at 1.</p>
<p>
Which starting number, under one million, produces <a href="https://projecteuler.net/problem=14">the longest chain</a>?</p>
<p>
NOTE: Once the chain starts, the terms are allowed to go above one million.</p>
<figure>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/5mFpVDpKX70?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"></iframe>
    </div>

<figcaption>
Uncrackable? The Collatz Conjecture - Numberphile.
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
Proposed solutions
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>This problem is highly computationally intensive, and it highlights R&#39;s lack of speed. Generating one million Collatz sequences and finding the longest one requires a lot more than a minute of processing time allowed for in Project Euler.</p>
<p>
<a href = "https://github.com/pprevos/ProjectEuler/" target="_blank"
   title="Download ProjectEuler from GitHub"
   alt="Download ProjectEuler from GitHub">
  <button class="button is-medium is-primary">
    <span class="icon is-large">
      <i class="fab fa-github"></i>
    </span>
    <span style="font-family: monospace">ProjectEuler</span>
  </button>
</a>

</p>
<div id="outline-container-headline-3" class="outline-3">
<h3 id="headline-3">
Brute Force
</h3>
<div id="outline-text-headline-3" class="outline-text-3">
<p>The brute force solution tests every answer and takes a long time to run.</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#888">## Project Euler 14: Longest Collatz Sequence</span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">## Brute Force</span>
</span></span><span style="display:flex;"><span>  collatz.chain <span style="color:#333">&lt;-</span> <span style="color:#080;font-weight:bold">function</span>(n) {
</span></span><span style="display:flex;"><span>      chain <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">vector</span>()
</span></span><span style="display:flex;"><span>      i <span style="color:#333">&lt;-</span> <span style="color:#60e;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#080;font-weight:bold">while</span> (n <span style="color:#333">!=</span> <span style="color:#60e;font-weight:bold">1</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#080;font-weight:bold">if</span> (n<span style="color:#333">%%</span><span style="color:#60e;font-weight:bold">2</span> <span style="color:#333">==</span> <span style="color:#60e;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>              n <span style="color:#333">&lt;-</span> n <span style="color:#333">/</span> <span style="color:#60e;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>          <span style="color:#080;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>          n <span style="color:#333">&lt;-</span> <span style="color:#60e;font-weight:bold">3</span> <span style="color:#333">*</span> n <span style="color:#333">+</span> <span style="color:#60e;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>          chain[i] <span style="color:#333">&lt;-</span> n
</span></span><span style="display:flex;"><span>          i <span style="color:#333">&lt;-</span> i <span style="color:#333">+</span> <span style="color:#60e;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#080;font-weight:bold">return</span>(chain)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  answer <span style="color:#333">&lt;-</span> <span style="color:#60e;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>  collatz.max <span style="color:#333">&lt;-</span> <span style="color:#60e;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-weight:bold">for</span> (n <span style="color:#080;font-weight:bold">in</span> <span style="color:#60e;font-weight:bold">1</span><span style="color:#333">:</span><span style="color:#60e;font-weight:bold">1E6</span>) {
</span></span><span style="display:flex;"><span>      collatz.length <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">length</span>(<span style="color:#06b;font-weight:bold">collatz.chain</span>(n))
</span></span><span style="display:flex;"><span>      <span style="color:#080;font-weight:bold">if</span> (collatz.length <span style="color:#333">&gt;</span> collatz.max) {
</span></span><span style="display:flex;"><span>          answer <span style="color:#333">&lt;-</span> n
</span></span><span style="display:flex;"><span>          collatz.max <span style="color:#333">&lt;-</span> collatz.length
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">print</span>(answer)</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-4" class="outline-3">
<h3 id="headline-4">
Optimised solution
</h3>
<div id="outline-text-headline-4" class="outline-text-3">
<p>The optimised version of the code stores the length of all sequences in an array. When the code generates a sequence and lands on a number already analysed, then it adds that previous number to the current one and moves on to the next step. This approach requires more memory but saves a lot of computation time. A minor tweak to the code optimises the rule for uneven numbers. Tripling an uneven number and adding one will always result in an even number so we can skip one step. This solution is more than twice as fast as the first version.</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#888">## Optimised method</span>
</span></span><span style="display:flex;"><span>  collatz.length <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">vector</span>(length <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">1E6</span>)
</span></span><span style="display:flex;"><span>  collatz.length[1] <span style="color:#333">&lt;-</span> <span style="color:#60e;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-weight:bold">for</span> (n <span style="color:#080;font-weight:bold">in</span> <span style="color:#60e;font-weight:bold">2</span><span style="color:#333">:</span><span style="color:#60e;font-weight:bold">1E6</span>) {
</span></span><span style="display:flex;"><span>      x <span style="color:#333">&lt;-</span> n
</span></span><span style="display:flex;"><span>      count <span style="color:#333">&lt;-</span> <span style="color:#60e;font-weight:bold">0</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#080;font-weight:bold">while</span> (x <span style="color:#333">!=</span> <span style="color:#60e;font-weight:bold">1</span> <span style="color:#333">&amp;</span> x <span style="color:#333">&gt;=</span> n) {
</span></span><span style="display:flex;"><span>          <span style="color:#080;font-weight:bold">if</span> (x <span style="color:#333">%%</span> <span style="color:#60e;font-weight:bold">2</span> <span style="color:#333">==</span> <span style="color:#60e;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>              x <span style="color:#333">&lt;-</span> x <span style="color:#333">/</span> <span style="color:#60e;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>              count <span style="color:#333">&lt;-</span> count <span style="color:#333">+</span> <span style="color:#60e;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#080;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>              x <span style="color:#333">&lt;-</span> (<span style="color:#60e;font-weight:bold">3</span> <span style="color:#333">*</span> x <span style="color:#333">+</span> <span style="color:#60e;font-weight:bold">1</span>) <span style="color:#333">/</span> <span style="color:#60e;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>              count <span style="color:#333">&lt;-</span> count <span style="color:#333">+</span> <span style="color:#60e;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      count <span style="color:#333">&lt;-</span> count <span style="color:#333">+</span> collatz.length[x]
</span></span><span style="display:flex;"><span>      collatz.length[n] <span style="color:#333">&lt;-</span> count
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  answer <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">which.max</span>(collatz.length)
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">print</span>(answer)</span></span></code></pre></div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-5" class="outline-2">
<h2 id="headline-5">
Visualising Collatz Sequences
</h2>
<div id="outline-text-headline-5" class="outline-text-2">
<p>The Collatz sequence is an example of a simple mathematical rule that can create an unpredictable pattern. The number of steps required to reach one is listed in <a href="https://oeis.org/A006577">sequence A006577</a> of the Online Encyclopedia of Integer Sequences. The image below visualises the number of steps for the first 1000 positive numbers. The scatterplot shows some unusual patterns. Does this visualisation show that the Collatz Sequence does have a pattern after all?</p>
<figure>
<img src="https://lucidmanager.org/images/project-euler/problem-014a.png" alt="Number of steps to terminate a Collatz sequence." title="Number of steps to terminate a Collatz sequence."/>
<figcaption>
Number of steps to terminate a Collatz sequence.
</figcaption>
</figure>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#888">## Visualise</span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">library</span>(ggplot2)
</span></span><span style="display:flex;"><span>  collatz <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">data.frame</span>(n <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">1</span><span style="color:#333">:</span><span style="color:#60e;font-weight:bold">10000</span>,
</span></span><span style="display:flex;"><span>                        steps <span style="color:#333">=</span> collatz.length[1<span style="color:#333">:</span><span style="color:#60e;font-weight:bold">10000</span>])
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">ggplot</span>(collatz, <span style="color:#06b;font-weight:bold">aes</span>(n, steps)) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">geom_point</span>(size <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">.5</span>, col <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;darkblue&#34;</span>) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">theme_minimal</span>(base_size <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">10</span>) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">labs</span>(title <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;Collatz Sequence&#34;</span>,
</span></span><span style="display:flex;"><span>         subtitle <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;Number of steps to reach 1&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">ggsave</span>(<span style="background-color:#fff0f0">&#34;../../../../static/images/project-euler/problem-014a.png&#34;</span>, width <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">6</span>, height <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">4</span>)</span></span></code></pre></div>
</div>
<div id="outline-container-headline-6" class="outline-3">
<h3 id="headline-6">
Collatz Chains
</h3>
<div id="outline-text-headline-6" class="outline-text-3">
<p>The Collatz sequences can also be visualised using networks. Each step between two numbers is an edge, and the numbers are the vertices. For example, the network for the Collatz sequence for number 10 is 5–16, 16–8, 8–4, 4–2, 2–1. When generating subsequent sequences, the network will start to overlap, and a tree of sequences appears. The tree below combines the Collatz sequences for the numbers 2 to 26. Number 27 has a very long sequence, making the tree much harder to read. The code to create this network uses the <em>igraph</em> package. The edge list is a data frame where each row indicates a connected set of numbers.</p>
<figure>
<img src="https://lucidmanager.org/images/project-euler/problem-014b.png" alt="Collatz network 1-26." title="Collatz netork 1-26"/>
<figcaption>
Collatz network \((n \leq 26)\).
</figcaption>
</figure>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#888">## Collatz Chains</span>
</span></span><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">library</span>(igraph)
</span></span><span style="display:flex;"><span>edgelist <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">data.frame</span>(a <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">2</span>, b <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">for</span> (n <span style="color:#080;font-weight:bold">in</span> <span style="color:#60e;font-weight:bold">3</span><span style="color:#333">:</span><span style="color:#60e;font-weight:bold">26</span>) {
</span></span><span style="display:flex;"><span>   chain <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">as.character</span>(<span style="color:#06b;font-weight:bold">c</span>(n, <span style="color:#06b;font-weight:bold">collatz.chain</span>(n)))
</span></span><span style="display:flex;"><span>   chain <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">data.frame</span>(a <span style="color:#333">=</span> chain[<span style="color:#333">-</span><span style="color:#06b;font-weight:bold">length</span>(chain)], b <span style="color:#333">=</span> chain[<span style="color:#60e;font-weight:bold">-1</span>])
</span></span><span style="display:flex;"><span>   edgelist <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">rbind</span>(edgelist, chain)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>g <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">graph.edgelist</span>(<span style="color:#06b;font-weight:bold">as.matrix</span>(edgelist))
</span></span><span style="display:flex;"><span>g <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">simplify</span>(g)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">png</span>(<span style="background-color:#fff0f0">&#34;../../../../static/images/project-euler/problem-014b.png&#34;</span>, 
</span></span><span style="display:flex;"><span>    width <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">1024</span>, height <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">768</span>)
</span></span><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">par</span>(mar <span style="color:#333">=</span> <span style="color:#06b;font-weight:bold">rep</span>(<span style="color:#60e;font-weight:bold">0</span>,<span style="color:#60e;font-weight:bold">4</span>))
</span></span><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">V</span>(g)<span style="color:#333">$</span>color <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">degree</span>(g, mode <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;out&#34;</span>) <span style="color:#333">==</span> <span style="color:#60e;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">plot</span>(g,
</span></span><span style="display:flex;"><span>     layout <span style="color:#333">=</span> layout.auto,
</span></span><span style="display:flex;"><span>     vertex.color <span style="color:#333">=</span> <span style="color:#06b;font-weight:bold">V</span>(g)<span style="color:#333">$</span>color,
</span></span><span style="display:flex;"><span>     vertex.frame.color <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">NA</span>,
</span></span><span style="display:flex;"><span>     frame.color <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;white&#34;</span>,
</span></span><span style="display:flex;"><span>     vertex.size <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">6</span>,
</span></span><span style="display:flex;"><span>     vertex.label.cex <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">1.5</span>,
</span></span><span style="display:flex;"><span>     vertex.label.color <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;black&#34;</span>,
</span></span><span style="display:flex;"><span>     edge.arrow.size <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">0.2</span>,
</span></span><span style="display:flex;"><span>     edge.color <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;grey&#34;</span>
</span></span><span style="display:flex;"><span>     )
</span></span><span style="display:flex;"><span> <span style="color:#06b;font-weight:bold">dev.off</span>()</span></span></code></pre></div>
</div>
<p>
<a href = "https://www.r-bloggers.com/" target="_blank" title="Proudly associated with R-Bloggers">
  <button class="button is-link is-medium">
    <span class="icon is-large">
      <i class="fab fa-r-project"></i>
    </span>
    <span>As seen on R Bloggers</span>
  </button>
</a>
</p>
</div>
</div>
</div>
</div>

      