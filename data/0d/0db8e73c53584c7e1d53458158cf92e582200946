
	
<p>
Percentile calculations can be more tricky than at first meets the eye. A <a href="https://en.wikipedia.org/wiki/Percentile">percentile</a> indicates the value below which a percentage of observations fall. Some percentiles have special names, such as the <a href="https://en.wikipedia.org/wiki/Quartile">quartile</a> or the <a href="https://en.wikipedia.org/wiki/Decile">decile</a>, both of which are <a href="https://en.wikipedia.org/wiki/Quantile">quantiles</a>. This deceivingly simple definition hides the various ways to determine this number. Unfortunately, there is <a href="https://www.amherst.edu/media/view/129116/original/Sample+Quantiles.pdf">no standard definition for percentiles</a>, so which method do you use? </p>
<p>
The <a href="https://stat.ethz.ch/R-manual/R-devel/library/stats/html/quantile.html">quantile</a> function in R generates sample percentiles corresponding to the given probabilities. By default, the quantile function provides the quartiles and the minimum and maximum values. The code snippet below creates semi-random data, plots the histogram and visualises the third quartile.</p>
<p>
The code for this page is available on GitHub in <code class="verbatim">case-studies/percentiles.R</code>.</p>
<p>
<a href = "https://github.com/pprevos/r4h2o/" target="_blank"
   title="Download r4h2o from GitHub"
   alt="Download r4h2o from GitHub">
  <button class="button is-medium is-primary">
    <span class="icon is-large">
      <i class="fab fa-github"></i>
    </span>
    <span style="font-family: monospace">r4h2o</span>
  </button>
</a>

</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#888">## Percentile calculations</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">## Example</span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">set.seed</span>(<span style="color:#60e;font-weight:bold">1969</span>)
</span></span><span style="display:flex;"><span>  test.data <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">rnorm</span>(n <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">10000</span>, mean <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">100</span>, sd <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">15</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">library</span>(ggplot2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">ggplot</span>(<span style="color:#06b;font-weight:bold">as.data.frame</span>(test.data), <span style="color:#06b;font-weight:bold">aes</span>(test.data)) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">geom_histogram</span>(binwidth <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">1</span>, <span style="color:#06b;font-weight:bold">aes</span>(y <span style="color:#333">=</span> ..density..), fill <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;dodgerblue&#34;</span>) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">geom_line</span>(stat <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;function&#34;</span>, fun <span style="color:#333">=</span> dnorm, args <span style="color:#333">=</span> <span style="color:#06b;font-weight:bold">list</span>(mean <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">100</span>, sd <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">15</span>), colour <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;red&#34;</span>, size <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">1</span>) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">geom_area</span>(stat <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;function&#34;</span>, fun <span style="color:#333">=</span> dnorm, args <span style="color:#333">=</span> <span style="color:#06b;font-weight:bold">list</span>(mean <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">100</span>, sd <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">15</span>),
</span></span><span style="display:flex;"><span>              colour <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;red&#34;</span>, fill <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;red&#34;</span>, alpha <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">0.5</span>, xlim <span style="color:#333">=</span> <span style="color:#06b;font-weight:bold">quantile</span>(test.data, <span style="color:#06b;font-weight:bold">c</span>(<span style="color:#60e;font-weight:bold">0.5</span>, <span style="color:#60e;font-weight:bold">0.75</span>))) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">theme_bw</span>(base_size <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">8</span>)</span></span></code></pre></div>
</div>
<figure>
<img src="https://lucidmanager.org/images/hydroinformatics/percentile-example.png" alt="Percentile Calculations example" title="Percentile Calculations example" width="50%"/>
<figcaption>
Percentile Calculations example.
</figcaption>
</figure>
<p>
The quantile function with default settings and the 95<sup>th</sup> percentile give the following results:</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">quantile</span>(test.data)</span></span></code></pre></div>
</div>
<pre class="example">
       0%       25%       50%       75%      100% 
 39.91964  89.68041 100.16437 110.01910 153.50195
</pre>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">quantile</span>(test.data, probs <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">0.95</span>)</span></span></code></pre></div>
</div>
<pre class="example">
     95% 
124.7775
</pre>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
Methods of percentile calculation
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>The quantile function in R provides nine different ways to calculate percentiles. Each of these options uses another method to interpolate between observed values. I will not discuss the mathematical nuances between these methods. <a href="https://www.amherst.edu/media/view/129116/original/Sample+Quantiles.pdf">Hyndman and Fan</a> (1996) provides a detailed discussion of these methods.</p>
<p>
The differences between the nine available methods only matter in highly skewed distributions, such as water quality data. All methods provide the same outcome for the normal distribution simulated above, as illustrated by the following code.</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">sapply</span>(<span style="color:#60e;font-weight:bold">1</span><span style="color:#333">:</span><span style="color:#60e;font-weight:bold">9</span>, <span style="color:#080;font-weight:bold">function</span>(m) <span style="color:#06b;font-weight:bold">quantile</span>(test.data, <span style="color:#60e;font-weight:bold">0.95</span>, type <span style="color:#333">=</span> m))</span></span></code></pre></div>
</div>
<pre class="example">
     95%      95%      95%      95%      95%      95%      95% 
124.7775 124.7775 124.7775 124.7775 124.7775 124.7775 124.7775 
     95%      95% 
124.7775 124.7775
</pre>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
Percentile calculations in water quality
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>The <a href="https://nhmrc.gov.au/about-us/publications/australian-drinking-water-guidelines">Australian Drinking Water Quality Guidelines</a> (November 2016) specify that: &#34;based on aesthetic considerations, the turbidity should not exceed 5 NTU at the consumer&#39;s tap&#34;. The Victorian Safe Drinking Water Regulations(2015) relax this requirement and require that:</p>
<blockquote>
<p>The 95<sup>th</sup> percentile of results for samples in any 12 months must be less than or equal to 5.0 NTU.</p>
</blockquote>
<p>
The Victorian water quality regulator <a href="https://www2.health.vic.gov.au/Api/downloadmedia/%7BA1F6D255-D5C7-4B7E-AAE5-8B7451EDE81A%7D">also specifies</a> that the percentile should be calculated with the <em>Weibull Method</em>. This requirement raises two questions: What is the Weibull method? How do you implement this requirement in R? </p>
<p>
The term Weibull Method is confusing as this is not a name generally used by statisticians. In Hyndman &amp; Fan (1996), this method has the less poetic name $\hat{Q}_8(p)$. The Victorian water quality regulator references <a href="http://amzn.to/2k8shr8">McBride (2005)</a>, who calls it the Weibull method. <a href="https://en.wikipedia.org/wiki/Waloddi_Weibull">Waloddi Weibull</a>, a Swedish engineer famous for his distribution, was one of the first to describe this method.</p>
<p>
This theoretical interlude aside, how can we practically apply this to water quality data?</p>
<p>
If you are interested in how the Weibull method works, the <code class="verbatim">weibull.quantile()</code> function below calculates a quantile <em>p</em> for a vector <em>x</em> using this method. This function gives the same result as <code class="verbatim">quantile(x, p, type = 6)</code>.</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#888">## Weibull method</span>
</span></span><span style="display:flex;"><span>  weibull.quantile <span style="color:#333">&lt;-</span> <span style="color:#080;font-weight:bold">function</span>(x, p) {
</span></span><span style="display:flex;"><span>    <span style="color:#888"># Order Samples from large to small</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#333">&lt;-</span> x<span style="color:#06b;font-weight:bold">[order</span>(x, decreasing <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">FALSE</span>)]
</span></span><span style="display:flex;"><span>    <span style="color:#888"># Determine the ranking of percentile according to Weibull (1939)</span>
</span></span><span style="display:flex;"><span>    r <span style="color:#333">&lt;-</span> p <span style="color:#333">*</span> (<span style="color:#06b;font-weight:bold">length</span>(x) <span style="color:#333">+</span> <span style="color:#60e;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#888"># Linear interpolation</span>
</span></span><span style="display:flex;"><span>    rfrac <span style="color:#333">&lt;-</span> (r <span style="color:#333">-</span> <span style="color:#06b;font-weight:bold">floor</span>(r))
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">return</span>((<span style="color:#60e;font-weight:bold">1</span> <span style="color:#333">-</span> rfrac) <span style="color:#333">*</span> x<span style="color:#06b;font-weight:bold">[floor</span>(r)] <span style="color:#333">+</span> rfrac <span style="color:#333">*</span> x<span style="color:#06b;font-weight:bold">[floor</span>(r) <span style="color:#333">+</span> <span style="color:#60e;font-weight:bold">1</span>])
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">weibull.quantile</span>(test.data, <span style="color:#60e;font-weight:bold">0.95</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">quantile</span>(test.data, <span style="color:#60e;font-weight:bold">0.95</span>, type <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">6</span>)</span></span></code></pre></div>
</div>
<pre class="example">
124.777545386916
</pre>
<div id="outline-container-headline-3" class="outline-3">
<h3 id="headline-3">
Turbidity Data Example
</h3>
<div id="outline-text-headline-3" class="outline-text-3">
<p>Turbidity data is not normally distributed as it is always greater than zero. In this example, we use simulated data from a fictional water system called Gormsey. This data is also used in book <a href="https://lucidmanager.org/tags/r4h2o/">Data Science for Water Utilities.</a></p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#888">## Visualise Data</span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">library</span>(tidyverse)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  gormsey <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">read_csv</span>(<span style="background-color:#fff0f0">&#34;~/Documents/projects/r4h2o/data/water_quality.csv&#34;</span>)
</span></span><span style="display:flex;"><span>  turbidity <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">filter</span>(gormsey, Measure <span style="color:#333">==</span> <span style="background-color:#fff0f0">&#34;Turbidity&#34;</span> <span style="color:#333">&amp;</span>
</span></span><span style="display:flex;"><span>                               Suburb <span style="color:#333">%in%</span> <span style="color:#06b;font-weight:bold">c</span>(<span style="background-color:#fff0f0">&#34;Blancathey&#34;</span>, <span style="background-color:#fff0f0">&#34;Tarnstead&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">ggplot</span>(turbidity, <span style="color:#06b;font-weight:bold">aes</span>(Result)) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">geom_density</span>(fill <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;dodgerblue&#34;</span>, <span style="color:#06b;font-weight:bold">aes</span>(y <span style="color:#333">=</span> ..density..)) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">scale_x_continuous</span>(trans <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;log10&#34;</span>) <span style="color:#333">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">facet_wrap</span>(<span style="color:#333">~</span>Suburb) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">theme_bw</span>() <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">labs</span>(title <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;Turbidity Distribution&#34;</span>,
</span></span><span style="display:flex;"><span>         x<span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;log Results&#34;</span>)</span></span></code></pre></div>
</div>
<figure>
<img src="https://lucidmanager.org/images/hydroinformatics/gormsey-turbidity.png" alt="Turbidity at customer tap" title="Turbidity at customer tap" width="70%"/>
<figcaption>
Turbidity at customer tap in two towns in the fictional country of Gormsey.
</figcaption>
</figure>
<p>
When we calculate the percentiles for all nine methods available in the base-R function, we see that the Weibull method generally provides the most conservative result for heavily skewed data.</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#888"># Calculate all percentile methods</span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">tapply</span>(turbidity<span style="color:#333">$</span>Result, turbidity<span style="color:#333">$</span>Suburb,
</span></span><span style="display:flex;"><span>         <span style="color:#080;font-weight:bold">function</span>(x) <span style="color:#06b;font-weight:bold">sapply</span>(<span style="color:#60e;font-weight:bold">1</span><span style="color:#333">:</span><span style="color:#60e;font-weight:bold">9</span>, <span style="color:#080;font-weight:bold">function</span>(m) <span style="color:#06b;font-weight:bold">quantile</span>(x, <span style="color:#60e;font-weight:bold">0.95</span>, type <span style="color:#333">=</span> m)))</span></span></code></pre></div>
</div>
<pre class="example">
$Blancathey
   95%    95%    95%    95%    95%    95%    95%    95%    95% 
6.0200 6.0200 6.0200 5.8820 6.2720 6.6500 5.9165 6.3980 6.3665 

$Tarnstead
     95%      95%      95%      95%      95%      95%      95% 
4.480000 4.480000 4.480000 4.432500 4.607500 4.837000 4.442000 
     95%      95% 
4.684000 4.664875
</pre>
<p>
<a href="https://lucidmanager.org/data-science/descriptive-statistics-in-water-quality/">Chapter 4</a> of my book <em>Data Science for Water Utilities</em> discusses calculating descriptive statistics with R</p>
<p>

  <div class="box">
    <div class="media">
      <figure class="media-left">
        <p class="image is-128x128">
          <img src="https://lucidmanager.org/images/books/2023_ds4wu.jpg" alt = "Data Science for Water Utilities" title = "Data Science for Water Utilities">
        </p>
      </figure>
      <div class="media-content">
        <div class="content">
          <p class="is-size-5 has-text-weight-bold">Data Science for Water Utilities</p>
          <p class="mb-2">Data Science for Water Utilities published by CRC Press is an applied, practical guide that shows water professionals how to use data science to solve urban water management problems using the R language for statistical computing.</p>
          <div class="buttons">
            <a class="button is-info" href="https://routledge.com/9781032354545" target="_blank">
              <span class="icon">
                <i class="fas fa-shopping-cart"></i>
              </span>
              <span>Routledge</span>
            </a>
            <a class="button is-info" href="https://www.amazon.com/Data-Science-Water-Utilities-Chapman/dp/1032354550" target="_blank">
              <span class="icon">
                <i class="fas fa-shopping-cart"></i>
              </span>
              <span>Amazon</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</p>
<p>
<a href = "https://www.r-bloggers.com/" target="_blank" title="Proudly associated with R-Bloggers">
  <button class="button is-link is-medium">
    <span class="icon is-large">
      <i class="fab fa-r-project"></i>
    </span>
    <span>As seen on R Bloggers</span>
  </button>
</a>
</p>
</div>
</div>
</div>
</div>

      