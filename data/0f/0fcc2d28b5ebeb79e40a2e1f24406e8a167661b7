
	
<p>
The Enron scandal is one of the most famous corporate governance failures in the history of capitalism. The case itself is interesting for its own sake, but in this post, I am more interested in one of the data sets that the subsequent investigation has provided. The code below show s how to analyse the Enron corpus using the R language.</p>
<p>
This blog post analyses an extensive collection of e-mails from former Enron employees. The Enron corpus is analysed using network analysis tools provided by the <a href="https://igraph.org/r/">iGraph package</a>. Network analysis is a versatile technique that can be used to add value to a lot of different data sets, including the complex corporate relationships of <a href="https://lucidmanager.org/data-science/trumpworld-analysis/">Donald Trump</a>.</p>
<figure>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/jrEf8uabe7E?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"></iframe>
    </div>

<figcaption>
The Enron Scandal Explained in One Minute
</figcaption>
</figure>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
The Enron Corpus
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>The Federal Energy Regulatory Commission used an extensive collection of emails from Enron employees as part of their inquiries. The Enron corpus is one of the only publicly available collections of emails available for research. This dataset also provides a fascinating playground for citizen data scientists.</p>
<p>
The set has privacy issues as it contains messages from living people. When analysing this data set, we need to keep in mind that the majority of former Enron employees were innocent people who lost their jobs due to the greed of their overlords. The code in this post only analyses the e-mail headers, ignoring the content.</p>
<figure>
<img src="https://fm.cnbc.com/applications/cnbc.com/resources/img/editorial/2014/10/13/102082546-675237.530x298.jpg" alt="Laid-off Enron employees outside Enron headquarters as the company collapsed in 2001" title="Laid-off Enron employees outside Enron headquarters as the company collapsed in 2001"/>
<figcaption>
Laid-off Enron employees outside Enron headquarters as the company collapsed in 2001 (Source cnbc.com).
</figcaption>
</figure>
<p>
The Enron Corpus is an extensive database of half a million emails generated by more than 100 Enron employees. You can download the corpus from the <a href="https://www.cs.cmu.edu/~./enron/">Carnegie Mellon School of Computer Science</a>. The first code snippet downloads the 7 May 2015 version of the dataset (about 423Mb, tarred and gzipped) and untars it to your working directory. </p>
<p>
<a href = "https://github.com/pprevos/digital-humanities/" target="_blank"
   title="Download digital-humanities from GitHub"
   alt="Download digital-humanities from GitHub">
  <button class="button is-medium is-primary">
    <span class="icon is-large">
      <i class="fab fa-github"></i>
    </span>
    <span style="font-family: monospace">digital-humanities</span>
  </button>
</a>

</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#080;font-weight:bold">if</span> (<span style="color:#333">!</span><span style="color:#06b;font-weight:bold">file.exists</span>(<span style="background-color:#fff0f0">&#34;enron_mail_20150507.tgz&#34;</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#06b;font-weight:bold">download.file</span>(<span style="background-color:#fff0f0">&#34;https://www.cs.cmu.edu/~./enron/enron_mail_20150507.tar.gz&#34;</span>,
</span></span><span style="display:flex;"><span>                     destfile <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;enron-mail-20150507.tgz&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-weight:bold">if</span> (<span style="color:#06b;font-weight:bold">file.exists</span>(<span style="background-color:#fff0f0">&#34;enron-mail-20150507.tgz&#34;</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#06b;font-weight:bold">untar</span>(<span style="background-color:#fff0f0">&#34;enron-mail-20150507.tgz&#34;</span>)
</span></span><span style="display:flex;"><span>  }</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
Preparing the Enron email
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>The main folder is <code class="verbatim">maildir</code>, which holds all the personal accounts. Our first task is to create a list of available emails. This code results in 517,401 e-mail files with 44,859 emails in the inboxes of users. The E-mail corpus consists of nested folders per user with each e-mail as a text file.</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  emails <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">list.files</span>(<span style="background-color:#fff0f0">&#34;maildir/&#34;</span>, full.names <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">TRUE</span>, recursive <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>  emails <span style="color:#333">&lt;-</span> emails<span style="color:#06b;font-weight:bold">[grep</span>(<span style="background-color:#fff0f0">&#34;/inbox&#34;</span>, emails)]
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">length</span>(emails)</span></span></code></pre></div>
</div>
<p>
The bulk of the code creates a list of emails between Enron employees. The code performs a lot of string manipulations to extract the information from the text files. The content of the e-mails is ignored, the code only retrieves the sender and the receiver. The analysis is limited to e-mails between Enron employees. The result of this code is a data frame with the usernames of the sender and receiver for each email. The data frame contains 2779 emails that meet these criteria. </p>
<p>
The code below looks extracts all internal emails in the Inox folders. It then retrieves a lis of usernames from the e-mails. The data is cleaned by removing users without sent e-mails, and emails which users sent to themselves.</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">library</span>(tibble)
</span></span><span style="display:flex;"><span>  inboxes <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">tibble</span>(
</span></span><span style="display:flex;"><span>      from <span style="color:#333">=</span> <span style="color:#06b;font-weight:bold">apply</span>(<span style="color:#06b;font-weight:bold">as.data.frame</span>(emails), <span style="color:#60e;font-weight:bold">1</span>, 
</span></span><span style="display:flex;"><span>                 <span style="color:#080;font-weight:bold">function</span>(x){<span style="color:#06b;font-weight:bold">readLines</span>(x, warn <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">FALSE</span>)[3]}),
</span></span><span style="display:flex;"><span>      to <span style="color:#333">=</span> emails,
</span></span><span style="display:flex;"><span>      stringsAsFactors <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">FALSE</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">## Keep only enron.com and strip all but username</span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">library</span>(stringr) <span style="color:#888"># String manipulation</span>
</span></span><span style="display:flex;"><span>  inboxes <span style="color:#333">&lt;-</span> inboxes<span style="color:#06b;font-weight:bold">[grepl</span>(<span style="background-color:#fff0f0">&#34;@enron.com&#34;</span>, inboxes<span style="color:#333">$</span>from),]
</span></span><span style="display:flex;"><span>  inboxes<span style="color:#333">$</span>from <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">str_remove_all</span>(inboxes<span style="color:#333">$</span>from, <span style="background-color:#fff0f0">&#34;From: |@enron.com&#34;</span>)
</span></span><span style="display:flex;"><span>  inboxes<span style="color:#333">$</span>to <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">str_remove_all</span>(inboxes<span style="color:#333">$</span>to, <span style="background-color:#fff0f0">&#34;maildir//|/inbox/[0-9]*.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">## Create list of usernames</span>
</span></span><span style="display:flex;"><span>  users <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">data.frame</span>(user <span style="color:#333">=</span> <span style="color:#06b;font-weight:bold">paste0</span>(<span style="background-color:#fff0f0">&#34;maildir/&#34;</span>, <span style="color:#06b;font-weight:bold">unique</span>(inboxes<span style="color:#333">$</span>to)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">## Remove those without sent mails</span>
</span></span><span style="display:flex;"><span>  sent <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">apply</span>(users, <span style="color:#60e;font-weight:bold">1</span>, <span style="color:#080;font-weight:bold">function</span>(x) <span style="color:#06b;font-weight:bold">sum</span>(<span style="color:#06b;font-weight:bold">grepl</span>(<span style="background-color:#fff0f0">&#34;sent&#34;</span>, <span style="color:#06b;font-weight:bold">dir</span>(x))))
</span></span><span style="display:flex;"><span>  users <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">subset</span>(users, sent <span style="color:#333">!=</span> <span style="color:#60e;font-weight:bold">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">## Replace username with e-mail name</span>
</span></span><span style="display:flex;"><span>  users<span style="color:#333">$</span>mailname <span style="color:#333">&lt;-</span> <span style="color:#080;font-weight:bold">NA</span>
</span></span><span style="display:flex;"><span>  i <span style="color:#333">&lt;</span> <span style="color:#60e;font-weight:bold">-1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#080;font-weight:bold">for</span> (i <span style="color:#080;font-weight:bold">in</span> <span style="color:#60e;font-weight:bold">1</span><span style="color:#333">:</span><span style="color:#06b;font-weight:bold">nrow</span>(users)){
</span></span><span style="display:flex;"><span>      sentmail <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">dir</span>(<span style="color:#06b;font-weight:bold">paste0</span>(users<span style="color:#333">$</span>user[i], <span style="background-color:#fff0f0">&#34;/sent_items/&#34;</span>))
</span></span><span style="display:flex;"><span>      name <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">readLines</span>(<span style="color:#06b;font-weight:bold">paste0</span>(users<span style="color:#333">$</span>user[i], <span style="background-color:#fff0f0">&#34;/sent_items/&#34;</span>, sentmail[1]), warn <span style="color:#333">=</span> <span style="color:#007020">F</span>)[3]
</span></span><span style="display:flex;"><span>      name <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">str_remove_all</span>(name, <span style="background-color:#fff0f0">&#34;From: |@enron.com&#34;</span>)
</span></span><span style="display:flex;"><span>      users<span style="color:#333">$</span>mailname[i] <span style="color:#333">&lt;-</span> name
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  users<span style="color:#333">$</span>user <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">str_remove</span>(users<span style="color:#333">$</span>user, <span style="background-color:#fff0f0">&#34;maildir/&#34;</span>)
</span></span><span style="display:flex;"><span>  inboxes <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">merge</span>(inboxes, by.x <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;to&#34;</span>, users, by.y <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;user&#34;</span>)
</span></span><span style="display:flex;"><span>  inboxes <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">tibble</span>(from <span style="color:#333">=</span> inboxes<span style="color:#333">$</span>from,
</span></span><span style="display:flex;"><span>                    to <span style="color:#333">=</span> inboxes<span style="color:#333">$</span>mailname)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">## Only e-mails between users inside the corpus</span>
</span></span><span style="display:flex;"><span>  inboxes <span style="color:#333">&lt;-</span> inboxes[inboxes<span style="color:#333">$</span>from <span style="color:#333">%in%</span> inboxes<span style="color:#333">$</span>to,]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">## Remove no.address</span>
</span></span><span style="display:flex;"><span>  inboxes <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">subset</span>(inboxes, from <span style="color:#333">!=</span> <span style="background-color:#fff0f0">&#34;no.address&#34;</span> <span style="color:#333">&amp;</span> to <span style="color:#333">!=</span> <span style="background-color:#fff0f0">&#34;no.address&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">## Remove emails to self</span>
</span></span><span style="display:flex;"><span>  inboxes <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">subset</span>(inboxes, inboxes<span style="color:#333">$</span>from <span style="color:#333">!=</span> inboxes<span style="color:#333">$</span>to)
</span></span><span style="display:flex;"><span>  inboxes</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-3" class="outline-2">
<h2 id="headline-3">
Analyse the Enron Corpus
</h2>
<div id="outline-text-headline-3" class="outline-text-2">
<p>The last code snippet defines a <a href="https://en.wikipedia.org/wiki/Graph_(discrete_mathematics)">graph</a> from the table of e-mails. Each employee is a node in the network, and each e-mail is an edge (line). The iGraph package is a powerful tool to analyse networks. The <code class="verbatim">graph_from_edgelist</code> function creates a network object that can be analysed using the iGraph package. The graph is directed because the information flows from the sender to the receiver.</p>
<p>
In the next step, the Spingglass algorithm finds <a href="https://en.wikipedia.org/wiki/Community_structure">community structure</a> within the data. A community is a group of nodes that are more connected with each other than with any other node.</p>
<p>
The last step visualises the network. The diagram is drawn using the Fruchterman-Reingold algorithm, which places the most connected nodes at the centre of the picture. The background colours in the diagram indicate the eight communities.</p>
<p>
The graph tells us a lot about the group of employees in the Enron corpus and how they relate to each other. Each of the communities represents a tightly connected group of employees that mainly e-mail each other. Any connections between communities are shown in red. When the <code class="verbatim">vertex.label = NA</code> line is removed, the usernames are displayed at each node.</p>
<p>
We can see groups that never email each other, lonely hangers-on and tightly knit cliques within Enron. In the centre of the graph, we see a few individuals who are connectors between groups because they send a lot of emails to people outside their community. On the fringes of the graph are the hangers-on who only once or twice emailed somebody in the corpus but were still included in the investigation.</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">library</span>(igraph)
</span></span><span style="display:flex;"><span>  g <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">graph_from_edgelist</span>(<span style="color:#06b;font-weight:bold">as.matrix</span>(inboxes), directed <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">TRUE</span>)
</span></span><span style="display:flex;"><span>  coms <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">spinglass.community</span>(g)
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">par</span>(mar <span style="color:#333">=</span> <span style="color:#06b;font-weight:bold">c</span>(<span style="color:#60e;font-weight:bold">0</span>,<span style="color:#60e;font-weight:bold">0</span>,<span style="color:#60e;font-weight:bold">2</span>,<span style="color:#60e;font-weight:bold">0</span>))
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">plot</span>(coms, g,
</span></span><span style="display:flex;"><span>      vertex.label<span style="color:#333">=</span><span style="color:#080;font-weight:bold">NA</span>,
</span></span><span style="display:flex;"><span>      layout <span style="color:#333">=</span> layout.fruchterman.reingold,
</span></span><span style="display:flex;"><span>      vertex.size <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>  )</span></span></code></pre></div>
</div>
<figure>
<img src="https://lucidmanager.org/images/digital-humanities/enron-email-network.jpg" alt="Enron email corpus network with communities" title="Enron email corpus network with communities"/>
<figcaption>
Enron email corpus network with communities.
</figcaption>
</figure>
<p>
This analysis provides only a quick glimpse into the knowledge contained in the Enron email corpus. An extensive range of tools is available to analyse such networks. An interesting exercise would be to overlap this network with the organisation chart to see the relationships between teams. Have fun playing with this fantastic, but somewhat sensitive, data set!</p>
<p>
<a href = "https://www.r-bloggers.com/" target="_blank" title="Proudly associated with R-Bloggers">
  <button class="button is-link is-medium">
    <span class="icon is-large">
      <i class="fab fa-r-project"></i>
    </span>
    <span>As seen on R Bloggers</span>
  </button>
</a>
</p>
</div>
</div>

      