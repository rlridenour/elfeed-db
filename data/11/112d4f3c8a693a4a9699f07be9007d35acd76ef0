<p><img src="https://xenodium.github.io/images/trying-out-mu4e-and-offlineimap/mu4e.png" alt=""></p>
<p>Managing Email from Emacs. Surely that's crazy-talk, but hey… let's give it a try.</p>
<h2>Install offlineimap</h2>
<p>Need to sync via imap. Use offlineimap. I'm on macOS, so homebrew is king for installing:</p>
<pre><code class="language-{.bash">brew install offlineimap
</code></pre>
<p>Before can configure offlineimap, we'll need to handle a few things first.</p>
<h2>Get a cert fingerprint</h2>
<p>Use openssl for getting a certificate fingerprint. From offlineimap's <a href="http://www.offlineimap.org/doc/FAQ.html#view-the-fingerprint">FAQ:</a></p>
<pre><code class="language-{.bash">SSL_CERT_DIR=&quot;&quot; openssl s_client -connect imap.migadu.com:993 &lt; /dev/null 2&gt;/dev/null | openssl x509 -fingerprint -noout -text -in /dev/stdin
</code></pre>
<p>Should give you something like:</p>
<blockquote>
<p>SHA1 Fingerprint=AA:BB:CC:DD:EE:DD:FF:AA:00:AA:2A:AA:AA:AA:A8:20:80:AA:A2:AA</p>
</blockquote>
<h2>Encrypt password</h2>
<p>Offlineimap can read passwords in plain text in its .offlineimaprc config file, but that's yuckie. Let's encrypt the password and use gnupg for that. Install it:</p>
<pre><code class="language-{.bash">brew install gnupg
</code></pre>
<p>If you haven't already, generate a key</p>
<pre><code class="language-{.bash">gpg --full-gen-key
</code></pre>
<p>Generate an offlineimap account password file.</p>
<pre><code class="language-{.bash">echo &quot;YourPassword&quot; | gpg --encrypt --recipient &quot;Your Name&quot; -o ~/.offlineimap_accountname.gpg
</code></pre>
<h2>Python password wrapper</h2>
<p>Based on Fabian's <a href="https://f-koehler.github.io/posts/2015-03-17-offlineimap-msmtp-gnupg.html">Encrypt OfflineIMAP and msmtp password with GnuPG</a>, I created ~/.read_password.py with:</p>
<pre><code class="language-python">import os
import subprocess

def read_password(path):
  return subprocess.check_output([&quot;gpg\n&quot;, &quot;--quiet\n&quot;, &quot;--batch\n&quot;, &quot;-d\n&quot;, os.path.expanduser(path)]).strip()
</code></pre>
<p>ps. Alternatively, see <a href="http://stevelosh.com/blog/2012/10/the-homely-mutt/#retrieving-passwords">The homely Mutt</a>'s section to store password in macOS's keychain.</p>
<h2>Configure offlineimap</h2>
<p>Offlineimap uses ~/.offlineimaprc for configuration. We now have all we need to put the configuration together:</p>
<pre><code class="language-conf">[general]
accounts = Personal

# Load this python file.
pythonfile = ~/.read_password.py

[Account Personal]
localrepository = Personal-Local

remoterepository = Personal-Remote

# After syncing, let mu index it.
postsynchook = mu index --maildir ~/stuff/active/Mail

# Sync imap every 5 minutes.
autorefresh = 5

# Alternate between 10 quick syncs and full syncs.
quick = 10

[Repository Personal-Local]
type = Maildir
localfolders = ~/stuff/active/Mail/Personal

[Repository Personal-Remote]
type = IMAP
remotehost = some.imap.host.com
remoteuser = your_user_name

# Use function defined in .read_password.py to read the password.
remotepasseval = read_password(&quot;~/.offlineimap_personal_account_password.gpg&quot;)

# Use the SHA1 fingerprint retrieved with openssl.
cert_fingerprint = aabbccddeeddffaa00aa2aaaaaaaa82080aaa2aa
</code></pre>
<h3>Cert file</h3>
<p>You can use macOS's certificates from Keychain Access -&gt; System Roots -&gt; Certificates, select all, and ⌘-⇧-e (for export items). Save to ~/certs.pem and use offlineimap configutation:</p>
<blockquote>
<p>sslcacertfile = /path/to/certs.pem</p>
</blockquote>
<p>Another option is executing lib/mk-ca-bundle.pl from curl's tarball to generate ca-bundle.crt, using certdata.txt from Mozilla's source tree.</p>
<h2>Install mu4e</h2>
<p>Manually modified mu4e recipe to pick up my Emacs binary. TIL about homebrew's edit command:</p>
<pre><code class="language-{.bash">brew edit mu
</code></pre>
<p>Changed the one line:</p>
<blockquote>
<ul>
<li>ENV[&quot;EMACS&quot;] = &quot;no&quot; if build.without? &quot;emacs&quot;</li>
<li>ENV[&quot;EMACS&quot;] = &quot;/Users/alvaro/homebrew/Cellar/emacs-plus/26.1-rc1_2/bin/emacs&quot;</li>
</ul>
</blockquote>
<p>Finally installed mu4e:</p>
<pre><code class="language-{.bash">brew install mu
</code></pre>
<h2>Configure mu4e</h2>
<p>Lastly, configure mu4e:</p>
<pre><code class="language-{.commonlisp">(add-to-list 'load-path
             (expand-file-name &quot;~/homebrew/share/emacs/site-lisp/mu/mu4e&quot;))
(use-package mu4e
  :config
  ;; Update mail using 'U' in main view:
  (setq mu4e-get-mail-command &quot;offlineimap&quot;)
  (setq mu4e-view-show-addresses t)
  (setq mu4e-attachment-dir (expand-file-name &quot;~/Downloads/&quot;))
  (setq mu4e-maildir &quot;path/to/Mail&quot;)
  (setq mu4e-html2text-command &quot;w3m -T text/html&quot;) ;; alternatively &quot;textutil -stdin -format html -convert txt -stdout&quot;
  (setq mu4e-user-mail-address-list '(&quot;myself@domain1.com&quot;
                                      &quot;myself@domain2.com&quot;))
  (setq mu4e-context-policy 'pick-first)
  (setq mu4e-compose-context-policy 'always-ask)
  (setq mu4e-contexts
        (list
         (make-mu4e-context
          :name &quot;domain1&quot;
          :enter-func (lambda () (mu4e-message &quot;Entering context myself@domain1.com&quot;))
          :leave-func (lambda () (mu4e-message &quot;Leaving context myself@domain1.com&quot;))
          :match-func (lambda (msg)
                        (when msg
                          (mu4e-message-contact-field-matches
                           msg '(:from :to :cc :bcc) &quot;myself@domain1.com&quot;)))
          :vars '((user-mail-address . &quot;myself@domain1.com&quot;)
                  (user-full-name . &quot;My name&quot;)
                  (mu4e-sent-folder . &quot;/Domain1/Sent&quot;)
                  (mu4e-drafts-folder . &quot;/Domain1/Drafts&quot;)
                  (mu4e-trash-folder . &quot;/Domain1/Trash&quot;)
                  (mu4e-compose-signature . nil)
                  (mu4e-compose-format-flowed . nil)
                  (smtpmail-smtp-user . &quot;myself@domain1.com&quot;)
                  (smtpmail-smtp-server . &quot;smtp.domain1.com&quot;)
                  (smtpmail-smtp-service . 587)))
         (make-mu4e-context
          :name &quot;domain2&quot;
          :enter-func (lambda () (mu4e-message &quot;Entering context myself@domain2.com&quot;))
          :leave-func (lambda () (mu4e-message &quot;Leaving context myself@domain2.com&quot;))
          :match-func (lambda (msg)
                        (when msg
                          (mu4e-message-contact-field-matches
                           msg '(:from :to :cc :bcc) &quot;myself@domain2.com&quot;)))
          :vars '((user-mail-address . &quot;myself@domain2.com&quot;)
                  (user-full-name . &quot;My name&quot;)
                  (mu4e-sent-folder . &quot;/Domain2/Sent&quot;)
                  (mu4e-drafts-folder . &quot;/Domain2/Drafts&quot;)
                  (mu4e-trash-folder . &quot;/Domain2/Trash&quot;)
                  (mu4e-compose-signature . nil)
                  (mu4e-compose-format-flowed . nil)
                  (smtpmail-smtp-user . &quot;myself@domain2.com&quot;)
                  (smtpmail-smtp-server . &quot;smtp.domain2.com&quot;)
                  (smtpmail-smtp-service . 587))))))

(use-package smtpmail
  :config
  (setq smtpmail-stream-type 'starttls)
  (setq smtpmail-debug-info t)
  (setq smtpmail-warn-about-unknown-extensions t)
  (setq smtpmail-queue-mail t)
  (setq smtpmail-default-smtp-server nil)
  ;; Created with mu mkdir path/to/Mail/queue
  ;; Also avoid indexing.
  ;; touch path/to/Mail/queue/.noindex
  (setq smtpmail-queue-dir &quot;path/to/Mail/queue/cur&quot;))

(use-package message
  :config
  (setq message-send-mail-function 'smtpmail-send-it))
</code></pre>
<h2>Authinfo</h2>
<p>Create an ~/.authinfo file for sendmail authentication with:</p>
<pre><code>machine smtp.host1.com login account1@host1.com password somepassword1
machine smtp.host2.com login account2@host2.com password somepassword2
</code></pre>
<p>Encrypt ~/.authinfo with M-x epa-encrypt-file. Keep ~/.authinfo.gpg and delete ~/.authinfo.</p>
<h2>Mu4e helpful references</h2>
<ul>
<li><a href="http://cachestocaches.com/2017/3/complete-guide-email-emacs-using-mu-and-">A Complete Guide to Email in Emacs using Mu and Mu4e</a>.</li>
<li><a href="https://www.reddit.com/r/emacs/comments/5fkq7r/a_year_with_notmuch_mail_a_superfast_email_client/">A year with Notmuch mail - a super-fast email client available on Emacs</a>.</li>
<li><a href="https://dev.to/shrysr/archaic-text-based-email-clients-rock-3flm">Archaic: text based email clients rock - DEV Community (lots of great links)</a>.</li>
<li><a href="https://gist.github.com/areina/3879626">areina's Manage your email in emacs with mu4e</a>.</li>
<li><a href="https://notanumber.io/2016-10-03/better-email-with-mu4e/">Better Email with mu4e (NaN)</a>.</li>
<li><a href="https://vxlabs.com/2014/06/06/configuring-emacs-mu4e-with-nullmailer-offlineimap-and-multiple-identities/">Configuring Emacs mu4e with nullmailer, offlineimap and multiple identities</a>.</li>
<li><a href="http://www.macs.hw.ac.uk/~rs46/posts/2014-01-13-mu4e-email-client.html">Drowning in Email; mu4e to the Rescue</a>.</li>
<li><a href="https://ebzzry.io/en/emacs-mail/">Ebzzry: Setting up Mail in Emacs</a>.</li>
<li><a href="http://www.kirang.in/2014/11/13/emacs-as-email-client-with-offlineimap-and-mu4e-on-osx">Emacs as email client with offlineimap and mu4e on OS X</a>.</li>
<li><a href="https://zmalltalker.com/linux/mu.html">Email done right (mu)</a>.</li>
<li><a href="https://f-koehler.github.io/posts/2015-03-17-offlineimap-msmtp-gnupg.html">Encrypt OfflineIMAP and msmtp password with GnuPG</a>.</li>
<li><a href="https://etienne.depar.is/emacs.d/mu4e.html">Etienne's Mu4e customization</a>.</li>
<li><a href="https://github.com/OfflineIMAP/imapfw">GitHub - OfflineIMAP/imapfw: imapfw (IMAP/mail framework)</a>.</li>
<li><a href="https://github.com/kensanata/ggg">Gmail Gnus GPG Guide (GGGG)</a>.</li>
<li><a href="https://martinralbrecht.wordpress.com/2016/05/30/handling-email-with-emacs/">Handling Email with Emacs</a> (helm included).</li>
<li><a href="https://www.reddit.com/r/emacs/comments/5hfcid/i_got_mu4e_working/">I got mu4e working! (Reddit)</a>.</li>
<li><a href="https://blog.danielgempesaw.com/post/43467552978/installing-mu-and-mu4e-with-homebrew-with-emacs">Installing mu and mu4e with homebrew with emacs</a>.</li>
<li><a href="https://github.com/iqbalansari/dotEmacs/blob/master/config/mail.org">Iqbal Ansari's mail config</a>.</li>
<li><a href="https://github.com/iqbalansari/dotEmacs/blob/master/config/mail.org">iqbalansari/dotEmacs: calendar integration</a>.</li>
<li><a href="https://jherrlin.github.io/posts/emacs-mu4e/">Mail in Emacs with mu4e and mbsync (jherrlin)</a>.</li>
<li><a href="http://pragmaticemacs.com/emacs/master-your-inbox-with-mu4e-and-org-mode/">Master your inbox with mu4e and org-mode</a>.</li>
<li><a href="https://github.com/djcb/mu">Mu's github mirror</a>.</li>
<li><a href="http://www.djcbsoftware.nl/code/mu">Mu's page</a>.</li>
<li><a href="http://wenshanren.org/?p=111">mu4e: an E-mail Client for Emacs</a>.</li>
<li><a href="https://github.com/danielfleischer/mu4easy">mu4easy: mu4e + mbsync configuration for multiple accounts.</a>.</li>
<li><a href="http://rudolfochrist.github.io/blog/2015/03/21/offlineimap-with-ssl-files-on-osx/">OfflineIMAP with SSL files on OSX - Sebastian Christ</a>.</li>
<li><a href="https://news.ycombinator.com/item?id=14221501">OfflineIMAP: sync and backup tool for IMAP (Hacker News) and mbsync in comments</a>.</li>
<li><a href="https://github.com/redguardtoo/mastering-emacs-in-one-year-guide/blob/master/gnus-guide-en.org">Practical guide to use Gnus with Gmail</a>.</li>
<li><a href="http://pragmaticemacs.com/mu4e-tutorials/">Pragmatic Emacs's mu4e tutorials</a>.</li>
<li><a href="http://prodissues.com/2016/02/adding-mu4e-support-to-emacs.html">Prodissues: Adding mu4e Support To Emacs</a>.</li>
<li><a href="http://prodissues.com/2016/02/emacs-gpg-for-dummies.html">Prodissues: Emacs GPG For Dummies</a>.</li>
<li><a href="http://ict4g.net/adolfo/notes/2014/12/27/emacs-imap.html">Reading IMAP Mail in Emacs on OSX</a>.</li>
<li><a href="https://vxlabs.com/2019/07/03/send-queued-mails-in-background-with-mu4e/">Sending queued mails in the background with mu4e</a>.</li>
<li><a href="https://aliquote.org/post/setting-up-mu4e-1-0-c/">Setting Up Mu4e 1.0 C - aliquot</a>.</li>
<li><a href="https://dataswamp.org/~solene/2018-05-22-mu4esmtp.html">Solene's post: Sending mail with mu4e</a>.</li>
<li><a href="https://lars.ingebrigtsen.no/2014/12/01/the-emacs-network-security-manager">The Emacs Network Security Manager</a>.</li>
<li><a href="http://tech.memoryimprintstudio.com/the-ultimate-emailing-agent-with-mu4e-and-emacs">The Ultimate Emailing Agent with Mu4e and Emacs</a>.</li>
<li><a href="https://www.reddit.com/r/emacs/comments/8q84dl/tip_how_to_easily_manage_your_emails_with_mu4e/">TIP: How to easily manage your emails with mu4e (Reddit)</a>.</li>
<li><a href="https://etienne.depar.is/a-ecrit/post/2016/09/23/Two-custom-headers-for-mu4e">Two custom headers for mu4e - Étienne Deparis</a>.</li>
<li><a href="https://www.reddit.com/r/emacs/comments/73a3gp/using_emacs_to_read_gmail/">Using Emacs to read gmail (Emacs subreddit)</a>.</li>
<li><a href="http://www.brool.com/post/using-mu4e/">Using mu4e (Brool blog)</a>.</li>
<li><a href="https://github.com/zamansky/using-emacs/blob/master/mu4econfig-sample.el">Zamansky mu4e's sample config</a>.</li>
<li><a href="https://www.youtube.com/watch?v=newRHXKm4H4">Zamansky's video on mu4e</a>.</li>
</ul>
