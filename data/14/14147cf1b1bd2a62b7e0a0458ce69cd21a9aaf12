<p>For my previous post I was talking about a software visual indicator to discern which key has been locked in a sticky key situation.  For example there are typically two modes of stickiness, being latched and locked, by default I had set up the locked variant as I thought it would be more useful for Emacs and in fact I have found this to be the case.  For example, double tapping the Control key allows nice easy single key navigation via &rsquo;n&rsquo; &lsquo;p&rsquo; &lsquo;f&rsquo; and &lsquo;b&rsquo;, possible page down with &lsquo;v&rsquo; and to delete lines I can use &lsquo;k&rsquo; .e.t.c.</p>
<figure><img src="https://emacs.dyerdwelling.family/ox-hugo/2024-04-14-10-55-03.jpg" width="100%">
</figure>

<p>I&rsquo;m sure I will find more bonuses in Emacs with this key locking mechanism and of course I can always tweak my keybindings, for example maybe a page up could be a Ctrl-&lt;key&gt; so I can have even more power navigating with a single &lt;key&gt;.</p>
<p>But how does a locked key setup work in a different program? and especially the software I use for my digital art, namely Krita.  I have a USB numpad peripheral in which I map each key to a Krita shortcut, for example common actions such as colour picking, brush resize, canvas flip, undo / redo e.t.c.  I have found this to actually be a nice cheaper option than one of the more specialised digital art controllers and more flexible as I will always be able to use it on linux with keymapping software like kmonad or kanata.</p>
<p>It didn&rsquo;t take long to find out that I was running into difficulties with Krita and the locked sticky setup.  For example colour picking is quite a common activity in digital art and it just so happens that for Krita it is bound by default to the Ctrl key!  In addition Shift resizes the brush too.  I found that quite often I was tapping the Ctrl and or Shift consecutively which was locking the modifier key which would have some unwanted side effects and would start to get frustrating as I fumble around to unlock the relevant modifier thus disrupting my flow.  I quickly came to the conclusion that a locked sticky was not viable for my use within Krita.</p>
<p>So how could I craft a solution to this problem?</p>
<p>In my previous post, I might have unintentionally already laid the groundwork as I have created both a latched and a locked sticky key variant in the xkb file format. Perhaps I could develop a toggling mechanism between the locked and latched states, switching to latched state when I use Krita.</p>
<p>Just like before, I think Waybar would be ideal to perform the toggle with a click (which could also be a stylus click from a pen) and to then display the current status.</p>
<p>Initially I created the following bash script to perform the toggling of the keymaps :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Define the paths to your keymap files</span>
</span></span><span style="display:flex;"><span>KEYMAP_SWAY<span style="color:#f92672">=</span>~/.config/keymap_sway.xkb
</span></span><span style="display:flex;"><span>KEYMAP_LOCKED<span style="color:#f92672">=</span>~/.config/keymap_with_locked_modifiers.xkb
</span></span><span style="display:flex;"><span>KEYMAP_STICKY<span style="color:#f92672">=</span>~/.config/keymap_with_sticky_modifiers.xkb
</span></span><span style="display:flex;"><span>CURRENT_KEYMAP_PATH<span style="color:#f92672">=</span>~/.config/keymap_current
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check if the current keymap is set, if not use the sway keymap</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> ! -f <span style="color:#e6db74">&#34;</span>$CURRENT_KEYMAP_PATH<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>   echo <span style="color:#e6db74">&#34;</span>$KEYMAP_SWAY<span style="color:#e6db74">&#34;</span> &gt; <span style="color:#e6db74">&#34;</span>$CURRENT_KEYMAP_PATH<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CURRENT_KEYMAP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>cat <span style="color:#e6db74">&#34;</span>$CURRENT_KEYMAP_PATH<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Swap the keymaps</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$CURRENT_KEYMAP<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span>$KEYMAP_LOCKED<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>   cp -f <span style="color:#e6db74">&#34;</span>$KEYMAP_STICKY<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$KEYMAP_SWAY<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>   echo <span style="color:#e6db74">&#34;</span>$KEYMAP_STICKY<span style="color:#e6db74">&#34;</span> &gt; <span style="color:#e6db74">&#34;</span>$CURRENT_KEYMAP_PATH<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>   cp -f <span style="color:#e6db74">&#34;</span>$KEYMAP_LOCKED<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$KEYMAP_SWAY<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>   echo <span style="color:#e6db74">&#34;</span>$KEYMAP_LOCKED<span style="color:#e6db74">&#34;</span> &gt; <span style="color:#e6db74">&#34;</span>$CURRENT_KEYMAP_PATH<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Reload Sway configuration</span>
</span></span><span style="display:flex;"><span>swaymsg reload
</span></span></code></pre></div><p>Note that at first I tried to use the xkbcomp command but by all accounts only works on X11 so with wayland and in particular Sway I had to find a workaround to reload a toggled keymap - which is where swaymsg reload comes in.  The solution is a little hacky but will work and involves swapping around files on disk and then forcing a reload of the sway configuration file.</p>
<p>As always with toggling, the key is usually working out the current toggle state in order to know what to toggle to.  I decided to use the old fashioned method of a file on disk containing the path to the current keymap!</p>
<p>In the sway configuration file I can now attach a keybinding to the new toggle script :</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">bindsym $mod+y exec keymap-toggle.sh
</code></pre><p>&lsquo;y&rsquo; for sticky seems appropriate methinks.</p>
<p>Now for updating waybar to reflect the status.  In this case as in the modifier LEDs of my last post I will have to create some custom modules and link it to a content producing bash script.</p>
<p>A keymap_monitor.sh script is as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>CURRENT_KEYMAP_PATH<span style="color:#f92672">=</span>~/.config/keymap_current
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CURRENT_KEYMAP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>cat <span style="color:#e6db74">&#34;</span>$CURRENT_KEYMAP_PATH<span style="color:#e6db74">&#34;</span> | grep <span style="color:#e6db74">&#34;sticky&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $CURRENT_KEYMAP <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>   echo <span style="color:#e6db74">&#34;{\&#34;text\&#34;: \&#34;STICKY\&#34;, \&#34;class\&#34;: \&#34;active\&#34;}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>   echo <span style="color:#e6db74">&#34;{\&#34;text\&#34;: \&#34;LOCKED\&#34;, \&#34;class\&#34;: \&#34;inactive\&#34;}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span></code></pre></div><p>and the waybar module :</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">&#34;custom/togglesticky&#34;: {
    &#34;exec&#34;: &#34;keymap-monitor.sh&#34;,
    &#34;interval&#34;: 1,
    &#34;return-type&#34;: &#34;json&#34;,
    &#34;on-click&#34;: &#34;keymap-toggle.sh&#34;,
}
</code></pre><p>Note the return-type type is json and the echo statements in the keymap_monitor.sh script have formatted the return data in the json format meaning the waybar module can process the string effectively.  Note also a css class is set up which will link to the associated waybar css style sheet and potentially offer a nice flexible look for each mode if desired.</p>
<p>&ldquo;on-click&rdquo;: &ldquo;keymap-toggle.sh&rdquo; will allow the toggle to be actioned and the monitor script will be called every second as per the interval setting to poll the current toggle state.</p>
<p>Well that should be about it!, when I now open up Krita I can just tap on the LOCKED indicator on waybar which will then display STICKY (I decided to go with STICKY rather than LATCHED)  This now indicates that I have changed the keymap, at which point double tapping any modifier keys as part of my arting shenanigans will now not lock the associated modifier and cause annoyance down the line.</p>
<figure><img src="https://emacs.dyerdwelling.family/ox-hugo/2024-04-14-10-55-19.jpg" width="100%">
</figure>

<p>I might even eventually find some icons or my preferred method emojis to make things look more graphically pleasing, but with all these things I always initially look to get most of the way there and in a working state before I start polishing it.</p>