<p><strong>EDIT - 2022-06-25:</strong>
I got some notes on Reddit by the ox-hugo dev (<a href="https://www.reddit.com/user/kaushalmodi/">u/kaushalmodi</a>) regarding some information in this post.</p>
<p>I would be remiss of course if i didn&rsquo;t mention theme here. See the <a href="https://www.reddit.com/r/emacs/comments/vj63n0/yet_another_blog_setup_based_on_emacs_org_mode/">thread on Reddit</a>.</p>
<h2 id="objective">Objective</h2>
<p>Quite simple really. I want to write my blog and publish it <strong>without leaving Emacs</strong>.</p>
<p>This post is my documentation – for me and whoever might be interested – of how I go about achieving this. Read on!</p>
<h2 id="hugo">Hugo</h2>
<blockquote>
<p>Hugo is one of the most popular open-source static site generators. With its amazing speed and flexibility, Hugo makes building websites fun again.</p>
</blockquote>
<p style="text-align:center;padding-left:300px;margin-top:-20px;">–– Hugo devs</p>
<p>Now&hellip; I really cannot say how my choice fell on <a href="https://gohugo.io">Hugo</a> back then. I have a strong suspicion that it might be the hipe back then. However, I haven&rsquo;t looked back since. It is easy to use, fast enough for my needs and I have found a theme – <a href="https://themes.gohugo.io/themes/hugo-theme-cactus/">Cactus theme</a> by <a href="https://github.com/monkeyWzr">Zeran Wu</a> – that tickles my fancy a whole lot.</p>
<figure><img src="https://macowners.club/images/hugo-logo.png" width="200px">
</figure>

<p>I do really mean &ldquo;easy to use&rdquo; when I say it, which is why I will not go into the Hugo setup and the How-To itself. Just hop over to the <a href="https://gohugo.io/getting-started/quick-start/">Quick Start</a> guide and find out for yourself.</p>
<h2 id="ox-hugo">ox-hugo</h2>
<p>I may have left out some details saying, that I want to write my posts inside Emacs. What I more precisely meant is that I want to write them in <a href="https://orgmode.org">Org mode</a>.</p>
<p>Lucky for me <a href="https://github.com/kaushalmodi">Kaushal Modi</a> already wrote a package for this&hellip;</p>
<blockquote>
<p>ox-hugo is an Org exporter backend that exports Org to Hugo-compatible Markdown (Blackfriday) and also generates the front-matter (in TOML or YAML format).</p>
</blockquote>
<p style="text-align:center;padding-left:300px;margin-top:-20px;">–– ox-hugo devs</p>
<p>Essentially you write your posts in Org Mode format and <a href="https://ox-hugo.scripter.co">ox-hugo</a> exports these to markdown in a manner &ldquo;digestible&rdquo; by Hugo.</p>
<p>Now of course there some rules you need to follow. The first one being selecting either the &ldquo;<a href="https://ox-hugo.scripter.co/#screenshot-one-post-per-subtree">One post per Org subtree</a>&rdquo; or the &ldquo;<a href="https://ox-hugo.scripter.co/#screenshot-one-post-per-file">One post per Org file</a>&rdquo; strategy.</p>
<p>I use the later. For some reason the first option did not work for me. In any case I prefer the second method. I tend to be able to keep track of the posts better this way.</p>
<p>Once you selected your strategy, you have now to create the directory, where your Org Mode files will live. This is called <code>content-org</code> by default and has to be in the root directory of the Hugo site.</p>
<p>You need to make sure to use some special <a href="https://ox-hugo.scripter.co/doc/org-meta-data-to-hugo-front-matter/">ox-hugo properties</a> as org-meta-line as well. This will translate largely into the front-matter for the markdown files exported. I my case the &ldquo;header&rdquo; for each post looks like this example of the current post:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="c"># default Org Mode header:</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+TITLE</span><span class="c">: Emacs, Hugo, GitLab and this Blog</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+AUTHOR</span><span class="c">: Aimé Bertrand</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+DATE</span><span class="c">: [2022-06-23 Thu]</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+LANGUAGE</span><span class="c">: en</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+STARTUP</span><span class="c">: indent showall</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Properties, special to Hugo:</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+HUGO_TAGS</span><span class="c">: emacs hugo ox-hugo gitlab ci/cd blog</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+HUGO_CATEGORIES</span><span class="c">: web</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+HUGO_BASE_DIR</span><span class="c">: ../</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+HUGO_SECTION</span><span class="c">: posts</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+HUGO_WEIGHT</span><span class="c">: auto</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+HUGO_AUTO_SET_LASTMOD</span><span class="c">: t</span>
</span></span><span class="line"><span class="cl"><span class="cs">#+EXPORT_FILE_NAME</span><span class="c">: emacs-hugo-gitlab-blog</span>
</span></span></code></pre></div><p>Most of these are self-explanatory. However&hellip;</p>
<dl>
<dt>#+HUGO_BASE_DIR:</dt>
<dd>The root directory of your site</dd>
<dt>#+HUGO_SECTION:</dt>
<dd>This is the section (directory) inside of your Hugo content directory</dd>
</dl>
<p>It is helpful also to setup &ldquo;<a href="https://ox-hugo.scripter.co/doc/auto-export-on-saving/">Auto-export on Saving</a>&rdquo;. This way you can live preview your post using the <a href="https://gohugo.io/commands/hugo_server/">Hugo server</a>. I enable this <a href="https://ox-hugo.scripter.co/doc/auto-export-on-saving/#enable-only-for-an-org-file">per org file</a> by adding the following at the bottom of the file. With an added benefit of being able to use other <strong>Emacs (Lisp)</strong> variables within this syntax.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-org" data-lang="org"><span class="line"><span class="cl"><span class="gh">*</span><span class="gs"> Footnotes</span>
</span></span><span class="line"><span class="cl"><span class="gh">*</span><span class="ni"> COMMENT</span><span class="gs"> Local Variables                          :ARCHIVE:</span>
</span></span><span class="line"><span class="cl"><span class="c"># Local Variables:</span>
</span></span><span class="line"><span class="cl"><span class="c"># eval: (org-hugo-auto-export-mode)</span>
</span></span><span class="line"><span class="cl"><span class="c"># eval: (flyspell-mode)</span>
</span></span><span class="line"><span class="cl"><span class="c"># End:</span>
</span></span></code></pre></div><p>Now this was just the steps I take to get my Hugo stack to work. There is a bunch more options to bend your posts to your liking. Head over to the <a href="https://ox-hugo.scripter.co">ox-hugo website</a> and find out more.</p>
<h2 id="org-mode">Org Mode</h2>
<figure><img src="https://macowners.club/images/org-mode-icon.png" width="100px">
</figure>

<p>Now all the remains to do is really just write down your post in good old Org Mode.</p>
<h2 id="gitlab">GitLab</h2>
<p>It is almost needless to say, that the blog is under version control&hellip;</p>
<p>&hellip; Good, now that I just said it anyways, let&rsquo;s talk about how I leverage this.</p>
<p>I use <a href="https://gitlab.com/aimebertrand">GitLab</a> as a remote for my git controlled projects. Meaning of course that i can take advantage of this for publishing my posts. This is handled by a GitLab CI/CD Pipeline.</p>
<p>The <a href="https://docs.gitlab.com/ee/ci/quick_start/">Get started with GitLab CI/CD</a> page is a good start to understanding the Ins and Outs of setting up your own pipeline. I suggest reading up a bit in case you want/need to know more.</p>
<figure><img src="https://macowners.club/images/gitlab.png" width="100px">
</figure>

<p>Now to my pipeline&hellip;</p>
<h3 id="docker-image">Docker image</h3>
<p>I use GitLabs own registry that has a Hugo Docker image to start with. For my case <code>hugo:latest</code>, which is minimal image based on <a href="https://www.alpinelinux.org">alpine</a> is more than good enough.</p>
<h3 id="ci-cd-variables">CI/CD variables</h3>
<p>Since I upload the content to my site via SFTP, I need to store the following values as <a href="https://docs.gitlab.com/ee/ci/variables/">CI/CD variables</a>.</p>
<dl>
<dt>FTP_HOST:</dt>
<dd>The address of the SFTP server</dd>
<dt>FTP_USER:</dt>
<dd>The username of the SFTP server</dd>
<dt>FTP_PASS:</dt>
<dd>The password to the username of the SFTP server</dd>
<dt>FTP_HOST_KEY:</dt>
<dd>The Docker container needs to know and accept the ssh host key sftp server</dd>
</dl>
<h3 id="lftp">LFTP</h3>
<p>I use the <a href="https://github.com/lavv17/lftp">cli program LFTP</a>, which can handle SFTP connections to upload the Hugo results.</p>
<h3 id="pipeline">Pipeline</h3>
<p>All of the above results into the following <code>.gitlab-ci.yml</code> for the pipeline.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry.gitlab.com/pages/hugo:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># this is because the Hugo theme comes in a submodule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">GIT_SUBMODULE_STRATEGY</span><span class="p">:</span><span class="w"> </span><span class="l">recursive</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Set sane timeout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="l">minutes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Install utils</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">apk add lftp openssh-client</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Add the key and known hosts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">mkdir /root/.ssh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">touch /root/.ssh/known_hosts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">echo $FTP_HOST_KEY &gt; /root/.ssh/known_hosts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">eval &#34;$(ssh-agent -s)&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Build the website</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">hugo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Build the website</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">lftp --user $FTP_USER --password $FTP_PASS sftp://$FTP_HOST -e &#34;set ftp:ssl-allow yes; mirror --reverse --verbose public/ ./; bye&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">only</span><span class="p">:</span><span class="w"> </span><span class="c"># Only run on main branch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH</span><span class="w">
</span></span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>As publishing stacks go, mine is really not particularly sophisticated. However it works fantastically.</p>
<p>With a reasonable overhead I now write all of my post inside of Org Mode. I push my commits with <a href="https://magit.vc/manual/magit/#Top">Magit</a> and my blog is automagically updated.</p>
