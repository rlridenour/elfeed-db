
	
<p>
A geographic bubble chart is a straightforward method to visualise quantitative information with a geospatial relationship. Last week, I was in Vietnam helping the Phú Thọ Water Supply Joint Stock Company with their data science. They asked me to create a map of a sample of their water consumption data. In this post, I share this little ditty to explain how to plot a bubble chart over a map using the ggmap package. </p>
<p>
In this post, I share this little ditty to explain how to plot a bubble chart over a map using the ggmap package. Thanks to Ms Quy and Mr Tuyen of Phu Tho Water for their permission to use this data. Other posts on this blog detail how to analyse water consumption from <a href="https://lucidmanager.org/data-science/analyse-digital-water-meter-data/">digital metering data</a>.</p>
<p>
This map visualises water consumption in the targeted area of Việt Trì. The larger the bubble, the larger the consumption. It is no surprise that two commercial customers used the most water.</p>
<figure>
<img src="https://lucidmanager.org/images/hydroinformatics/vietwater.jpg" alt="Viet Water conference 2018" title="Viet Water conference 2018"/>
<figcaption>
Viet Water Conference 2018.
</figcaption>
</figure>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
Load and Explore the Data
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>The sample data contains a list of just over 100 readings from water meters in the city of Việt Trì, Vietnam, along with their geospatial locations. This data uses the World Geodetic System of 1984 (WGS84), compatible with Google Maps and similar systems. </p>
<p>
<a href = "https://github.com/pprevos/r4h2o/" target="_blank"
   title="Download r4h2o from GitHub"
   alt="Download r4h2o from GitHub">
  <button class="button is-medium is-primary">
    <span class="icon is-large">
      <i class="fab fa-github"></i>
    </span>
    <span style="font-family: monospace">r4h2o</span>
  </button>
</a>

</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#888"># Water consumption bubble chart</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  water <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">read.csv</span>(<span style="background-color:#fff0f0">&#34;data/viet-tri-consumption.csv&#34;</span>)
</span></span><span style="display:flex;"><span>  water<span style="color:#333">$</span>Consumption <span style="color:#333">&lt;-</span> water<span style="color:#333">$</span>read_new <span style="color:#333">-</span> water<span style="color:#333">$</span>read_old
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">## Summarise the data</span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">summary</span>(water<span style="color:#333">$</span>Consumption)</span></span></code></pre></div>
</div>
<p>
Consumption per connection ranges from 0 to 529 cubic metres, with an average of 23.45 cubic metres.</p>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
Visualise the data with a geographic bubble chart
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>With the <a href="https://r-graph-gallery.com/324-map-background-with-the-ggmap-library.html">ggmap</a> extension of the ggplot package, we can visualise any spatial data set on a map. The only condition is that the spatial coordinates are in the WGS84 datum. The ggmap package adds a geographical layer to ggplot by providing a Google Maps or OpenStreetMap canvas. The first step is to download the map canvas. You need to know the centre coordinates and the zoom factor to do this. Determining the perfect zoon factor requires some trial and error. The ggmap package provides for various map types, which are described in detail in the <a href="https://cran.r-project.org/web/packages/ggmap/ggmap.pdf">documentation</a>. You will need a <a href="https://lucidmanager.org/data-science/geocoding-with-ggmap/">Google Maps API</a> to enable this functionality.</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#888">## Plot on Google Maps</span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">library</span>(ggmap)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  api <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">readLines</span>(<span style="background-color:#fff0f0">&#34;data/google-maps.api&#34;</span>) <span style="color:#888"># Text file with the API key</span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">register_google</span>(key <span style="color:#333">=</span> api)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  centre <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">c</span>(<span style="color:#06b;font-weight:bold">mean</span>(<span style="color:#06b;font-weight:bold">range</span>(water<span style="color:#333">$</span>lon)), <span style="color:#06b;font-weight:bold">mean</span>(<span style="color:#06b;font-weight:bold">range</span>(water<span style="color:#333">$</span>lat)))
</span></span><span style="display:flex;"><span>  viettri <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">get_map</span>(centre, zoom <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">17</span>, maptype <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;hybrid&#34;</span>)
</span></span><span style="display:flex;"><span>  g <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">ggmap</span>(viettri)</span></span></code></pre></div>
</div>
<p>
The ggmap package follows the same conventions as ggplot. We first call the map layer and then add any required geom. The point geom creates a nice bubble chart when combined with the <code class="verbatim">scale_size_area option</code>. This option scales the points to a maximum size to ensure they are easily visible. The transparency (alpha) minimises the problem of overplotting. This last code snippet plots the map with water consumption. </p>
<figure>
<img src="https://lucidmanager.org/images/hydroinformatics/viet-tri-consumption.jpg" alt="Water consumption in  Việt Trì" title="Water consumption in  Việt Trì."/>
<figcaption>
Water consumption in  Việt Trì.
</figcaption>
</figure>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#888"># Add data to ggmap  </span>
</span></span><span style="display:flex;"><span>  g <span style="color:#333">+</span> <span style="color:#06b;font-weight:bold">geom_point</span>(data <span style="color:#333">=</span> water, <span style="color:#06b;font-weight:bold">aes</span>(x <span style="color:#333">=</span> lon, y <span style="color:#333">=</span> lat, size <span style="color:#333">=</span> Consumption),
</span></span><span style="display:flex;"><span>                 shape <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">21</span>, colour <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;dodgerblue4&#34;</span>, fill <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;dodgerblue&#34;</span>, 
</span></span><span style="display:flex;"><span>                 alpha <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">.8</span>) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">scale_size_area</span>(max_size <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">30</span>) <span style="color:#333">+</span> <span style="color:#888"># Size of the biggest point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">ggtitle</span>(<span style="background-color:#fff0f0">&#34;Việt Trì sự tiêu thụ nước&#34;</span>)</span></span></code></pre></div>
</div>
<p>

  <div class="box">
    <div class="media">
      <figure class="media-left">
        <p class="image is-128x128">
          <img src="https://lucidmanager.org/images/books/2023_ds4wu.jpg" alt = "Data Science for Water Utilities" title = "Data Science for Water Utilities">
        </p>
      </figure>
      <div class="media-content">
        <div class="content">
          <p class="is-size-5 has-text-weight-bold">Data Science for Water Utilities</p>
          <p class="mb-2">Data Science for Water Utilities published by CRC Press is an applied, practical guide that shows water professionals how to use data science to solve urban water management problems using the R language for statistical computing.</p>
          <div class="buttons">
            <a class="button is-info" href="https://routledge.com/9781032354545" target="_blank">
              <span class="icon">
                <i class="fas fa-shopping-cart"></i>
              </span>
              <span>Routledge</span>
            </a>
            <a class="button is-info" href="https://www.amazon.com/Data-Science-Water-Utilities-Chapman/dp/1032354550" target="_blank">
              <span class="icon">
                <i class="fas fa-shopping-cart"></i>
              </span>
              <span>Amazon</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</p>
<p>
<a href = "https://www.r-bloggers.com/" target="_blank" title="Proudly associated with R-Bloggers">
  <button class="button is-link is-medium">
    <span class="icon is-large">
      <i class="fab fa-r-project"></i>
    </span>
    <span>As seen on R Bloggers</span>
  </button>
</a>
</p>
</div>
</div>

      