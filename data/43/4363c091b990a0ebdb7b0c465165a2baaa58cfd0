 
          <p>You all knew this was coming. After <a href="/post/2026/01/thinking-about-email-workflows/">thinking about my email workflow</a> I had to put it to practice. The grand plan was to force myself to learn more about Emacs by doing email in it with the added advantage of freeing up Mac Mail to manage my Exchange work emails there. Anything is better than staring at that dreaded Outlook web interface.</p>
<p>There are tons of cool blog posts out there about <code>mbsync</code>, <code>mu</code>, and <code>mu4e</code> configuration&mdash;this one&rsquo;s mine. Most focus on how to set up mbsync which is the CLI tool that syncs your IMAP account with a local folder for mu to index. The process is fairly straightforward: the only tricky thing to do is use macOS&rsquo;s password keyring to store the IMAP password and export a copy of the certificates for the handshake:</p>
<pre tabindex="0"><code>IMAPAccount brainbaking
Host imap.myserver.org
User wouter@myserver.org
PassCmd &#34;security find-generic-password -s mu4e-brainbaking-mailbox -a wouter@brainbaking.com -w&#34;
Port 993
TLSType IMAPS
AuthMechs Login
CertificateFile ~/Databases/maildir/certificates/root-certificates.pem
</code></pre><p>Instead, I&rsquo;d like to focus on <code>mu4e</code> configuration, as most of my sweat originated from that direction. You can find the full config at <a href="https://codeberg.org/wouterg/bakemacs/src/branch/main/config/mailbox.el">my &ldquo;bakemacs&rdquo; Codeberg repository</a>. I customized the hell out of it.</p>
<h2 id="vertical-layout">Vertical Layout</h2>
<p>First and foremost, I hate the default UI of mu4e. Splitting windows horizontally when opening an email just feels like a giant amount of wasted space. Any other sane email client splits vertically, usually in the popular three-column mode. The first column, a quick jump to your folders, isn&rsquo;t needed thanks to the shortcuts.</p>
<p>Changing the split config is very easy: <code>(setq mu4e-split-view 'vertical)</code>. Fiddle with <code>mu4e-headers-visible-columns</code> to get that percentage header/view just right (mine&rsquo;s at <code>40</code>):</p>
<p>But then the first buffer becomes completely useless because mu4e&rsquo;s header columns are sorted in a weird way. The from and subject columns are last which will be covered by the mail you just opened. Quickly scrolling through mails with <code>n</code> (next) and <code>p</code> (previous) loses its meaning. But mixing that up isn&rsquo;t that easy as the last column with a width of <code>nil</code> is the only one that can take up the remaining room. Additionally, since I use <code>consult-mu</code>, I want the headers to be consistent.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1">defun</span> bb/mu4e-header-layout <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">&amp;optional</span> for-consult<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;Calculate header widths based on current frame width.
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">If FOR-CONSULT is non-nil, use :date instead of :human-date.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">let*</span> <span style="color:#eceff4">((</span>width <span style="color:#eceff4">(</span>frame-width<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>         <span style="color:#eceff4">(</span>fixed-space <span style="color:#eceff4">(</span><span style="color:#88c0d0">+</span> <span style="color:#b48ead">20</span> <span style="color:#b48ead">12</span> <span style="color:#b48ead">12</span> <span style="color:#b48ead">6</span><span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>         <span style="color:#eceff4">(</span>subject-width <span style="color:#eceff4">(</span><span style="color:#88c0d0">max</span> <span style="color:#b48ead">20</span> <span style="color:#eceff4">(</span><span style="color:#88c0d0">-</span> width fixed-space <span style="color:#b48ead">10</span><span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>         <span style="color:#eceff4">(</span>date-field <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">if</span> for-consult <span style="color:#a3be8c">:date</span> <span style="color:#a3be8c">:human-date</span><span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">`</span><span style="color:#eceff4">((</span><span style="color:#a3be8c">:from</span>       <span style="color:#81a1c1">.</span> <span style="color:#b48ead">20</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#eceff4">(</span><span style="color:#a3be8c">:subject</span>    <span style="color:#81a1c1">.</span> <span style="color:#81a1c1">,</span>subject-width<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#eceff4">(</span><span style="color:#a3be8c">:flags</span>      <span style="color:#81a1c1">.</span> <span style="color:#b48ead">6</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#eceff4">(</span><span style="color:#a3be8c">:short-maildir</span> <span style="color:#81a1c1">.</span> <span style="color:#b48ead">12</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#eceff4">(</span><span style="color:#81a1c1">,</span>date-field <span style="color:#81a1c1">.</span> <span style="color:#b48ead">12</span><span style="color:#eceff4">))))</span>
</span></span></code></pre></div><p>Wait a minute, what&rsquo;s <code>:short-maildir</code>? That doesn&rsquo;t exist! Well, it does now:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#616e87;font-style:italic">;; unclutter that :maildir column please</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>add-to-list <span style="color:#a3be8c">&#39;mu4e-header-info-custom</span>
</span></span><span style="display:flex;"><span>               <span style="color:#81a1c1">&#39;</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">:short-maildir</span> <span style="color:#81a1c1">.</span>
</span></span><span style="display:flex;"><span>								<span style="color:#eceff4">(</span><span style="color:#a3be8c">:name</span> <span style="color:#a3be8c">&#34;Short Maildir&#34;</span>
</span></span><span style="display:flex;"><span>								 <span style="color:#a3be8c">:shortname</span> <span style="color:#a3be8c">&#34;Folder&#34;</span>
</span></span><span style="display:flex;"><span>								 <span style="color:#a3be8c">:help</span> <span style="color:#a3be8c">&#34;Maildir without account prefix&#34;</span>
</span></span><span style="display:flex;"><span>								 <span style="color:#a3be8c">:function</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1">lambda</span> <span style="color:#eceff4">(</span>msg<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>											 <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">let</span> <span style="color:#eceff4">((</span>maildir <span style="color:#eceff4">(</span>mu4e-message-field msg <span style="color:#a3be8c">:maildir</span><span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>											   <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">if</span> maildir
</span></span><span style="display:flex;"><span>												   <span style="color:#eceff4">(</span>replace-regexp-in-string <span style="color:#a3be8c">&#34;^/?brainbaking/?&#34;</span> <span style="color:#a3be8c">&#34;&#34;</span> maildir<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>												 <span style="color:#a3be8c">&#34;&#34;</span><span style="color:#eceff4">))))))</span>
</span></span></code></pre></div><p>No wonder the <code>:maildir</code> column isn&rsquo;t used by default. Then, wire the header layout function to both <code>mu4e-headers-fields</code> and <code>consult-mu-headers-fields</code>. The result:</p>
<p>
<figure><a href="https://brainbaking.com/post/2026/01/customizing-the-emacs-email-experience-with-mu4e/mu4e-splitscreen.jpg" class="lbox">
		<img src="https://brainbaking.com/post/2026/01/customizing-the-emacs-email-experience-with-mu4e/mu4e-splitscreen.jpg" loading="lazy" title="mu4e:view with a mu4e:headers buffer to the left." data-pagefind-index-attrs="title">
	</a>
	
		<figcaption>mu4e:view with a mu4e:headers buffer to the left.</figcaption></figure>
</p>
<p>To discourage Emacs from opening the HTML version first in case both MIME parts are there just like in the screenshot, set <code>mm-discouraged-alternatives '(&quot;text/html&quot; &quot;text/richtext&quot;)</code>. If you receive a lot of HTML email with weird CSS colors, this might be handy too:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1">defun</span> bb/mu4e-view-force-clean-html <span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;Render HTML using current theme colors by disabling SHR colors.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>interactive<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span><span style="color:#88c0d0">require</span> <span style="color:#a3be8c">&#39;shr</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">let</span> <span style="color:#eceff4">((</span>shr-use-colors <span style="color:#8fbcbb">nil</span><span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">(</span>mu4e-view-refresh<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>message <span style="color:#a3be8c">&#34;HTML colors stripped.&#34;</span><span style="color:#eceff4">))</span>
</span></span></code></pre></div><h2 id="threading-niceties">Threading Niceties</h2>
<p>Mu4e feels like a classic eighties text-based terminal app. No wonder conversation mode doesn&rsquo;t exist&mdash;but it makes up for that with the shortcuts (once you&rsquo;re familiar with them) and the threading view options it provides.</p>
<p>Yet my <code>bb/mu4e-header-layout</code> completely screwed up that because the last column isn&rsquo;t the &ldquo;flexible&rdquo; column anymore. Whoops. Most other blog posts seem to prefer horizontal splits as well. Digging into <code>mu4e-thread.el</code>, I discover a way to simply overwrite the logic:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>with-eval-after-load <span style="color:#a3be8c">&#39;mu4e-thread</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">(</span><span style="color:#81a1c1">defun</span> mu4e-thread-fold-info <span style="color:#eceff4">(</span><span style="color:#88c0d0">count</span> unread<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a3be8c">&#34;A compact, single-line replacement for folded thread info fixing custom col logic.&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">let</span> <span style="color:#eceff4">((</span>msg <span style="color:#eceff4">(</span><span style="color:#88c0d0">format</span> <span style="color:#a3be8c">&#34;\t[+%d%s messages in thread]\n&#34;</span> <span style="color:#88c0d0">count</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">(</span><span style="color:#88c0d0">&gt;</span> unread <span style="color:#b48ead">0</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">(</span><span style="color:#88c0d0">format</span> <span style="color:#a3be8c">&#34;, %d!&#34;</span> unread<span style="color:#eceff4">)</span> <span style="color:#a3be8c">&#34;&#34;</span><span style="color:#eceff4">))))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">(</span>propertize msg <span style="color:#a3be8c">&#39;face</span> <span style="color:#a3be8c">&#39;mu4e-thread-fold-face</span><span style="color:#eceff4">))))</span>
</span></span></code></pre></div><p>There, better. How about we add a quick way to fold and unfold all these conversations?</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1">defun</span> bb/mu4e-toggle-thread-folding <span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;Toggle between folding and unfolding all threads.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>interactive<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">if</span> mu4e-thread--fold-status
</span></span><span style="display:flex;"><span>      <span style="color:#eceff4">(</span>mu4e-thread-unfold-all<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">(</span>mu4e-thread-fold-all<span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1">defun</span> bb/mu4e-toggle-thread-related <span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;Toggle mu4e-headers-include-related and refresh the view.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>interactive<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">setq</span> mu4e-headers-include-related <span style="color:#eceff4">(</span><span style="color:#88c0d0">not</span> mu4e-headers-include-related<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>mu4e-headers-rerun-search<span style="color:#eceff4">))</span>
</span></span></code></pre></div><p><code>include-related</code> integrates your sent mails into the thread just like a conversation but quickly turns the view into a mess, hence the toggle. I bound these to <code>z</code> and <code>Z</code>. The result:</p>
<p>
<figure><a href="https://brainbaking.com/post/2026/01/customizing-the-emacs-email-experience-with-mu4e/mu4e-threading.gif" class="lbox">
		<img src="https://brainbaking.com/post/2026/01/customizing-the-emacs-email-experience-with-mu4e/mu4e-threading.gif" loading="lazy" title="Showcasing the threading and related threading toggles in mu4e:view mode." data-pagefind-index-attrs="title">
	</a>
	
		<figcaption>Showcasing the threading and related threading toggles in mu4e:view mode.</figcaption></figure>
</p>
<p>The decent column colours come from the package <code>mu4e-column-faces</code>. The flags can be souped up with fancy variants by setting <code>mu4e-use-fancy-chars</code> and pairing simple with fancy char (e.g. <code>mu4e-headers-attach-mark '(&quot;a&quot; . &quot;ðŸ“Ž&quot;)</code>). I prefer using nerd icons like everywhere else but haven&rsquo;t yet figured out how to do so.</p>
<h2 id="syncing-spam-rules">Syncing, Spam, Rules</h2>
<p>You can simply instruct mu4e to use an external syncing tool by setting <code>mu4e-get-mail-command</code> to <code>&quot;mbsync -a&quot;</code>. I used to hack it with the value <code>&quot;true&quot;</code> and then add an Elisp hook to execute the shell command myself in order to jam in <code>bogofilter</code> as a spam filter but that screws up the async fetch logic. The problems don&rsquo;t stop with spam filtering: I also want to apply some simple rules that automatically move incoming mails to certain IMAP folders. Mu4e doesn&rsquo;t work like that, you&rsquo;re supposed to use labels and leave things as is, but I&rsquo;d rather not.</p>
<p>With some help from my friend Gemini to identify the right functions, I came up with this:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1">defun</span> bb/mu4e-filter-inbox <span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;Move files manually and strip UIDs with a silent Bogofilter check.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>interactive<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">let*</span> <span style="color:#eceff4">((</span>match-count <span style="color:#b48ead">0</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#eceff4">(</span>base-dir <span style="color:#eceff4">(</span>mu4e-root-maildir<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>         <span style="color:#eceff4">(</span>mu-find-cmd <span style="color:#eceff4">(</span><span style="color:#88c0d0">format</span> <span style="color:#a3be8c">&#34;mu find maildir:%s --format=plain --fields=l&#34;</span> mu4e-inbox-folder<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>         <span style="color:#eceff4">(</span>paths <span style="color:#eceff4">(</span>split-string <span style="color:#eceff4">(</span>shell-command-to-string mu-find-cmd<span style="color:#eceff4">)</span> <span style="color:#a3be8c">&#34;\n&#34;</span> <span style="color:#8fbcbb">t</span><span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">(</span><span style="color:#81a1c1">dolist</span> <span style="color:#eceff4">(</span>old-path paths<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#616e87;font-style:italic">;; bogofilter output: 0 = spam, 1 = ham, 2 = unsure.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">let*</span> <span style="color:#eceff4">((</span>is-spam <span style="color:#eceff4">(</span><span style="color:#88c0d0">=</span> <span style="color:#b48ead">0</span> <span style="color:#eceff4">(</span>call-process <span style="color:#a3be8c">&#34;bogofilter&#34;</span> <span style="color:#8fbcbb">nil</span> <span style="color:#8fbcbb">nil</span> <span style="color:#8fbcbb">nil</span> <span style="color:#a3be8c">&#34;&lt;&#34;</span> old-path<span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>             <span style="color:#eceff4">(</span>target-dir <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">if</span> is-spam <span style="color:#a3be8c">&#34;/brainbaking/Junk/new&#34;</span>
</span></span><span style="display:flex;"><span>                           <span style="color:#eceff4">(</span>bb/mu4e--match-rule old-path mu4e-inbox-rules<span style="color:#eceff4">))))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#eceff4">(</span><span style="color:#81a1c1">when</span> target-dir
</span></span><span style="display:flex;"><span>          <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">let*</span> <span style="color:#eceff4">((</span>filename <span style="color:#eceff4">(</span>file-name-nondirectory old-path<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#eceff4">(</span>clean-name <span style="color:#eceff4">(</span>replace-regexp-in-string <span style="color:#a3be8c">&#34;,U=[0-9]+&#34;</span> <span style="color:#a3be8c">&#34;&#34;</span> filename<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#eceff4">(</span>new-path <span style="color:#eceff4">(</span>concat base-dir <span style="color:#eceff4">(</span>expand-file-name clean-name target-dir<span style="color:#eceff4">))))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#eceff4">(</span><span style="color:#88c0d0">rename-file</span> old-path new-path <span style="color:#8fbcbb">t</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">setq</span> match-count <span style="color:#eceff4">(</span><span style="color:#88c0d0">1+</span> match-count<span style="color:#eceff4">))))))</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">(</span><span style="color:#81a1c1">when</span> <span style="color:#eceff4">(</span><span style="color:#88c0d0">&gt;</span> match-count <span style="color:#b48ead">0</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">progn</span>
</span></span><span style="display:flex;"><span>        <span style="color:#eceff4">(</span>mu4e-update-index<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#eceff4">(</span>message <span style="color:#a3be8c">&#34;Filtered %d messages.&#34;</span> match-count<span style="color:#eceff4">)))))</span>
</span></span></code></pre></div><p>That&rsquo;s hooked into <code>mu4e-index-updated-hook</code>. What does this thing do?</p>
<ol>
<li>Find all email paths in the inbox folder (<code>mu4e-inbox-folder</code> is a custom var I made up) using <code>mu find</code>. I failed to find something working that mu4e provided.</li>
<li>For each path, ask bogofilter if this is spam. If yes, move to <code>/Junk/new</code>. If no, check the rules to see where it should end up in.</li>
<li>Move with <code>rename-file</code>, but strip the mu suffixes that already gave it an ID as this otherwise confuses mbsync/mu because we moved the file ourselves.</li>
<li>Re-index if anything happened to keep things in sync.</li>
</ol>
<p>Matching for rules is fairly straightforward:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1">defun</span> bb/mu4e--match-rule <span style="color:#eceff4">(</span>file rules<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;Search the first 10000 chars of FILE for RULES.
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">Return the target folder or nil.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>with-temp-buffer
</span></span><span style="display:flex;"><span>    <span style="color:#616e87;font-style:italic">;; a peu pres the header area (2000 was too narrow) to avoid dumping the entire mail in there</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">(</span>insert-file-contents file <span style="color:#8fbcbb">nil</span> <span style="color:#b48ead">0</span> <span style="color:#b48ead">10000</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">let</span> <span style="color:#eceff4">((</span>target <span style="color:#8fbcbb">nil</span><span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#eceff4">(</span><span style="color:#81a1c1">dolist</span> <span style="color:#eceff4">(</span>rule rules target<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#eceff4">(</span>goto-char <span style="color:#eceff4">(</span>point-min<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#eceff4">(</span><span style="color:#81a1c1">when</span> <span style="color:#eceff4">(</span>re-search-forward <span style="color:#eceff4">(</span><span style="color:#88c0d0">car</span> rule<span style="color:#eceff4">)</span> <span style="color:#8fbcbb">nil</span> <span style="color:#8fbcbb">t</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>          <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">setq</span> target <span style="color:#eceff4">(</span><span style="color:#88c0d0">cdr</span> rule<span style="color:#eceff4">)))))))</span>
</span></span><span style="display:flex;"><span>		  
</span></span><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">setq</span>   mu4e-inbox-rules <span style="color:#81a1c1">&#39;</span><span style="color:#eceff4">((</span><span style="color:#a3be8c">&#34;^From:.*Limited Run Games&#34;</span> <span style="color:#81a1c1">.</span> <span style="color:#a3be8c">&#34;/brainbaking/Mailinglists/new&#34;</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>						   <span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;^From:.*SBS&#34;</span> <span style="color:#81a1c1">.</span> <span style="color:#a3be8c">&#34;/brainbaking/Mailinglists/cur&#34;</span><span style="color:#eceff4">)))</span>
</span></span></code></pre></div><p>The function inserts the first 10k chars of the email file itself into a temp buffer and uses regex to match the rules. A few caveats: <code>From:</code> occurs more than once in a raw email file, search for the beginning of a line. Also, the first 2k chars wasn&rsquo;t enough, some headers contain a lot of junk. You could just as well dump everything in there but the limit is there just in case.</p>
<p>But what if we move an email to the junk folder ourselves&mdash;shouldn&rsquo;t we train bogofilter to identify future mails like that as spam? Ah yes:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1">defun</span> bb/mu4e-train-on-move <span style="color:#eceff4">(</span>docid msg target<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;Train bogofilter when moving to spam/inbox.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">let*</span> <span style="color:#eceff4">((</span>rel-path <span style="color:#eceff4">(</span>mu4e-message-field msg <span style="color:#a3be8c">:path</span><span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>		 <span style="color:#eceff4">(</span>abs-path <span style="color:#eceff4">(</span>expand-file-name rel-path <span style="color:#eceff4">(</span>mu4e-root-maildir<span style="color:#eceff4">))))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">(</span><span style="color:#81a1c1">cond</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#616e87;font-style:italic">;; Moving TO Junk</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#eceff4">((</span><span style="color:#88c0d0">string=</span> target mu4e-spam-folder<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">progn</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">(</span>shell-command <span style="color:#eceff4">(</span><span style="color:#88c0d0">format</span> <span style="color:#a3be8c">&#34;bogofilter -s &lt; %s&#34;</span> <span style="color:#eceff4">(</span>shell-quote-argument abs-path<span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#eceff4">(</span>message <span style="color:#a3be8c">&#34;Bogofilter: Trained SPAM (%s)&#34;</span> abs-path<span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#616e87;font-style:italic">;; Moving TO Inbox</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#eceff4">((</span><span style="color:#88c0d0">string=</span> target mu4e-inbox-folder<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#eceff4">(</span>shell-command <span style="color:#eceff4">(</span><span style="color:#88c0d0">format</span> <span style="color:#a3be8c">&#34;bogofilter -n &lt; %s&#34;</span> <span style="color:#eceff4">(</span>shell-quote-argument abs-path<span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#eceff4">(</span>message <span style="color:#a3be8c">&#34;Bogofilter: Trained HAM (%s)&#34;</span> abs-path<span style="color:#eceff4">)))))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic">;; hook this thing in like this:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>with-eval-after-load <span style="color:#a3be8c">&#39;mu4e</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">let</span> <span style="color:#eceff4">((</span>move-mark <span style="color:#eceff4">(</span>alist-get <span style="color:#a3be8c">&#39;move</span> mu4e-marks<span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#eceff4">(</span><span style="color:#81a1c1">setf</span> <span style="color:#eceff4">(</span>alist-get <span style="color:#a3be8c">&#39;move</span> mu4e-marks<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#eceff4">(</span>plist-put move-mark <span style="color:#a3be8c">:action</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#eceff4">(</span><span style="color:#81a1c1">lambda</span> <span style="color:#eceff4">(</span>docid msg target<span style="color:#eceff4">)</span> <span style="color:#616e87;font-style:italic">;; train and do the original server move</span>
</span></span><span style="display:flex;"><span>						 <span style="color:#eceff4">(</span>bb/mu4e-train-on-move docid msg target<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>						 <span style="color:#eceff4">(</span>mu4e--server-move docid target<span style="color:#eceff4">))))))</span>
</span></span></code></pre></div><p>I don&rsquo;t know if the hook hack is the right thing to do but this works.</p>
<h2 id="fixing-annoyances">Fixing Annoyances</h2>
<p>More annoyances? You&rsquo;d be starting to wonder why use mu4e at all, right? Because we can and because it&rsquo;s Lisp!</p>
<p>When marking mails for actions such as deleting and moving, after pressing <code>x</code> to execute all marks you still have to confirm with <code>y</code> or <code>n</code>. I hate that: I want <code>x</code> and that&rsquo;s it. Another hack to the rescue:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1">defun</span> bb/mu4e-mark-execute <span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;Execute mu4e mark all without asking for confirmation.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>interactive<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>mu4e-mark-execute-all <span style="color:#8fbcbb">t</span><span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic">;; hook this thing in like this:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">:bind</span> <span style="color:#eceff4">(</span><span style="color:#a3be8c">:map</span> mu4e-main-mode-map
</span></span><span style="display:flex;"><span>		 <span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;u&#34;</span> <span style="color:#81a1c1">.</span> mu4e-update-mail-and-index<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		 <span style="color:#a3be8c">:map</span> mu4e-headers-mode-map
</span></span><span style="display:flex;"><span>         <span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;z&#34;</span> <span style="color:#81a1c1">.</span> bb/mu4e-toggle-thread-folding<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Z&#34;</span> <span style="color:#81a1c1">.</span> bb/mu4e-toggle-thread-related<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		 <span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;s-f&#34;</span> <span style="color:#81a1c1">.</span> <span style="color:#88c0d0">#&#39;</span>consult-mu<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		 <span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;x&#34;</span> <span style="color:#81a1c1">.</span> bb/mu4e-mark-execute<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>		 <span style="color:#a3be8c">:map</span> mu4e-view-mode-map
</span></span><span style="display:flex;"><span>		 <span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;x&#34;</span> <span style="color:#81a1c1">.</span> bb/mu4e-mark-execute<span style="color:#eceff4">))</span>
</span></span></code></pre></div><p>The <code>:bind</code> solves another annoyance: updating in main mode is bound to the <code>U</code> key but I don&rsquo;t need that stinkin&rsquo; uppercase there. Also, since <code>s-f</code> is my <code>consult-line</code> anywhere else because I&rsquo;m coming from a more traditional editor, I have it pop up <code>consult-mu</code> here instead.</p>
<p>While debugging the spam filter function I occasionally required the full path of the open mail. Here&rsquo;s a handy function that adds it to your kill ring (that&rsquo;s Emacs l33t speak for &ldquo;clipboard history&rdquo;):</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1">defun</span> bb/mu4e-copy-message-path <span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;Copy the path of the current message to the `kill-ring`.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>interactive<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">let</span> <span style="color:#eceff4">((</span>path <span style="color:#eceff4">(</span>mu4e-message-field <span style="color:#eceff4">(</span>mu4e-message-at-point<span style="color:#eceff4">)</span> <span style="color:#a3be8c">:path</span><span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">(</span>kill-new path<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">(</span>message <span style="color:#a3be8c">&#34;Copied: %s&#34;</span> path<span style="color:#eceff4">)))</span>
</span></span></code></pre></div><h2 id="autocompleting-mac-contacts">Autocompleting Mac Contacts</h2>
<p>We&rsquo;re almost there. Yesterday I had the luminous idea to integrate Mac Contacts with mu4e. By default, when you enable auto-completion in compose mode, <code>TAB</code> fetches data from mu&rsquo;s indexes. That means you&rsquo;ll see email addresses from folks you&rsquo;ve already exchanged mails with. But I might have contacts saved (wired to our own CardDav server) where that&rsquo;s not the case. I discovered that this functionality is actually built into Emacs with <code>eudcb-macos-contacts</code>. Except that that didn&rsquo;t work.</p>
<p>Well, it didn&rsquo;t at first because I had Emacs running as a daemon using <code>launchctl</code> which is very strictly sandboxed and blocks any access to Contacts even though I explicitly approved it in the security settings. Now I run it as a simple login items startup shell script meaning it runs under my account.</p>
<p>And then it still didn&rsquo;t run <em>smoothly</em>: the autocomplete took 4 seconds to load because <code>eudcb</code> is ridiculously slow. So I went the other route and tried <code>contacts-cli</code>, a small tool that fetches info from Contacts leveraging Swift&rsquo;s native Mac-compliant capabilities. And that didn&rsquo;t work either because I couldn&rsquo;t get the tool to run. So I rolled my own, or rather, let Gemini do most of the rolling, as I don&rsquo;t know anything about Swift let alone the Mac-specific interfaces. It came up with a small script that I simply embedded into Elisp as a string:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1">defun</span> bb/mac-contacts-query <span style="color:#eceff4">(</span>str<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;Query macOS contacts for STR using a native Swift snippet.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span><span style="color:#81a1c1">unless</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1">or</span> <span style="color:#eceff4">(</span><span style="color:#8fbcbb">null</span> str<span style="color:#eceff4">)</span> <span style="color:#eceff4">(</span>string-empty-p <span style="color:#eceff4">(</span><span style="color:#88c0d0">string-trim</span> str<span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">let*</span> <span style="color:#eceff4">((</span>swift-code <span style="color:#eceff4">(</span><span style="color:#88c0d0">format</span> <span style="color:#a3be8c">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">import Contacts
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">let store = CNContactStore()
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">let keys = [CNContactGivenNameKey, CNContactFamilyNameKey, CNContactEmailAddressesKey] as [CNKeyDescriptor]
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">let predicate = CNContact.predicateForContacts(matchingName: \&#34;%s\&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">if let contacts = try? store.unifiedContacts(matching: predicate, keysToFetch: keys) {
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">    for c in contacts {
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">        for e in c.emailAddresses {
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">            let name = \&#34;\\(c.givenName) \\(c.familyName)\&#34;.trimmingCharacters(in: .whitespaces)
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">            print(\&#34;\\(name) &lt;\\(e.value)&gt;\&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">        }
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">    }
</span></span></span><span style="display:flex;"><span><span style="color:#a3be8c">}&#34;</span> str<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>           <span style="color:#eceff4">(</span>cmd <span style="color:#eceff4">(</span><span style="color:#88c0d0">format</span> <span style="color:#a3be8c">&#34;echo %s | swift -&#34;</span> <span style="color:#eceff4">(</span>shell-quote-argument swift-code<span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>           <span style="color:#eceff4">(</span>results <span style="color:#eceff4">(</span>shell-command-to-string cmd<span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#eceff4">(</span><span style="color:#81a1c1">unless</span> <span style="color:#eceff4">(</span>string-empty-p <span style="color:#eceff4">(</span><span style="color:#88c0d0">string-trim</span> results<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#eceff4">(</span>delete-dups <span style="color:#eceff4">(</span>split-string <span style="color:#eceff4">(</span><span style="color:#88c0d0">string-trim</span> results<span style="color:#eceff4">)</span> <span style="color:#a3be8c">&#34;\n&#34;</span> <span style="color:#8fbcbb">t</span><span style="color:#eceff4">))))))</span>
</span></span></code></pre></div><p>The output of <code>(bb/mac-contacts-query &quot;wouter&quot;)</code> then becomes <code>(&quot;Wouter Groeneveld &lt;emailaddress@domain.be&gt;&quot;)</code>. Cool! But how do we hook this into the existing mu4e autocomplete that already serves mu&rsquo;s indexed email addresses? Use <a href="https://github.com/minad/cape">Cape&rsquo;s Super-Capf</a> that merges stuff into a giant completion at point function:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1">defun</span> bb/mac-contacts-capf <span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;Cape-compatible CAPF for macOS contacts via Swift.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">let</span> <span style="color:#eceff4">((</span>bounds <span style="color:#eceff4">(</span>bounds-of-thing-at-point <span style="color:#a3be8c">&#39;symbol</span><span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#616e87;font-style:italic">;; Check if we are actually in a header field (To, Cc, Bcc)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">(</span><span style="color:#81a1c1">when</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1">and</span> bounds <span style="color:#eceff4">(</span>save-excursion
</span></span><span style="display:flex;"><span>                        <span style="color:#eceff4">(</span>beginning-of-line<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#eceff4">(</span>looking-at <span style="color:#a3be8c">&#34;^\\(To\\|Cc\\|Bcc\\):&#34;</span><span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#eceff4">(</span><span style="color:#8fbcbb">list</span> <span style="color:#eceff4">(</span><span style="color:#88c0d0">car</span> bounds<span style="color:#eceff4">)</span> <span style="color:#eceff4">(</span><span style="color:#88c0d0">cdr</span> bounds<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#eceff4">(</span>bb/mac-contacts-query <span style="color:#eceff4">(</span>buffer-substring-no-properties <span style="color:#eceff4">(</span><span style="color:#88c0d0">car</span> bounds<span style="color:#eceff4">)</span> <span style="color:#eceff4">(</span><span style="color:#88c0d0">cdr</span> bounds<span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a3be8c">:exclusive</span> <span style="color:#a3be8c">&#39;no</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a3be8c">:company-kind</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1">lambda</span> <span style="color:#eceff4">(</span>_<span style="color:#eceff4">)</span> <span style="color:#a3be8c">&#39;email</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a3be8c">:annotation-function</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1">lambda</span> <span style="color:#eceff4">(</span>_<span style="color:#eceff4">)</span> <span style="color:#a3be8c">&#34; [Mac]&#34;</span><span style="color:#eceff4">)))))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1">defun</span> bb/mu4e-compose-setup <span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a3be8c">&#34;Setup mu4e compose mode (proper corfu, spell et al stuff).&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>setq-local corfu-auto <span style="color:#8fbcbb">nil</span>
</span></span><span style="display:flex;"><span>			  completion-cycle-threshold <span style="color:#8fbcbb">nil</span>
</span></span><span style="display:flex;"><span>			  completion-at-point-functions <span style="color:#eceff4">(</span><span style="color:#8fbcbb">list</span>
</span></span><span style="display:flex;"><span>											 <span style="color:#eceff4">(</span>cape-capf-super
</span></span><span style="display:flex;"><span>											  <span style="color:#eceff4">(</span>cape-capf-properties <span style="color:#88c0d0">#&#39;</span>mu4e-complete-contact <span style="color:#a3be8c">:company-kind</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1">lambda</span> <span style="color:#eceff4">(</span>_<span style="color:#eceff4">)</span> <span style="color:#a3be8c">&#39;email</span><span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>											  <span style="color:#88c0d0">#&#39;</span>bb/mac-contacts-capf<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>											 <span style="color:#88c0d0">#&#39;</span>message-completion-function
</span></span><span style="display:flex;"><span>											 <span style="color:#88c0d0">#&#39;</span>ispell-completion-at-point<span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>auto-fill-mode <span style="color:#b48ead">-1</span><span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>toggle-input-method<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>corfu-mode <span style="color:#b48ead">1</span><span style="color:#eceff4">))</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">(</span>add-hook <span style="color:#a3be8c">&#39;mu4e-compose-mode-hook</span> <span style="color:#88c0d0">#&#39;</span>bb/mu4e-compose-setup<span style="color:#eceff4">)</span>
</span></span></code></pre></div><p>There, more annoyances fixed by disabling auto fill mode and telling Corfu to stay put until I press <code>TAB</code> myself. The keen Elisper will notice that we also wrapped the default <code>mu4e-complete-contact</code> to be able to inject a <code>:company-kind</code> lambda. This adds a nice icon to keep things consistent. Yes, you&rsquo;re right, <code>'email</code> is a symbol that doesn&rsquo;t exist in <code>nerd-icons</code>&mdash;just define it yourself with <code>'(email :style &quot;cod&quot; :icon &quot;mail&quot; :face font-lock-variable-name-face)</code>. The result:</p>
<p>
<figure><a href="https://brainbaking.com/post/2026/01/customizing-the-emacs-email-experience-with-mu4e/mu4e-autocomplete.gif" class="lbox">
		<img src="https://brainbaking.com/post/2026/01/customizing-the-emacs-email-experience-with-mu4e/mu4e-autocomplete.gif" loading="lazy" title="Autocompleting email addresses in the To: field in mu4e:compose mode." data-pagefind-index-attrs="title">
	</a>
	
		<figcaption>Autocompleting email addresses in the To: field in mu4e:compose mode.</figcaption></figure>
</p>
<p>Note the two test emails appearing with <code> [Mac]</code> suffixes: these come from Mac Contacts, while the first email address is a bogus one I emailed to in order to showcase the <code>capf</code> merge. The first time this triggers it&rsquo;s still a bit slow because of the Swift interpreter. I guess I can look into compiling that somehow? For now, I hope not to mess too much with the config anymore and to actually, you know, use it? Ah, the Emacs curse&hellip;</p>


          
          <p>
            Related topics: /
                  <a href="https://brainbaking.com/tags/emacs">emacs</a> /
                  <a href="https://brainbaking.com/tags/email">email</a> /</span>
          </p>
          
          <p>
            By <a href="/about">Wouter Groeneveld</a> on 15 January 2026.&nbsp;
            <a href="mailto:hifromrss@brainbaking.com?subject=Re: Customizing%20The%20Emacs%20Email%20Experience%20With%20Mu4e">Reply via email</a>.
          </p>
          
      