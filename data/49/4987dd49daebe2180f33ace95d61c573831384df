<p>
Since I've wrote <a href="https://eugene-andrienko.com/it/2020/09/26/thinkpad-x220-freebsd">post about my specific FreeBSD settings for Thinkpad X220</a>
near 5 years have passed. That post has a lot of additions and become a bit
messy. So, after I updated FreeBSD on my laptop up to 14.2 version and finally
found some time to carefully read a <a href="https://docs.freebsd.org/en/books/handbook/">"FreeBSD handbook"</a>, I decided to write a
new article about my configuration and about few useful utilities and tricks.
</p>

<p>
Few words about my setup. I use ZFS as a filesystem. The root filesystem
installed in the ZFS pool <code>zroot</code> which has two disks: first near a 500Â GB SSD
and second a 160Â Gb SSD:
</p>

<pre class="example">
 ~ % zpool status zroot
  pool: zroot
 state: ONLINE
  scan: scrub repaired 0B in 00:06:42 with 0 errors on Thu Feb 6 03:13:50 2025
config:

        NAME          STATE     READ WRITE CKSUM
        zroot         ONLINE       0     0     0
          ada0p3.eli  ONLINE       0     0     0
          ada2p3.eli  ONLINE       0     0     0

errors: No known data errors
 ~ % zpool list zroot
NAME    SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
zroot   579G   123G   456G        -         -     6%    21%  1.00x    ONLINE  -
</pre>

<p>
As you can see, I bravely traded reliability for read speedðŸ« . I hope that
snapshots and backups will save me.
</p>

<p>
And there is a third disk is in separate pool with a datasets for VMs (bhyve):
</p>

<pre class="example">
 ~ % zpool status hdd
  pool: hdd
 state: ONLINE
  scan: scrub repaired 0B in 00:01:37 with 0 errors on Thu Feb  6 03:08:49 2025
config:

        NAME        STATE     READ WRITE CKSUM
        hdd         ONLINE       0     0     0
          ada1      ONLINE       0     0     0

errors: No known data errors
 ~ % zfs list -r hdd
NAME              USED  AVAIL  REFER  MOUNTPOINT
hdd              10.2G   439G    96K  /hdd
hdd/vms          10.2G   439G  3.86G  /hdd/vms
hdd/vms/windows  6.39G   439G  6.39G  /hdd/vms/windows
</pre>

<p>
There is a <a href="https://eugene-andrienko.com/en/it/2024/12/21/thinkpad-x220-libreboot">Libreboot installed in the laptop</a> instead of BIOS. So my <code>loader</code>
starts in graphics mode, instead I've get problems with Libreboot built with
corebootfb.
</p>

<p>
As a WiFi card I use an Intel 8260 card with integrated WiFi and Bluetooth
(TL-8260D2W).
</p>

<p>
More information about my hardware you can read in <a href="https://eugene-andrienko.com/en/it/2024/07/07/thinkpad-x220-second-life">this post</a>.
</p>
<div class="outline-2">
<h2>TOC&#xa0;&#xa0;&#xa0;<span class="tag"></span></h2>
<div class="outline-text-2">
<ul class="org-ul">
<li><a href="#bootloader">Bootloader</a></li>
<li><a href="#drm">Direct Rendering Manager kernel module</a></li>
<li><a href="#boot-loader-conf">/boot/loader.conf</a></li>
<li><a href="#etc-rc-conf">/etc/rc.conf</a></li>
<li><a href="#etc-sysctl-conf">/etc/sysctl.conf</a></li>
<li><a href="#x-window-system">X Window System</a></li>
<li><a href="#power-management">Power management</a></li>
<li><a href="#networking">Networking</a>
<ul class="org-ul">
<li><a href="#usb-tethering">USB tethering</a></li>
</ul></li>
<li><a href="#storage">Storage</a></li>
<li><a href="#fingerprint-scanner">Fingerprint scanner</a></li>
<li><a href="#files-to-download">Files to download</a></li>
<li><a href="#notes">Notes</a></li>
</ul>
</div>
</div>
<div id="outline-container-bootloader" class="outline-2">
<h2 id="bootloader">Bootloader</h2>
<div class="outline-text-2" id="text-bootloader">
<p>
As <a href="https://libreboot.org/docs/bsd/#freebsd-and-corebootfb">stated in the Libreboot's site</a>, it doesn't works well with the FreeBSD
<code>loader</code>. If you install libreboot with <code>libgfxinit</code> (i.e. use binary with
<code>-corebootfb</code> suffix) and try to load FreeBSD, then you get a slim line on the
top of the screen instead of bootloader graphics and boot log of the FreeBSD
kernel and <code>init</code>. It looks like this:
</p>


<div class="figure">
<p><img src="/assets/static/freebsd_n_corebootfb.jpg" alt="Slim blue line on the top of the screen instead of the bsdinstall interface fullscreen" align="center" />
</p>
<p class="fignum"><i>Slim blue line instead of bsdinstall interface</i></p>
</div>

<p>
Fortunately, I found a workaround for this problem. If you booting the FreeBSD
installation media and the <code>loader</code> interface should appears on the screenÂ â€”
blindly press <code>Esc</code> and type <code>vbe on</code> and press <code>Enter</code>. After that the fullscreen
<code>loader</code> interface should appear and installation process should display on the
screen as usual.
</p>

<p>
If you already installed FreeBSD, then just add the next lines to the
<code>/boot/loader.conf</code>:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">1: </span>hw.vga.textmode=<span style="color: #009c8f;">"0"</span>
<span id="coderef-loader-conf-resolution" class="coderef-off"><span class="linenr">2: </span><span style="color: #0072d4;">vbe_max_resolution</span>=2560x1440</span>
</pre>
</div>

<p>
Don't forget to insert the actual resolution to the line
<a href="#coderef-loader-conf-resolution" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-resolution');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-resolution');">2</a>!
</p>

<p>
After switch to FreeBSDÂ 14.2 the things became more complicated. Because of
Netflix, the graphics mode from MBR bootloader <a href="https://www.freebsd.org/releases/14.2R/relnotes/#:~:text=removed%20support%20for%20graphics%20mode">was removed</a> and GZIP/BZIP2
compression takes its place. But this graphics mode was necessary for me to
see anything on the screen while system is booting. The previously described
trick doesn't work if bootloader lacks of graphics mode!
</p>

<p>
I found <a href="https://forums.freebsd.org/threads/freebsd-14-2-bootsplash-gone.96142/#post-684187">a solution</a> in the FreeBSD forum: just rebuild a loader with reverted
<a href="https://cgit.freebsd.org/src/commit/?id=4d3b05a8530e">4d3b05a8530e</a> commit and image on the display will be back. To achieve this I
did the next things:
</p>
<ol class="org-ol">
<li>Went to the <code>/usr/src/</code> catalog.</li>
<li>Because there is no Git repository in this catalog (in my case), I manually
reverted the changes from the aforementioned commit.</li>
<li><p>
Then I executed next set of commands:
</p>
<pre class="example">
cd /usr/src/stand/
make clean
make
make install
</pre>

<p>
I should note that <code>make clean install</code> command, suggested at the mentioned
forum's message, didn't completed successfully on my machine. That's why
there are three consequtive <code>make</code> calls on the code block above.
</p>

<p>
These calls should be completed without an errors.
</p></li>
<li>At this point the <code>loader</code> with graphics support should be already installed
in the <code>/boot</code> directory. So, after a reboot, the graphics interface of
bootloader and the boot log of the kernel should appear on the screen.</li>
</ol>
</div>
</div>
<div id="outline-container-drm" class="outline-2">
<h2 id="drm">Direct Rendering Manager kernel module</h2>
<div class="outline-text-2" id="text-drm">
<p>
<i>This section is applicable till 31 March 2025. After the FreeBSDÂ 14.1 EoL it
will be no longer neccessary.</i>
</p>

<p>
For now (February 2025) the drm-kmod kernel module is still building for
FreeBSDÂ 14.1. So when I updated to 14.2 release, I've got a drm-kmod for 14.1
kernel with 14.2 kernel. Of course it didn't work properly and I've got nor
text consoles neither boot log (after <code>init</code> start). Only the X-server works,
which is starting automatically on boot on my laptop.
</p>

<p>
There are two "default" options I've found in the Internet:
</p>
<ol class="org-ol">
<li>Don't update till 31 March 2025. After this date the drm-kmod will be built
for FreeBSDÂ 14.2 and it will be safe to update the system.</li>
<li>Update the system now and build proper DRM kernel module for 14.2 manually.</li>
</ol>

<p>
Fortunately, the <a href="https://mas.to/@patrizia@hachyderm.io">@patrizia@hachyderm.io</a> showed me the third option. There is
exists a special FreeBSD-kmods repository with drm-kmod, built for newly
released FreeBSD version.
</p>

<p>
Based on <a href="https://hachyderm.io/@patrizia/113897441053997542">this</a> and <a href="https://forums.freebsd.org/threads/new-install-of-14-2.96276/#post-684792">this</a>, the solution is simple:
</p>
<ol class="org-ol">
<li><p>
Add/edit the file <code>/usr/local/etc/pkg/repos/FreeBSD-kmods.conf</code>. It should
has the next contents for the system based on the quarterly releases:
</p>
<pre class="example">
FreeBSD-kmods: {
    url             : "pkg+https://pkg.freebsd.org/${ABI}/kmods_quarterly_${VERSION_MINOR}",
    enabled         : yes,
    priority        : 10,
    mirror_type     : "SRV",
    signature_type  : "FINGERPRINTS",
    fingerprints    : "/usr/share/keys/pkg"
}
</pre></li>
<li>Call <code>sudo pkg update</code> to check that the new repository is accessible.</li>
<li><p>
Check currently used drm-kmod version
</p>
<pre class="example">
% sudo pkg info | grep drm
drm-61-kmod-6.1.92.1402000_3   DRM drivers modules
drm-kmod-20220907_3            Metaport of DRM modules for the linuxkpi-based KMS components
</pre></li>
<li><p>
Check that this version (drm-61-kmod in my case) exists in FreeBSD-kmod repository:
</p>
<pre class="example">
% sudo pkg search -r FreeBSD-kmods drm
drm-515-kmod-5.15.160.1402000_2 DRM drivers modules
drm-61-kmod-6.1.92.1402000_3   DRM drivers modules
</pre></li>
<li><p>
Remove installed drm-kmod:
</p>
<pre class="example">
% sudo pkg remove drm-kmod drm-61-kmod
</pre></li>
<li><p>
And install drm-61-kmod from a proper repository:
</p>
<pre class="example">
% sudo pkg install -r FreeBSD-kmods drm-61-kmod &amp;&amp; sudo pkg install drm-kmod
</pre></li>
</ol>

<p>
After reboot the boot log and the text consoles are back!
</p>
</div>
</div>
<div id="outline-container-boot-loader-conf" class="outline-2">
<h2 id="boot-loader-conf">/boot/loader.conf</h2>
<div class="outline-text-2" id="text-boot-loader-conf">
<p>
There were two sections about FreeBSDÂ 14.2 specific things, which I've added
to the system after upgrading from 14.1. Now I'll write about the realðŸ˜Ž
system configuration.
</p>

<p>
Let's start with <code>/boot/loader.conf</code> â€” there is a configuration file for
<a href="https://man.freebsd.org/cgi/man.cgi?query=loader&amp;sektion=8&amp;format=html">loader(8)</a> â€” the 3rd stage bootloader, which loads the kernel. Most of
variables in this file are well described in <a href="https://man.freebsd.org/cgi/man.cgi?loader.conf">loader.conf(5)</a>.
</p>

<p>
The first section of my file describes <code>loader</code>-related configuration:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">1: </span><span style="color: #909995;">##################</span>
<span class="linenr">2: </span><span style="color: #909995;"># </span><span style="color: #909995;">Loader settings:</span>
<span class="linenr">3: </span><span style="color: #909995;">##################</span>
<span id="coderef-loader-conf-boot-delay" class="coderef-off"><span class="linenr">4: </span><span style="color: #0072d4;">autoboot_delay</span>=<span style="color: #009c8f;">"0"</span></span>
<span id="coderef-loader-conf-beastie" class="coderef-off"><span class="linenr">5: </span><span style="color: #0072d4;">beastie_disable</span>=<span style="color: #009c8f;">"YES"</span></span>
<span id="coderef-loader-conf-boot-mute" class="coderef-off"><span class="linenr">6: </span><span style="color: #0072d4;">boot_mute</span>=<span style="color: #009c8f;">"YES"</span></span>
<span class="linenr">7: </span><span style="color: #0072d4;">cpu_microcode_load</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr">8: </span><span style="color: #0072d4;">cpu_microcode_name</span>=<span style="color: #009c8f;">"/boot/firmware/intel-ucode.bin"</span>
</pre>
</div>

<p>
Lines <a href="#coderef-loader-conf-boot-delay" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-boot-delay');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-boot-delay');">4</a> and <a href="#coderef-loader-conf-beastie" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-beastie');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-beastie');">5</a> are used to skip the
<code>loader</code>'s interactive menu and boot the kernel right after the computer is
turned on. I can still jump to the <code>loader</code> console by pressing any key while
the <code>loader</code> is loading modules and preparing to load the kernel.
</p>

<p>
Line <a href="#coderef-loader-conf-boot-mute" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-boot-mute');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-boot-mute');">6</a> used to hide the kernel log during
loading. Instead, the nice white FreeBSD logo is displayed, just like in other
consumer OSes:
</p>


<div class="figure">
<p><img src="/assets/static/bootlogo.png" alt="black and white FreeBSD boot logo" align="center" />
</p>
<p class="fignum"><i>FreeBSD logo during the boot if boot_mute="YES"</i></p>
</div>

<p>
The last two lines allow loading <a href="https://en.wikipedia.org/wiki/Microcode">Intel CPU microcode</a> during kernel
loading. The <code>sysutils/cpu-microcode-intel</code> package should be installed first!
</p>

<p>
In the next section, there are lines with kernel modules that the <code>loader</code> will
load:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="linenr"> 9: </span><span style="color: #909995;">##################</span>
<span class="linenr">10: </span><span style="color: #909995;"># </span><span style="color: #909995;">Modules to load:</span>
<span class="linenr">11: </span><span style="color: #909995;">##################</span>
<span id="coderef-loader-conf-i915kms" class="coderef-off"><span class="linenr">12: </span><span style="color: #0072d4;">i915kms_load</span>=<span style="color: #009c8f;">"YES"</span></span>
<span id="coderef-loader-conf-aesni" class="coderef-off"><span class="linenr">13: </span><span style="color: #0072d4;">aesni_load</span>=<span style="color: #009c8f;">"YES"</span></span>
<span class="linenr">14: </span><span style="color: #0072d4;">cryptodev_load</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr">15: </span><span style="color: #0072d4;">geom_eli_load</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr">16: </span><span style="color: #0072d4;">zfs_load</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr">17: </span><span style="color: #0072d4;">libiconv_load</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr">18: </span><span style="color: #0072d4;">libmchain_load</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr">19: </span><span style="color: #0072d4;">cd9660_iconv_load</span>=<span style="color: #009c8f;">"YES"</span>
<span id="coderef-loader-conf-cd9660-iconv" class="coderef-off"><span class="linenr">20: </span><span style="color: #0072d4;">msdosfs_iconv_load</span>=<span style="color: #009c8f;">"YES"</span></span>
<span class="linenr">21: </span><span style="color: #0072d4;">acpi_ibm_load</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr">22: </span><span style="color: #0072d4;">acpi_video_load</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr">23: </span><span style="color: #0072d4;">acpi_dock_load</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr">24: </span><span style="color: #909995;"># </span><span style="color: #909995;">Load the H-TCP algorithm. It has a more aggressive ramp-up to max</span>
<span class="linenr">25: </span><span style="color: #909995;"># </span><span style="color: #909995;">bandwidth, and its optimized for high-speed, high-latency connections.</span>
<span id="coderef-loader-conf-cc-htcp" class="coderef-off"><span class="linenr">26: </span><span style="color: #0072d4;">cc_htcp_load</span>=<span style="color: #009c8f;">"YES"</span></span>
<span id="coderef-loader-conf-cpuctl" class="coderef-off"><span class="linenr">27: </span><span style="color: #0072d4;">cpuctl_load</span>=<span style="color: #009c8f;">"YES"</span></span>
<span class="linenr">28: </span><span style="color: #0072d4;">coretemp_load</span>=<span style="color: #009c8f;">"YES"</span>
<span id="coderef-loader-conf-sysctlinfo" class="coderef-off"><span class="linenr">29: </span><span style="color: #0072d4;">sysctlinfo_load</span>=<span style="color: #009c8f;">"YES"</span></span>
<span class="linenr">30: </span><span style="color: #0072d4;">sysctlbyname_improved_load</span>=<span style="color: #009c8f;">"YES"</span>
</pre>
</div>

<p>
Although these lines may look a bit crypticÂ â€” they aren't. Most of these lines
were added by the <code>bsdinstaller</code> during the installation process. The
instructions for loading modules may look like the same instructions from
<code>/etc/rc.conf</code>Â â€” but they should be placed in <code>/boot/loader.conf</code>. This is
necessary because these modules <b>must</b> be loaded before the system mounts the
disks using <a href="https://man.freebsd.org/cgi/man.cgi?rc(8)">rc(8)</a> scripts. Without them, the system won't be able to mount the
disks and initialize the other hardware properly. That's why modules should be
loaded by the <code>loader</code> before initialization scripts loading.
</p>

<ul class="org-ul">
<li>Line <a href="#coderef-loader-conf-i915kms" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-i915kms');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-i915kms');">12</a> was added by myselfÂ â€” it instructs to load kernel
mode setting<sup><a id="fnr.modesetting-wiki" class="footref" href="#fn.modesetting-wiki" role="doc-backlink">1</a></sup> module for the Intel integrated video
card. Without it, there was no graphical output, at least in the console.</li>
<li><p>
Lines from <a href="#coderef-loader-conf-aesni" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-aesni');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-aesni');">13</a> through <a href="#coderef-loader-conf-cd9660-iconv" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-cd9660-iconv');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-cd9660-iconv');">20</a> load the
storage-related kernel modules. Some modules (<code>aesni</code>, <code>cryptodev</code>, <code>geom_eli</code> and
<code>zfs)</code> were added during the installation process. They are needed to decrypt
the encrypted disk partitions, to decrypt them fast enough, and for ZFS
support.
</p>

<p>
The <code>libiconv</code>, <code>libmchain</code>, <code>cd9660_iconv</code> and <code>msdosfs_iconv</code> modules were added
by myself. They are needed for codeset conversion when the path on the
mounted filesystem is not in UTF-8 but in something like CP1251, CP866,
etc. This usually happens when I mount some old ISOs from the 199Xs or
unpack some archives from the Windows XP era with Cyrillic filenames.
</p></li>
<li>Various <code>acpi_*</code> modules are needed to support Thinkpad-specific things:
<ul class="org-ul">
<li><a href="https://man.freebsd.org/cgi/man.cgi?query=acpi_ibm&amp;apropos=0&amp;sektion=4&amp;manpath=FreeBSD+14.2-RELEASE&amp;arch=default&amp;format=html">acpi_ibm(4)</a> provides access to Thinkpad-specific hardware available
through the ACPI interface. For example, ThinkLight status can be read via
<code>sysctl dev.acpi_ibm.0.thinklight</code>, and even enabled programmatically via
<code>sudo sysctl dev.acpi_ibm.0.thinklight=1</code>.</li>
<li><a href="https://man.freebsd.org/cgi/man.cgi?query=acpi_video&amp;apropos=0&amp;sektion=4&amp;manpath=FreeBSD+14.2-RELEASE&amp;arch=default&amp;format=html">acpi_video(4)</a> provides various controls for some video core outputs (LVDS,
VGA, etc).</li>
<li><a href="https://man.freebsd.org/cgi/man.cgi?query=acpi_dock&amp;apropos=0&amp;sektion=4&amp;manpath=FreeBSD+14.2-RELEASE&amp;arch=default&amp;format=html">acpi_dock(4)</a> is a docking station device driver.</li>
</ul></li>
<li>Line <a href="#coderef-loader-conf-cc-htcp" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-cc-htcp');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-cc-htcp');">26</a> was taken from <a href="https://www.sacredheartsc.com/blog/freebsd-14-on-the-desktop/">this blog post</a> to improve
performance when my laptop is connected to the Internet (my main use case).</li>
<li>The next two lines, starting at <a href="#coderef-loader-conf-cpuctl" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-cpuctl');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-cpuctl');">27</a>, are necessary to
access specific CPU-related information, such as CPUID or temperature, and
to perform CPU firmware updates.</li>
<li><p>
The last two lines, starting at <a href="#coderef-loader-conf-sysctlinfo" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-sysctlinfo');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-sysctlinfo');">29</a>, are added for
<a href="https://man.freebsd.org/cgi/man.cgi?query=mixertui&amp;sektion=8&amp;n=1">mixertui(8)</a>Â â€” an ncurses-like interface mixer for OSS:
</p>

<div class="figure">
<p><img src="/assets/static/mixertui.png" alt="Console interface for mixertui, with gauge controls for different sound inputs/outputs" align="center" />
</p>
<p class="fignum"><i>mixertui console interface</i></p>
</div></li>
</ul>

<p>
The last section contains some system settings. All of these settings are just
some <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;apropos=0&amp;sektion=8&amp;manpath=FreeBSD+14.2-RELEASE&amp;arch=default&amp;format=html">sysctl(8)</a> variables that are read-only on FreeBSD and can only be changed
by the <code>loader</code>.
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">31: </span><span style="color: #909995;">##################</span>
<span class="linenr">32: </span><span style="color: #909995;"># </span><span style="color: #909995;">System settings:</span>
<span class="linenr">33: </span><span style="color: #909995;">##################</span>
<span id="coderef-loader-conf-allow-destructive-dtrace" class="coderef-off"><span class="linenr">34: </span>security.bsd.allow_destructive_dtrace=0</span>
<span class="linenr">35: </span><span style="color: #909995;">#</span>
<span class="linenr">36: </span><span style="color: #909995;"># </span><span style="color: #909995;">Read only but tunable sysctl settings:</span>
<span class="linenr">37: </span><span style="color: #909995;">#</span>
<span id="coderef-loader-conf-enable-fbc" class="coderef-off"><span class="linenr">38: </span><span style="color: #909995;"># </span><span style="color: #909995;">Enable framebuffer compression for power saving:</span></span>
<span class="linenr">39: </span>compat.linuxkpi.i915_enable_fbc=1
<span class="linenr">40: </span><span style="color: #909995;"># </span><span style="color: #909995;">Try to skip unnecessary mode sets at boot time:</span>
<span id="coderef-loader-conf-fastboot" class="coderef-off"><span class="linenr">41: </span>compat.linuxkpi.i915_fastboot=1</span>
<span id="coderef-loader-conf-synaptics" class="coderef-off"><span class="linenr">42: </span>hw.psm.synaptics_support=1</span>
<span class="linenr">43: </span>hw.psm.trackpoint_support=1
<span id="coderef-loader-conf-kern" class="coderef-off"><span class="linenr">44: </span>kern.hz=100</span>
<span class="linenr">45: </span>kern.ipc.shmmni=<span style="color: #009c8f;">"1024"</span>
<span class="linenr">46: </span>kern.ipc.shmseg=<span style="color: #009c8f;">"1024"</span>
<span class="linenr">47: </span>kern.maxproc=<span style="color: #009c8f;">"100000"</span>
<span class="linenr">48: </span><span style="color: #909995;"># </span><span style="color: #909995;">Enable faster soreceive() implementation:</span>
<span id="coderef-loader-conf-soreceive" class="coderef-off"><span class="linenr">49: </span>net.inet.tcp.soreceive_stream=<span style="color: #009c8f;">"1"</span></span>
<span class="linenr">50: </span><span style="color: #909995;"># </span><span style="color: #909995;">Increase the network interface queue link - the default (50) is way</span>
<span class="linenr">51: </span><span style="color: #909995;"># </span><span style="color: #909995;">too low:</span>
<span id="coderef-loader-conf-queue-link" class="coderef-off"><span class="linenr">52: </span>net.isr.defaultqlimit=<span style="color: #009c8f;">"2048"</span></span>
<span class="linenr">53: </span>net.link.ifqmaxlen=<span style="color: #009c8f;">"2048"</span>
</pre>
</div>

<ul class="org-ul">
<li>The <a href="#coderef-loader-conf-allow-destructive-dtrace" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-allow-destructive-dtrace');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-allow-destructive-dtrace');">34</a>th line has been added by
<code>bsdinstall</code>. It removes DTrace's ability to work with system
internals<sup><a id="fnr.dtrace-internal" class="footref" href="#fn.dtrace-internal" role="doc-backlink">2</a></sup>.</li>
<li>The lines from <a href="#coderef-loader-conf-enable-fbc" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-enable-fbc');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-enable-fbc');">38</a> to <a href="#coderef-loader-conf-fastboot" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-fastboot');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-fastboot');">41</a> just
enable some nice features for my integrated Intel GMA X3100 video card.</li>
<li>Two lines starting at <a href="#coderef-loader-conf-synaptics" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-synaptics');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-synaptics');">42</a> line enable TrackPoint and
Synaptics touchpad support.</li>
<li>Four lines starting at <a href="#coderef-loader-conf-kern" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-kern');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-kern');">44</a> contain various kernel-related
handles that increase the defaults to make it more suitable for desktop
systems.</li>
<li>Line <a href="#coderef-loader-conf-soreceive" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-soreceive');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-soreceive');">49</a> and two lines after <a href="#coderef-loader-conf-queue-link" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-loader-conf-queue-link');" onmouseout="CodeHighlightOff(this, 'coderef-loader-conf-queue-link');">52</a>
were taken from someone's blogpost to increase the network performance of my
laptop.</li>
</ul>
</div>
</div>
<div id="outline-container-etc-rc-conf" class="outline-2">
<h2 id="etc-rc-conf">/etc/rc.conf</h2>
<div class="outline-text-2" id="text-etc-rc-conf">
<p>
The next main configuration file in FreeBSD is an <code>/etc/rc.conf</code>. Here, as
stated in <a href="https://man.freebsd.org/cgi/man.cgi?rc.conf(5)">rc.conf(5)</a>, stored the next settings:
</p>
<ul class="org-ul">
<li>Network configuration, including hostname, interface(s) configuration, etc.</li>
<li>List services to run at system startup.</li>
<li>Sometimes, it includes configuration for <b>system</b> services.</li>
</ul>

<p>
List of services already populated by <code>bsdinstaller</code>, but I've added a lot more:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="linenr"> 1: </span><span style="color: #909995;">####################</span>
<span class="linenr"> 2: </span><span style="color: #909995;"># </span><span style="color: #909995;">Services to start:</span>
<span class="linenr"> 3: </span><span style="color: #909995;">####################</span>
<span class="linenr"> 4: </span><span style="color: #0072d4;">local_unbound_enable</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr"> 5: </span><span style="color: #0072d4;">clear_tmp_enable</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr"> 6: </span><span style="color: #0072d4;">sshd_enable</span>=<span style="color: #009c8f;">"NO"</span>
<span class="linenr"> 7: </span><span style="color: #0072d4;">ntpd_enable</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr"> 8: </span><span style="color: #0072d4;">autofs_enable</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr"> 9: </span><span style="color: #0072d4;">zfs_enable</span>=<span style="color: #009c8f;">"YES"</span>
<span id="coderef-rc-conf-custom-lines" class="coderef-off"><span class="linenr">10: </span><span style="color: #0072d4;">dbus_enable</span>=<span style="color: #009c8f;">"YES"</span></span>
<span id="coderef-rc-conf-lightdm" class="coderef-off"><span class="linenr">11: </span><span style="color: #0072d4;">lightdm_enable</span>=<span style="color: #009c8f;">"YES"</span></span>
<span class="linenr">12: </span><span style="color: #0072d4;">powerd_enable</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr">13: </span><span style="color: #0072d4;">wifibox_enable</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr">14: </span><span style="color: #0072d4;">webcamd_enable</span>=<span style="color: #009c8f;">"YES"</span>
<span id="coderef-rc-conf-devmatch" class="coderef-off"><span class="linenr">15: </span><span style="color: #0072d4;">devmatch_enable</span>=<span style="color: #009c8f;">"YES"</span></span>
<span id="coderef-rc-conf-vm" class="coderef-off"><span class="linenr">16: </span><span style="color: #0072d4;">vm_enable</span>=<span style="color: #009c8f;">"YES"</span></span>
<span id="coderef-rc-conf-linux" class="coderef-off"><span class="linenr">17: </span><span style="color: #0072d4;">linux_enable</span>=<span style="color: #009c8f;">"YES"</span></span>
<span id="coderef-rc-conf-microcode-update" class="coderef-off"><span class="linenr">18: </span><span style="color: #0072d4;">microcode_update_enable</span>=<span style="color: #009c8f;">"YES"</span></span>
</pre>
</div>

<p>
My custom settings starting from line <a href="#coderef-rc-conf-custom-lines" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-rc-conf-custom-lines');" onmouseout="CodeHighlightOff(this, 'coderef-rc-conf-custom-lines');">10</a>. First, I enable
D-BusÂ â€” sadly, it is necessary for some programs even if I use i3wm, despite
it was created for KDE or GnomeÂ â€” for example for <del>Firefox</del> Librewolf and
<a href="https://fprint.freedesktop.org/">fprintd</a> utilities.
</p>

<p>
Then (<a href="#coderef-rc-conf-lightdm" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-rc-conf-lightdm');" onmouseout="CodeHighlightOff(this, 'coderef-rc-conf-lightdm');">11</a>), I enable LightDM serviceÂ â€” the nice and lightweight
login screen for X server:
</p>


<div class="figure">
<p><img src="/assets/static/lightdm.jpg" alt="LightDM login window" align="center" />
</p>
<p class="fignum"><i>LightDM login screen</i></p>
</div>

<p>
LightDM configuration for i3 was a bit tricky. But after some experiments I
added these lines to <code>/usr/local/etc/lightdm/lightdm.conf</code>:
</p>

<div class="org-src-container">
<pre class="src src-nil"><span class="linenr">1: </span>[Seat:*]
<span class="linenr">2: </span>xserver-share=true
<span class="linenr">3: </span>greeter-session=lightdm-gtk-greeter
<span class="linenr">4: </span>session-wrapper=/usr/local/etc/lightdm/Xsession
<span id="coderef-lightdm-conf-2k" class="coderef-off"><span class="linenr">5: </span>display-setup-script=xrandr --output DP-3 --primary --dpi 130</span>
</pre>
</div>

<p>
On the line <a href="#coderef-lightdm-conf-2k" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-lightdm-conf-2k');" onmouseout="CodeHighlightOff(this, 'coderef-lightdm-conf-2k');">5</a> there is a special command to properly setup X
server to display login screen on the right display with a right DPI.
</p>

<p>
Lets return to the <code>/etc/rc.conf</code>. Line <a href="#coderef-rc-conf-devmatch" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-rc-conf-devmatch');" onmouseout="CodeHighlightOff(this, 'coderef-rc-conf-devmatch');">15</a> enables auto-loading
of kernel modules with <a href="https://man.freebsd.org/cgi/man.cgi?query=devmatch&amp;sektion=8&amp;apropos=0&amp;manpath=FreeBSD+14.2-RELEASE+and+Ports">devmatch(8)</a>Â â€” I need it to blacklist some modules,
which is unnecessary in my configuration but load by default. And the line
<a href="#coderef-rc-conf-microcode-update" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-rc-conf-microcode-update');" onmouseout="CodeHighlightOff(this, 'coderef-rc-conf-microcode-update');">18</a> enables service to update CPU microcode on the
start (if package <code>sysutils/cpu-microcode-intel</code> is installed).
</p>

<p>
Then, I enable the <code>vm</code> service for <a href="https://github.com/churchers/vm-bhyve">bhyve-vm management console</a> (line
<a href="#coderef-rc-conf-vm" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-rc-conf-vm');" onmouseout="CodeHighlightOff(this, 'coderef-rc-conf-vm');">16</a>). And a <a href="https://docs.freebsd.org/en/books/handbook/linuxemu/">Linuxulator</a>Â â€” Linux compatibility layerÂ â€” on the line
<a href="#coderef-rc-conf-linux" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-rc-conf-linux');" onmouseout="CodeHighlightOff(this, 'coderef-rc-conf-linux');">17</a>. Usually it is not necessary for normal FreeBSD operation
because all necessary programs built for FreeBSD. I don't remember why I
enable it, maybe to launch Dwarf Fortress, may be to lauch <a href="https://cataclysmdda.org/">Cataclysm-DDA</a>.
</p>

<p>
The most of the system-related configuration is already populated by the
<code>bsdinstaller</code>. So I've just added the few lines:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">19: </span><span style="color: #909995;">#######################</span>
<span class="linenr">20: </span><span style="color: #909995;"># </span><span style="color: #909995;">System configuration:</span>
<span class="linenr">21: </span><span style="color: #909995;">#######################</span>
<span class="linenr">22: </span><span style="color: #0072d4;">hostname</span>=<span style="color: #009c8f;">"freebsd"</span>
<span id="coderef-rc-conf-kld-list" class="coderef-off"><span class="linenr">23: </span><span style="color: #0072d4;">kld_list</span>=<span style="color: #009c8f;">"fusefs ipsec ng_l2tp cuse"</span></span>
<span class="linenr">24: </span><span style="color: #0072d4;">syslogd_flags</span>=<span style="color: #009c8f;">"-ss"</span>
<span class="linenr">25: </span><span style="color: #909995;"># </span><span style="color: #909995;">Set dumpdev to "AUTO" to enable crash dumps, "NO" to disable</span>
<span class="linenr">26: </span><span style="color: #0072d4;">dumpdev</span>=<span style="color: #009c8f;">"NO"</span>
<span id="coderef-rc-conf-blacklist" class="coderef-off"><span class="linenr">27: </span><span style="color: #0072d4;">devmatch_blocklist</span>=<span style="color: #009c8f;">"if_iwm if_iwlwifi"</span></span>
</pre>
</div>

<ul class="org-ul">
<li>In the line <a href="#coderef-rc-conf-kld-list" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-rc-conf-kld-list');" onmouseout="CodeHighlightOff(this, 'coderef-rc-conf-kld-list');">23</a> I load some kernel modules: the <code>fusefs</code> and
the <code>cuse</code> modules. The first is necessary to work with <a href="https://en.wikipedia.org/wiki/Filesystem_in_Userspace">userspace
filesystems</a>. And the second is necessary for webcamd to operate with my
web-camera. Also, for some experiments with <a href="https://en.wikipedia.org/wiki/Layer_2_Tunneling_Protocol">L2TP</a> I load <code>ipsec</code> and <code>ng_l2tp</code>
modules.</li>
<li>And in the line <a href="#coderef-rc-conf-blacklist" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-rc-conf-blacklist');" onmouseout="CodeHighlightOff(this, 'coderef-rc-conf-blacklist');">27</a> I blacklisted modules for FreeBSD WiFiÂ â€”
because I use <a href="https://man.freebsd.org/cgi/man.cgi?query=wifibox&amp;apropos=0&amp;sektion=8&amp;manpath=freebsd-ports&amp;format=html">wifibox(8)</a>, all FreeBSD related wireless networking shouldn't
interfere with it.</li>
</ul>

<p>
The daemons' configuration also populated by <code>bsdinstaller</code>:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">28: </span><span style="color: #909995;">#########################</span>
<span class="linenr">29: </span><span style="color: #909995;"># </span><span style="color: #909995;">Services configuration:</span>
<span class="linenr">30: </span><span style="color: #909995;">#########################</span>
<span class="linenr">31: </span><span style="color: #0072d4;">ntpd_sync_on_start</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr">32: </span><span style="color: #0072d4;">moused_nondefault_enable</span>=<span style="color: #009c8f;">"NO"</span>
<span id="coderef-rc-conf-webcamd-conf" class="coderef-off"><span class="linenr">33: </span><span style="color: #0072d4;">webcamd_0_flags</span>=<span style="color: #009c8f;">"-d ugen0.5"</span></span>
<span id="coderef-rc-conf-vm-conf" class="coderef-off"><span class="linenr">34: </span><span style="color: #0072d4;">vm_dir</span>=<span style="color: #009c8f;">"zfs:hdd/vms"</span></span>
</pre>
</div>

<p>
Here I just added an option for <code>webcamd</code> to use only specified device as a my
web-camera (<a href="#coderef-rc-conf-webcamd-conf" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-rc-conf-webcamd-conf');" onmouseout="CodeHighlightOff(this, 'coderef-rc-conf-webcamd-conf');">33</a>), as written <a href="https://docs.freebsd.org/en/books/handbook/multimedia/index.html#webcam-setup">in documentation</a>. And
specified the separate ZFS pool on the thirdt HDD to use for my VMs.
</p>
</div>
</div>
<div id="outline-container-etc-sysctl-conf" class="outline-2">
<h2 id="etc-sysctl-conf">/etc/sysctl.conf</h2>
<div class="outline-text-2" id="text-etc-sysctl-conf">
<p>
The last main configuration file is a <code>/etc/sysctl.conf</code> with various system
variables.
</p>

<p>
The first section in my file is just a kernel-related settings:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="linenr"> 1: </span><span style="color: #909995;">##################</span>
<span class="linenr"> 2: </span><span style="color: #909995;"># </span><span style="color: #909995;">Kernel settings:</span>
<span class="linenr"> 3: </span><span style="color: #909995;">##################</span>
<span class="linenr"> 4: </span>kern.geom.label.disk_ident.enable=<span style="color: #009c8f;">"0"</span>
<span class="linenr"> 5: </span>kern.geom.label.gptid.enable=<span style="color: #009c8f;">"0"</span>
<span class="linenr"> 6: </span>kern.randompid=1
<span class="linenr"> 7: </span>kern.coredump=0
<span class="linenr"> 8: </span>kern.corefile=/dev/null
<span class="linenr"> 9: </span>kern.vt.enable_bell=0
<span class="linenr">10: </span><span style="color: #909995;"># </span><span style="color: #909995;">Make desktop more responsive under high CPU load:</span>
<span class="linenr">11: </span>kern.sched.preempt_thresh=224
<span class="linenr">12: </span><span style="color: #909995;"># </span><span style="color: #909995;">Prevent shared memory from being swapped to disk:</span>
<span class="linenr">13: </span>kern.ipc.shm_use_phys=1
</pre>
</div>

<p>
Aside from the first lines added by the <code>bsdinstaller</code> and the commented lines,
there are the following settings:
</p>
<ul class="org-ul">
<li>Coredumps are disabled</li>
<li>Bell on the console is also disabled.</li>
</ul>

<p>
The next section in the file is hardware-specific:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">14: </span><span style="color: #909995;">###################</span>
<span class="linenr">15: </span><span style="color: #909995;"># </span><span style="color: #909995;">Hardware setings:</span>
<span class="linenr">16: </span><span style="color: #909995;">###################</span>
<span id="coderef-sysctl-conf-trackpoint" class="coderef-off"><span class="linenr">17: </span>hw.psm.trackpoint.sensitivity=150</span>
<span class="linenr">18: </span>hw.psm.trackpoint.upper_plateau=125
<span class="linenr">19: </span>hw.syscons.bell=0
<span class="linenr">20: </span><span style="color: #909995;"># </span><span style="color: #909995;">Enable sleep:</span>
<span id="coderef-sysctl-conf-suspend" class="coderef-off"><span class="linenr">21: </span>hw.pci.do_power_suspend=0</span>
<span class="linenr">22: </span>hw.pci.do_power_nodriver=1
<span class="linenr">23: </span>hw.acpi.lid_switch_state=S3
<span class="linenr">24: </span>hw.acpi.sleep_button_state=S3
<span class="linenr">25: </span><span style="color: #909995;"># </span><span style="color: #909995;">Override ACPI coretemp values:</span>
<span id="coderef-sysctl-conf-acpi-thermal" class="coderef-off"><span class="linenr">26: </span>hw.acpi.thermal.user_override=1</span>
<span class="linenr">27: </span>hw.acpi.thermal.tz0._PSV=80C
<span class="linenr">28: </span>hw.acpi.thermal.tz1._PSV=80C
<span class="linenr">29: </span>hw.acpi.thermal.tz0._CRT=199C
<span class="linenr">30: </span>hw.acpi.thermal.tz1._CRT=199C
</pre>
</div>

<p>
Here are my specific trackpoint sensivity values, starting at
lineÂ <a href="#coderef-sysctl-conf-trackpoint" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-sysctl-conf-trackpoint');" onmouseout="CodeHighlightOff(this, 'coderef-sysctl-conf-trackpoint');">17</a>. I chose these numbers experimentally, to get
the best user experience.
</p>

<p>
The four lines starting atÂ <a href="#coderef-sysctl-conf-suspend" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-sysctl-conf-suspend');" onmouseout="CodeHighlightOff(this, 'coderef-sysctl-conf-suspend');">21</a>, configure the suspend
behavior for my laptop. The first two lines are from the FreeBSD forum. They
make my peripherals (especially the PCI Express card with USB3.0 ports in it)
work properly after the laptop wakes up. The last two lines tell the OS to go
to S3 state when I close the lid or press the sleep key (Fn+F4 on my Thinkpad
X220).
</p>

<p>
The five lines from <a href="#coderef-sysctl-conf-acpi-thermal" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-sysctl-conf-acpi-thermal');" onmouseout="CodeHighlightOff(this, 'coderef-sysctl-conf-acpi-thermal');">26</a> line are the <b>DANGEROUS</b> ones!
The first allows you to override thermal protections for the laptop. So, if
you configure something wrong, the laptop might meltðŸ« . The next two lines
lower the default temperature to disable the passive coolingÂ â€” the defaults
were set to 90Â°C, which is too high for me.
</p>

<p>
And the last two lines are necessary to prevent some weird behaviour of my
laptop when it wakes up from the sleep state. Due to a some bug in the
Libreboot, my ThinkPad X220 doing some hard calculations with it's CPU for a
second, when it is waking up. And this second is enough for ACPI to decide,
"on ho, the CPU is overheatingÂ â€” let's turn off the everything!"
</p>

<p>
So, to prevent this unwanted shutdown I added those two lines. For now, laptop
still overheats for a second (fan noise increases) but it is successfully
wakes up and working like a charm. And it is not melt (yet)!
</p>

<p>
The next few lines are filesystem specific settings. Most of these are also
set by <code>bsdinstaller</code>.
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">29: </span><span style="color: #909995;">###############</span>
<span class="linenr">30: </span><span style="color: #909995;"># </span><span style="color: #909995;">VFS settings:</span>
<span class="linenr">31: </span><span style="color: #909995;">###############</span>
<span id="coderef-sysctl-conf-usermount" class="coderef-off"><span class="linenr">32: </span>vfs.usermount=1</span>
<span class="linenr">33: </span>vfs.read_max=128
<span class="linenr">34: </span>vfs.zfs.min_auto_ashift=12 <span style="color: #909995;"># </span><span style="color: #909995;">4 KB blocks</span>
<span class="linenr">35: </span><span style="color: #909995;"># </span><span style="color: #909995;">Increase ZFS transaction timeout to save battery</span>
<span id="coderef-sysctl-conf-zfs-timeout" class="coderef-off"><span class="linenr">36: </span>vfs.zfs.txg.timeout=<span style="color: #009c8f;">"10"</span></span>
</pre>
</div>

<p>
I just made the following changes:
</p>
<ul class="org-ul">
<li>Allow user to mount filesystems in line <a href="#coderef-sysctl-conf-usermount" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-sysctl-conf-usermount');" onmouseout="CodeHighlightOff(this, 'coderef-sysctl-conf-usermount');">32</a>. Since I'm
the only one user of my laptop, I obviously allow myself to mount
filesystems from various USB drives, SD cards, etc.</li>
<li>The line <a href="#coderef-sysctl-conf-zfs-timeout" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-sysctl-conf-zfs-timeout');" onmouseout="CodeHighlightOff(this, 'coderef-sysctl-conf-zfs-timeout');">36</a> I took from the someone's blog. I can't
say that it significantly increases the battery life of the laptop&#x2026;</li>
</ul>

<p>
The next lines are not written by meÂ â€” I took them from <a href="https://www.sacredheartsc.com/blog/freebsd-14-on-the-desktop/">this blogpost</a>:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">37: </span><span style="color: #909995;">#############################</span>
<span class="linenr">38: </span><span style="color: #909995;"># </span><span style="color: #909995;">Network performance tuning:</span>
<span class="linenr">39: </span><span style="color: #909995;">#############################</span>
<span class="linenr">40: </span>kern.ipc.maxsockbuf=2097152
<span class="linenr">41: </span>kern.ipc.soacceptqueue=1024
<span class="linenr">42: </span>kern.ipc.somaxconn=1024
<span class="linenr">43: </span>net.inet.tcp.abc_l_var=44
<span class="linenr">44: </span>net.inet.tcp.cc.abe=1
<span class="linenr">45: </span>net.inet.tcp.cc.algorithm=htcp
<span class="linenr">46: </span>net.inet.tcp.cc.htcp.adaptive_backoff=1
<span class="linenr">47: </span>net.inet.tcp.cc.htcp.rtt_scaling=1
<span class="linenr">48: </span>net.inet.tcp.ecn.enable=1
<span class="linenr">49: </span>net.inet.tcp.fast_finwait2_recycle=1
<span class="linenr">50: </span>net.inet.tcp.fastopen.server_enable=1
<span class="linenr">51: </span>net.inet.tcp.finwait2_timeout=5000
<span class="linenr">52: </span>net.inet.tcp.initcwnd_segments=44
<span class="linenr">53: </span>net.inet.tcp.keepcnt=2
<span class="linenr">54: </span>net.inet.tcp.keepidle=62000
<span class="linenr">55: </span>net.inet.tcp.keepinit=5000
<span class="linenr">56: </span>net.inet.tcp.minmss=536
<span class="linenr">57: </span>net.inet.tcp.msl=2500
<span class="linenr">58: </span>net.inet.tcp.mssdflt=1448
<span class="linenr">59: </span>net.inet.tcp.nolocaltimewait=1
<span class="linenr">60: </span>net.inet.tcp.recvbuf_max=2097152
<span class="linenr">61: </span>net.inet.tcp.recvspace=65536
<span class="linenr">62: </span>net.inet.tcp.sendbuf_inc=65536
<span class="linenr">63: </span>net.inet.tcp.sendbuf_max=2097152
<span class="linenr">64: </span>net.inet.tcp.sendspace=65536
<span class="linenr">65: </span>net.local.stream.recvspace=65536
<span class="linenr">66: </span>net.local.stream.sendspace=65536
</pre>
</div>

<p>
The next lines were added when I was experimenting with sleep on my
librebooted laptop:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">67: </span><span style="color: #909995;">####################################################</span>
<span class="linenr">68: </span><span style="color: #909995;"># </span><span style="color: #909995;">Switch virtual consoles back and forth on suspend:</span>
<span class="linenr">69: </span><span style="color: #909995;">####################################################</span>
<span class="linenr">70: </span>kern.vt.suspendswitch=0
<span class="linenr">71: </span>hw.acpi.sleep_delay=0
<span class="linenr">72: </span>hw.acpi.verbose=1
</pre>
</div>

<p>
After librebooting my laptop and suddenly finding that my RTC battery is
deadÂ â€” I force the kernel to save system time to the RTC on system shutdown:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">73: </span><span style="color: #909995;">#######################</span>
<span class="linenr">74: </span><span style="color: #909995;"># </span><span style="color: #909995;">Save datetime to RTC:</span>
<span class="linenr">75: </span><span style="color: #909995;">#######################</span>
<span class="linenr">76: </span>machdep.disable_rtc_set=0
</pre>
</div>

<p>
Of course, I replaced the dead battery with the new one, but because I'm using
the laptop in the places where the Internet may not existsÂ â€” I'm really
dependent on the right time value from the RTC chip.
</p>
</div>
</div>
<div id="outline-container-x-window-system" class="outline-2">
<h2 id="x-window-system">X Window System</h2>
<div class="outline-text-2" id="text-x-window-system">
<p>
I still use the X server in all my computers because â€¦ it just works and
requires minimal or no configuration itself (unless you need very special
features). I read a lot of comments on Reddit where people blame the X server
for requiring manual configuration, problems with video output, freezes,
crashes, and so on. But I have never experienced such problems with my Radeon,
NVidia and Intel integrated cards. The last time I was forced to configure X
server by hand was almost 2006-2007<sup><a id="fnr.slackware" class="footref" href="#fn.slackware" role="doc-backlink">3</a></sup>. The problems usually came with
video drivers in the extremely customized systems, like Gentoo with a custom
kernel and FreeBSD on the machine with a soldered-on 2K expansion board and 2K
display.
</p>

<p>
On my BSD box I have these lines in
<code>/usr/local/etc/X11/xorg.conf.d/10-intel.conf</code> to get the nice transparency and
other effects with picom:
</p>
<div class="org-src-container">
<pre class="src src-nil"><span class="linenr"> 1: </span>Section "Device"
<span class="linenr"> 2: </span>    Identifier  "Card0"
<span class="linenr"> 3: </span>    Driver      "intel"
<span class="linenr"> 4: </span>    BusID       "PCI:0:2:0"
<span class="linenr"> 5: </span>    Option      "Accel"        "true"
<span class="linenr"> 6: </span>    Option      "AccelMethod"  "SNA"
<span class="linenr"> 7: </span>    Option      "DRI"          "3"
<span class="linenr"> 8: </span>    Option      "TearFree"     "true"
<span class="linenr"> 9: </span>EndSection
<span class="linenr">10: </span>
<span class="linenr">11: </span>Section "Module"
<span class="linenr">12: </span>    Load        "dri3"
<span class="linenr">13: </span>EndSection
</pre>
</div>

<p>
Sometimes I use an external IBMÂ MU29J ball mouse with two buttons:
</p>

<p>
    <img alt="IBM black ball mouse" src="/assets/images/uses/mouse.jpg"/>
</p>

<p>
So I added the next configuration for the X server to
<code>/usr/local/etc/X11/xorg.conf.d/20-ibm.conf</code>. This allows me to press the left
and right buttons at the same time to simulate pressing the middle button.
</p>

<div class="org-src-container">
<pre class="src src-nil"><span class="linenr">1: </span>Section "InputClass"
<span class="linenr">2: </span>    Identifier "IBM MU29J Mouse"
<span class="linenr">3: </span>    Driver "libinput"
<span class="linenr">4: </span>    MatchDevicePath "/dev/input/event9"
<span class="linenr">5: </span>    Option "MiddleEmulation" "on"
<span class="linenr">6: </span>    Option "AccelProfile" "flat"
<span class="linenr">7: </span>    Option "AccelSpeed" "1.0"
<span class="linenr">8: </span>EndSection
</pre>
</div>

<p>
The path <code>/dev/input/event9</code> is taken from <code>/var/log/Xorg.0.log</code>Â â€” it is printed
in this file after the mouse is connected.
</p>

<p>
The last custom configuration is a few lines to disable the touchpad when the
external mouse is connected and to send a click event when I tap on the
touchpad (it was disabled by default):
</p>

<div class="org-src-container">
<pre class="src src-nil"><span class="linenr">1: </span>Section "InputClass"
<span class="linenr">2: </span>    Identifier "X220 Touchpad"
<span class="linenr">3: </span>    MatchIsTouchpad "on"
<span class="linenr">4: </span>    MatchDevicePath "/dev/input/event*"
<span class="linenr">5: </span>    Driver "libinput"
<span class="linenr">6: </span>    Option "Tapping" "on"
<span class="linenr">7: </span>    Option "SendEventsMode" "disabled-on-external-mouse"
<span class="linenr">8: </span>EndSection
</pre>
</div>

<p>
I saved it as <code>/usr/local/etc/X11/xorg.conf.d/30-touchpad.conf</code> and after
restarting the X server, my touchpad automatically disables when the IBM mouse
is connected.
</p>
</div>
</div>
<div id="outline-container-power-management" class="outline-2">
<h2 id="power-management">Power management</h2>
<div class="outline-text-2" id="text-power-management">
<p>
To prolong life of the laptop when it's running on battery, I've just been
using the <a href="https://man.freebsd.org/cgi/man.cgi?powerd">powerd(8)</a> (this line from the <code>/etc/rc.conf</code>):
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0072d4;">powerd_enable</span>=<span style="color: #009c8f;">"YES"</span>
</pre>
</div>

<p>
All necessary configuration are also placed in the <code>/etc/rc.conf</code>:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">35: </span><span style="color: #909995;">######################</span>
<span class="linenr">36: </span><span style="color: #909995;"># </span><span style="color: #909995;">Power configuration:</span>
<span class="linenr">37: </span><span style="color: #909995;">######################</span>
<span class="linenr">38: </span><span style="color: #0072d4;">powerd_flags</span>=<span style="color: #009c8f;">"-a hiadaptive -b adaptive -i 75 -N -M 2000"</span>
<span class="linenr">39: </span><span style="color: #0072d4;">performance_cx_lowest</span>=<span style="color: #009c8f;">"Cmax"</span>
<span class="linenr">40: </span><span style="color: #0072d4;">economy_cx_lowest</span>=<span style="color: #009c8f;">"Cmax"</span>
</pre>
</div>

<p>
Here I just select the <code>hiadaptive</code> mode when the laptop is running on AC power
and the <code>adaptive</code> mode when it is running on battery. As described in the
powerd man page:
</p>

<pre class="example">
hiadaptive  Like adaptive mode, but tuned for systems where performance
            and interactivity are more important than power consump-
            tion.  It increases frequency faster, reduces frequency
            less aggressively, and will maintain full frequency for
            longer.  May be abbreviated as hadp.
</pre>

<pre class="example">
adaptive    Attempt to strike a balance by degrading performance when
            the system appears idle and increasing it when the system
            is busy.  It offers a good balance between a small perfor-
            mance loss for greatly increased power savings.  May be ab-
            breviated as adp.
</pre>

<p>
Then I slightly increase the CPU load percent level at which powerd will start
to degrade performance to save the battery power. The default was at 50% and I
set it to the 75%.
</p>

<p>
And I set the maximum frequency that powerd will use to 2Â GHz. Out of the box
my CPU can run at a maximum of 2.7Â GHz, but I don't need so much computation
power, so I keep it at 2Â GHz. The most CPU-intensive programÂ â€” Librewolf with
a YouTube video playing in a tabÂ â€” still works well with a 2Â GHz CPU.
</p>

<p>
But I don't like it when my CPU is too hot (close to 50-60Â°C) when I watch the
YouTube videos. So, in order to trade some silence for CPU temperature, I
install the <a href="https://github.com/claudiozz/bsdfan">bsdfan</a> utility. This little thing allows me to tweak the
temperature levels at which the fan starts spinning.
</p>

<p>
This daemon starts with these simple lines in <code>/etc/rc.local</code>:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #909995;">#</span><span style="color: #909995;">!/bin/</span><span style="color: #489100; font-weight: bold;">sh</span>

/usr/local/bin/bsdfan -d
</pre>
</div>

<p>
And to stop the daemon on system shutdown, these lines were added to the
<code>/etc/rc.shutdown.local</code>:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #909995;">#</span><span style="color: #909995;">!/bin/</span><span style="color: #489100; font-weight: bold;">sh</span>

/usr/bin/pkill bsdfan
</pre>
</div>

<p>
I use the default configuration file, placed in the <code>/usr/local/etc/bsdfan.conf</code>
with tweaked values that I choose experimentally:
</p>
<div class="org-src-container">
<pre class="src src-nil">#Levels are defined with: level(level_number, level_min_temperature, level_max_temperature)
#level_number goes from 0 (fan not active) to 7 (fan at full speed)
#not all levels have to be used

#the first level 'level_min_temperature' must be equal to 0 and the last level 'level_max_temperature' must be &gt;150
#please define levels in ascending order by level_number
#be careful

level (0,0,39)
level (1,38,46)
level (3,39,49)
level (4,44,51)
level (5,46,52)
level (7,49,32767)
</pre>
</div>
</div>
</div>
<div id="outline-container-networking" class="outline-2">
<h2 id="networking">Networking</h2>
<div class="outline-text-2" id="text-networking">
<p>
I have the two network interfaces on the laptop:
</p>
<ul class="org-ul">
<li><code>em0</code>Â â€” the Ethernet card</li>
<li><code>wlan0</code>Â â€” the WiFi card.</li>
</ul>

<p>
Speaking of Ethernet it's pretty easy to configure. Just ask the DHCP server
for the network configuration and do it in the background so the system
doesn't wait at boot time if it's not connected to any networks:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">41: </span><span style="color: #909995;">########################</span>
<span class="linenr">42: </span><span style="color: #909995;"># </span><span style="color: #909995;">Network configuration:</span>
<span class="linenr">43: </span><span style="color: #909995;">########################</span>
<span class="linenr">44: </span><span style="color: #0072d4;">ifconfig_em0</span>=<span style="color: #009c8f;">"DHCP"</span>
<span class="linenr">45: </span><span style="color: #0072d4;">ifconfig_em0_descr</span>=<span style="color: #009c8f;">"Ethernet"</span>
<span class="linenr">46: </span><span style="color: #0072d4;">background_dhclient</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr">47: </span><span style="color: #0072d4;">background_dhclient_em0</span>=<span style="color: #009c8f;">"YES"</span>
<span id="coderef-rc-conf-route-delay" class="coderef-off"><span class="linenr">48: </span><span style="color: #0072d4;">defaultroute_delay</span>=<span style="color: #009c8f;">"0"</span></span>
</pre>
</div>

<p>
LineÂ <a href="#coderef-rc-conf-route-delay" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-rc-conf-route-delay');" onmouseout="CodeHighlightOff(this, 'coderef-rc-conf-route-delay');">48</a> tells the system not to wait at boot while the
interface(s) are getting address(es) from DHCPÂ â€” it's also to speed up booting
when there are no networks.
</p>

<p>
The WiFi configuration is much trickier. Since I'm using an Intel 8260 WiFi
card<sup><a id="fnr.4" class="footref" href="#fn.4" role="doc-backlink">4</a></sup>, I can't (for now<sup><a id="fnr.freebsd-wifi" class="footref" href="#fn.freebsd-wifi" role="doc-backlink">5</a></sup>) rely on the default FreeBSD
drivers if I want to use the new enough IEEEÂ 802.11 standards. So I start
using the <a href="https://github.com/pgj/freebsd-wifibox">wifibox</a>:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0072d4;">wifibox_enable</span>=<span style="color: #009c8f;">"YES"</span>
</pre>
</div>

<p>
The system-side configuration is quite simple, and copies the configuration
for the <code>em0</code> interface:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">49: </span><span style="color: #0072d4;">ifconfig_wifibox0_descr</span>=<span style="color: #009c8f;">"WiFi (wifibox)"</span>
<span class="linenr">50: </span><span style="color: #0072d4;">ifconfig_wifibox0</span>=<span style="color: #009c8f;">"SYNCDHCP"</span>
<span class="linenr">51: </span><span style="color: #0072d4;">background_dhclient_wifibox0</span>=<span style="color: #009c8f;">"YES"</span>
</pre>
</div>

<p>
The configuration of the wifibox is well described in it's documentation and I
won't write about it here.
</p>
</div>
<div id="outline-container-usb-tethering" class="outline-3">
<h3 id="usb-tethering">USB tethering</h3>
<div class="outline-text-3" id="text-usb-tethering">
<p>
After reading the FreeBSD Handbook for the nth time, I found a few sentences
about USB tethering.
</p>

<p>
Back in the days, then phones didn't have the "smart" prefix, I used the cable
to connect my laptop to the Internet with my phone. The setup looks like this:
</p>
<ul class="org-ul">
<li>The phone connects to the Internet via the GPRS</li>
<li>The laptop connects to the phone via the USB cable</li>
<li>The driver in the OS (Linux) sees the phone as a usual modem (from the
dial-up era, of course).</li>
<li>Then the laptop can connect to the Internet via the <code>ppp</code>, just like in the
old days of 56K.</li>
</ul>

<p>
Times have changed and now smartphones can share their Internet connection via
WiFi. I have used this feature for some time. It has some advantagesÂ â€” for
example, if the WiFi interface is already configured on the system, then the
user should just connect to the right AP with the right password as usual to
connect to the Internet. There are also some disadvantagesÂ â€” the WiFi AP is
visible to everyone and the radio transmission drains the batteries of both
the laptop and the phone.
</p>

<p>
So I decided to experiment with USB tethering on the modern system to extend
the battery life and reduce the EMR for my devices. I used the Android phone,
other phones should use the different kernel modules<sup><a id="fnr.tethering-modules" class="footref" href="#fn.tethering-modules" role="doc-backlink">6</a></sup>.
</p>

<p>
On the FreeBSD side, the configuration is simpleÂ â€” I've just added the next
lines to <code>/etc/rc.conf</code> and rebooted:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">52: </span><span style="color: #0072d4;">if_urndis_load</span>=<span style="color: #009c8f;">"YES"</span>
<span class="linenr">53: </span><span style="color: #0072d4;">ifconfig_ue0</span>=<span style="color: #009c8f;">"DHCP"</span>
<span class="linenr">54: </span><span style="color: #0072d4;">ifconfig_ue0_descr</span>=<span style="color: #009c8f;">"Motorola Defy (tethering)"</span>
</pre>
</div>

<p>
On the phone side, the configuration is much easierÂ â€” just connect the phone
to the laptop with the USB cable and select "USB tethering" in the
notification area.
</p>

<p>
After that, the <code>dmesg</code> should show that the OS has recognized the device as a
USB Ethernet peripheral:
</p>
<pre class="example">
ugen1.2: &lt;unknown TrebleDroid vanilla&gt; at usbus1
ugen1.2: &lt;unknown TrebleDroid vanilla&gt; at usbus1 (disconnected)
ugen1.2: &lt;unknown TrebleDroid vanilla&gt; at usbus1
urndis0 on uhub0
urndis0: &lt;unknown TrebleDroid vanilla, class 0/0, rev 2.00/4.19, addr 1&gt; on usbus1
ue0: &lt;USB Ethernet&gt; on urndis0
ue0: Ethernet address: 16:b5:c1:e6:61:58
</pre>

<p>
Then, to establish the connection through the new interface, the following
commands can be issued:
</p>
<pre class="example">
# service netif restart ue0
# service dhclient restart ue0
</pre>

<p>
I wrote a simple script to connect over the phone without typing a lot of
commands:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #909995;">#</span><span style="color: #909995;">!/usr/bin/</span><span style="color: #489100; font-weight: bold;">env</span><span style="color: #909995;"> zsh</span>

<span style="color: #489100; font-weight: bold;">if</span> [ -f /usr/bin/x11-ssh-askpass ]; <span style="color: #489100; font-weight: bold;">then</span>
    <span style="color: #53676d; font-weight: bold;">export</span> <span style="color: #0072d4;">SUDO_ASKPASS</span>=<span style="color: #009c8f;">"/usr/bin/x11-ssh-askpass"</span>
<span style="color: #489100; font-weight: bold;">elif</span> [ -f /usr/local/bin/x11-ssh-askpass ]; <span style="color: #489100; font-weight: bold;">then</span>
    <span style="color: #53676d; font-weight: bold;">export</span> <span style="color: #0072d4;">SUDO_ASKPASS</span>=<span style="color: #009c8f;">"/usr/local/bin/x11-ssh-askpass"</span>
<span style="color: #489100; font-weight: bold;">else</span>
    <span style="color: #489100; font-weight: bold;">exit</span> 1
<span style="color: #489100; font-weight: bold;">fi</span>

<span style="color: #489100; font-weight: bold;">case</span> $(<span style="color: #53676d; font-weight: bold;">echo</span> <span style="color: #009c8f;">"disable wifi:phone connect:phone disconnect"</span> | rofi -dpi 0 -dmenu -sep <span style="color: #009c8f;">":"</span> -p <span style="color: #009c8f;">"Select"</span>) <span style="color: #489100; font-weight: bold;">in</span>
    <span style="color: #009c8f;">"disable wifi"</span>)
        sudo -A service wifibox stop
        ;;
    <span style="color: #009c8f;">"phone connect"</span>)
        sudo -A service netif stop em0
        sudo -A service wifibox stop
        sudo -A service netif restart ue0
        sudo -A service dhclient restart ue0
        ;;
    <span style="color: #009c8f;">"phone disconnect"</span>)
        sudo -A service netif restart
        sudo -A service wifibox restart
        sudo -A service dhclient restart em0
        sudo -A service dhclient restart wifibox0
        ;;
<span style="color: #489100; font-weight: bold;">esac</span>
</pre>
</div>

<p>
This code displays a rofi menu with the three items and runs the appropriate
commands with sudo. The sudo will ask for a password using the askpass facility and
then execute the necessary set of commands to enable/disable network
interfaces.
</p>
</div>
</div>
</div>
<div id="outline-container-storage" class="outline-2">
<h2 id="storage">Storage</h2>
<div class="outline-text-2" id="text-storage">
<p>
Let's review my storage-specific configuration. As you can see from the <a href="#etc-rc-conf">/etc/rc.conf</a> section, I'm using the <a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a> to automount the removable USB
drives with the next (default) configuration in the <code>/etc/auto_master</code>:
</p>
<pre class="example">
#
# Automounter master map, see auto_master(5) for details.
#
/net		-hosts		-nobrowse,nosuid,intr
# When using the -media special map, make sure to edit devd.conf(5)
# to move the call to "automount -c" out of the comments section.
/media		-media		-nosuid
</pre>

<p>
As you can see from the output of the <code>zpool status zroot</code> command at the top of
the postÂ â€” I am using two disks in a pool for the root filesystem. Some data
is written to the 500Â Gb SSD and some is written to the 150Â Gb SSD:
</p>
<pre class="example">
# zpool iostat -v zroot
                capacity     operations     bandwidth
pool          alloc   free   read  write   read  write
------------  -----  -----  -----  -----  -----  -----
zroot         97.1G   482G     59     17  6.26M   622K
  ada0p3.eli  35.3G  99.7G     21      7  2.26M   231K
  ada2p3.eli  61.9G   382G     38     10  3.99M   391K
------------  -----  -----  -----  -----  -----  -----
</pre>

<p>
There is no redundancyÂ â€” if one disk fails, the entire root filesystem
fails. So backups a very important to me.
</p>

<p>
ZFS comes to the rescue here! To make a snapshot of the root filesystem, I use
the next command (after the <code>@</code> symbol you can add any string you like, usually
the timestamp):
</p>
<pre class="example">
# zfs snapshot -r zroot@2025-03-09
</pre>

<p>
To check which snapshot was created, I use the next command for the <code>zroot</code>
mounted on the <code>/</code>:
</p>
<pre class="example">
% s ls -ls /.zfs/snapshot
total 255
17 drwxr-xr-x  20 root wheel   26B Jun 26  2024 2024-06-26-21:56:36-0/
17 drwxr-xr-x  20 root wheel   26B Jun 26  2024 2024-06-26-22:36:03-0/
17 drwxr-xr-x  20 root wheel   26B Jun 26  2024 2024-06-26-22:39:36-0/
17 drwxr-xr-x  20 root wheel   26B Jun 27  2024 2024-06-26-22:48:38-0/
17 drwxr-xr-x  20 root wheel   26B Aug 23  2024 2024-08-23-17:11:49-0/
17 drwxr-xr-x  20 root wheel   26B Sep  5  2024 2024-09-05-08:32:00-0/
17 drwxr-xr-x  20 root wheel   26B Oct 10 10:29 2024-10-10-10:58:23-0/
17 drwxr-xr-x  22 root wheel   28B Oct 30 20:09 2024-10-30-21:48:22-0/
17 drwxr-xr-x  22 root wheel   28B Jan 26 14:59 2025-01-26-17:15:24-0/
17 drwxr-xr-x  22 root wheel   28B Jan 26 17:17 2025-01-26-17:18:53-0/
17 drwxr-xr-x  22 root wheel   28B Feb  4 21:18 2025-02-04-21:20:58-0/
17 drwxr-xr-x  22 root wheel   28B Feb 10 01:32 2025-02-10-02:16:57-0/
17 drwxr-xr-x  22 root wheel   28B Feb 25 00:30 2025-02-25-00:45:45-0/
17 drwxr-xr-x  22 root wheel   28B Mar  9 10:40 2025-03-09/
17 drwxr-xr-x  21 root wheel   27B Oct 27 01:45 backup_recursive_2024-10-27/
</pre>

<p>
As you can see, there are a lot of outdated backups, mostly created by the
<code>freebsd-update</code> utility. I remove them with the <code>zfs destroy</code> command:
</p>
<pre class="example">
# zfs destroy -R zroot@backup_recursive_2024-10-27
# zfs destroy -R zroot/ROOT/default@2024-06-26-21:56:36-0
# zfs destroy -R zroot/ROOT/default@2024-06-26-22:36:03-0
# zfs destroy -R zroot/ROOT/default@2024-06-26-22:39:36-0
...
</pre>

<p>
After that, the only one (current) snapshot remains in the system:
</p>
<pre class="example">
# zfs list -r -t snapshot
NAME                            USED  AVAIL  REFER  MOUNTPOINT
zroot@2025-03-09                  0B      -    96K  -
zroot/ROOT@2025-03-09             0B      -    96K  -
zroot/ROOT/default@2025-03-09     0B      -  43.6G  -
zroot/home@2025-03-09             0B      -  49.9G  -
zroot/tmp@2025-03-09              0B      -   224K  -
zroot/usr@2025-03-09              0B      -    96K  -
zroot/usr/ports@2025-03-09        0B      -  2.65G  -
zroot/usr/src@2025-03-09          0B      -   857M  -
zroot/var@2025-03-09              0B      -    96K  -
zroot/var/audit@2025-03-09        0B      -   360K  -
zroot/var/crash@2025-03-09        0B      -    96K  -
zroot/var/log@2025-03-09          0B      -  3.93M  -
zroot/var/mail@2025-03-09         0B      -   576K  -
zroot/var/tmp@2025-03-09          0B      -   104K  -
# ls -ls /.zfs/snapshot
total 17
17 drwxr-xr-x  22 root wheel   28B Mar  9 10:40 2025-03-09/
</pre>

<p>
Restoring from this snapshot can be done with the:
</p>
<pre class="example">
# zfs rollback zroot@2025-03-09
</pre>

<p>
Snapshot can also be sent anywhere with the:
</p>
<pre class="example">
# zfs send zroot@2025-03-09 | send_it_somewhere
</pre>

<p>
or:
</p>

<pre class="example">
# zfs send zroot@2025-03-09 &gt; /backup/2025-03-09-zroot.snap
</pre>

<p>
To check the health of my disks and to verify the checksums of the files in my
pools, here are the next set of commands:
</p>
<pre class="example">
 $ zpool status -x
all pools are healthy
# zpool scrub zroot
# zpool scrub hdd
</pre>

<p>
The last two commands start a lot of heavy I/O operations, so don't launch
them if the system is already using the disks intensively! Estimates and
results of the scrubbing operation can be viewed using the <code>zpool status</code>
command.
</p>

<p>
The FreeBSD Handbook recommends launch scrubbing at least once a month.
</p>
</div>
</div>
<div id="outline-container-fingerprint-scanner" class="outline-2">
<h2 id="fingerprint-scanner">Fingerprint scanner</h2>
<div class="outline-text-2" id="text-fingerprint-scanner">
<p>
Some day, some time, I decided to configure fingerprint scanner on my
laptop. Many years ago I wrote an article about libfprint for IBM Portal, so I
thought that setting up fingerprint service will not be so difficult.
</p>


<div class="figure">
<p><img src="/assets/static/fingerprint_scanner.jpg" alt="fingerprint scanner with turned on green LED on the left" align="center" width="50%" />
</p>
<p class="fignum"><i>Thinkpad X220 fingerprint scanner</i></p>
</div>

<p>
As a starting documentation I take the next blog post:
<a href="https://hauweele.net/~gawen/blog/?p=408">https://hauweele.net/~gawen/blog/?p=408</a> and slightly modify some steps to fit
them to my system:
</p>

<ol class="org-ol">
<li><p>
First, I install all the necessary packages:
</p>
<pre class="example">
pkg install fprintd libfprint
</pre></li>
<li><p>
Then, I add my user to the <code>fprint</code> group to access the scanner device
without elevating to root:
</p>
<pre class="example">
pw groupadd fprint
pw groupmod fprint -m drag0n
</pre></li>
<li><p>
To get the correct permissions on the device file itself, I play with
<code>devd</code>Â â€” create the file <code>/usr/local/etc/devd/fingerprint.conf</code> and add the
following lines:
</p>
<pre class="example">
notify 100 {
    match "system"      "USB";
    match "subsystem"   "DEVICE";
    match "type"        "ATTACH";
    match "vendor"      "0x147e";
    match "product"     "0x2016";
    action "chown drag0n:fprint /dev/$cdev &amp;&amp; chmod 660 /dev/$cdev";
};
</pre>

<p>
After that I reboot the system to apply the new settings.
</p></li>
<li><p>
Then, I ran into the D-Bus-related problemsðŸ¤®. The <code>libfprint</code> utilities
communicate with the daemon via D-Bus and my user can't connect to the
daemon via it.
</p>

<p>
I don't use D-Bus in my systemÂ â€” I only have it to work with the <a href="https://dunst-project.org/">dunst
notification daemon</a>. There is a lightweight replacement for the big
notification daemons of a large desktop environments, which I obviously
don't use either. It works fine for me out of the box.
</p>

<p>
But it is not a case of <code>libfprint</code> utilities. So I've added the next lines
to <code>/usr/local/share/dbus-1/system.d/net.reactivated.Fprint.conf</code>:
</p>

<pre class="example">
&lt;policy user="drag0n"&gt;
  &lt;allow own="net.reactivated.Fprint"/&gt;
&lt;/policy&gt;
</pre></li>
<li><p>
And finally it's time to use fingerprints instead of passwords! Because I'm
a bit paranoid, I don't want to use fingerprints instead of a login
password or any other high-value passwords (like a password to unlock a GPG
key). Obviously, if I do that, then <i>some</i> bad actors can forcibly roll my
finger on the scanner and get access to my system.
</p>

<p>
So, I decide to use fingerprint instead of password only with <code>sudo</code>. If I'm
already logged in and someone catches me and forcibly rolls my fingerÂ â€”
then I'm <b>already</b> <i>sooo fucked up</i> before that event!
</p>

<p>
To use the fingerprint scanner with <code>sudo</code>, I've just added this line to the
top of the file <code>/usr/local/etc/pam.d/sudo</code>:
</p>

<pre class="example">
auth       sufficient  /usr/local/lib/security/pam_fprintd.so
</pre></li>
<li>Finally, I soft reboot the system with <code>reboot -r</code> and enroll my finger with
the <code>sudo fprintd-enroll drag0n</code> command. To verify that the finger was
successfully scanned, I killed the <code>fprintd</code> daemon and verified the finger
with the <code>fprintd-verify</code> command.</li>
</ol>

<p>
Now, <code>sudo</code> asks me for my finger first and then asks for the password after
three failed attempts to get a proper fingerprint:
</p>
<pre class="example">
~ % sudo uname
Swipe your right index finger across the fingerprint reader
Your finger was not centered, try swiping your finger again
FreeBSD
</pre>
</div>
</div>
<div id="outline-container-files-to-download" class="outline-2">
<h2 id="files-to-download">Files to download</h2>
<div class="outline-text-2" id="text-files-to-download">
<ul class="org-ul">
<li><a href="/assets/static/loader.conf.txt">/boot/loader.conf</a></li>
<li><a href="/assets/static/rc.conf.txt">/etc/rc.conf</a></li>
<li><a href="/assets/static/sysctl.conf.txt">/etc/sysctl.conf</a></li>
<li><a href="/assets/static/10-intel.conf.txt">/usr/local/etc/X11/xorg.conf.d/10-intel.conf</a></li>
<li><a href="/assets/static/20-ibm.conf.txt">/usr/local/etc/X11/xorg.conf.d/20-ibm.conf</a></li>
<li><a href="/assets/static/30-touchpad.conf.txt">/usr/local/etc/X11/xorg.conf.d/30-touchpad.conf</a></li>
<li><a href="/assets/static/bsdfan.conf.txt">/usr/local/etc/bsdfan.conf</a></li>
<li><a href="/assets/static/phone-connect.sh.txt">phone-connect.sh</a></li>
</ul>
</div>
</div>
<div id="outline-container-notes" class="outline-2">
<h2 id="notes">Notes</h2>
<div class="outline-text-2" id="text-notes">
</div>
</div>
<div id="footnotes">

<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.modesetting-wiki" class="footnum" href="#fnr.modesetting-wiki" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://en.wikipedia.org/wiki/Mode_setting">https://en.wikipedia.org/wiki/Mode_setting</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.dtrace-internal" class="footnum" href="#fnr.dtrace-internal" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
For example, it is possible to call <code>panic()</code> via DTrace.
</p></div></div>

<div class="footdef"><sup><a id="fn.slackware" class="footnum" href="#fnr.slackware" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
In these times I used Slackware (MOPSLinux) and <code>Xconfigure</code>
generates wrong <code>/etc/X11/xorg.conf</code> for my AGP video card and CRT monitor, so I
was forced to write it by hands with proper monitor description and
proprietary driver's section included.
</p>

<p class="footpara">
<a href="https://eugene-andrienko.com/en/it/2024/01/02/life-in-console">https://eugene-andrienko.com/en/it/2024/01/02/life-in-console</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4" role="doc-backlink">4</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
TL-8260D2W
</p></div></div>

<div class="footdef"><sup><a id="fn.freebsd-wifi" class="footnum" href="#fnr.freebsd-wifi" role="doc-backlink">5</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://freebsdfoundation.org/blog/why-laptop-support-why-now-freebsds-strategic-move-toward-broader-adoption/">Why laptop support, why now: FreeBSDâ€™s strategic move toward
broader adoption</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.tethering-modules" class="footnum" href="#fnr.tethering-modules" role="doc-backlink">6</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
See the documentation:
<a href="https://docs.freebsd.org/en/books/handbook/advanced-networking/#network-usb-tethering">https://docs.freebsd.org/en/books/handbook/advanced-networking/#network-usb-tethering</a>
</p></div></div>


</div>
</div>