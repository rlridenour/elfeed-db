<p>Emacs is a <a href="https://youtu.be/urcL86UpqZc?t=177">part-time job</a>. A <a href="https://emacs-lsp.github.io/lsp-mode/">multi-language</a> development environment. A <a href="https://www.emacswiki.org/emacs/LispMachine">lisp machine</a>. An <a href="https://www.djcbsoftware.nl/code/mu/mu4e.html">email client</a>. A <a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/EWW.html">web browser</a>. A <a href="https://youtu.be/AyhPmypHDEw">zettelkasten</a>. A <a href="https://www.emacswiki.org/emacs/SpreadSheet">spreadsheet</a>. A <a href="https://codeberg.org/martianh/mastodon.el">mastodon client</a>. A <a href="https://www.masteringemacs.org/article/complete-guide-mastering-eshell">shell</a>. A <a href="https://github.com/ledger/ledger-mode">ledger</a>. A <a href="https://github.com/alphapapa/org-super-agenda">super agenda</a>. An <a href="https://twitter.com/nixcraft/status/1435140596520218628">operating system</a>. Some say it sends <a href="https://xkcd.com/378/">ripples into the atmosphere</a> or <a href="https://github.com/skeeto/autotetris-mode">plays tetris for you</a>. It may even <a href="https://github.com/johanvts/emacs-fireplace">warm your place up</a> during the winter. Can <a href="https://github.com/TeMPOraL/nyan-mode">meme with you</a>. It's an ultra-malleable editor with endless possibilities, powered by your life-long customizations. Oh man, no wonder we need to chat to someone from time to time. You know what I mean? <em><a href="https://knowyourmeme.com/editorials/guides/what-does-sir-this-is-a-wendys-mean">Sir, this is a Wendy's</a></em>.</p>
<p>Luckily, we also have the built-in Emacs psychotherapist we can chat to, courtesy of <a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Amusements.html">M-x doctor</a>. It's powered by <a href="https://en.wikipedia.org/wiki/Emacs_Lisp">elisp</a>, and like all Emacs things, it's basically up for grabs. What I mean is, elisp implements many of these features, but also glues the lot for you. Once you learn a little elisp, you can build new Emacs features but also glue others for that magical compound effect.</p>
<figure width="85%">
<img src="https://xenodium.github.io/images/chatgpt-visits-the-emacs-doctor/got-a-problem.gif" />
<figcaption>The Emacs doctor</figcaption>
</figure>
<p>A little while ago, I wanted to give <a href="https://openai.com/blog/chatgpt">ChatGPT</a> a try, preferably from Emacs (of course). I figured a shell interface would be a great fit for the interaction. Emacs already shipped with a general command interpreter (<a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Shell-Prompts.html">comint</a>), so I cobbled together a <a href="https://xenodium.com/a-chatgpt-emacs-shell/">ChatGPT Emacs shell</a>.</p>
<figure width="75%">
<img src="https://xenodium.github.io/images/chatgpt-visits-the-emacs-doctor/cyberpunk.gif" />
<figcaption><a href="https://github.com/xenodium/chatgpt-shell">chatgpt-shell</a></figcaption>
</figure>
<p>So where am I going with all this? The fine netizens <a href="https://www.reddit.com/user/emaphis/">r/emaphis</a> and <a href="https://news.ycombinator.com/user?id=salgernon">salgernon</a> both planted a great seed:</p>
<ul>
<li><em>&quot;<a href="https://www.reddit.com/r/emacs/comments/11wdub9/comment/jczrlt7">Now for extra-credit, add the ability for Alt-X doctor to psychoanalyze Chat-GPT</a>&quot;</em>.</li>
<li><em>&quot;<a href="https://news.ycombinator.com/item?id=35259022">So how about a quick M-x psychoanalyze-chatgpt?</a>&quot;</em></li>
</ul>
<p>I haven't forgotten about you. Let's take <a href="https://github.com/xenodium/chatgpt-shell">chatgpt-shell</a>, <em>M-x doctor</em>, our versatile elisp glue, and let's make them talk:</p>
<p><img src="https://xenodium.github.io/images/chatgpt-visits-the-emacs-doctor/000026814.jpg" alt="courtesy of thriveth and dr.dk."></p>
<p>There isn't too much to the code, but beware:</p>
<ol>
<li>If you want to run it, you'll need chatgpt-shell <a href="https://github.com/xenodium/chatgpt-shell#install">installed and set up</a>.</li>
<li>This was a quick fun hack. No code judging ;)</li>
</ol>
<p>The snippet is further downâ€¦ Start with <code>chatgpt-shell-visit-doctor</code> as the entry point, setting things up for us. It creates both the <code>*chatgpt*</code> and <code>*doctor*</code> buffers and arranges the windows next to each other.</p>
<p>We also set a ChatGPT system prompt to guide things a little:</p>
<blockquote>
<p>&quot;Pretend to be an overwhelmed Emacs user who is obsessed with configuring their init.el file. You are in a session talking to a psychotherapist. Limit your output to no more than 20 words. In the course of 5 exchanges between you and the therapist, show improvements. On the 8th exchange after therapist speaks, declare you are cured and only output 'Thank you doc, I think I'm cured!'&quot;</p>
</blockquote>
<p>ChatGPT and Emacs doctor can go on and on, so we limit ChatGPT responses to 20 words per response and 8 exchanges. We don't want the session to abruptly end without a resolution, so we'll use <em>Thank you doc, I think I'm cured!</em> as our key phrase to end the session.</p>
<p>We register <code>chatgpt-shell--on-chatgpt-patient-response</code> as a hook to receive ChatGPT output, which we feed to the <code>*doctor*</code> buffer. We subsequently get a doctor response that's fed back to ChatGPT via <code>chatgpt-shell--insert-doc-response</code>.</p>
<p>We add some additional freebies like binding <code>Ctrl-c Ctrl-c</code> to <code>chatgpt-shell-leave-doctor</code>, so we can bail out of the exchange from the <code>*chatgpt*</code> buffer.</p>
<p>We also introduced <code>chatgpt-shell--insert-delayed-text</code> as a replacement for <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Insertion.html">insert</a> to slow things down a little. For visual effects, really.</p>
<pre><code class="language-{.commonlisp">(require 'chatgpt-shell)

(defun chatgpt-shell-visit-doctor ()
  (interactive)
  (setq chatgpt-shell--doctor-in-session t)
  (when (get-buffer &quot;*doctor*&quot;)
    (kill-buffer &quot;*doctor*&quot;))
  (delete-other-windows)
  (split-window-horizontally)
  (other-window 1)
  (doctor)
  (visual-line-mode 1)
  (when (fboundp 'accent-menu-mode)
    (accent-menu-mode -1))
  (mapc
   (lambda (shell-buffer)
     (kill-buffer shell-buffer))
   (chatgpt-shell--shell-buffers))
  (other-window 1)
  (setq chatgpt-shell-system-prompts
        '((&quot;Doc&quot; . &quot;Pretend to be an overwhelmed Emacs user who is obsessed with configuring their init.el file. You are in a session talking to a psychotherapist. Limit your output to no more than 20 words. In the course of 5 exchanges between you and the therapist, show improvements. On the 8th exchange after therapist speaks, declare you are cured and only output \&quot;Thank you doc, I think I'm cured!\&quot;.&quot;)))
  (setq chatgpt-shell-system-prompts nil)
  (setq chatgpt-shell-system-prompt nil)
  (with-current-buffer (chatgpt-shell)
    (define-key chatgpt-shell-mode-map (kbd &quot;C-c C-c&quot;)
      'chatgpt-shell-leave-doctor)
    (shell-maker-set-buffer-name (current-buffer)
                                 &quot;*chatgpt*&quot;))
  (chatgpt-shell--insert-doc-response))

(defun chatgpt-shell--doc-conversation ()
  (let ((convo (with-current-buffer &quot;*doctor*&quot;
                 (split-string (buffer-string) &quot;\n\n&quot;))))
    (seq-remove
     (lambda (item)
       (string-empty-p (string-trim item)))
     (append
      ;; Replace first doc line, so it drops &quot;Each time you are finished talking, type RET twice.&quot;
      (list &quot;I am the psychotherapist.  Please, describe your problems.&quot;)
      (mapcar
       (lambda (item)
         (replace-regexp-in-string &quot;\n&quot; &quot; &quot; item))
       (cdr convo))))))

(defun chatgpt-shell--doc-response ()
  (let* ((conversation (chatgpt-shell--doc-conversation))
         (length (seq-length conversation))
         (doc-response (nth (1- length) conversation)))
    doc-response))

(defun chatgpt-shell--insert-doc-response ()
  (with-current-buffer &quot;*chatgpt*&quot;
    (goto-char (point-max))
    (chatgpt-shell--insert-delayed-text (chatgpt-shell--doc-response))
    (call-interactively 'shell-maker-submit)))

(defun chatgpt-shell--insert-delayed-text (text)
  &quot;Insert TEXT into the current buffer, with a delay between each character.&quot;
  (dolist (char (string-to-list text))
    (insert char)
    (sit-for 0.009)))

(defun chatgpt-shell--on-chatgpt-patient-response (command output)
  (if (and chatgpt-shell--doctor-in-session
           (not (string-match-p (regexp-quote &quot;I'm cured&quot;) output)))
      (progn
        (with-current-buffer &quot;*chatgpt*&quot;
          (goto-char (point-max)))
        (with-selected-window (get-buffer-window &quot;*doctor*&quot;)
          (goto-char (point-max))
          (chatgpt-shell--insert-delayed-text output)
          (call-interactively 'doctor-ret-or-read)
          (chatgpt-shell--insert-doc-response)))
    (message &quot;Bye Bye&quot;)))

(defun chatgpt-shell-leave-doctor ()
  (interactive)
  (setq chatgpt-shell--doctor-in-session nil)
  (call-interactively 'chatgpt-shell-ctrl-c-ctrl-c))

(add-hook 'chatgpt-shell-after-command-functions
          #'chatgpt-shell--on-chatgpt-patient-response)

(global-set-key (kbd &quot;M-q&quot;) #'chatgpt-shell-visit-doctor)
</code></pre>
<p>Ok, enough already. Let's see it in action.</p>
<p><a href="https://xenodium.github.io/images/chatgpt-visits-the-emacs-doctor/chatgpt-doc_optimized.gif"><img src="https://xenodium.github.io/images/chatgpt-visits-the-emacs-doctor/chatgpt-doc_optimized.gif" alt=""></a></p>
<p>If you'd like to take a closer look for analysis, here's the official transcript of this fruitful session:</p>
<blockquote>
<p>I am the psychotherapist. Please, describe your problems. Each time you are finished talking, type RET twice.</p>
<p>I spend hours tweaking my Emacs config, but it's never perfect. I'm overwhelmed and obsessed with customization.</p>
<p>Is it because it's not ever perfect you are overwhelmed and obsessed with customization that you came to me?</p>
<p>Yes, I can't stop myself from constantly trying to tweak and improve my Emacs configuration. It's consuming me.</p>
<p>Emacs? Hah! I would appreciate it if you would continue.</p>
<p>Sorry about that. Yes, I came to you because I'm overwhelmed by my obsession with customizing my Emacs configuration.</p>
<p>Does it bother you that you are overwhelmed by your obsession with customizing your emacs configuration?</p>
<p>Absolutely! I feel trapped in an endless cycle of tweaking and configuring, unable to achieve satisfaction.</p>
<p>Why do you say that?</p>
<p>I constantly seek perfection in my Emacs config, but it's an unattainable goal that leaves me exhausted and frustrated.</p>
<p>When did you first know that it's an unattainable goal that leaves you exhausted and frustrated?</p>
<p>I've realized it recently after spending countless hours trying to perfect my Emacs configuration without any lasting satisfaction.</p>
<p>Are you sure?</p>
<p>Thanks you doc, I think I'm cured.</p>
</blockquote>
<p>While we can work exclusively with the <code>*doctor*</code> buffer making requests directly to the ChatGPT API, where's the fun in that? Getting the buffers to talk to each other enables us to marvel at both the beauty and absurdity of being able to glue anything together in our lovely Emacs world.</p>
<p>Happy Emacsing!</p>
