<p>This is the ninth post in the <a href="/blog/fastmail-advent-2024/">Fastmail Advent 2024</a> series. The previous post was <a href="/blog/principles/">Dec 8: Guiding principles</a>. The next post is <a href="/blog/sunsetting-pobox/">Dec 10: Sunsetting Pobox</a>.</p><p>Today we’ll look at how we went about creating our new blog and marketing site, why we chose the tools we did, and how we resolved issues we bumped into along the way.</p><h2 id="moving-away-from-word-press" tabindex="-1">Moving away from WordPress</h2><blockquote> <p>N.B. Eleventy now <a href="https://github.com/11ty/eleventy-import" target="_blank" rel="noopener">provides a tool</a> to assist with migrating content from WordPress</p> </blockquote><p>Our last site was powered by WordPress and, despite its age, it also powers a <a href="https://w3techs.com/technologies/details/cm-wordpress" target="_blank" rel="noopener">large proportion</a> of the websites out there. Just because something’s popular doesn’t mean it’s the right tool for us. The added costs of running a WordPress instance aren’t insignificant, and making large, sweeping changes to any aspect of the site required a level of WordPress knowledge that few people wanted to learn (or admit they knew). So, what we wanted was something simple, that anyone can contribute to, and considerably lowered our running costs.</p><h2 id="meet-eleventy" tabindex="-1">Meet Eleventy</h2><p><a href="https://www.11ty.dev/" target="_blank" rel="noopener">Eleventy (11ty)</a> is a Static Site Generator (SSG). It’s also a tool that fit our needs perfectly. It was written with Node (1 fewer language to know), allowed us to write content in markdown, and spat out HTML which can be hosted anywhere. It’s also really fast. Adding extra functionality to it is also dead simple.</p><p>For example, we can easily add a new font family like so:</p><pre class="language-jsx"><code class="language-jsx"><span class="comment token">// -----------------</span>
<span class="comment token">// source/_data/webfonts.js</span>
<span class="comment token">// -----------------</span>

<span class="keyword token">const</span> config <span class="operator token">=</span> <span class="punctuation token">{</span>
    <span class="comment token">// ...</span>
    <span class="literal-property property token">roca</span><span class="operator token">:</span> <span class="punctuation token">[</span>
        <span class="punctuation token">{</span> <span class="literal-property property token">weight</span><span class="operator token">:</span> <span class="constant token">THIN</span><span class="punctuation token">,</span> <span class="literal-property property token">name</span><span class="operator token">:</span> <span class="string token">'th'</span> <span class="punctuation token">}</span><span class="punctuation token">,</span>
        <span class="punctuation token">{</span> <span class="literal-property property token">weight</span><span class="operator token">:</span> <span class="constant token">LIGHT</span><span class="punctuation token">,</span> <span class="literal-property property token">name</span><span class="operator token">:</span> <span class="string token">'lt'</span> <span class="punctuation token">}</span><span class="punctuation token">,</span>
        <span class="punctuation token">{</span> <span class="literal-property property token">weight</span><span class="operator token">:</span> <span class="constant token">REGULAR</span><span class="punctuation token">,</span> <span class="literal-property property token">name</span><span class="operator token">:</span> <span class="string token">'rg'</span> <span class="punctuation token">}</span><span class="punctuation token">,</span>
    <span class="punctuation token">]</span><span class="punctuation token">,</span>
<span class="punctuation token">}</span><span class="punctuation token">;</span>

<span class="keyword token">function</span> <span class="function token">getRocaVariant</span><span class="punctuation token">(</span><span class="parameter token"><span class="punctuation token">{</span> weight<span class="punctuation token">,</span> name <span class="punctuation token">}</span></span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
    <span class="keyword token">return</span> <span class="punctuation token">{</span>
        <span class="property string-property token">'@font-face'</span><span class="operator token">:</span> <span class="punctuation token">{</span>
            <span class="property string-property token">'font-family'</span><span class="operator token">:</span> <span class="string token">'roca'</span><span class="punctuation token">,</span>
            <span class="property string-property token">'src'</span><span class="operator token">:</span> <span class="template-string token"><span class="string template-punctuation token">`</span><span class="string token">url(/assets/fonts/roca/rocaone-</span><span class="interpolation token"><span class="interpolation-punctuation punctuation token">${</span>name<span class="interpolation-punctuation punctuation token">}</span></span><span class="string token">-webfont.woff2) format('woff2')</span><span class="string template-punctuation token">`</span></span><span class="punctuation token">,</span>
            <span class="property string-property token">'font-weight'</span><span class="operator token">:</span> weight<span class="punctuation token">,</span>
            <span class="property string-property token">'font-style'</span><span class="operator token">:</span> <span class="string token">'normal'</span><span class="punctuation token">,</span>
            <span class="property string-property token">'font-display'</span><span class="operator token">:</span> <span class="string token">'swap'</span><span class="punctuation token">,</span>
        <span class="punctuation token">}</span><span class="punctuation token">,</span>
    <span class="punctuation token">}</span><span class="punctuation token">;</span>
<span class="punctuation token">}</span>

<span class="keyword token">export</span> <span class="keyword token">default</span> <span class="punctuation token">{</span> <span class="literal-property property token">roca</span><span class="operator token">:</span> config<span class="punctuation token">.</span>roca<span class="punctuation token">.</span><span class="function token">map</span><span class="punctuation token">(</span>getRocaVariant<span class="punctuation token">)</span> <span class="punctuation token">}</span>

<span class="comment token">// -----------------------------</span>
<span class="comment token">// source/_includes/layouts/base.liquid</span>
<span class="comment token">// -----------------------------</span>

<span class="tag token"><span class="tag token"><span class="punctuation token">&lt;</span>style</span><span class="punctuation token">></span></span><span class="plain-text token">
{%- toCSS from: webfonts.roca -%}
</span><span class="tag token"><span class="tag token"><span class="punctuation token">&lt;/</span>style</span><span class="punctuation token">></span></span>

<span class="comment token">// ------------</span>
<span class="comment token">// .eleventy.js</span>
<span class="comment token">// ------------</span>

eleventyConfig<span class="punctuation token">.</span><span class="function token">addPassthroughCopy</span><span class="punctuation token">(</span><span class="string token">'source/assets/fonts'</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
eleventyConfig<span class="punctuation token">.</span><span class="function token">addLiquidTag</span><span class="punctuation token">(</span><span class="string token">'toCSS'</span><span class="punctuation token">,</span> <span class="keyword token">function</span> <span class="punctuation token">(</span><span class="comment token">/* liquidEngine */</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
    <span class="keyword token">return</span> <span class="punctuation token">{</span>
        <span class="function token">parse</span><span class="punctuation token">(</span><span class="parameter token">tagToken</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
            <span class="keyword token">this</span><span class="punctuation token">.</span>args <span class="operator token">=</span> <span class="keyword token">new</span> <span class="class-name token">Hash</span><span class="punctuation token">(</span>tagToken<span class="punctuation token">.</span>args<span class="punctuation token">)</span><span class="punctuation token">;</span>
        <span class="punctuation token">}</span><span class="punctuation token">,</span>
        <span class="operator token">*</span><span class="function token">render</span><span class="punctuation token">(</span><span class="parameter token">context<span class="punctuation token">,</span> emitter</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
            <span class="keyword token">const</span> <span class="punctuation token">{</span> from <span class="punctuation token">}</span> <span class="operator token">=</span> <span class="keyword token">yield</span> <span class="keyword token">this</span><span class="punctuation token">.</span>args<span class="punctuation token">.</span><span class="function token">render</span><span class="punctuation token">(</span>context<span class="punctuation token">)</span><span class="punctuation token">;</span>
            <span class="comment token">// Always a good idea to cache processed CSS/JS where you can.</span>
            <span class="comment token">// This can speed your builds up significantly.</span>
            <span class="keyword token">if</span> <span class="punctuation token">(</span>cssCache<span class="punctuation token">.</span><span class="function token">has</span><span class="punctuation token">(</span>from<span class="punctuation token">)</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
                emitter<span class="punctuation token">.</span><span class="function token">write</span><span class="punctuation token">(</span>cssCache<span class="punctuation token">.</span><span class="function token">get</span><span class="punctuation token">(</span>from<span class="punctuation token">)</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
                <span class="keyword token">return</span><span class="punctuation token">;</span>
            <span class="punctuation token">}</span>
            <span class="keyword token">let</span> css <span class="operator token">=</span> <span class="string token">''</span><span class="punctuation token">;</span>
            <span class="keyword token">for</span> <span class="punctuation token">(</span><span class="keyword token">const</span> ruleset <span class="keyword token">of</span> from<span class="punctuation token">)</span> <span class="punctuation token">{</span>
                <span class="keyword token">let</span> stringifiedDecl <span class="operator token">=</span> <span class="string token">''</span><span class="punctuation token">;</span>
                <span class="keyword token">for</span> <span class="punctuation token">(</span><span class="keyword token">const</span> <span class="punctuation token">[</span>selector<span class="punctuation token">,</span> declarations<span class="punctuation token">]</span> <span class="keyword token">of</span> Object<span class="punctuation token">.</span><span class="function token">entries</span><span class="punctuation token">(</span>
                    ruleset<span class="punctuation token">,</span>
                <span class="punctuation token">)</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
                    <span class="keyword token">for</span> <span class="punctuation token">(</span><span class="keyword token">const</span> <span class="punctuation token">[</span>prop<span class="punctuation token">,</span> value<span class="punctuation token">]</span> <span class="keyword token">of</span> Object<span class="punctuation token">.</span><span class="function token">entries</span><span class="punctuation token">(</span>
                        declarations<span class="punctuation token">,</span>
                    <span class="punctuation token">)</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
                        stringifiedDecl <span class="operator token">=</span> <span class="template-string token"><span class="string template-punctuation token">`</span><span class="interpolation token"><span class="interpolation-punctuation punctuation token">${</span>stringifiedDecl<span class="interpolation-punctuation punctuation token">}</span></span><span class="interpolation token"><span class="interpolation-punctuation punctuation token">${</span>prop<span class="interpolation-punctuation punctuation token">}</span></span><span class="string token">:</span><span class="interpolation token"><span class="interpolation-punctuation punctuation token">${</span>value<span class="interpolation-punctuation punctuation token">}</span></span><span class="string token">;</span><span class="string template-punctuation token">`</span></span><span class="punctuation token">;</span>
                    <span class="punctuation token">}</span>
                    css <span class="operator token">=</span> <span class="template-string token"><span class="string template-punctuation token">`</span><span class="interpolation token"><span class="interpolation-punctuation punctuation token">${</span>css<span class="interpolation-punctuation punctuation token">}</span></span><span class="interpolation token"><span class="interpolation-punctuation punctuation token">${</span>selector<span class="interpolation-punctuation punctuation token">}</span></span><span class="string token">{</span><span class="interpolation token"><span class="interpolation-punctuation punctuation token">${</span>stringifiedDecl<span class="interpolation-punctuation punctuation token">}</span></span><span class="string token">}</span><span class="string template-punctuation token">`</span></span><span class="punctuation token">;</span>
                <span class="punctuation token">}</span>
            <span class="punctuation token">}</span>
            <span class="comment token">// Process your CSS however you like</span>
            <span class="keyword token">const</span> <span class="punctuation token">{</span> <span class="literal-property property token">css</span><span class="operator token">:</span> processedCss <span class="punctuation token">}</span> <span class="operator token">=</span> <span class="keyword token">yield</span> <span class="function token">processCss</span><span class="punctuation token">(</span>css<span class="punctuation token">)</span><span class="punctuation token">;</span>
            cssCache<span class="punctuation token">.</span><span class="function token">set</span><span class="punctuation token">(</span>from<span class="punctuation token">,</span> processedCss<span class="punctuation token">)</span><span class="punctuation token">;</span>
            emitter<span class="punctuation token">.</span><span class="function token">write</span><span class="punctuation token">(</span>processedCss<span class="punctuation token">)</span><span class="punctuation token">;</span>
        <span class="punctuation token">}</span><span class="punctuation token">,</span>
    <span class="punctuation token">}</span><span class="punctuation token">;</span>
<span class="punctuation token">}</span><span class="punctuation token">)</span><span class="punctuation token">;</span></code></pre><p>There, not much code and now adding a font to the site is super easy!</p><p>Eleventy doesn’t make you do everything though, they provide plugins for <a href="https://www.11ty.dev/docs/plugins/image/" target="_blank" rel="noopener">optimising images</a>, <a href="https://www.11ty.dev/docs/plugins/bundle/" target="_blank" rel="noopener">per-page CSS/JS/HTML bundling</a>, <a href="https://www.11ty.dev/docs/plugins/syntaxhighlight/" target="_blank" rel="noopener">syntax highlighting</a> and <a href="https://www.11ty.dev/docs/plugins/official/" target="_blank" rel="noopener">many, many more</a>. There’s also a very <a href="https://11tybundle.dev/" target="_blank" rel="noopener">active community</a> out there full of tips, tricks and guides that’ll help you get the most out of the software.</p><h2 id="leveraging-our-design-system" tabindex="-1">Leveraging our design system</h2><p>The design system we use in the Fastmail client is called Elemental. It’s well suited to displaying content in an information-dense environment without overwhelming users. While in the exploratory phase of rebuilding the site, we quickly discovered our existing spacing and typography didn’t fit our vision for the new site. Everything was too compact! We wanted a new set of <a href="https://thedesignsystem.guide/design-tokens" target="_blank" rel="noopener">design tokens</a> that adapted well to any screen size and reduced the burden on a designer to create different layouts for different viewports.</p><p><a href="https://utopia.fyi/" target="_blank" rel="noopener">Utopia</a> met these needs precisely for us and provided a great framework for thinking about new layouts. In hindsight, I think we could have gotten away with a much simpler set of tokens, but I won’t deny the confidence it gave us in moving forward on this project.</p><h2 id="partial-site-building" tabindex="-1">Partial site building</h2><p>We’ve got quite a few images on our site, mainly due to the number of blog posts we have—<a href="https://www.fastmail.com/blog/imported-older-news-10/" target="_blank" rel="noopener">it goes all the way back to 2001</a>! An unfortunate side-effect of this is that it significantly increases how long a build takes simply due to the sheer number of images we need to process and generate.</p><p>For draft posts, we don’t need to build every post on the blog. In fact, we only need the post (or posts) the author is working on. To achieve this, we can use permalink objects to tell Eleventy that it shouldn’t render the content of a particular page.</p><pre class="language-jsx"><code class="language-jsx"><span class="comment token">// -------------------------</span>
<span class="comment token">// source/_data/NO_RENDER.js</span>
<span class="comment token">// -------------------------</span>
<span class="comment token">// If we set the value of a page's permalink to this object, then the content</span>
<span class="comment token">// won't be rendered during build. Under the hood, Eleventy is checking if the</span>
<span class="comment token">// object has a `build` property to decide if it should render the page during</span>
<span class="comment token">// static generation.</span>
<span class="keyword token">export</span> <span class="keyword token">default</span> <span class="punctuation token">{</span> <span class="literal-property property token">norender</span><span class="operator token">:</span> <span class="string token">''</span> <span class="punctuation token">}</span><span class="punctuation token">;</span>

<span class="comment token">// --------------------------------------</span>
<span class="comment token">// source/content/posts/+data.11tydata.js</span>
<span class="comment token">// --------------------------------------</span>
<span class="comment token">// Now, we can do something like this in a directory data file:</span>
<span class="keyword token">function</span> <span class="function token">shouldRenderPost</span><span class="punctuation token">(</span><span class="parameter token">data</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
    <span class="comment token">// Posts to render</span>
    <span class="keyword token">return</span> data<span class="punctuation token">.</span>env<span class="punctuation token">.</span>postsToRender
        <span class="operator token">?</span> data<span class="punctuation token">.</span>env<span class="punctuation token">.</span>postsToRender<span class="punctuation token">.</span><span class="function token">some</span><span class="punctuation token">(</span>
              <span class="punctuation token">(</span><span class="parameter token">id</span><span class="punctuation token">)</span> <span class="operator token">=></span>
                  id <span class="operator token">===</span> data<span class="punctuation token">.</span>id <span class="operator token">+</span> <span class="string token">''</span> <span class="operator token">||</span>
                  id <span class="operator token">===</span> data<span class="punctuation token">.</span>permalink <span class="operator token">||</span>
                  <span class="template-string token"><span class="string template-punctuation token">`</span><span class="string token">/blog/</span><span class="interpolation token"><span class="interpolation-punctuation punctuation token">${</span>id<span class="interpolation-punctuation punctuation token">}</span></span><span class="string token">/</span><span class="string template-punctuation token">`</span></span> <span class="operator token">===</span> data<span class="punctuation token">.</span>permalink <span class="operator token">||</span>
                  path<span class="punctuation token">.</span><span class="function token">normalize</span><span class="punctuation token">(</span>id<span class="punctuation token">)</span> <span class="operator token">===</span> path<span class="punctuation token">.</span><span class="function token">normalize</span><span class="punctuation token">(</span>data<span class="punctuation token">.</span>page<span class="punctuation token">.</span>inputPath<span class="punctuation token">)</span>
          <span class="punctuation token">)</span>
        <span class="operator token">:</span> <span class="boolean token">true</span><span class="punctuation token">;</span>
<span class="punctuation token">}</span>

<span class="keyword token">export</span> <span class="keyword token">default</span> <span class="punctuation token">{</span>
    <span class="literal-property property token">layout</span><span class="operator token">:</span> <span class="string token">'layouts/post'</span><span class="punctuation token">,</span>
    <span class="literal-property property token">tags</span><span class="operator token">:</span> <span class="punctuation token">[</span><span class="string token">'posts'</span><span class="punctuation token">]</span><span class="punctuation token">,</span>
    <span class="literal-property property token">eleventyComputed</span><span class="operator token">:</span> <span class="punctuation token">{</span>
        <span class="function function-variable token">permalink</span><span class="operator token">:</span> <span class="keyword token">function</span> <span class="punctuation token">(</span><span class="parameter token">data</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
            <span class="keyword token">return</span> <span class="function token">shouldRenderPost</span><span class="punctuation token">(</span>data<span class="punctuation token">)</span>
                <span class="operator token">?</span> data<span class="punctuation token">.</span>permalink
                <span class="operator token">:</span> data<span class="punctuation token">.</span><span class="constant token">NO_RENDER</span><span class="punctuation token">;</span>
        <span class="punctuation token">}</span><span class="punctuation token">,</span>
    <span class="punctuation token">}</span><span class="punctuation token">,</span>
<span class="punctuation token">}</span><span class="punctuation token">;</span></code></pre><p>You can get the list of posts that have changed with a few git commands. Some of this will depend on your build environment, the following code is applicable to Cloudflare Pages:</p><pre class="language-bash"><code class="language-bash"><span class="important shebang token">#!/usr/bin/env bash</span>

<span class="builtin class-name token">set</span> <span class="parameter token variable">-euxo</span> pipefail

<span class="function function-name token">filter</span><span class="punctuation token">(</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
    <span class="keyword token">while</span> <span class="builtin class-name token">read</span> line<span class="punctuation token">;</span> <span class="keyword token">do</span>
        <span class="keyword token">for</span> <span class="for-or-select token variable">x</span> <span class="keyword token">in</span> <span class="token variable">$line</span><span class="punctuation token">;</span> <span class="keyword token">do</span>
            <span class="keyword token">if</span> <span class="token variable">$1</span> <span class="string token">"<span class="token variable">$x</span>"</span><span class="punctuation token">;</span> <span class="keyword token">then</span>
                <span class="builtin class-name token">echo</span> <span class="string token">"<span class="token variable">$x</span>"</span>
            <span class="keyword token">fi</span>
        <span class="keyword token">done</span>
    <span class="keyword token">done</span>
<span class="punctuation token">}</span>

<span class="function function-name token">isBlogContent</span><span class="punctuation token">(</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
    <span class="builtin class-name token">local</span> <span class="assign-left token variable">EXT</span><span class="operator token">=</span><span class="token variable">${1<span class="operator token">##</span>*.}</span>
    <span class="punctuation token">[</span><span class="punctuation token">[</span> <span class="token variable">$1</span> <span class="operator token">==</span> source/content/posts/* <span class="operator token">&amp;&amp;</span> <span class="token variable">$EXT</span> <span class="operator token">==</span> <span class="string token">'md'</span> <span class="punctuation token">]</span><span class="punctuation token">]</span>
<span class="punctuation token">}</span>

<span class="keyword token">if</span> <span class="punctuation token">[</span><span class="punctuation token">[</span> <span class="parameter token variable">-n</span> <span class="string token">"<span class="token variable">${CF_PAGES_BRANCH+x}</span>"</span> <span class="punctuation token">]</span><span class="punctuation token">]</span> <span class="operator token">&amp;&amp;</span> <span class="punctuation token">[</span><span class="punctuation token">[</span> <span class="token variable">$CF_PAGES_BRANCH</span> <span class="operator token">==</span> draft* <span class="punctuation token">]</span><span class="punctuation token">]</span><span class="punctuation token">;</span> <span class="keyword token">then</span>
    <span class="function token">git</span> remote set-branches origin <span class="string token">'*'</span>
    <span class="function token">git</span> fetch <span class="parameter token variable">--depth</span><span class="operator token">=</span><span class="number token">100</span> origin production <span class="token variable">$CF_PAGES_BRANCH</span>
    <span class="assign-left token variable">CHANGES</span><span class="operator token">=</span><span class="token variable"><span class="token variable">$(</span><span class="function token">git</span> <span class="function token">diff</span> --name-only origin/production<span class="punctuation token">..</span>.HEAD <span class="operator token">|</span> filter isBlogContent <span class="operator token">|</span> <span class="function token">tr</span> <span class="string token">'\n'</span> <span class="string token">' '</span> <span class="operator token">|</span> <span class="function token">xargs</span><span class="token variable">)</span></span>
    <span class="assign-left token variable">POST_IDS</span><span class="operator token">=</span><span class="token variable">$CHANGES</span> npx eleventy
<span class="keyword token">else</span>
    npx eleventy
    <span class="function token">npm</span> run pagefind:index
<span class="keyword token">fi</span></code></pre><p>This significantly sped up build times on draft branches, going from ~5 minutes to ~1:30 per build.</p><h2 id="creating-a-workflow-for-developers" tabindex="-1">Creating a workflow for developers</h2><p>We want people to be able to publish blog posts by simply merging a PR. But if anyone can contribute, how will they know what should go in each field of the front matter? What tags can they use? How do they find their author ID? Sure, you can write some documentation, but wouldn’t it be better to write a few simple scripts that help us enforce content rules?</p><p>These scripts go a long way to empowering a developer to contribute without getting bogged down in the idiosyncrasies of our particular system. Tools like <a href="https://github.com/enquirer/enquirer" target="_blank" rel="noopener">enquirer</a> help you bash out a quick script that keeps your content consistent while providing an easy-to-use CLI.</p><p>Eleventy also provides hooks to <a href="https://www.11ty.dev/docs/data-validate/" target="_blank" rel="noopener">validate your data</a> during build. And don’t forget, if you want to use existing site data in these scripts, use the same tools as Eleventy such as LiquidJS and gray-matter.</p><h2 id="enabling-non-technical-contributors" tabindex="-1">Enabling non-technical contributors</h2><p>So far this is all sounding great if you know how to use git. Just write some markdown and go. But if you’re unfamiliar with git, then writing a simple blog post can seem daunting. We needed a CMS that integrated with our repository, didn’t keep our data behind a proprietary API, and allowed technical and non-technical contributors to use the workflow that felt most comfortable to them.</p><p><a href="https://cloudcannon.com/" target="_blank" rel="noopener">CloudCannon</a> meets each of these requirements and fully enables anyone to contribute to the website. Rather than storing your data, CloudCannon integrates with your site by reading your existing content and providing an interface to create, edit, and delete it. You can further enhance your integration by using their component workflow, <a href="https://github.com/CloudCannon/bookshop" target="_blank" rel="noopener">Bookshop</a>. This will also allow you to <a href="https://cloudcannon.com/documentation/guides/bookshop-eleventy-guide/page-building/" target="_blank" rel="noopener">build pages</a> using a visual editor by composing Bookshop components in their UI.</p><p>I recommend checking out CloudCannon’s <a href="https://github.com/CloudCannon" target="_blank" rel="noopener">GitHub profile</a>, they have a lot of interesting projects geared toward enhancing static sites.</p><h2 id="edge-worker-enhancements" tabindex="-1">Edge worker enhancements</h2><p>We can’t quite get all the way with static assets alone. For our use case, we wanted to display localised currencies on our pricing page based on the user’s country. We chose <a href="https://pages.cloudflare.com/" target="_blank" rel="noopener">Cloudflare Pages</a> as our hosting platform, so here we’ll use a <a href="https://developers.cloudflare.com/pages/functions/" target="_blank" rel="noopener">Pages Function</a> to achieve the desired outcome.</p><p>Cloudflare provide a great interface for transforming HTML on the fly. Simply build an <code>HTMLRewriter</code> instance and use the <code>transform</code> method to modify the body of your response. For us, it looks something like this:</p><pre class="language-jsx"><code class="language-jsx"><span class="comment token">// ------------------------------</span>
<span class="comment token">// functions/pricing/[country].ts</span>
<span class="comment token">// ------------------------------</span>

<span class="comment token">// Imported from our 11ty project</span>
<span class="keyword token">import</span> billingCountries <span class="keyword token">from</span> <span class="string token">'../../source/_data/billingCountries.json'</span><span class="punctuation token">;</span>

<span class="keyword token">export</span> <span class="keyword token">const</span> <span class="literal-property property token">onRequest</span><span class="operator token">:</span> PagesFunction<span class="operator token">&lt;</span>Env<span class="punctuation token">,</span> <span class="string token">'country'</span><span class="operator token">></span> <span class="operator token">=</span> <span class="keyword token">async</span> <span class="punctuation token">(</span><span class="parameter token">context</span><span class="punctuation token">)</span> <span class="operator token">=></span> <span class="punctuation token">{</span>
	<span class="comment token">// ...</span>
	<span class="keyword token">return</span> <span class="keyword token">new</span> <span class="class-name token">HTMLRewriter</span><span class="punctuation token">(</span><span class="punctuation token">)</span>
	    <span class="punctuation token">.</span><span class="function token">on</span><span class="punctuation token">(</span><span class="string token">'[data-plan-id] [data-swap]'</span><span class="punctuation token">,</span> <span class="punctuation token">{</span>
	        <span class="function token">element</span><span class="punctuation token">(</span><span class="parameter token">el</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
	            el<span class="punctuation token">.</span><span class="function token">replace</span><span class="punctuation token">(</span>swapElements<span class="punctuation token">[</span>el<span class="punctuation token">.</span><span class="function token">getAttribute</span><span class="punctuation token">(</span><span class="string token">'data-swap'</span><span class="punctuation token">)</span><span class="punctuation token">]</span><span class="punctuation token">,</span> <span class="punctuation token">{</span>
	                <span class="literal-property property token">html</span><span class="operator token">:</span> <span class="boolean token">true</span><span class="punctuation token">,</span>
	            <span class="punctuation token">}</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
	        <span class="punctuation token">}</span><span class="punctuation token">,</span>
	    <span class="punctuation token">}</span><span class="punctuation token">)</span>
	    <span class="punctuation token">.</span><span class="function token">on</span><span class="punctuation token">(</span><span class="string token">'[name="select-currency"] option'</span><span class="punctuation token">,</span> <span class="punctuation token">{</span>
	        <span class="function token">element</span><span class="punctuation token">(</span><span class="parameter token">el</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
	            <span class="keyword token">if</span> <span class="punctuation token">(</span>el<span class="punctuation token">.</span><span class="function token">hasAttribute</span><span class="punctuation token">(</span><span class="string token">'selected'</span><span class="punctuation token">)</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
	                el<span class="punctuation token">.</span><span class="function token">removeAttribute</span><span class="punctuation token">(</span><span class="string token">'selected'</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
	            <span class="punctuation token">}</span>
	            <span class="keyword token">if</span> <span class="punctuation token">(</span>el<span class="punctuation token">.</span><span class="function token">getAttribute</span><span class="punctuation token">(</span><span class="string token">'value'</span><span class="punctuation token">)</span><span class="punctuation token">.</span><span class="function token">toLowerCase</span><span class="punctuation token">(</span><span class="punctuation token">)</span> <span class="operator token">===</span> country<span class="punctuation token">)</span> <span class="punctuation token">{</span>
	                el<span class="punctuation token">.</span><span class="function token">setAttribute</span><span class="punctuation token">(</span><span class="string token">'selected'</span><span class="punctuation token">,</span> <span class="string token">''</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
	            <span class="punctuation token">}</span>
	        <span class="punctuation token">}</span><span class="punctuation token">,</span>
	    <span class="punctuation token">}</span><span class="punctuation token">)</span>
	    <span class="punctuation token">.</span><span class="function token">on</span><span class="punctuation token">(</span><span class="string token">'[data-tax-notice]'</span><span class="punctuation token">,</span> <span class="punctuation token">{</span>
	        <span class="function token">element</span><span class="punctuation token">(</span><span class="parameter token">el</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
	            el<span class="punctuation token">.</span><span class="function token">setInnerContent</span><span class="punctuation token">(</span>swapElements<span class="punctuation token">[</span><span class="string token">'taxNotice'</span><span class="punctuation token">]</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
	        <span class="punctuation token">}</span><span class="punctuation token">,</span>
	    <span class="punctuation token">}</span><span class="punctuation token">)</span>
	    <span class="punctuation token">.</span><span class="function token">on</span><span class="punctuation token">(</span><span class="string token">'[name="plan-type"]'</span><span class="punctuation token">,</span> <span class="punctuation token">{</span>
	        <span class="function token">element</span><span class="punctuation token">(</span><span class="parameter token">el</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
	            <span class="keyword token">if</span> <span class="punctuation token">(</span><span class="operator token">!</span>url<span class="punctuation token">.</span>searchParams<span class="punctuation token">.</span><span class="function token">has</span><span class="punctuation token">(</span><span class="string token">'plan-type'</span><span class="punctuation token">,</span> <span class="string token">'business'</span><span class="punctuation token">)</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
	                <span class="keyword token">return</span><span class="punctuation token">;</span>
	            <span class="punctuation token">}</span>
	            <span class="keyword token">const</span> isBusiness <span class="operator token">=</span> el<span class="punctuation token">.</span><span class="function token">getAttribute</span><span class="punctuation token">(</span><span class="string token">'value'</span><span class="punctuation token">)</span> <span class="operator token">===</span> <span class="string token">'business'</span><span class="punctuation token">;</span>
	            <span class="keyword token">if</span> <span class="punctuation token">(</span>isBusiness<span class="punctuation token">)</span> <span class="punctuation token">{</span>
	                el<span class="punctuation token">.</span><span class="function token">setAttribute</span><span class="punctuation token">(</span><span class="string token">'checked'</span><span class="punctuation token">,</span> <span class="string token">'checked'</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
	            <span class="punctuation token">}</span> <span class="keyword token">else</span> <span class="punctuation token">{</span>
	                el<span class="punctuation token">.</span><span class="function token">removeAttribute</span><span class="punctuation token">(</span><span class="string token">'checked'</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
	            <span class="punctuation token">}</span>
	        <span class="punctuation token">}</span><span class="punctuation token">,</span>
	    <span class="punctuation token">}</span><span class="punctuation token">)</span>
        <span class="punctuation token">.</span><span class="function token">transform</span><span class="punctuation token">(</span><span class="keyword token">await</span> context<span class="punctuation token">.</span>env<span class="punctuation token">.</span><span class="constant token">ASSETS</span><span class="punctuation token">.</span><span class="function token">fetch</span><span class="punctuation token">(</span>pageURL<span class="punctuation token">)</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
<span class="punctuation token">}</span>

<span class="comment token">// --------------------------</span>
<span class="comment token">// functions/pricing/index.ts</span>
<span class="comment token">// --------------------------</span>

<span class="keyword token">import</span> billingCountries <span class="keyword token">from</span> <span class="string token">'../../source/_data/billingCountries.json'</span><span class="punctuation token">;</span>

<span class="keyword token">const</span> supportedCountries <span class="operator token">=</span> billingCountries<span class="punctuation token">.</span><span class="function token">reduce</span><span class="punctuation token">(</span><span class="punctuation token">(</span><span class="parameter token">countries<span class="punctuation token">,</span> country</span><span class="punctuation token">)</span> <span class="operator token">=></span> <span class="punctuation token">{</span>
    countries<span class="punctuation token">.</span><span class="function token">add</span><span class="punctuation token">(</span>country<span class="punctuation token">.</span>code<span class="punctuation token">)</span><span class="punctuation token">;</span>
    <span class="keyword token">return</span> countries<span class="punctuation token">;</span>
<span class="punctuation token">}</span><span class="punctuation token">,</span> <span class="keyword token">new</span> <span class="class-name token">Set</span><span class="punctuation token">(</span><span class="punctuation token">)</span><span class="punctuation token">)</span><span class="punctuation token">;</span>

<span class="keyword token">export</span> <span class="keyword token">const</span> <span class="literal-property property token">onRequest</span><span class="operator token">:</span> PagesFunction<span class="tag token"><span class="tag token"><span class="punctuation token">&lt;</span><span class="class-name token">Env</span></span><span class="punctuation token">></span></span><span class="plain-text token"> = (context) => </span><span class="punctuation token">{</span>
    <span class="keyword token">let</span> country <span class="operator token">=</span> context<span class="punctuation token">.</span>request<span class="punctuation token">.</span>cf<span class="punctuation token">.</span>country<span class="punctuation token">;</span>
    <span class="keyword token">if</span> <span class="punctuation token">(</span><span class="operator token">!</span>supportedCountries<span class="punctuation token">.</span><span class="function token">has</span><span class="punctuation token">(</span>country<span class="punctuation token">)</span><span class="punctuation token">)</span> <span class="punctuation token">{</span>
        country <span class="operator token">=</span> <span class="string token">'US'</span><span class="punctuation token">;</span>
    <span class="punctuation token">}</span>
    <span class="keyword token">const</span> url <span class="operator token">=</span> <span class="keyword token">new</span> <span class="class-name token">URL</span><span class="punctuation token">(</span>context<span class="punctuation token">.</span>request<span class="punctuation token">.</span>url<span class="punctuation token">)</span><span class="punctuation token">;</span>
    url<span class="punctuation token">.</span>pathname <span class="operator token">=</span> <span class="template-string token"><span class="string template-punctuation token">`</span><span class="string token">/pricing/</span><span class="interpolation token"><span class="interpolation-punctuation punctuation token">${</span>country<span class="punctuation token">.</span><span class="function token">toLowerCase</span><span class="punctuation token">(</span><span class="punctuation token">)</span><span class="interpolation-punctuation punctuation token">}</span></span><span class="string token">/</span><span class="string template-punctuation token">`</span></span><span class="punctuation token">;</span>
    <span class="keyword token">return</span> Response<span class="punctuation token">.</span><span class="function token">redirect</span><span class="punctuation token">(</span>url<span class="punctuation token">.</span>href<span class="punctuation token">,</span> <span class="number token">302</span><span class="punctuation token">)</span><span class="punctuation token">;</span>
<span class="punctuation token">}</span><span class="plain-text token">;
</span></code></pre><p>Now, when a user visits <a href="http://www.fastmail.com/pricing/" target="_blank" rel="noopener">fastmail.com/pricing/</a>, they’ll be redirected to a page with prices in their currency (if we support it).</p><p>Unfortunately, this is the part of our site that isn’t portable. Hopefully, once <a href="https://wintercg.org/" target="_blank" rel="noopener">WinterCG</a> picks up steam, we’ll start seeing much better compatibility between these different runtimes. But for now, using an Edge worker does mean accepting a certain level of lock-in with your provider.</p><h2 id="wrapping-up" tabindex="-1">Wrapping up</h2><p>Personally, I’ve found Eleventy to be a great piece of software. It puts you in full control of the site you want to build and gives you the tools to extend its functionality with ease.</p>