<p>
I've recently started handling the <a href="https://www.bikebrigade.ca/">Bike Brigade</a>
newsletter, so now I'm itching to solve the little
bits of friction that get in my way when I work
with the rich-text <a href="https://mailchimp.com/">Mailchimp</a> block editor.
</p>

<p>
I'm not quite ready to generate everything with
<a href="https://sachachua.com/topic/org/">Org Mode</a>. Sometimes other people go in and edit
the newsletter through the web interface, so I
shouldn't just dump a bunch of HTML in. (We don't have the more expensive plan that would allow me to make editable templates.) I draft the newsletter as a Slack canvas so more people can weigh in with their suggestions:
</p>


<figure id="org0f4b188">
<img src="https://sachachua.com/blog/2025/06/transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours/2025-06-20_20-58-49.png" alt="2025-06-20_20-58-49.png" class="box-shadow">

<figcaption><span class="figure-number">Figure 1: </span>Screenshot of Slack canvas</figcaption>
</figure>

<p>
And then I redo it in Mailchimp:
</p>


<figure id="orge6e6f7c">
<img src="https://sachachua.com/blog/2025/06/transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours/2025-06-20_21-01-08.png" alt="2025-06-20_21-01-08.png" class="box-shadow">

<figcaption><span class="figure-number">Figure 2: </span>Screenshot of Mailchimp design</figcaption>
</figure>

<p>
My process is roughly:
</p>

<ol class="org-ol">
<li>Duplicate blocks.</li>
<li>Copy the text for each item and paste it in. Adjust formatting.</li>
<li>Update the dates and links. Flip back and forth between the dispatch webpage and Mailchimp, getting the links and the dates just right.</li>
<li>Download images one by one.</li>
<li>Replace the images by uploading the saved images. Hunt through lots of files named image (3).png, image (4).png, and so on. Update their attributes and links.</li>
<li>Change text and link colours as needed by manually selecting the text, clicking on the colour button in the toolbar, and selecting the correct colour.</li>
<li>Change the text on each button. Switch to Slack, copy the link, switch back to Mailchimp, and update the link.</li>
</ol>

<p>
I think I can get <a href="https://sachachua.com/topic/emacs/">Emacs</a> to make things easier.
</p>

<div class="sticky-toc" id="org1026119">
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="https://sachachua.com/blog/feed/index.xml#areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-automating-buttons">Automating buttons</a></li>
<li><a href="https://sachachua.com/blog/feed/index.xml#areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html">Transforming HTML</a></li>
<li><a href="https://sachachua.com/blog/feed/index.xml#areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-saving-images">Saving images</a></li>
<li><a href="https://sachachua.com/blog/feed/index.xml#areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-cleaning-up">Cleaning up</a></li>
<li><a href="https://sachachua.com/blog/feed/index.xml#areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-removing-sections">Removing sections</a></li>
<li><a href="https://sachachua.com/blog/feed/index.xml#areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-formatting-calls-to-action">Formatting calls to action</a></li>
<li><a href="https://sachachua.com/blog/feed/index.xml#areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-changing-link-colours">Changing link colours</a></li>
<li><a href="https://sachachua.com/blog/feed/index.xml#areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-wrapping-it-up">Wrapping it up</a></li>
<li><a href="https://sachachua.com/blog/feed/index.xml#areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-next-steps">Next steps</a></li>
</ul>
</div>

</div>
<div id="outline-container-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-automating-buttons" class="outline-3">
<h3 id="areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-automating-buttons">Automating buttons</h3>
<div class="outline-text-3" id="text-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-automating-buttons">
<p>
The newsletter includes a button to make it easier
to volunteer for deliveries. In case people want
to plan ahead, I also include a link to the
following week's signups.
</p>

<p>
Dates are fiddly and error-prone, so I want to
automate them. I can use a Mailchimp code block to
paste in some HTML directly, since I don't think
other people will need to edit this button. Here I
take advantage of <code>org-read-date</code>'s clever date
parsing so that I can specify dates like <code>+2Sun</code>
to mean two Sundays from now. That way, I don't
have to do any date calculations myself.
</p>

<p>
This code generates something like this:
</p>


<figure id="org0d802ed">
<img src="https://sachachua.com/blog/2025/06/transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours/2025-06-20_21-09-44.png" alt="2025-06-20_21-09-44.png" class="box-shadow">

<figcaption><span class="figure-number">Figure 3: </span>Screenshot of buttons</figcaption>
</figure>

<details class="code-details" style="padding: 1em;
                          background-color: #e5f5e5;
                          border-radius: 15px;
                          color: hsl(157 75%);
                          font-size: 0.9em;
                          box-shadow: 0.05em 0.1em 5px 0.01em  #00000057;">
                  <summary>
                    <strong>
                      <font face="Courier" size="3" color="green">
                         Text from the screenshot
                      </font>
                    </strong>
                  </summary>
<p>
SIGN UP NOW TO DELIVER JUN 23-29 <br>
You can also sign up early to deliver Jun 30-Jul 6
</p>


</details>

<p>
Here's the code. It calculates the dates, formats
the HTML code. I use <code>format-time-string</code> to
format just the month part of the dates and
compare them to tell if I can skip the month part
of the end date. After the HTML is formatted, the
code uses <a href="https://github.com/jordansissel/xdotool">xdotool</a> (a Linux command-line tool) to
switch to Google Chrome so that I can paste it in.
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(<span class="org-keyword">defun</span> <span class="org-function-name">my-brigade-copy-signup-block</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((newsletter-date (org-read-date nil nil <span class="org-string">"+Sun"</span>))
         (current-week (org-read-date nil t <span class="org-string">"+Mon"</span>))
         (current-week-end (org-read-date nil t <span class="org-string">"+2Sun"</span>))
         (next-week (org-read-date nil t <span class="org-string">"+2Mon"</span>))
         (next-week-end (org-read-date nil t <span class="org-string">"+3Sun"</span>)))
    (kill-new
     (format
      <span class="org-string">"&lt;div style=\"background-color: #223f4d; text-align: center; max-width: 384px; margin: auto; margin-bottom: 12px;\"&gt;&lt;a href=\"https://dispatch.bikebrigade.ca/campaigns/signup?current_week=%s\" target=\"_blank\" class=\"mceButtonLink\" style=\"background-color:#223f4d;border-radius:0;border:2px solid #223f4d;color:#ffffff;display:block;font-family:'Helvetica Neue', Helvetica, Arial, Verdana, sans-serif;font-size:16px;font-weight:normal;font-style:normal;padding:16px 28px;text-decoration:none;text-align:center;direction:ltr;letter-spacing:0px\" rel=\"noreferrer\"&gt;SIGN UP NOW TO DELIVER %s-%s&lt;/a&gt;</span>
<span class="org-string">&lt;/div&gt;</span>
<span class="org-string">&lt;p style=\"text-align: center; font-family: 'Helvetica Neue', Helvetica, Arial, Verdana\"&gt;&lt;a href=\"https://dispatch.bikebrigade.ca/campaigns/signup?current_week=%s\" style=\"color: #476584; margin-top: 12px; margin-bottom: 12px;\" target=\"_blank\"&gt;You can also sign up early to deliver %s-%s&lt;/a&gt;&lt;/p&gt;"</span>
      (format-time-string <span class="org-string">"%Y-%m-%d"</span> current-week)
      (upcase (format-time-string <span class="org-string">"%b %e"</span> current-week))
      (format-time-string
       (<span class="org-keyword">if</span> (string= (format-time-string <span class="org-string">"%m"</span> current-week)
                    (format-time-string <span class="org-string">"%m"</span> current-week-end))
           <span class="org-string">"%-e"</span>
         <span class="org-string">"%b %-e"</span>)
       current-week-end)
      (format-time-string <span class="org-string">"%Y-%m-%d"</span> next-week)
      (format-time-string <span class="org-string">"%b %e"</span> next-week)
      (format-time-string
       (<span class="org-keyword">if</span> (string= (format-time-string <span class="org-string">"%m"</span> next-week)
                    (format-time-string <span class="org-string">"%m"</span> next-week-end))
           <span class="org-string">"%-e"</span>
         <span class="org-string">"%b %-e"</span>)
       next-week-end)))
    (shell-command <span class="org-string">"xdotool search  &#45;&#45;onlyvisible &#45;&#45;all Chrome windowactivate windowfocus"</span>)))
</code></pre>
</div>


<p>
Now I can use an Org Mode link like
<code>elisp:my-brigade-copy-signup-block</code> to generate
the HTML code that I can paste into a Mailchimp
code block. The button link is underlined even
though the inline style says
<code>text-decoration:none</code>, but it's easy enough to
remove that with <code>Ctrl+u</code>.
</p>
</div>
</div>
<div id="outline-container-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html" class="outline-3">
<h3 id="areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html">Transforming HTML</h3>
<div class="outline-text-3" id="text-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html">
<p>
The rest of the newsletter is less
straightforward. I copy parts of the newsletter
draft from the canvas in Slack to the block editor
in Mailchimp. When I paste it in, I need to do a
lot to format the results neatly.
</p>

<p>
I think I'll want to use this technique of
transforming HTML data on the clipboard again in
the future, so let's start with a general way to
do it. This uses the <a href="https://github.com/astrand/xclip">xclip</a> tool for command-line
copying and pasting in X11 environments. It parses
the HTML into a document object model (DOM), runs
it through various functions sequentially, and
copies the transformed results. Using DOMs instead
of regular expressions means that it's easier to
handle nested elements.
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-transform-html-clipboard-functions</span> nil <span class="org-doc">"List of functions to call with the clipboard contents.</span>
<span class="org-doc">Each function should take a DOM node and return the resulting DOM node."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-transform-html-clipboard</span> (<span class="org-type">&amp;optional</span> activate-app-afterwards functions text)
  <span class="org-doc">"Parse clipboard contents and transform it.</span>
<span class="org-doc">This calls FUNCTIONS, defaulting to `</span><span class="org-doc"><span class="org-constant">my-transform-html-clipboard-functions</span></span><span class="org-doc">'.</span>
<span class="org-doc">If ACTIVATE-APP-AFTERWARDS is non-nil, use xdotool to try to activate that app's window."</span>
  (<span class="org-keyword">with-temp-buffer</span>
    (<span class="org-keyword">let</span> ((text (<span class="org-keyword">or</span> text (shell-command-to-string <span class="org-string">"unbuffer -p xclip -o -selection clipboard -t text/html 2&gt;&amp; /dev/null"</span>))))
      (<span class="org-keyword">if</span> (string= text <span class="org-string">""</span>)
          (<span class="org-warning">error</span> <span class="org-string">"Clipboard does not contain HTML."</span>)
        (insert (concat <span class="org-string">"&lt;div&gt;"</span>
                        text
                        <span class="org-string">"&lt;/div&gt;"</span>))))
    (<span class="org-keyword">let</span> ((dom (libxml-parse-html-region (point-min) (point-max))))
      (erase-buffer)
      (dom-print (seq-reduce
                  (<span class="org-keyword">lambda</span> (prev val)
                    (funcall val prev))
                  (<span class="org-keyword">or</span> functions my-transform-html-clipboard-functions)
                  dom)))
    (shell-command-on-region
     (point-min) (point-max)
     <span class="org-string">"xclip -i -selection clipboard -t text/html -filter 2&gt;&amp; /dev/null"</span>))
    (<span class="org-keyword">when</span> activate-app-afterwards
      (call-process <span class="org-string">"xdotool"</span> nil nil nil <span class="org-string">"search"</span> <span class="org-string">"&#45;&#45;onlyvisible"</span> <span class="org-string">"&#45;&#45;all"</span> activate-app-afterwards <span class="org-string">"windowactivate"</span> <span class="org-string">"windowfocus"</span>)))
</code></pre>
</div>

</div>
</div>
<div id="outline-container-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-saving-images" class="outline-3">
<h3 id="areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-saving-images">Saving images</h3>
<div class="outline-text-3" id="text-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-saving-images">
<p>
Images from Slack don't transfer cleanly to
Mailchimp. I can download images from Slack one at
a time, but Slack saves them with generic
filenames like <code>image (2).png</code>. Each main
newsletter item has one image, so I'd like to
automatically save the image using the item title.
</p>

<p>
When I copy HTML from the Slack canvas, images are
included as data URIs. The markup looks like this:
<code>&lt;img src='data:image/png;base64,iVBORw0KGgo...</code>
With the way I do the draft in Slack, images are
always followed by the item title as an <code>h2</code>
heading. If there isn't a heading, the image just
doesn't get saved. If there's no image in a
section, the code clears the variable, so that's
fine too. I can parse and save the images like
this:
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(<span class="org-keyword">defun</span> <span class="org-function-name">my-transform-html-save-images</span> (dom dir <span class="org-type">&amp;optional</span> file-prefix transform-fn)
  (<span class="org-keyword">let</span> (last-image)
    (dom-search dom
                (<span class="org-keyword">lambda</span> (node)
                  (<span class="org-keyword">pcase</span> (dom-tag node)
                    (<span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">img</span>
                     (<span class="org-keyword">let</span> ((data (<span class="org-keyword">dom-attr</span> node <span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">src</span>)))
                       (<span class="org-keyword">with-temp-buffer</span>
                         (insert data)
                         (goto-char (point-min))
                         (<span class="org-keyword">when</span> (looking-at <span class="org-string">"data:image/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">;]+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">;base64,"</span>)
                           (<span class="org-keyword">setq</span> last-image (cons (match-string 1)
                                                  (buffer-substring (match-end 0) (point-max))))))))
                    (<span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">h2</span>
                     (<span class="org-keyword">when</span> last-image
                       (<span class="org-keyword">with-temp-file</span>
                           (expand-file-name
                            (format <span class="org-string">"%s%s.%s"</span>
                                    (<span class="org-keyword">or</span> file-prefix <span class="org-string">""</span>)
                                    (<span class="org-keyword">if</span> transform-fn
                                        (funcall transform-fn (dom-texts node))
                                      (dom-texts node))
                                    (car last-image))
                            dir)
                         (set-buffer-file-coding-system <span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">binary</span>)
                         (insert (base64-decode-string (cdr last-image)))))
                     (<span class="org-keyword">setq</span> last-image nil)))))
    dom))
</code></pre>
</div>


<p>
I wrapped this in a small function for
newsletter-specific processing:
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-brigade-newsletter-images-directory</span> <span class="org-string">"~/proj/bike-brigade/newsletter/images"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-brigade-save-newsletter-images</span> (dom)
  (my-transform-html-save-images
   dom
   my-brigade-newsletter-images-directory
   (concat (org-read-date nil nil <span class="org-string">"+Sun"</span>)
           <span class="org-string">"-news-"</span>)
   (<span class="org-keyword">lambda</span> (heading)
     (replace-regexp-in-string
      <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">-a-z0-9]"</span> <span class="org-string">""</span>
      (replace-regexp-in-string
       <span class="org-string">" +"</span>
       <span class="org-string">"-"</span>
       (string-trim (downcase heading)))))))
</code></pre>
</div>


<p>
For easier testing, I used <code>xclip -o -selection
clipboard -t text/html &gt; ~/Downloads/test.html</code> to
save the clipboard. To run the code with the saved
clipboard, I can call it like this:
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(my-transform-html-clipboard
 nil
 <span class="org-highlight-quoted-quote">'</span>(my-brigade-save-newsletter-images)
 (<span class="org-keyword">with-temp-buffer</span> (insert-file-contents <span class="org-string">"~/Downloads/test.html"</span>) (buffer-string)))
</code></pre>
</div>

</div>
</div>
<div id="outline-container-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-cleaning-up" class="outline-3">
<h3 id="areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-cleaning-up">Cleaning up</h3>
<div class="outline-text-3" id="text-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-cleaning-up">
<p>
Now that I've saved the images, I can remove them:
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(<span class="org-keyword">defun</span> <span class="org-function-name">my-transform-html-remove-images</span> (dom)
  (<span class="org-keyword">dolist</span> (img (dom-by-tag dom <span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">img</span>))
    (dom-remove-node dom img))
  dom)
</code></pre>
</div>


<p>
I can also remove the italics that I use for comments.
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(<span class="org-keyword">defun</span> <span class="org-function-name">my-transform-html-remove-italics</span> (dom)
  (<span class="org-keyword">dolist</span> (node (dom-by-tag dom <span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">i</span>))
    (dom-remove-node dom node))
  dom)
</code></pre>
</div>


<p>
Here's how I can test it:
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(my-transform-html-clipboard
 nil
 <span class="org-highlight-quoted-quote">'</span>(my-brigade-save-newsletter-images
   my-transform-html-remove-images
   my-transform-html-remove-italics)
 (<span class="org-keyword">with-temp-buffer</span> (insert-file-contents <span class="org-string">"~/Downloads/test.html"</span>) (buffer-string)))
</code></pre>
</div>

</div>
</div>
<div id="outline-container-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-removing-sections" class="outline-3">
<h3 id="areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-removing-sections">Removing sections</h3>
<div class="outline-text-3" id="text-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-removing-sections">
<p>
I put longer comments and instructions under "Meta" headings, which I can automatically remove.
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-brigade-section</span> nil)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-brigade-remove-meta-recursively</span> (node <span class="org-type">&amp;optional</span> recursing)
  <span class="org-doc">"Remove &lt;h1&gt;Meta&lt;/h1&gt; headings in NODE and the elements that follow them.</span>
<span class="org-doc">Resume at the next h1 heading."</span>
  (<span class="org-keyword">unless</span> recursing (<span class="org-keyword">setq</span> my-brigade-section nil))
  (<span class="org-keyword">cond</span>
   ((eq (dom-tag node) <span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">h1</span>)
    (<span class="org-keyword">setq</span> my-brigade-section (string-trim (dom-texts node)))
    (<span class="org-keyword">if</span> (string= my-brigade-section <span class="org-string">"Meta"</span>)
        nil
      node))
   ((string= my-brigade-section <span class="org-string">"Meta"</span>)
    nil)
   (t
    (<span class="org-keyword">let</span> ((processed
           (seq-keep
            (<span class="org-keyword">lambda</span> (child)
              (<span class="org-keyword">if</span> (stringp child)
                  (<span class="org-keyword">unless</span> (string= my-brigade-section <span class="org-string">"Meta"</span>)
                    child)
                (my-brigade-remove-meta-recursively child t)))
            (dom-children node))))
      <span class="org-highlight-quoted-quote">`</span>(,(dom-tag node) ,(dom-attributes node) ,@processed)))))
</code></pre>
</div>


<p>
Let's try it out:
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(my-transform-html-clipboard
 nil
 <span class="org-highlight-quoted-quote">'</span>(my-brigade-save-newsletter-images
   my-transform-html-remove-images
   my-transform-html-remove-italics
   my-brigade-remove-meta-recursively)
 (<span class="org-keyword">with-temp-buffer</span> (insert-file-contents <span class="org-string">"~/Downloads/test.html"</span>) (buffer-string)))
</code></pre>
</div>

</div>
</div>
<div id="outline-container-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-formatting-calls-to-action" class="outline-3">
<h3 id="areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-formatting-calls-to-action">Formatting calls to action</h3>
<div class="outline-text-3" id="text-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-formatting-calls-to-action">
<p>
Mailchimp recommends using buttons for calls to
action so that they're larger and easier to click
than links. In my Slack canvas draft, I use [ link
text ] to indicate those calls to action. Wouldn't
it be nice if my code automatically transformed
those into centered buttons?
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(<span class="org-keyword">defun</span> <span class="org-function-name">my-brigade-format-buttons</span> (dom)
  (<span class="org-keyword">dolist</span> (node (dom-by-tag dom <span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">a</span>))
    (<span class="org-keyword">let</span> ((text (dom-texts node)))
      (<span class="org-keyword">if</span> (string-match <span class="org-string">"\\[ *</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> *\\]"</span> text)
          <span class="org-comment-delimiter">;; </span><span class="org-comment">button, wrap in a table</span>
          (<span class="org-keyword">with-temp-buffer</span>
            (insert
             (format <span class="org-string">"&lt;table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" data-block-id=\"627\" class=\"mceButtonContainer\" style=\"margin: auto; text-align: center\"&gt;&lt;tbody&gt;&lt;tr class=\"mceStandardButton\"&gt;&lt;td style=\"background-color:#000000;border-radius:0;text-align:center\" valign=\"top\" class=\"mceButton\"&gt;&lt;a href=\"%s\" target=\"_blank\" class=\"mceButtonLink\" style=\"background-color:#000000;border-radius:0;border:2px solid #000000;color:#ffffff;display:block;font-family:'Helvetica Neue', Helvetica, Arial, Verdana, sans-serif;font-size:16px;font-weight:normal;font-style:normal;padding:16px 28px;text-decoration:none;text-align:center;direction:ltr;letter-spacing:0px\" rel=\"noreferrer\"&gt;%s&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;"</span>
                     (<span class="org-keyword">dom-attr</span> node <span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">href</span>)
                     (match-string 1 text)))
            (dom-add-child-before
             (dom-parent dom node)
             (car (dom-by-tag (libxml-parse-html-region (point-min) (point-max)) <span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">table</span>)) node)
            (dom-remove-node dom node)))))
  dom)
</code></pre>
</div>


<p>
Now I can test those functions in combination:
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(my-transform-html-clipboard
 nil
 <span class="org-highlight-quoted-quote">'</span>(my-brigade-save-newsletter-images
   my-transform-html-remove-images
   my-transform-html-remove-italics
   my-brigade-remove-meta-recursively
   my-brigade-format-buttons)
 (<span class="org-keyword">with-temp-buffer</span> (insert-file-contents <span class="org-string">"~/Downloads/test.html"</span>) (buffer-string)))
</code></pre>
</div>



<figure id="orgdbbd552">
<img src="https://sachachua.com/blog/2025/06/transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours/2025-06-20_21-10-38.png" alt="2025-06-20_21-10-38.png" class="box-shadow">

<figcaption><span class="figure-number">Figure 4: </span>Screenshot of button</figcaption>
</figure>
</div>
</div>
<div id="outline-container-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-changing-link-colours" class="outline-3">
<h3 id="areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-changing-link-colours">Changing link colours</h3>
<div class="outline-text-3" id="text-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-changing-link-colours">
<p>
I also want to change the link colours to match
the colour scheme. The newsletter has two parts
distinguished by background colours. Bike Brigade
updates use black text on a white background, and
community updates use white text on a dark blue
background so that they're visually distinct. For
contrast, I like to use light blue links in the
community section, which doesn't match the colour
of the links when I paste them in from Slack. This
meant manually recolouring the text and each of
the links in Mailchimp, which was tedious.
</p>


<figure id="orgc28df29">
<img src="https://sachachua.com/blog/2025/06/transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours/2025-06-20_21-25-51.png" alt="2025-06-20_21-25-51.png" class="box-shadow">

<figcaption><span class="figure-number">Figure 5: </span>Screenshot of community update colours</figcaption>
</figure>

<p>
This code changes the colours of the links. It
also changes the colours of text by wrapping spans
around them. It skips the links we turned into
buttons.
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-brigade-community-text-style</span> <span class="org-string">"color: #ffffff"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-brigade-community-link-style</span> <span class="org-string">"color: #aed9ef"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-brigade-recolor-recursively</span> (node)
  <span class="org-doc">"Change the colors of links and text in NODE.</span>
<span class="org-doc">Ignore links with the class mceButtonLink.</span>
<span class="org-doc">Uses `</span><span class="org-doc"><span class="org-constant">my-brigade-community-text-style</span></span><span class="org-doc">' and `</span><span class="org-doc"><span class="org-constant">my-brigade-community-link-style</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">pcase</span> (dom-tag node)
    (<span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">table</span> node) <span class="org-comment-delimiter">; </span><span class="org-comment">pass through, don't recurse further</span>
    (<span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">a</span>           <span class="org-comment-delimiter">; </span><span class="org-comment">change the colour</span>
     (<span class="org-keyword">unless</span> (string= (<span class="org-keyword">or</span> (<span class="org-keyword">dom-attr</span> node <span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">class</span>) <span class="org-string">""</span>) <span class="org-string">"mceButtonLink"</span>)
       (dom-set-attribute node <span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">style</span> my-brigade-community-link-style))
     node)
    (_
     (<span class="org-keyword">let</span> ((processed
            (seq-map
             (<span class="org-keyword">lambda</span> (child)
               (<span class="org-keyword">if</span> (stringp child)
                   (dom-node <span class="org-highlight-quoted-quote">'</span><span class="org-highlight-quoted-symbol">span</span> <span class="org-highlight-quoted-quote">`</span>((style . ,my-brigade-community-text-style)) child)
                 (my-brigade-recolor-recursively child)))
             (dom-children node))))
       <span class="org-highlight-quoted-quote">`</span>(,(dom-tag node) ,(dom-attributes node) ,@processed)))))
</code></pre>
</div>


<p>
I can add that to the sequence:
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(my-transform-html-clipboard
 nil
 <span class="org-highlight-quoted-quote">'</span>(my-brigade-save-newsletter-images
   my-transform-html-remove-images
   my-transform-html-remove-italics
   my-brigade-remove-meta-recursively
   my-brigade-format-buttons
   my-brigade-recolor-recursively)
 (<span class="org-keyword">with-temp-buffer</span> (insert-file-contents <span class="org-string">"~/Downloads/test.html"</span>) (buffer-string)))
</code></pre>
</div>

</div>
</div>
<div id="outline-container-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-wrapping-it-up" class="outline-3">
<h3 id="areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-wrapping-it-up">Wrapping it up</h3>
<div class="outline-text-3" id="text-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-transforming-html-wrapping-it-up">
<p>
Now that I've made all those little pieces, I can put them together in two interactive functions. The first function will be for the regular colour scheme, and the second function will be for the light-on-dark colour scheme. For convenience, I'll have it activate Google Chrome afterwards so that I can paste the results into the right block.
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(<span class="org-keyword">defun</span> <span class="org-function-name">my-brigade-transform-html</span> (<span class="org-type">&amp;optional</span> recolor file)
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">when</span> current-prefix-arg (read-file-name <span class="org-string">"File: "</span>))))
  (my-transform-html-clipboard
  <span class="org-string">"Chrome"</span>
  (append
   <span class="org-highlight-quoted-quote">'</span>(my-brigade-save-newsletter-images
     my-transform-html-remove-images
     my-transform-html-remove-italics
     my-brigade-remove-meta-recursively
     my-brigade-format-buttons)
   (<span class="org-keyword">if</span> recolor <span class="org-highlight-quoted-quote">'</span>(my-brigade-recolor-recursively)))
  (<span class="org-keyword">when</span> file
    (<span class="org-keyword">with-temp-buffer</span> (insert-file-contents file) (buffer-string)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-brigade-transform-community-html</span> (<span class="org-type">&amp;optional</span> file)
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">when</span> current-prefix-arg (read-file-name <span class="org-string">"File: "</span>))))
  (my-brigade-transform-html t file))
</code></pre>
</div>


<p>
And then I can use links like this for quick shortcuts:
</p>

<ul class="org-ul">
<li><code>[[elisp:(my-brigade-transform-html nil "~/Downloads/test.html")]]</code></li>
<li><code>[[elisp:(my-brigade-transform-community-html "~/Downloads/test.html")]]</code></li>
<li><code>[[elisp:(my-brigade-transform-html)]]</code></li>
</ul>

<p>
Since this pastes the results as formatted text, it's
editable using the usual Mailchimp workflow. That
way, other people can make last-minute updates.
</p>

<p>
With embedded images, the saved HTML is about 8
MB. The code makes quick work of it. This saves
about 10-15 minutes per newsletter, so the time
investment probably won't <a href="https://xkcd.com/1205/">directly pay off</a>. But it
also reduces annoyance, which is even more
important than raw time savings. I enjoyed
figuring all this out. I think this technique of
transforming HTML in the clipboard will come in
handy. By writing the functions as small,
composable parts, I can change how I want to
transform the clipboard.
</p>
</div>
</div>
<div id="outline-container-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-next-steps" class="outline-3">
<h3 id="areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-next-steps">Next steps</h3>
<div class="outline-text-3" id="text-areas-transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours-next-steps">
<p>
It would be interesting to someday automate the campaign blocks while still making them mostly editable, as in the following examples:
</p>

<ul class="org-ul">
<li><a href="https://github.com/tan-yong-sheng/mailchimp_auto/">tan-yong-sheng/mailchimp_auto: A command line application to automate the email campaign creation process on MailChimp based on the google spreadsheet input</a></li>
<li><a href="https://dev.to/kylegalbraith/automating-my-newsletter-generation-with-mailchimp-google-sheets-and-aws-lambda-1n11">Automating My Newsletter Generation with MailChimp, Google Sheets, and AWS Lambda - DEV Community</a></li>
</ul>

<p>
Maybe someday!
</p>

<p>
(Also, hat tip to this <a href="https://www.reddit.com/r/emacs/comments/da9h10/why_does_shellcommand_hang_using_xclip_filter_to/">Reddit post</a> that helped me
get xclip to work more reliably from within Emacs
by adding <code>-filter 2&gt;&amp; /dev/null</code> to the end of my
xclip call so it didn't hang.)
</p>
</div>
</div>
<div><a href="https://sachachua.com/blog/2025/06/transforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours/index.org">View org source for this post</a></div>
<p>You can <a href="https://social.sachachua.com/@sacha/statuses/01JY8274M6CQC98Q64KYFTJE3C" target="_blank" rel="noopener noreferrer">comment on Mastodon</a> or <a href="mailto:sacha@sachachua.com?subject=Comment%20on%20https%3A%2F%2Fsachachua.com%2Fblog%2F2025%2F06%2Ftransforming-html-clipboard-contents-with-emacs-to-smooth-out-mailchimp-annoyances-dates-images-comments-colours%2F&body=Name%20you%20want%20to%20be%20credited%20by%20(if%20any)%3A%20%0AMessage%3A%20%0ACan%20I%20share%20your%20comment%20so%20other%20people%20can%20learn%20from%20it%3F%20Yes%2FNo%0A">e-mail me at sacha@sachachua.com</a>.</p>