<p>It's been roughly 9 months since I <a href="https://xenodium.com/a-chatgpt-emacs-shell/">experimented</a> with wiring the <a href="https://openai.com/blog/chatgpt">ChatGPT</a> API to an Emacs <a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Shell-Prompts.html">comint</a> buffer in <a href="https://github.com/xenodium/chatgpt-shell">chatgpt-shell</a>. ChatGPT's request-response nature maps fairly well to a shell's mode of interaction.</p>
<p>In the past, I've also talked about <a href="https://xenodium.com/yasnippet-in-emacs-eshell/">blurring the lines between shell and editor</a>. That is, using Emacs as your shell (<a href="https://www.masteringemacs.org/article/complete-guide-mastering-eshell">eshell</a> being my favourite) enables compounding goodies from both shell and editor when both are used from the same app.</p>
<p>Keeping interactions within the same app also cuts down on some of that friction that comes with context switching between your text editor and the browser for <a href="https://en.wikipedia.org/wiki/Large_language_model">llm</a> things.</p>
<p>Today, my interactions with llms typically consists of copying and pasting details from other Emacs buffers, crafting a query, and finally submitting by pressing enter (RET) from a shell like <a href="https://github.com/xenodium/chatgpt-shell">chatgpt-shell</a>.</p>
<p><img src="https://xenodium.github.io/images/a-chatgpt-shell-compose-ux-experiment/shell-find-bug.gif" alt=""></p>
<p>With the entire interaction happening from Emacs, we're already cutting a fair amount of friction… But we can do better, specially when copying, pasting, and crafting those multi-line queries (you don't want to prematurely submit those shell queries by inadvertently pressing RET when you want a newline).</p>
<h2>chatgpt-shell-prompt-compose</h2>
<p>This is where <code>chatgpt-shell-prompt-compose</code> comes in, an opinionated experiment bringing some of my favourite &quot;compose&quot; features over from the likes of <a href="https://github.com/magit">magit</a> commit buffers, <a href="https://www.gnu.org/software/emacs/manual/html_node/org/Using-capture.html">org capture</a>, <a href="https://www.djcbsoftware.nl/code/mu/mu4e/">mu4e</a> compose, and so on…</p>
<p>You can bring a compose buffer up by invoking <code>M-x chatgpt-shell-prompt-compose</code>. From there, you can both craft and send your queries. If you're a magit fan, the process should feel fairly familiar with crafting a git commit message by editing away and quickly committing (via <code>C-c C-c</code> binding). Similarly, you can also abort with the familiar <code>C-c C-k</code> binding.</p>
<p><img src="https://xenodium.github.io/images/a-chatgpt-shell-compose-ux-experiment/10k.gif" alt=""></p>
<p>I use this compose utility often enough that I bound it to <code>C-c C-e</code>, though this may not be your cup of tea (needs overriding other mode maps).</p>
<pre><code class="language-{.commonlisp">(use-package chatgpt-shell
  :commands
  (chatgpt-shell
   chatgpt-shell-prompt-compose)
  :bind ((&quot;C-c C-e&quot; . chatgpt-shell-prompt-compose)
         :map org-mode-map
         (&quot;C-c C-e&quot; . chatgpt-shell-prompt-compose)
         :map eshell-mode-map
         (&quot;C-c C-e&quot; . chatgpt-shell-prompt-compose)
         :map mu4e-compose-mode-map
         (&quot;C-c C-e&quot; . chatgpt-shell-prompt-compose)
         :map emacs-lisp-mode-map
         (&quot;C-c C-e&quot; . chatgpt-shell-prompt-compose)))
</code></pre>
<p>While the compose buffer displays a single query/response at a time, it also follows on from previous requests. You can press <code>r</code> to reply and continue the conversation.</p>
<p><img src="https://xenodium.github.io/images/a-chatgpt-shell-compose-ux-experiment/marathon.gif" alt=""></p>
<p>The compose buffer is fairly stateless and mostly serves as viewport over the last query in the shell itself. If you invoke <code>chatgpt-shell-prompt-compose</code> with a prefix (ie. C-u), it wipes the shell history. You can do it from the compose buffer itself, if you forgot to prior to launching.</p>
<p>You can also use the <code>o</code> binding to jump to the &quot;other buffer&quot; (the shell carrying the conversation history).</p>
<p><img src="https://xenodium.github.io/images/a-chatgpt-shell-compose-ux-experiment/other.gif" alt=""></p>
<p>If using the <code>r</code> and <code>o</code> bindings in a compose buffer sounds a little strange, fear not. The compose buffer is writeable while crafting queries, thus you can safely insert any character. Once a query is submitted (via <code>C-c C-c</code>), the buffer automatically becomes read-only, and thus unlocking single-character bindings.</p>
<p>Another magit commit favorite of mine is using the <code>M-p</code> or <code>M-n</code> bindings to insert previous messages via <code>git-commit-prev-message</code> or <code>git-commit-next-message</code>.</p>
<p>With that in mind, I also brought <code>M-p</code> and <code>M-n</code> over to the editable compose buffer.</p>
<p><img src="https://xenodium.github.io/images/a-chatgpt-shell-compose-ux-experiment/previous-next-history.gif" alt=""></p>
<p>If cycling isn't efficient enough, you can also use the typical <code>M-r</code> binding to search and insert from history.</p>
<p><img src="https://xenodium.github.io/images/a-chatgpt-shell-compose-ux-experiment/search-history.png" alt=""></p>
<p>Now, getting back to removing some of that copy-pasting friction… Selecting text in any buffer and invoking <code>M-x chatgpt-shell-prompt-compose</code> (or <code>C-c C-e</code> in my case) automatically pastes the region into the compose buffer. You get to tweak your query before submitting (via that familiar <code>C-c C-c</code>), in a more flexible buffer (compared to a shell).</p>
<p><em>Note: You can also invoke the compose command with a region as many times as you'd like. Each region is sent to the compose buffer, so you can craft more involved queries before submission.</em></p>
<p><img src="https://xenodium.github.io/images/a-chatgpt-shell-compose-ux-experiment/find-and-fix-bug.gif" alt=""></p>
<p>While I typically prefer short query responses (using diffs like the example above), I sometimes want full snippets as follow-ups. I found myself typing <em>&quot;show entire snippet&quot;</em> often enough, that I now use one of those single-character bindings (<code>e</code>) for this purpose.</p>
<p><img src="https://xenodium.github.io/images/a-chatgpt-shell-compose-ux-experiment/show-entire-snippet.gif" alt=""></p>
<h2>Compose bindings</h2>
<p>I've showcased most of the compose key bindings, here's the whole lot (so far anyway), which you can also view from <code>chatgpt-shell-prompt-compose</code>'s documentation.</p>
<h3>Editing</h3>
<ul>
<li><code>C-c C-c</code> to send the buffer query.</li>
<li><code>C-c C-k</code> to cancel compose buffer.</li>
<li><code>M-r</code> search through history.</li>
<li><code>M-p</code> cycle through previous item in history.</li>
<li><code>M-n</code> cycle through next item in history.</li>
</ul>
<h3>Read-only</h3>
<ul>
<li><code>C-c C-c</code> After sending offers to abort query in-progress.</li>
<li><code>q</code> Exits the read-only buffer.</li>
<li><code>g</code> Refresh (re-send the query). Useful to retry on disconnects.</li>
<li><code>n</code> Jump to next source block.</li>
<li><code>p</code> Jump to next previous block.</li>
<li><code>r</code> Reply to follow-up with additional questions.</li>
<li><code>e</code> Send &quot;Show entire snippet&quot; query.</li>
<li><code>o</code> Jump to other buffer (ie. the shell itself).</li>
<li><code>C-M-h</code> Mark block at point.</li>
</ul>
<h2>Buyer beware: it's all pretty experimental</h2>
<p>When I started playing with the compose buffer idea, I wasn't too sure whether or not its usage would stick, so I basically hacked <code>chatgpt-shell-prompt-compose</code> to pieces. A cheap prototype of sorts to validate the idea before fully committing to a more involved solution.</p>
<p>I'll eventually rewrite <code>chatgpt-shell-prompt-compose</code> as either a major or minor mode if there's enough interest.</p>
<p>For now, I'll continue using as is to validate its usefulness.</p>
<p>If you give <code>chatgpt-shell-prompt-compose</code> a try, I'd love to hear your feedback (<a href="https://indieweb.social/@xenodium">Mastodon</a> / <a href="https://twitter.com/xenodium">Twitter</a> / <a href="https://www.reddit.com/user/xenodium">Reddit</a> / <a href="mailto:me__AT__xenodium.com">Email</a>).</p>
<p><em>Enjoying this content? Find it useful? Consider <a href="https://github.com/sponsors/xenodium">sponsoring</a>.</em></p>
