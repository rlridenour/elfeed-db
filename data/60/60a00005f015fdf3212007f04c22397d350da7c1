
         
         <p>Over at Oxford University they use their own calendaring scheme to
label the terms and weeks of their school year. Why? Because they can!
And why would some guy in the mountains of Cyprus care? Because it‚Äôs
fun to write Emacs Lisp!</p>

<p>The academic year is divided into three periods of teaching and three
of vacation. The latter have no special names, while the former are
called ‚ÄúMichaelmas‚Äù, ‚ÄúHilary‚Äù, and ‚ÄúTrinity‚Äù. Each teaching term
consists of a few weeks whose numbering starts from <code class="language-plaintext highlighter-rouge">1</code>.</p>

<p>With some custom code, we can configure the Emacs <code class="language-plaintext highlighter-rouge">M-x calendar</code> to
tell us (i) which term we are in for the current month of the Oxford
academic year, if any, (ii) which term and week number we are in, if
any, and (iii) which is the standard week number.</p>

<h2>The generic ‚ÄòM-x calendar‚Äô üò¥</h2>

<p>Here is how it looks without any customisations. Serviceable, but not
conducive to the Oxford culture.</p>

<p><a href="https://protesilaos.com/assets/images/attachments/2025-01-09-emacs-calendar-generic.png"><img alt="Generic Emacs calendar" src="https://protesilaos.com/assets/images/attachments/2025-01-09-emacs-calendar-generic.png" /></a></p>

<h2>The Oxford-friendly ‚ÄòM-x calendar‚Äô üéì</h2>

<p>It is busier, for sure, though this is what you get for being at
Oxford. Notice that when there is nothing Oxford-related, we just show
the regular calendar information.</p>

<p><a href="https://protesilaos.com/assets/images/attachments/2025-01-09-emacs-calendar-oxford.png"><img alt="Oxford Emacs calendar" src="https://protesilaos.com/assets/images/attachments/2025-01-09-emacs-calendar-oxford.png" /></a></p>

<h2>The code</h2>

<p><strong>UPDATE 2025-01-09 18:36 +0200:</strong> I revised a few lines of code to
(i) work with either Sunday or Monday as the first day of the week,
(ii) not show any Oxford week beyond the years specified in
<code class="language-plaintext highlighter-rouge">prot-oxford-dates</code>.</p>

<hr />

<p>I wrote this over the course of a few hours. It may be refined here
and there, but I think it is already good enough. The only major
improvement would be to implement the formula that Oxford uses to
derive their dates. As I do not know it, the <code class="language-plaintext highlighter-rouge">prot-oxford-dates</code> have
to be updated manually each year.</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; NOTE 2025-01-09: Perhaps there is some formula to always get the</span>
<span class="c1">;; dates, but I am not aware of it.  As such, these dates need to be</span>
<span class="c1">;; updated at the start of each school year.</span>
<span class="c1">;;</span>
<span class="c1">;; Source: &lt;https://www.ox.ac.uk/about/facts-and-figures/dates-of-term&gt;.</span>
<span class="p">(</span><span class="nb">defvar</span> <span class="nv">prot-oxford-dates</span>
  <span class="o">'</span><span class="p">((</span><span class="nv">michaelmas</span>  <span class="p">(</span><span class="mi">10</span> <span class="mi">13</span> <span class="mi">2024</span><span class="p">)</span>  <span class="p">(</span><span class="mi">12</span> <span class="mi">7</span> <span class="mi">2024</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">hilary</span>      <span class="p">(</span><span class="mi">1</span>  <span class="mi">19</span> <span class="mi">2025</span><span class="p">)</span>  <span class="p">(</span><span class="mi">3</span> <span class="mi">15</span> <span class="mi">2025</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">trinity</span>     <span class="p">(</span><span class="mi">4</span>  <span class="mi">27</span> <span class="mi">2025</span><span class="p">)</span>  <span class="p">(</span><span class="mi">6</span> <span class="mi">21</span> <span class="mi">2025</span><span class="p">)))</span>
  <span class="s">"Alist of Oxford calendar terms with start and end date.
Each element is of the form (NAME START END), where NAME is the name of
the term, as a symbol, START is the start date and END is the end date.
START and END each are of the form (month day year), where each element
is a number."</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">prot-oxford--get-iso-week</span> <span class="p">(</span><span class="nv">date</span><span class="p">)</span>
  <span class="s">"Get the ISO week of DATE.
DATE is a list of the form (month day year)."</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">calendar-date-is-valid-p</span> <span class="nv">date</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">error</span> <span class="s">"The date `%s' does not conform with `calendar-date-is-valid-p'"</span> <span class="nv">date</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">car</span>
   <span class="p">(</span><span class="nv">calendar-iso-from-absolute</span>
    <span class="p">(</span><span class="nv">calendar-absolute-from-gregorian</span> <span class="nv">date</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">prot-oxford--get-term-week</span> <span class="p">(</span><span class="nv">term-start-week</span> <span class="nv">term-end-week</span> <span class="nv">iso-week</span> <span class="nv">prefix</span><span class="p">)</span>
  <span class="s">"Return the number of the Oxford term week or nil.
Determine the week given TERM-START-WEEK and TERM-END-WEEK as Gregorian
week numbers.  Compare ISO-WEEK to them.

If `calendar-week-start-day' is a Monday, then start counting weeks from
0, because Oxford weeks start from Sunday (otherwise, Week 1 includes 6
days before the first Sunday).

When returning the number, concatenate it with PREFIX.  PREFIX is a
single letter string.  A longer PREFIX is trimmed accordingly."</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="nv">term-start-week</span> <span class="nv">term-end-week</span> <span class="nv">iso-week</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">when-let*</span> <span class="p">((</span><span class="nv">offset</span> <span class="p">(</span><span class="nv">pcase</span> <span class="nv">calendar-week-start-day</span>
                          <span class="p">(</span><span class="mi">0</span> <span class="mi">1</span><span class="p">)</span>
                          <span class="p">(</span><span class="mi">1</span> <span class="mi">0</span><span class="p">)))</span>
                <span class="p">(</span><span class="nc">number</span> <span class="p">(</span><span class="nb">cond</span>
                         <span class="p">((</span><span class="nb">&gt;</span> <span class="nv">iso-week</span> <span class="nv">term-end-week</span><span class="p">)</span>
                          <span class="no">nil</span><span class="p">)</span>
                         <span class="p">((</span><span class="nb">=</span> <span class="nv">term-start-week</span> <span class="nv">iso-week</span><span class="p">)</span>
                          <span class="nv">offset</span><span class="p">)</span>
                         <span class="p">((</span><span class="nb">&lt;</span> <span class="nv">term-start-week</span> <span class="nv">iso-week</span><span class="p">)</span>
                          <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">iso-week</span> <span class="nv">term-start-week</span><span class="p">)</span> <span class="nv">offset</span><span class="p">))))</span>
                <span class="p">(</span><span class="nv">pre</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">prefix</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span>
                         <span class="p">(</span><span class="nv">substring</span> <span class="nv">prefix</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">)</span>
                       <span class="nv">prefix</span><span class="p">)))</span>
      <span class="p">(</span><span class="nv">concat</span> <span class="nv">pre</span> <span class="p">(</span><span class="nv">number-to-string</span> <span class="nc">number</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">prot-oxford--get-term-weeks</span> <span class="p">(</span><span class="nv">term</span> <span class="nv">year</span><span class="p">)</span>
  <span class="s">"Return Oxford TERM start and end week numbers as a list.
Check YEAR to determine if the date is out of bonds of the
`prot-oxford-dates'."</span>
  <span class="p">(</span><span class="nv">pcase-let*</span> <span class="p">((</span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">beg-date</span> <span class="o">,</span><span class="nv">end-date</span><span class="p">)</span> <span class="p">(</span><span class="nv">alist-get</span> <span class="nv">term</span> <span class="nv">prot-oxford-dates</span><span class="p">))</span>
               <span class="p">(</span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">_</span> <span class="o">,</span><span class="nv">_</span> <span class="o">,</span><span class="nv">term-year</span><span class="p">)</span> <span class="nv">beg-date</span><span class="p">)</span>
               <span class="p">(</span><span class="nv">beg-week</span> <span class="p">(</span><span class="nv">prot-oxford--get-iso-week</span> <span class="nv">beg-date</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">end-week</span> <span class="p">(</span><span class="nv">prot-oxford--get-iso-week</span> <span class="nv">end-date</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">=</span> <span class="nv">term-year</span> <span class="nv">year</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">list</span> <span class="nv">beg-week</span> <span class="nv">end-week</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">defface</span> <span class="nv">prot-oxford-term-indicator</span>
  <span class="o">'</span><span class="p">((((</span><span class="nc">class</span> <span class="nv">color</span><span class="p">)</span> <span class="p">(</span><span class="nv">min-colors</span> <span class="mi">88</span><span class="p">)</span> <span class="p">(</span><span class="nv">background</span> <span class="nv">light</span><span class="p">))</span>
     <span class="ss">:foreground</span> <span class="s">"#224499"</span><span class="p">)</span>
    <span class="p">(((</span><span class="nc">class</span> <span class="nv">color</span><span class="p">)</span> <span class="p">(</span><span class="nv">min-colors</span> <span class="mi">88</span><span class="p">)</span> <span class="p">(</span><span class="nv">background</span> <span class="nv">dark</span><span class="p">))</span>
     <span class="ss">:foreground</span> <span class="s">"#afc9f3"</span><span class="p">)</span>
    <span class="p">(</span><span class="no">t</span> <span class="ss">:inherit</span> <span class="nb">shadow</span><span class="p">))</span>
  <span class="s">"Face to style the Oxford term indicator."</span><span class="p">)</span>

<span class="p">(</span><span class="nv">defface</span> <span class="nv">prot-oxford-regular-week</span>
  <span class="o">'</span><span class="p">((</span><span class="no">t</span> <span class="ss">:inherit</span> <span class="nb">shadow</span><span class="p">))</span>
  <span class="s">"Face to style the regular week."</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">prot-oxford-week</span> <span class="p">(</span><span class="nv">month</span> <span class="nv">day</span> <span class="nv">year</span><span class="p">)</span>
  <span class="s">"Use MONTH DAY YEAR to determine current week.
Derive the Oxford term week based on the `prot-oxford-dates'."</span>
  <span class="p">(</span><span class="nv">pcase-let*</span> <span class="p">((</span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">m-w-beg</span> <span class="o">,</span><span class="nv">m-w-end</span><span class="p">)</span> <span class="p">(</span><span class="nv">prot-oxford--get-term-weeks</span> <span class="ss">'michaelmas</span> <span class="nv">year</span><span class="p">))</span>
               <span class="p">(</span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">h-w-beg</span> <span class="o">,</span><span class="nv">h-w-end</span><span class="p">)</span> <span class="p">(</span><span class="nv">prot-oxford--get-term-weeks</span> <span class="ss">'hilary</span> <span class="nv">year</span><span class="p">))</span>
               <span class="p">(</span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">t-w-beg</span> <span class="o">,</span><span class="nv">t-w-end</span><span class="p">)</span> <span class="p">(</span><span class="nv">prot-oxford--get-term-weeks</span> <span class="ss">'trinity</span> <span class="nv">year</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">gregorian-week</span> <span class="p">(</span><span class="nv">prot-oxford--get-iso-week</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">month</span> <span class="nv">day</span> <span class="nv">year</span><span class="p">)))</span>
               <span class="p">(</span><span class="nv">oxford-week</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">prot-oxford--get-term-week</span> <span class="nv">m-w-beg</span> <span class="nv">m-w-end</span> <span class="nv">gregorian-week</span> <span class="s">"M"</span><span class="p">)</span>
                                <span class="p">(</span><span class="nv">prot-oxford--get-term-week</span> <span class="nv">h-w-beg</span> <span class="nv">h-w-end</span> <span class="nv">gregorian-week</span> <span class="s">"H"</span><span class="p">)</span>
                                <span class="p">(</span><span class="nv">prot-oxford--get-term-week</span> <span class="nv">t-w-beg</span> <span class="nv">t-w-end</span> <span class="nv">gregorian-week</span> <span class="s">"T"</span><span class="p">)</span>
                                <span class="s">""</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="s">" %2s  %2s  "</span>
            <span class="p">(</span><span class="nv">propertize</span> <span class="nv">oxford-week</span> <span class="ss">'face</span> <span class="ss">'prot-oxford-term-indicator</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">propertize</span> <span class="p">(</span><span class="nb">format</span> <span class="s">"%2s"</span> <span class="nv">gregorian-week</span><span class="p">)</span> <span class="ss">'face</span> <span class="ss">'prot-oxford-regular-week</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">prot-oxford--get-term-month</span> <span class="p">(</span><span class="nv">term-name</span> <span class="nv">term-start-month</span> <span class="nv">term-end-month</span> <span class="nv">month</span><span class="p">)</span>
  <span class="s">"Return the TERM-NAME of the term month or nil.
Determine the name given TERM-START-MONTH and TERM-END-MONTH as month
numbers.  Compare MONTH to them."</span>
  <span class="p">(</span><span class="nv">when-let*</span> <span class="p">((</span><span class="nc">number</span> <span class="p">(</span><span class="nb">cond</span>
                       <span class="p">((</span><span class="nb">&gt;</span> <span class="nv">month</span> <span class="nv">term-end-month</span><span class="p">)</span>
                        <span class="no">nil</span><span class="p">)</span>
                       <span class="p">((</span><span class="nb">=</span> <span class="nv">term-start-month</span> <span class="nv">month</span><span class="p">)</span>
                        <span class="mi">1</span><span class="p">)</span>
                       <span class="p">((</span><span class="nb">&lt;</span> <span class="nv">term-start-month</span> <span class="nv">month</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">month</span> <span class="nv">term-start-month</span><span class="p">)</span> <span class="mi">1</span><span class="p">)))))</span>
    <span class="nv">term-name</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">prot-oxford--get-months</span> <span class="p">(</span><span class="nv">term</span><span class="p">)</span>
  <span class="s">"Get start and end months of `prot-oxford-dates' TERM as a list."</span>
  <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#'</span><span class="nb">car</span> <span class="p">(</span><span class="nv">alist-get</span> <span class="nv">term</span> <span class="nv">prot-oxford-dates</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">prot-oxford-month</span> <span class="p">(</span><span class="nv">year</span> <span class="nv">month</span><span class="p">)</span>
  <span class="s">"Return abbreviated name of MONTH for YEAR.
Append the Oxford term name based on the `prot-oxford-dates'."</span>
  <span class="p">(</span><span class="nv">pcase-let*</span> <span class="p">((</span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">m-beg</span> <span class="o">,</span><span class="nv">m-end</span><span class="p">)</span> <span class="p">(</span><span class="nv">prot-oxford--get-months</span> <span class="ss">'michaelmas</span><span class="p">))</span>
               <span class="p">(</span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">h-beg</span> <span class="o">,</span><span class="nv">h-end</span><span class="p">)</span> <span class="p">(</span><span class="nv">prot-oxford--get-months</span> <span class="ss">'hilary</span><span class="p">))</span>
               <span class="p">(</span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">t-beg</span> <span class="o">,</span><span class="nv">t-end</span><span class="p">)</span> <span class="p">(</span><span class="nv">prot-oxford--get-months</span> <span class="ss">'trinity</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">oxford-term-name</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">prot-oxford--get-term-month</span> <span class="s">"Michael"</span> <span class="nv">m-beg</span> <span class="nv">m-end</span> <span class="nv">month</span><span class="p">)</span>
                                     <span class="p">(</span><span class="nv">prot-oxford--get-term-month</span> <span class="s">"Hilary"</span> <span class="nv">h-beg</span> <span class="nv">h-end</span> <span class="nv">month</span><span class="p">)</span>
                                     <span class="p">(</span><span class="nv">prot-oxford--get-term-month</span> <span class="s">"Trinity"</span> <span class="nv">t-beg</span> <span class="nv">t-end</span> <span class="nv">month</span><span class="p">)</span>
                                     <span class="s">""</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="s">"%s %s %s"</span>
            <span class="p">(</span><span class="nv">propertize</span> <span class="p">(</span><span class="nv">calendar-month-name</span> <span class="nv">month</span> <span class="ss">:abbreviate</span><span class="p">)</span> <span class="ss">'face</span> <span class="ss">'calendar-month-header</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">propertize</span> <span class="p">(</span><span class="nb">format</span> <span class="s">"%s"</span> <span class="nv">year</span><span class="p">)</span> <span class="ss">'face</span> <span class="ss">'calendar-month-header</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">propertize</span> <span class="nv">oxford-term-name</span> <span class="ss">'face</span> <span class="ss">'prot-oxford-term-indicator</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">prot-oxford-intermonth-header</span> <span class="p">()</span>
  <span class="s">"Return string for `calendar-intermonth-header'."</span>
  <span class="p">(</span><span class="nb">format</span> <span class="s">"%s %s"</span>
          <span class="p">(</span><span class="nv">propertize</span> <span class="s">"OX"</span> <span class="ss">'face</span> <span class="ss">'prot-oxford-term-indicator</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">propertize</span> <span class="s">"Week"</span> <span class="ss">'face</span> <span class="ss">'shadow</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">setopt</span> <span class="nv">calendar-left-margin</span> <span class="mi">10</span>
        <span class="c1">;; Oxford assumes Sunday starts the week, but we want to work</span>
        <span class="c1">;; with the ISO commercial dates, so Monday (1) is the first</span>
        <span class="c1">;; day of the week.  But Sunday (0) will still work.</span>
        <span class="nv">calendar-week-start-day</span> <span class="mi">1</span>
        <span class="nv">calendar-intermonth-spacing</span> <span class="mi">12</span>
        <span class="nv">calendar-intermonth-header</span> <span class="p">(</span><span class="nv">prot-oxford-intermonth-header</span><span class="p">)</span>
        <span class="nv">calendar-intermonth-text</span> <span class="o">'</span><span class="p">(</span><span class="nv">prot-oxford-week</span> <span class="nv">month</span> <span class="nv">day</span> <span class="nv">year</span><span class="p">)</span>
        <span class="nv">calendar-month-header</span> <span class="o">'</span><span class="p">(</span><span class="nv">prot-oxford-month</span> <span class="nv">year</span> <span class="nv">month</span><span class="p">))</span>
</code></pre></div></div>
        
      