<p>
<i>Published: [2025-07-04 Fri]. Comments <a href="https://mathstodon.xyz/@oantolin/114797585280691160">on Mastodon</a>.</i>
</p>

<p>
It's Friday and jcs over at <a href="https://irreal.org/blog/">Irreal</a> has started a tradition of being
polemical on what he calls <i>Red Meat Fridays</i>. I'm joining in on the fun
today to explain why I don't like <code>which-key</code> ―but going somewhat
against the red meat spirit I don't want to merely criticize: I'll
offer up a suggestion of something better at the end, too.
</p>

<p>
What <code>which-key-mode</code> does is popup in the echo area a list of key
bindings and commands found under the current prefix. Here's what it
looks like after I pressed <code>C-x C-k</code> waited a second for the popup to
appear:
</p>


<div id="org308eee0" class="figure">
<p><img src="http://www.matem.unam.mx/~omar/files/which-key-example.png" alt="which-key-example.png" />
</p>
</div>

<p>
Since the commands under <code>C-x C-k</code> didn't all fit on a single page,
<code>which-key</code> splits them into multiple pages and you can advance through
them with <code>C-h n</code> and <code>C-h p</code>. Reading through the <code>which-key</code> popup is a
great way to learn what is bound under a prefix. People love this and
<code>which-key</code> is now bundled with Emacs.
</p>

<p>
So why don't I like it? There's a minor reason and a major reason. The
minor reason is simply that it is automatic by default. The default
configuration has the <code>which-key</code> popup appear 1 second after typing a
prefix. Some people love this because it pops up precisely when they
don't know or can't remember what key to press next. I dislike almost
all forms of automatically appearing UI finding them jittery and
distracting; I almost always prefer to summon UI explicitly with a key
press or maybe mouse action. I understand this only a personal
preference, and it is an easily fixed one at that! There is a simple
way to configure <code>which-key</code> to wait for you to type <code>C-h</code> to appear:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #213067; font-weight: bold;">setq</span> which-key-show-early-on-C-h t
      which-key-idle-delay 1e6 <span style="color: #084092; font-style: italic;">; </span><span style="color: #084092; font-style: italic;">11 days
</span>      which-key-idle-secondary-delay 0.05)
</pre>
</div>

<p>
So that was just a small matter of personal preference, what's the
major reason at the heart of this polemic then? It is this: I believe
we should use computers for automation, to assist us in finding
information. Clearly <code>which-key-mode</code> has a different philosophy: it
merely displays all the key bindings under a prefix and then lets
humans do all the work! A human has to read the key bindings, possibly
paging through a couple of pages them. It feels ridiculously to be
sitting at a computer, a very powerful information retrieval machine,
equipped with a high bandwidth input device (namely: a keyboard) and
to read a bunch of boring text as if it were printed on a piece of
paper (or two or sometimes even three pieces of paper!)
</p>

<p>
Now, sometimes you <i>do</i> want to read all the key bindings under a
prefix, to find out or to refresh your memory about what's there. In
those cases I have no problem with <code>which-key</code>'s approach, but I find
that most often I'm looking for a specific key binding and I remember
a portion of the command name or maybe a bit of the binding (some
Emacs key bindings are long enough that I can remember them
partially but not completely!) When I'm looking for a specific
binding, I really want the computer to do the searching for me, that's
what the damn thing is for!
</p>

<p>
And now I'll tell you about the improved <code>which-key</code> I promised at the
start. It has all the paper-like functionality of <code>which-key</code>, but
additionally will help you search instead of patiently waiting while
you to do all the work yourself. This replacement is a function called
<code>embark-prefix-help-command</code> that comes with my <a href="https://github.com/oantolin/embark">Embark</a> package. To use
it simply <code>(setq prefix-help-command #'embark-prefix-help-command)</code>. The
<code>prefix-help-command</code> variable controls what happens when you press <code>C-h</code>
after typing a prefix. What <code>embark-prefix-help-command</code> does is prompt
you in the minibuffer, with completion, for a key-binding−command pair
under the current prefix. You can view your options or type some input
in the minibuffer to narrow the listing. It is best paired with a
minibuffer completion UI that automatically displays the current
completion candidates in real time as you type. (I discussed several
of these in another blog post: <a href="#my-quest-for-completion">My quest for completion</a>.) I recommend
<a href="https://github.com/minad/vertico">Vertico</a>, because it has an option to display completions in a grid,
which makes <code>embark-prefix-help-command</code> look a lot like <code>which-key</code>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(vertico-multiform-mode)
(add-to-list 'vertico-multiform-categories '(embark-keybinding grid))
</pre>
</div>

<p>
Here's what that looks like, for the same <code>C-x C-k</code> prefix as above:
</p>


<div id="org97450cd" class="figure">
<p><img src="http://www.matem.unam.mx/~omar/files/embark-prefix-help-command-all.png" alt="embark-prefix-help-command-all.png" />
</p>
</div>

<p>
You could use this just like <code>which-key</code>, reading all the commands and
key bindings; Vertico even lets you use <code>C-v</code> and <code>M-v</code> to page through
the results (which I find slightly more comfortable than the default
in <code>which-key</code> of <code>C-h n</code> and <code>C-h p</code>). But you can also use the minibuffer
input to narrow the options. This works best if you have a completion
style that lets you type a substring from anywhere inside a candidate
to match it. I recommend the <a href="https://github.com/oantolin/orderless">Orderless</a> completion style, or I wouldn't
have written it, but the built-in <code>substring</code> completion style works
too. Say I was trying to remember a key binding for some command that
deals with keyboard macro counters ―see <code>(info "(emacs) Keyboard Macro
Counter")</code> if you haven't heard of these. Then you just type "cou" and
get this:
</p>


<div id="orgdf9bea2" class="figure">
<p><img src="http://www.matem.unam.mx/~omar/files/embark-prefix-help-command-narrowed.png" alt="embark-prefix-help-command-narrowed.png" />
</p>
</div>

<p>
You can also narrow by a part of the key binding rather than the
command name. For example, I'm writing this blog post in org-mode and
have inline images displayed, but when you add a new one that one is
not displayed automatically. I could toggle the display of inline
images off and on again with <code>C-c C-x C-v</code>, but I remembered there was a
key binding for that, under the same <code>C-c C-x</code> prefix that involved <code>v</code>
with some other modifiers, so I typed <code>C-c C-x C-h</code> and then "-v" and
saw that <code>C-M-v</code> was the rest of the binding I was looking for.
</p>

<p>
This UI is very flexible: besides the narrowing via completion, you
can do lots of other things. You can can navigate with <code>C-n</code>, <code>C-p</code> or the
arrow keys among the completion candidates, press <code>RET</code> on a command to
run it, and you have the full power of Embark: say you have <code>embark-act</code>
bound to <code>C-.</code>, then you can press <code>C-. h</code> when a candidate is displayed
to show its documentation, or <code>C-. d</code> to go to its definition, or <code>C-. w</code>
to copy the command name to the kill-ring. Or say you want to explore
some subset of the commands more in depth, you can narrow to the
subset you want and run <code>embark-export</code> (with <code>C-. E</code>) to get a nice
<code>apropos-mode</code> buffer with a summary of those functions, like this one:
</p>


<div id="org7b17013" class="figure">
<p><img src="http://www.matem.unam.mx/~omar/files/embark-prefix-help-command-apropos.png" alt="embark-prefix-help-command-apropos.png" />
</p>
</div>

<p>
Or say, you wanted a little table of those keyboard macro counter
commands and their key bindings. Instead of <code>embark-export</code> you'd use
<code>embark-collect</code> to get this buffer:
</p>


<div id="orgbdb4374" class="figure">
<p><img src="http://www.matem.unam.mx/~omar/files/embark-prefix-help-command-collect.png" alt="embark-prefix-help-command-collect.png" />
</p>
</div>

<p>
From there I copied the first two columns as a rectangle, plopped them
into this org-mode buffer, added a few pipe symbols (using
<code>string-rectangle</code>), and a header, to get this table:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Key</th>
<th scope="col" class="org-left">Command</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">C-a</td>
<td class="org-left">kmacro-add-counter</td>
</tr>

<tr>
<td class="org-left">TAB</td>
<td class="org-left">kmacro-insert-counter</td>
</tr>

<tr>
<td class="org-left">C-c</td>
<td class="org-left">kmacro-set-counter</td>
</tr>

<tr>
<td class="org-left">C-q &gt;</td>
<td class="org-left">kmacro-quit-counter-greater</td>
</tr>

<tr>
<td class="org-left">C-q &lt;</td>
<td class="org-left">kmacro-quit-counter-less</td>
</tr>

<tr>
<td class="org-left">C-q =</td>
<td class="org-left">kmacro-quit-counter-equal</td>
</tr>

<tr>
<td class="org-left">C-r s</td>
<td class="org-left">kmacro-reg-save-counter</td>
</tr>

<tr>
<td class="org-left">C-r l</td>
<td class="org-left">kmacro-reg-load-counter</td>
</tr>

<tr>
<td class="org-left">C-r a &gt;</td>
<td class="org-left">kmacro-reg-add-counter-greater</td>
</tr>

<tr>
<td class="org-left">C-r a &lt;</td>
<td class="org-left">kmacro-reg-add-counter-less</td>
</tr>

<tr>
<td class="org-left">C-r a =</td>
<td class="org-left">kmacro-reg-add-counter-equal</td>
</tr>
</tbody>
</table>

<p>
I hope this taste of the flexibility of <code>embark-prefix-help-command</code>
whets your appetite for more. 
</p>
