<p>I run the <a href="https://regolith-desktop.com/">Regolith Desktop Environment</a> on my laptop, which I love because it provides a convenient GNOME wrapper and interface for the <a href="https://i3wm.org/">i3 tiling window manager</a>. Regolith relies on a program called <code class="language-plaintext highlighter-rouge">ilia</code> for application launching, and sometimes <code class="language-plaintext highlighter-rouge">ilia</code> gets caught in some kind of CPU-churning state that locks up my whole system. I have not been able to figure out what is causing it, so I (of course) turned to Emacs for a solution.</p>

<!--more-->

<h2 id="turning-to-consult-omni">Turning to <code class="language-plaintext highlighter-rouge">consult-omni</code></h2>

<p>Armin Darvish has created a powerful Emacs package called <a href="https://github.com/armindarvish/consult-omni"><code class="language-plaintext highlighter-rouge">consult-omni</code></a>, which provides a wrapper around <code class="language-plaintext highlighter-rouge">consult</code> for searching through any number of information sources. I believe <code class="language-plaintext highlighter-rouge">consult-omni</code> was originally intended to query web search engines and document databases, but Darvish has also provided a search mode for your local desktop applications, and can act as an application launcher.</p>

<p>Darvish provides an example application launcher in his <code class="language-plaintext highlighter-rouge">consult-omni</code> YouTube tutorial. The source code is straightforward, but I wanted to tweak it just a little. You can view <a href="https://github.com/armindarvish/consult-omni/wiki/YouTube-Tutorial#create-a-launcher">his original on the project’s wiki on GitHub</a>. You can watch him explain his technique below.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/wNH2E7iT__c?start=8595" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>

<p>After a few tweaks, here is what I came up with.</p>

<div class="language-emacs-lisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">defun</span> <span class="nv">consult-launcher</span> <span class="p">()</span>
  <span class="s">"A launcher suitable for use from a window manager."</span>
  <span class="p">(</span><span class="nv">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">width</span> <span class="p">(</span><span class="nb">floor</span> <span class="p">(</span><span class="nb">*</span> <span class="mf">0.6</span> <span class="p">(</span><span class="nv">display-pixel-width</span><span class="p">))))</span>
         <span class="p">(</span><span class="nv">height</span> <span class="p">(</span><span class="nb">floor</span> <span class="p">(</span><span class="nb">*</span> <span class="mf">0.6</span> <span class="p">(</span><span class="nv">display-pixel-height</span><span class="p">))))</span>
         <span class="p">(</span><span class="nv">left</span> <span class="p">(</span><span class="nb">floor</span> <span class="p">(</span><span class="nb">*</span> <span class="mf">0.2</span> <span class="p">(</span><span class="nv">display-pixel-width</span><span class="p">))))</span>
         <span class="p">(</span><span class="nv">top</span> <span class="p">(</span><span class="nb">floor</span> <span class="p">(</span><span class="nb">*</span> <span class="mf">0.2</span> <span class="p">(</span><span class="nv">display-pixel-height</span><span class="p">))))</span>
         <span class="p">(</span><span class="nv">params</span> <span class="o">`</span><span class="p">((</span><span class="nv">name</span> <span class="o">.</span> <span class="s">"omni-launcher"</span><span class="p">)</span>
                   <span class="p">(</span><span class="nv">width</span> <span class="o">.</span> <span class="o">,</span><span class="p">(</span><span class="nb">cons</span> <span class="ss">'text-pixels</span> <span class="nv">width</span><span class="p">))</span>
                   <span class="p">(</span><span class="nv">height</span> <span class="o">.</span> <span class="o">,</span><span class="p">(</span><span class="nb">cons</span> <span class="ss">'text-pixels</span> <span class="nv">height</span><span class="p">))</span>
                   <span class="p">(</span><span class="nv">left</span> <span class="o">.</span> <span class="o">,</span><span class="nv">left</span><span class="p">)</span>
                   <span class="p">(</span><span class="nv">top</span> <span class="o">.</span> <span class="o">,</span><span class="nv">top</span><span class="p">)</span>
                   <span class="p">(</span><span class="nv">minibuffer</span> <span class="o">.</span> <span class="nv">only</span><span class="p">)))</span>
         <span class="p">(</span><span class="nv">frame</span> <span class="p">(</span><span class="nv">make-frame</span> <span class="nv">params</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">with-selected-frame</span> <span class="nv">frame</span>
      <span class="p">(</span><span class="nv">select-frame-set-input-focus</span> <span class="nv">frame</span><span class="p">)</span>
      <span class="c1">;; If i3 is running and there is a control socket, let's tell</span>
      <span class="c1">;; it we are a floating frame.</span>
      <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">getenv</span> <span class="s">"I3SOCK"</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">call-process</span> <span class="s">"i3-msg"</span> <span class="no">nil</span> <span class="no">nil</span> <span class="no">nil</span>
                        <span class="p">(</span><span class="nb">format</span> <span class="s">"[id=%s] floating enable"</span>
                                <span class="p">(</span><span class="nv">s-trim</span> <span class="p">(</span><span class="nv">shell-command-to-string</span> <span class="s">"xdotool getactivewindow"</span><span class="p">)))))</span>
      <span class="p">(</span><span class="k">unwind-protect</span>
          <span class="p">(</span><span class="k">progn</span> <span class="p">(</span><span class="nv">consult-omni-apps-static</span> <span class="s">".*"</span> <span class="p">(</span><span class="nv">propertize</span> <span class="s">"&gt; "</span> <span class="ss">'face</span> <span class="ss">'consult-omni-path-face</span><span class="p">))</span>
                 <span class="no">nil</span><span class="p">)</span>
        <span class="p">(</span><span class="k">progn</span>
          <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">frame-live-p</span> <span class="nv">frame</span><span class="p">)</span> <span class="p">(</span><span class="nv">delete-frame</span> <span class="nv">frame</span><span class="p">))</span>
          <span class="no">nil</span><span class="p">)))))</span>
</code></pre></div></div>

<p>I made two changes to get this to work nicely with <code class="language-plaintext highlighter-rouge">i3</code>. First, I removed the <code class="language-plaintext highlighter-rouge">yequake</code> dependency. Second, I added a call to <code class="language-plaintext highlighter-rouge">i3-msg</code> that sets the launcher frame as floating, which makes it much nicer to use. Like Darvish’s version, you can run this from the command line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emacsclient -e '(consult-launcher)'
</code></pre></div></div>

<h2 id="adding-an-ilia-fallback">Adding an <code class="language-plaintext highlighter-rouge">ilia</code> fallback</h2>

<p>Don’t tell all the other Emacs users, but I don’t have Emacs set up to launch automatically when I start my computer and log into X11. I probably should, huh? Also, there are times when I (gasp!) shut down Emacs, usually to restart it or fix something that I have broken. When those times happen, I want to be able to launch applications, so I need a failsafe in case <code class="language-plaintext highlighter-rouge">consult-launcher</code> isn’t available!</p>

<p>To solve this, I created a simple shell wrapper script, which looks like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># Check if Emacs server is running by looking for the server socket</span>
<span class="c"># Default server name is "server", but you can change this if needed</span>
<span class="nv">SERVER_NAME</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">EMACS_SERVER_NAME</span><span class="k">:-</span><span class="nv">server</span><span class="k">}</span><span class="s2">"</span>
<span class="nv">SERVER_FILE</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">XDG_RUNTIME_DIR</span><span class="k">:-</span><span class="p">/tmp</span><span class="k">}</span><span class="s2">/emacs/</span><span class="k">${</span><span class="nv">SERVER_NAME</span><span class="k">}</span><span class="s2">"</span>

<span class="k">if</span> <span class="o">[</span> <span class="nt">-S</span> <span class="s2">"</span><span class="nv">$SERVER_FILE</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c"># Emacs is running, use emacsclient to launch your application</span>
    emacsclient <span class="nt">-e</span> <span class="s1">'(consult-launcher)'</span>
<span class="k">else</span>
    <span class="c"># Emacs is not running, fall back to ilia</span>
    ilia <span class="nt">-p</span> apps
<span class="k">fi</span>
</code></pre></div></div>

<p>If you want to use this, the important part is that <code class="language-plaintext highlighter-rouge">SERVER_FILE</code> points to the socket that your Emacs server uses. Make sure that <code class="language-plaintext highlighter-rouge">emacsclient</code> and <code class="language-plaintext highlighter-rouge">ilia</code> are both in a reasonable location so your shell can find them, then bind this command to whatever you usually use to launch <code class="language-plaintext highlighter-rouge">ilia</code>.</p>

<p>By the way, if you are using Regolith’s normal method of launching <code class="language-plaintext highlighter-rouge">ilia</code>, you can add your shell script to your Regolith configuration pretty easily. Open <code class="language-plaintext highlighter-rouge">$HOME/.config/regolith3/Xresources</code> in your text editor, and add the line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wm.program.launcher.app: /path/to/your/launcher.sh
</code></pre></div></div>

<p>You can then run <code class="language-plaintext highlighter-rouge">xrdb -override $HOME/.config/regolith3/Xresources</code> and it should work! Good luck.</p>

<h2 id="drawbacks">Drawbacks</h2>

<p>One of the nice things about <code class="language-plaintext highlighter-rouge">ilia</code> is that it keeps track of applications your run frequently, so they tend to bubble up to the top of its application listing. The Emacs method doesn’t do that. I don’t mind so much, I always end up typing in application names. It is fun to use Emacs as an application launcher, and I hope that it helps me avoid the CPU-churn problem that <code class="language-plaintext highlighter-rouge">ilia</code> has been experiencing far too often.</p>

<p>Have I come up with a clever solution, or a lazy workaround? I’m looking forward to hearing your thoughts.</p>