<p>I just built emacs-plus@29 on my MacOS using <code>--with-native-comp</code> just
to see what it is and how it works.</p>
<p>I&rsquo;ll talk about my impression of it later. Let&rsquo;s start with the issue.</p>
<p>I use straight.el + use-package and as soon as I started my
new Emacs instance I&rsquo;ve got this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>Debugger entered--Lisp error: (void-variable native-comp-deferred-compilation-deny-list)
</span></span><span style="display:flex;"><span>straight--build-native-compile((:type git :host github :repo <span style="color:#e6db74">&#34;radian-software/straight.el&#34;</span> :files (<span style="color:#e6db74">&#34;straight*.el&#34;</span>) :branch <span style="color:#e6db74">&#34;master&#34;</span> :package <span style="color:#e6db74">&#34;straight&#34;</span> :local-repo <span style="color:#e6db74">&#34;straight.el&#34;</span>))
</span></span><span style="display:flex;"><span>straight--build-package((:type git :host github :repo <span style="color:#e6db74">&#34;radian-software/straight.el&#34;</span> :files (<span style="color:#e6db74">&#34;straight*.el&#34;</span>) :branch <span style="color:#e6db74">&#34;master&#34;</span> :package <span style="color:#e6db74">&#34;straight&#34;</span> :local-repo <span style="color:#e6db74">&#34;straight.el&#34;</span>) <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span>f(compiled-function () <span style="color:#960050;background-color:#1e0010">#</span>&lt;bytecode 0x13b193a2e77f4e46&gt;)()
</span></span><span style="display:flex;"><span>straight--transaction-exec(use-package-\&#34;c809124e9c5270ea1c72e2c3507331d1\&#34;-nil-nil :now <span style="color:#960050;background-color:#1e0010">#</span>f(compiled-function () <span style="color:#960050;background-color:#1e0010">#</span>&lt;bytecode 0x13b193a2e77f4e46&gt;))
</span></span><span style="display:flex;"><span>straight-use-package((straight :type git :host github :repo <span style="color:#e6db74">&#34;radian-software/straight.el&#34;</span> :files (<span style="color:#e6db74">&#34;straight*.el&#34;</span>) :branch <span style="color:#e6db74">&#34;master&#34;</span>))
</span></span><span style="display:flex;"><span>load-with-code-conversion(<span style="color:#e6db74">&#34;/Users/krydos/.emacs.d/straight/repos/straight.el/...&#34;</span> <span style="color:#e6db74">&#34;/Users/krydos/.emacs.d/straight/repos/straight.el/...&#34;</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">t</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">load</span>(<span style="color:#e6db74">&#34;/Users/krydos/.emacs.d/straight/repos/straight.el/...&#34;</span> <span style="color:#66d9ef">nil</span> nomessage)
</span></span><span style="display:flex;"><span>(let ((bootstrap-file (<span style="color:#a6e22e">expand-file-name</span> <span style="color:#e6db74">&#34;straight/repos/straight.el/bootstrap.el&#34;</span> user-emacs-directory)) (bootstrap-version <span style="color:#ae81ff">6</span>)) (if (<span style="color:#a6e22e">file-exists-p</span> bootstrap-file) <span style="color:#66d9ef">nil</span> (save-current-buffer (<span style="color:#a6e22e">set-buffer</span> (url-retrieve-synchronously <span style="color:#e6db74">&#34;https://raw.githubusercontent.com/radian-software/...&#34;</span> <span style="color:#e6db74">&#39;silent</span> <span style="color:#e6db74">&#39;inhibit-cookies</span>)) (<span style="color:#a6e22e">goto-char</span> (<span style="color:#a6e22e">point-max</span>)) (eval-print-last-sexp))) (<span style="color:#a6e22e">load</span> bootstrap-file <span style="color:#66d9ef">nil</span> <span style="color:#e6db74">&#39;nomessage</span>))
</span></span><span style="display:flex;"><span>load-with-code-conversion(<span style="color:#e6db74">&#34;/Users/krydos/.emacs.d/init.el&#34;</span> <span style="color:#e6db74">&#34;/Users/krydos/.emacs.d/init.el&#34;</span> <span style="color:#66d9ef">t</span> <span style="color:#66d9ef">t</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">load</span>(<span style="color:#e6db74">&#34;/Users/krydos/.emacs.d/init&#34;</span> noerror nomessage)
</span></span><span style="display:flex;"><span>startup--load-user-init-file(<span style="color:#960050;background-color:#1e0010">#</span>f(compiled-function () <span style="color:#960050;background-color:#1e0010">#</span>&lt;bytecode 0x155c027c85bc7d&gt;) <span style="color:#960050;background-color:#1e0010">#</span>f(compiled-function () <span style="color:#960050;background-color:#1e0010">#</span>&lt;bytecode -0x1f3c61addc0da035&gt;) <span style="color:#66d9ef">t</span>)
</span></span><span style="display:flex;"><span>command-line()
</span></span><span style="display:flex;"><span>normal-top-level()
</span></span></code></pre></div><p>It looks like for some reason straight.el expects <code>native-comp-deferred-compilation-deny-list</code> variable available in Emacs while
this variable was renamed to <code>native-comp-jit-compilation-deny-list</code>.</p>
<p>Straight.el&rsquo;s <code>master</code> branch doesn&rsquo;t know about the rename but the <code>develop</code> branch does.
So to switch straight.el to newer branch we can define <code>straight-repository-branch</code> somewhere on the top of our init.el like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(setq straight-repository-branch <span style="color:#e6db74">&#34;develop&#34;</span>)
</span></span></code></pre></div><p>I also removed my <code>~/.emacs.d/straight</code> directory to make sure every other package will be pulled from scratch
and there are no conflicts between my current version of Emacs and the older one (28).</p>
<h2 id="native-compilation-impression">Native compilation impression</h2>
<p>I&rsquo;m not sure about it. Since I use my own config and I don&rsquo;t include that many packages everything was quite quick
even without the <code>--with-native-comp</code>.
With native compilation I don&rsquo;t see the difference, maybe I&rsquo;ll notice it later.</p>
<p>What I noticed is that when I first started my Emacs 29 the compilation process was running on the background (without indication) and
the whole UI was sluggish. Switching buffers was slow, reaction to my keystrokes was delayed, etc.
But in few minutes, I believe when everything was compiled, everything started to work as usual, no delays, no issues.</p>