<p>On a previous post I created an elisp function to quickly duplicate a file or directory in <code>dired</code>, by default it would copy the <code>dired</code> item under the cursor to an <code>old</code> suffix or append a number based on the universal argument.</p>
<p><a href="https://emacs.dyerdwelling.family/emacs/20230606213531-emacs--dired-duplicate-here-revisited/">Dired Duplicate Here Revisited</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elisp" data-lang="elisp"><span style="display:flex;"><span>(defun my/dired-duplicate-file (arg)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Duplicate the current file in Dired.&#34;</span>
</span></span><span style="display:flex;"><span>  (interactive <span style="color:#e6db74">&#34;p&#34;</span>)
</span></span><span style="display:flex;"><span>  (let ((filename (dired-get-filename)))
</span></span><span style="display:flex;"><span>    (setq target (<span style="color:#a6e22e">concat</span> (file-name-sans-extension filename)
</span></span><span style="display:flex;"><span>                   <span style="color:#e6db74">&#34;-old&#34;</span>
</span></span><span style="display:flex;"><span>                   (if (<span style="color:#a6e22e">&gt;</span> arg <span style="color:#ae81ff">1</span>) (<span style="color:#a6e22e">number-to-string</span> arg))
</span></span><span style="display:flex;"><span>                   (file-name-extension filename <span style="color:#66d9ef">t</span>)))
</span></span><span style="display:flex;"><span>    (if (<span style="color:#a6e22e">file-directory-p</span> filename)
</span></span><span style="display:flex;"><span>      (copy-directory filename target)
</span></span><span style="display:flex;"><span>      (<span style="color:#a6e22e">copy-file</span> filename target))
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>  )
</span></span></code></pre></div><p>This worked well for a while but now I want something a little more robust and after working within Krita for a while I decided that I would like to implement its incremental save naming convention.</p>
<p>It&rsquo;s pretty simple really, just an incremented integer, zero padded to a width of 3, inserted just before the extension:</p>
<figure><img src="https://emacs.dyerdwelling.family/ox-hugo/20231013153639-emacs--More-Flexible-Duplicate-Thing-Function.jpg" width="100%">
</figure>

<p>So I just need to apply a little counter logic but still have the potential to pass in the universal argument and of course avoid overriding any existing backup as it did before.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elisp" data-lang="elisp"><span style="display:flex;"><span>(defun my/dired-duplicate-file (arg)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Duplicate a file from dired with an incremented number.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  If ARG is provided, it sets the counter.&#34;</span>
</span></span><span style="display:flex;"><span>  (interactive <span style="color:#e6db74">&#34;p&#34;</span>)
</span></span><span style="display:flex;"><span>  (let* ((file (dired-get-file-for-visit))
</span></span><span style="display:flex;"><span>          (dir (<span style="color:#a6e22e">file-name-directory</span> file))
</span></span><span style="display:flex;"><span>          (name (<span style="color:#a6e22e">file-name-nondirectory</span> file))
</span></span><span style="display:flex;"><span>          (base-name (file-name-sans-extension name))
</span></span><span style="display:flex;"><span>          (extension (file-name-extension name <span style="color:#66d9ef">t</span>))
</span></span><span style="display:flex;"><span>          (counter (if arg (<span style="color:#a6e22e">prefix-numeric-value</span> arg) <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>          (new-file))
</span></span><span style="display:flex;"><span>    (while (and (setq new-file
</span></span><span style="display:flex;"><span>                  (<span style="color:#a6e22e">format</span> <span style="color:#e6db74">&#34;%s%s_%03d%s&#34;</span> dir base-name counter extension))
</span></span><span style="display:flex;"><span>             (<span style="color:#a6e22e">file-exists-p</span> new-file))
</span></span><span style="display:flex;"><span>      (setq counter (<span style="color:#a6e22e">1+</span> counter)))
</span></span><span style="display:flex;"><span>    (if (<span style="color:#a6e22e">file-directory-p</span> file)
</span></span><span style="display:flex;"><span>      (copy-directory file new-file)
</span></span><span style="display:flex;"><span>      (<span style="color:#a6e22e">copy-file</span> file new-file))
</span></span><span style="display:flex;"><span>    (dired-revert)))
</span></span></code></pre></div><p>I can now create any number of dired file/directory backups quickly from <code>dired</code> (well up to 100).</p>