<p><img src="https://xenodium.github.io/images/swiftui-layout-previews-using-emacs-org-blocks/ob-swiftui.gif" alt=""></p>
<p>✨ <em>UPDATE: The snippets in this post are outdated. See <a href="https://github.com/xenodium/ob-swiftui">ob-swiftui</a> for better SwiftUI babel support</em>. ✨</p>
<p>Chris Eidhof <a href="https://twitter.com/chriseidhof/status/1261360332594974721">twitted</a> a handy <a href="https://gist.github.com/chriseidhof/26768f0b63fa3cdf8b46821e099df5ff">snippet</a> that enables quickly bootstrapping throwaway SwiftUI code. It can be easily integrated into other tools for rapid experimentation.</p>
<p>Being a SwiftUI noob, I could use some SwiftUI integration with my editor of choice. With some elisp glue and a small patch, Chris's snippet can be used to generate SwiftUI inline previews using Emacs org babel. This is particularly handy for playing around with SwiftUI layouts.</p>
<p>We can piggyback ride off zweifisch's <a href="https://github.com/zweifisch/ob-swift">ob-swift</a> by advicing <em>org-babel-execute:swift</em> to inject the org source block into the bootstrapping snippet. We also add a hook to <em>org-babel-after-execute-hook</em> to automatically refresh the inline preview.</p>
<p>If you're a <a href="https://github.com/jwiegley/use-package">use-package</a> user, the following snippet should make things fairly self-contained (if you have <a href="https://melpa.org/">melpa</a> set up already).</p>
<pre><code class="language-{.commonlisp">(use-package org
  :hook ((org-mode . org-display-inline-images))
  :config

  (use-package ob
    :config

    (use-package ob-swift
      :ensure t
      :config
      (org-babel-do-load-languages 'org-babel-load-languages
                                   (append org-babel-load-languages
                                           '((swift     . t))))

      (defun ar/org-refresh-inline-images ()
        (when org-inline-image-overlays
          (org-redisplay-inline-images)))

      ;; Automatically refresh inline images.
      (add-hook 'org-babel-after-execute-hook 'ar/org-refresh-inline-images)

      (defun adviced:org-babel-execute:swift (f &amp;rest args)
        &quot;Advice `adviced:org-babel-execute:swift' enabling swiftui header param.&quot;
        (let* ((body (nth 0 args))
               (params (nth 1 args))
               (swiftui (cdr (assoc :swiftui params)))
               (output))
          (when swiftui
            (assert (or (string-equal swiftui &quot;preview&quot;)
                        (string-equal swiftui &quot;interactive&quot;))
                    nil &quot;:swiftui must be either preview or interactive&quot;)
            (setq body (format
                        &quot;
import Cocoa
import SwiftUI
import Foundation

let screenshotURL = URL(fileURLWithPath: NSTemporaryDirectory(), isDirectory: true).appendingPathComponent(ProcessInfo.processInfo.globallyUniqueString + \&quot;.png\&quot;)
let preview = %s

NSApplication.shared.run {
  %s
}

extension NSApplication {
  public func run&lt;V: View&gt;(@ViewBuilder view: () -&gt; V) {
    let appDelegate = AppDelegate(view())
    NSApp.setActivationPolicy(.regular)
    mainMenu = customMenu
    delegate = appDelegate
    run()
  }
}

extension NSApplication {
  var customMenu: NSMenu {
    let appMenu = NSMenuItem()
    appMenu.submenu = NSMenu()

    let quitItem = NSMenuItem(
      title: \&quot;Quit \(ProcessInfo.processInfo.processName)\&quot;,
      action: #selector(NSApplication.terminate(_:)), keyEquivalent: \&quot;q\&quot;)
    quitItem.keyEquivalentModifierMask = []
    appMenu.submenu?.addItem(quitItem)

    let mainMenu = NSMenu(title: \&quot;Main Menu\&quot;)
    mainMenu.addItem(appMenu)
    return mainMenu
  }
}

class AppDelegate&lt;V: View&gt;: NSObject, NSApplicationDelegate, NSWindowDelegate {
  var window = NSWindow(
    contentRect: NSRect(x: 0, y: 0, width: 414 * 0.2, height: 896 * 0.2),
    styleMask: [.titled, .closable, .miniaturizable, .resizable, .fullSizeContentView],
    backing: .buffered, defer: false)

  var contentView: V

  init(_ contentView: V) {
    self.contentView = contentView
  }

  func applicationDidFinishLaunching(_ notification: Notification) {
    window.delegate = self
    window.center()
    window.contentView = NSHostingView(rootView: contentView)
    window.makeKeyAndOrderFront(nil)

    if preview {
      screenshot(view: window.contentView!, saveTo: screenshotURL)
      // Write path (without newline) so org babel can parse it.
      print(screenshotURL.path, terminator: \&quot;\&quot;)
      NSApplication.shared.terminate(self)
      return
    }

    window.setFrameAutosaveName(\&quot;Main Window\&quot;)
    NSApp.activate(ignoringOtherApps: true)
  }
}

func screenshot(view: NSView, saveTo fileURL: URL) {
  let rep = view.bitmapImageRepForCachingDisplay(in: view.bounds)!
  view.cacheDisplay(in: view.bounds, to: rep)
  let pngData = rep.representation(using: .png, properties: [:])
  try! pngData?.write(to: fileURL)
}
&quot;
                        (if (string-equal swiftui &quot;preview&quot;)
                            &quot;true&quot;
                          &quot;false&quot;)
                        body))
            (setq args (list body params)))
          (setq output (apply f args))
          (when org-inline-image-overlays
            (org-redisplay-inline-images))
          output))

      (advice-add #'org-babel-execute:swift
                  :around
                  #'adviced:org-babel-execute:swift))))
</code></pre>
<p><s>Snippet also at github <a href="https://gist.github.com/xenodium/79154033bc26e733b8c43af228cbce5b">gist</a> and included in <a href="https://github.com/xenodium/dotsies/blob/master/emacs/features/fe-org.el">my emacs config</a></s>.</p>
<p><em>UPDATE: See <a href="https://github.com/xenodium/ob-swiftui">ob-swiftui</a> for a better version of babel SwiftUI support.</em></p>
<p>Once the snippet is evaluated, we're ready to use in an org babel block. We introduced the <em>:swiftui</em> header param to switch between inline static <em>preview</em> and <em>interactive</em> mode.</p>
<p>To try out an inline <em>preview</em>, create a new org file (eg. swiftui.org) and a source block like:</p>
<pre><code class="language-org">#+begin_src swift :results file :swiftui preview
  VStack(spacing: 10) {
      HStack(spacing: 10) {
        Rectangle().fill(Color.yellow)
        Rectangle().fill(Color.green)
      }
      Rectangle().fill(Color.blue)
      HStack(spacing: 10) {
        Rectangle().fill(Color.green)
        Rectangle().fill(Color.yellow)
      }
    }
    .frame(maxWidth: .infinity, maxHeight: .infinity)
#+end_src
</code></pre>
<pre><code class="language-org">#+results:
</code></pre>
<p><img src="https://xenodium.github.io/images/swiftui-layout-previews-using-emacs-org-blocks/vstack.jpg" alt=""></p>
<p>Place the cursor anywhere inside the source block (#+begin_src/#+end_src) and press C-c C-c (or M-x org-ctrl-c-ctrl-c).</p>
<p>To run interactively, change the <em>:swiftui</em> param to <em>interactive</em> and press C-c C-c (or M-x org-ctrl-c-ctrl-c). When running interactively, press &quot;q&quot; (without ⌘) to quit the Swift app.</p>
<p>comments on <a href="https://twitter.com/xenodium/status/1194224168709083137">twitter</a>.</p>
<h2>Update</h2>
<ul>
<li>Tweaked the snippet to make it more self-contained and made the steps more reproducible. Need to work out how to package things to make them more accessible. May be best to contribute as a patch to <a href="https://github.com/zweifisch/ob-swift">ob-swift</a> and we can avoid the icky <em>advice-add</em>.</li>
<li>Thanks to Chris Eidhof for PNG support (instead of TIFF). Also TIL Swift's <em>print</em> has got a terminator param.</li>
</ul>
