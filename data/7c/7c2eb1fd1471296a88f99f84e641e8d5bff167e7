
<p>As codebases grow, maintaining proper indentation becomes increasingly difficult, especially in languages like Python or YAML, where indentation is not just a matter of style but an important part of the syntax. When working with large code blocks or deeply nested structures, it’s easy to lose track of the correct indentation level, leading to errors and decreased readability. In this post, we’ll explore Emacs packages and an Elisp code snippet that can help manage indentation in these indentation-sensitive languages.</p>



<h2 class="wp-block-heading">Code snippet: Indenting new lines based on previous non-blank line</h2>



<p>The following code snippet configures Emacs to indent based on the indentation of the previous non-blank line:</p>


<pre class="wp-block-code"><span><code class="hljs language-lisp"><span class="hljs-comment">;; This ensures that pressing Enter will insert a new line and indent it.</span>
(<span class="hljs-name">global-set-key</span> (<span class="hljs-name">kbd</span> <span class="hljs-string">"RET"</span>) #'newline-and-indent)

<span class="hljs-comment">;; Indentation based on the indentation of the previous non-blank line.</span>
(<span class="hljs-name">setq-default</span> indent-line-function #'indent-relative-first-indent-point)

<span class="hljs-comment">;; In modes such as `text-mode', pressing Enter multiple times removes</span>
<span class="hljs-comment">;; the indentation. The following fixes the issue and ensures that text</span>
<span class="hljs-comment">;; is properly indented using `indent-relative' or</span>
<span class="hljs-comment">;; `indent-relative-first-indent-point'.</span>
(<span class="hljs-name">setq-default</span> indent-line-ignored-functions '())</code></span></pre>


<h2 class="wp-block-heading">Emacs package: outline-indent.el (Code folding)</h2>



<p>The <a href="https://github.com/jamescherti/outline-indent.el"><strong>outline-indent.el</strong></a> Emacs package provides a minor mode that enables code folding based on indentation levels for various indentation-based text files, such as YAML, Python, and any other indented text files.</p>



<figure class="wp-block-image size-large"><img decoding="async" width="1024" height="684" src="https://www.jamescherti.com/wp-content/uploads/emacs-outline-indent-1024x684.png" alt="" class="wp-image-3583" srcset="https://www.jamescherti.com/wp-content/uploads/emacs-outline-indent-1024x684.png 1024w, https://www.jamescherti.com/wp-content/uploads/emacs-outline-indent-300x200.png 300w, https://www.jamescherti.com/wp-content/uploads/emacs-outline-indent-768x513.png 768w, https://www.jamescherti.com/wp-content/uploads/emacs-outline-indent-449x300.png 449w, https://www.jamescherti.com/wp-content/uploads/emacs-outline-indent.png 1117w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>To install the <code>outline-indent</code> from MELPA, add the following code to your Emacs init file:</p>


<pre class="wp-block-code"><span><code class="hljs language-lisp">(<span class="hljs-name">use-package</span> outline-indent
  <span class="hljs-symbol">:ensure</span> <span class="hljs-literal">t</span>
  <span class="hljs-symbol">:commands</span> (<span class="hljs-name">outline-indent-minor-mode</span>
             outline-indent-insert-heading)
  <span class="hljs-symbol">:hook</span> ((<span class="hljs-name">yaml-mode</span> . outline-indent-minor-mode)
         (<span class="hljs-name">yaml-ts-mode</span> . outline-indent-minor-mode)
         (<span class="hljs-name">python-mode</span> . outline-indent-minor-mode)
         (<span class="hljs-name">python-ts-mode</span> . outline-indent-minor-mode))
  <span class="hljs-symbol">:custom</span>
  (<span class="hljs-name">outline-indent-ellipsis</span> <span class="hljs-string">" ▼ "</span>))</code></span></pre>


<p>In addition to code folding, <em>outline-indent</em> allows:</p>



<ul class="wp-block-list">
<li>Moving indented blocks up and down.</li>



<li>Indenting/unindenting to adjust indentation levels.</li>



<li>Inserting a new line with the same indentation level as the current line.</li>



<li>Move backward/forward to the indentation level of the current line.</li>



<li>Customizing the ellipsis to replace the default &#8220;&#8230;&#8221; with something more visually appealing, such as &#8220;▼&#8221;.</li>



<li>Selecting the indented block with.</li>



<li>And other features.</li>
</ul>



<h2 class="wp-block-heading">Emacs Package: dtrt-indent (Guessing the original indentation offset)</h2>



<p>The <a href="https://melpa.org/#/dtrt-indent"><strong>dtrt-indent</strong></a> provides an Emacs minor mode that detects the original indentation offset used in source code files and automatically adjusts Emacs settings accordingly, making it easier to edit files created with different indentation styles.</p>


<pre class="wp-block-code"><span><code class="hljs language-lisp">(<span class="hljs-name">use-package</span> dtrt-indent
  <span class="hljs-symbol">:ensure</span> <span class="hljs-literal">t</span>
  <span class="hljs-symbol">:commands</span> (<span class="hljs-name">dtrt-indent-global-mode</span>
             dtrt-indent-mode
             dtrt-indent-adapt
             dtrt-indent-undo
             dtrt-indent-diagnosis
             dtrt-indent-highlight)
  <span class="hljs-symbol">:config</span>
  (<span class="hljs-name">dtrt-indent-global-mode</span>))</code></span></pre>


<h2 class="wp-block-heading">Emacs package: indent-bars (Indentation guides)</h2>



<p>The <strong><a href="https://github.com/jdtsmith/indent-bars">indent-bars</a></strong> Emacs package, written by JD Smith, enhances code readability by providing visual indentation guides, optimized for speed and customization. It supports both space and tab-based indentation and offers optional tree-sitter integration, which includes features like scope focus. The appearance of the guide bars is highly customizable, allowing you to adjust their color, blending, width, position, and even apply a zigzag pattern. Depth-based coloring with a customizable cyclical palette adds clarity to nested structures. The package also features fast current-depth highlighting, configurable bar changes, and the ability to display bars on blank lines. Additionally, it maintains consistent bar depth within multi-line strings and lists, and it works seamlessly in terminal environments using a vertical bar character. (Send your customizations to JD Smith, the author of indent-bars. He mentioned on Reddit that, &#8220;If you or others have customized the bar style settings, I&#8217;d be happy to add them to <a href="https://github.com/jdtsmith/indent-bars/blob/main/examples.md">the examples</a> page&#8221;.)</p>



<figure class="wp-block-image size-full is-style-default"><img decoding="async" width="578" height="550" src="https://www.jamescherti.com/wp-content/uploads/emacs-indent-bars.gif" alt="" class="wp-image-3579"/></figure>



<p>The <code>indent-bars</code> package isn&#8217;t available in any package database yet, but you can install it using <code>straight</code>.</p>



<ol class="wp-block-list">
<li>If you haven&#8217;t already done so, <a href="https://github.com/radian-software/straight.el?tab=readme-ov-file#getting-started">add the straight.el bootstrap code</a> to your init file.</li>



<li>After that, add the following code to your Emacs init file:</li>
</ol>


<pre class="wp-block-code"><span><code class="hljs language-lisp">(<span class="hljs-name">use-package</span> indent-bars
  <span class="hljs-symbol">:ensure</span> <span class="hljs-literal">t</span>
  <span class="hljs-symbol">:commands</span> indent-bars-mode
  <span class="hljs-symbol">:straight</span> (<span class="hljs-name">indent-bars</span>
             <span class="hljs-symbol">:type</span> git
             <span class="hljs-symbol">:host</span> github
             <span class="hljs-symbol">:repo</span> <span class="hljs-string">"jdtsmith/indent-bars"</span>)
  <span class="hljs-symbol">:hook</span> ((<span class="hljs-name">yaml-mode</span> . indent-bars-mode)
         (<span class="hljs-name">yaml-ts-mode</span> . indent-bars-mode)
         (<span class="hljs-name">python-mode</span> . indent-bars-mode)
         (<span class="hljs-name">python-ts-mode</span> . indent-bars-mode))
  <span class="hljs-symbol">:custom</span>
  (<span class="hljs-name">indent-bars-prefer-character</span> <span class="hljs-literal">t</span>))</code></span></pre>


<p><span style="text-decoration: underline;">The indent-bars fancy guide bars when indent-bars-prefer-character is set to nil:</span></p>



<p>If you are using Linux or macOS (not PGTK on Linux, NS on macOS, or Windows), try setting the <code>indent-bars-prefer-character</code> variable to <code>nil</code> to make indent-bars display fancy guide bars using the :stipple face attribute (see <a href="https://github.com/jdtsmith/indent-bars?tab=readme-ov-file#compatibility">indent-bars compatibility</a>). On macOS, it only works if you are using the non-NS version of Emacs, known as emacs-mac-app, which can be installed from MacPorts using the emacs-mac-app or emacs-mac-app-devel package.</p>



<p>You can have Emacs automatically set the <code>indent-bars-prefer-character</code> variable to <code>nil</code> when the window system is PGTK or NS, where the stipple attribute is not supported and using the character is preferred, with the following Elisp code:</p>


<pre class="wp-block-code"><span><code class="hljs language-lisp"><span class="hljs-comment">;; Make the indent-bars package decide when to use the stipple attribute</span>
(<span class="hljs-name">setq</span> indent-bars-prefer-character
      (<span class="hljs-name">if</span> (<span class="hljs-name">memq</span> initial-window-system '(pgtk ns)) <span class="hljs-literal">t</span>))</code></span></pre>


<h2 class="wp-block-heading">Code snippet: Inserting a new line before the next line that has the same or less indentation level</h2>



<p><em>(If you&#8217;re using <code>outline-indent.el</code>, there&#8217;s no need for the Elisp code below. You can simply use the <code>(outline-indent-insert-heading)</code> function.)</em></p>



<p>You can use the following function to inserts a new line just before the next line that has the same or less indentation level:</p>


<pre class="wp-block-code"><span><code class="hljs language-lisp">(<span class="hljs-name">defun</span> my-insert-line-before-same-indentation ()
  <span class="hljs-string">"Insert a new line with the same indentation level as the current line.
The line is inserted just before the next line that shares the same or less
indentation level. This function finds the nearest non-empty line with the same
or less indentation as the current line and inserts a new line before it.

This function is part of the outline-indent (MELPA) Emacs package.
It was extracted from the function (outline-indent-insert-heading)
written by James Cherti and distributed under the GPL 3.0 or later license."</span>
  (<span class="hljs-name">interactive</span>)
  (<span class="hljs-name">let</span> ((<span class="hljs-name">initial-indentation</span> <span class="hljs-literal">nil</span>)
        (<span class="hljs-name">found-point</span> <span class="hljs-literal">nil</span>))
    (<span class="hljs-name">save-excursion</span>
      (<span class="hljs-name">beginning-of-visual-line</span>)
      (<span class="hljs-name">setq</span> initial-indentation (<span class="hljs-name">current-indentation</span>))
      (<span class="hljs-name">while</span> (<span class="hljs-name">and</span> (<span class="hljs-name">not</span> found-point) (<span class="hljs-name">not</span> (<span class="hljs-name">eobp</span>)))
        (<span class="hljs-name">forward-line</span> <span class="hljs-number">1</span>)
        (<span class="hljs-name">if</span> (<span class="hljs-name">and</span> (<span class="hljs-name">&gt;=</span> initial-indentation (<span class="hljs-name">current-indentation</span>))
                 (<span class="hljs-name">not</span> (<span class="hljs-name">looking-at-p</span> <span class="hljs-string">"^&#91; \t]*$"</span>)))
            (<span class="hljs-name">setq</span> found-point (<span class="hljs-name">point</span>))))
      (<span class="hljs-name">when</span> (<span class="hljs-name">and</span> (<span class="hljs-name">not</span> found-point) (<span class="hljs-name">eobp</span>))
        (<span class="hljs-name">setq</span> found-point (<span class="hljs-name">point</span>))))
    (<span class="hljs-name">when</span> found-point
      (<span class="hljs-name">goto-char</span> found-point)
      (<span class="hljs-name">forward-line</span> <span class="hljs-number">-1</span>)
      (<span class="hljs-name">end-of-line</span>)
      (<span class="hljs-name">newline</span>)
      (<span class="hljs-name">indent-to</span> initial-indentation))))</code></span></pre>


<p>If you are an Emacs Evil mode user, here&#8217;s an additional function that switches to insert mode after inserting a new line with matching indentation:</p>


<pre class="wp-block-code"><span><code class="hljs language-lisp">(<span class="hljs-name">with-eval-after-load</span> <span class="hljs-string">"evil"</span>
  (<span class="hljs-name">defun</span> my-evil-insert-line-before-same-indentation ()
    <span class="hljs-string">"Insert a new line with the same indentation level as the current line."</span>
    (<span class="hljs-name">interactive</span>)
    (<span class="hljs-name">my-insert-line-before-same-indentation</span>)
    (<span class="hljs-name">evil-insert-state</span>))

  <span class="hljs-comment">;; Pressing Ctrl-Enter calls my-evil-insert-line-before-same-indentation </span>
  (<span class="hljs-name">evil-define-key</span> '(normal insert) 'global (<span class="hljs-name">kbd</span> <span class="hljs-string">"C-&lt;return&gt;"</span>)
    #'my-evil-insert-line-before-same-indentation))</code></span></pre>


<h2 class="wp-block-heading">Built-in feature: indent-rigidly</h2>



<p>The <code>indent-rigidly</code> built-in Emacs feature (<code>C-x TAB</code>) allows for manual adjustment of indentation by shifting a block of text left or right. It makes it easy to adjust indentation levels interactively. This can be especially useful for fine-tuning indentation in code or text where automatic tools might not always get it right. (By the way, moving the entire block with indent-rigidly is similar to the <a href="https://github.com/jamescherti/outline-indent.el?tab=readme-ov-file#outline-indent-promote-and-outline-indent-demote" target="_blank" rel="noreferrer noopener">promote/demote</a> functions in the <a href="https://github.com/jamescherti/outline-indent.el" target="_blank" rel="noreferrer noopener">outline-indent.el</a> package.)</p>



<h2 class="wp-block-heading">Related links</h2>



<ul class="wp-block-list">
<li><a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Indentation.html"><strong>Emacs documentation: Indentation</strong></a></li>



<li><a href="https://melpa.org/#/block-nav"><strong>block-nav</strong></a>: Allows navigation through code based on indentation.</li>



<li><a href="https://melpa.org/#/aggressive-indent"><strong>aggressive-indent</strong></a>: Automatically maintains proper indentation throughout your code. Works better with languages such as Elisp, C/C++, Javascript, CSS&#8230;</li>



<li><a href="https://github.com/mickeynp/combobulate"><strong>Combobulate</strong></a>: Combobulate enhances structured editing and movement for various programming languages by leveraging Emacs 29&#8217;s tree-sitter library. Combobulate uses tree-sitter’s concrete syntax tree for precise code analysis, resulting in more accurate movement and editing.</li>



<li><a href="https://github.com/magnars/expand-region.el"><strong>expand-region</strong></a>: Expand the selected region by semantic units by repeatedly pressing the key until the desired area is highlighted.</li>



<li><code>outline-indent.el</code> alternative:
<ul class="wp-block-list">
<li>origami.el: No longer maintained, slow, and have known to have bugs that affect its reliability and performance.</li>



<li>yafolding.el: No longer maintained and slow. It does not work out of the box with Evil mode and evil-collection.</li>
</ul>
</li>



<li><code>Indent-bars</code> alternatives (they work, are no longer maintained):
<ul class="wp-block-list">
<li><a href="https://github.com/zk-phi/indent-guide"><strong>indent-guide</strong></a>: An older indent-bars alternative that uses overlays with <code>|</code> characters. There are some performance concerns reported, and it is incompatible with <code>company</code> and other similar in-buffer modes. (indent-bars is better.)</li>



<li><a href="https://github.com/antonj/Highlight-Indentation-for-Emacs"><strong>highlight-indentation-mode</strong></a>: An indent-bars alternative that uses overlays to display indentation guides and includes a mode for showing the current indentation level. It offers partial support for guides on blank lines. (indent-bars is better.)</li>



<li><a href="https://github.com/DarthFennec/highlight-indent-guides"><strong>highlight-indent-guides</strong></a>: An indent-bars alternative that offers a highly customizable indentation highlighting, featuring options for color, style, and current depth indication.  (indent-bars is better.)</li>



<li><a href="https://codeberg.org/ideasman42/emacs-hl-indent-scope"><strong>hl-indent-scope</strong></a>: An indent-bars alternative that highlights indentation based on language scope, requiring specific support for each language, and uses overlays to display indentation guides. (indent-bars is better.)</li>



<li><a href="https://github.com/skeeto/visual-indentation-mode"><strong>visual-indentation-mode</strong></a>: An indent-bars alternative that uses full character-based alternating color indentation guides. The package is now archived. (indent-bars is better.)</li>
</ul>
</li>
</ul>



<h2 class="wp-block-heading">Conclusion</h2>



<p>This article has highlighted various Emacs packages and Elisp code snippets to enhance indentation management in indentation sensitive programming languages.</p>



<p>It took me a while to find the packages mentioned in this article, as I had to test many of them. Unfortunately, many popular packages are unmaintained, slow, or have unresolved bugs. <strong>I’ve only shared the packages that work flawlessly</strong>. For instance, while the Origami package is widely used, it&#8217;s slow, buggy, and no longer maintained. The <code>outline-indent.el</code> package is a more modern alternative for folding indented text, aligning with the trend of utilizing built-in Emacs features (like Corfu, Cape, Vertico, Consult&#8230;). Similarly, <code>indent-bars</code> provides a more refined experience than older packages like <code>highlight-indent-guides</code> and <code>highlight-indentation</code>.</p>



<p></p>



<p>If you have any other packages or Elisp code you rely on for managing indentation in sensitive languages, I&#8217;d love to hear about them.</p>
