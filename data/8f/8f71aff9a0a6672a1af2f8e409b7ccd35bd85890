<p>
I think almost everyone who reads my blog knows that the BIOS is the first
program that runs when the computer is turned on. Usually, the only actions
user can do with this program¬†‚Äî open the BIOS menu and change the boot order,
change date/time, change peripheral settings and so on. Or, if the user is
lucky, he can find and install the BIOS modified by hackers (but he can't look
inside this BIOS without reverse engineering skills). Unfortunately, the BIOS
source code is closed and initialization of <i>your</i> computer should rely on the
forbearance of some companies that develop BIOS binaries (for example, <a href="https://en.wikipedia.org/wiki/American_Megatrends">AMI</a> or
<a href="https://en.wikipedia.org/wiki/Award_Software">Award Software International</a>) and forbearance of computer hardware vendors.
</p>

<p>
As long as the computer is used "as is", there are no problems. But, as is
usually the case with proprietary software, any unusual change leads to such
extreme tricks that building the Linux kernel looks like a child's prank.
</p>

<p>
In my case, I upgraded my Thinkpad¬†X220 with an extension board for a new
2K¬†screen and added some new peripherals¬†‚Äî then the BIOS became the
problem. First, Lenovo's whitelist disallowed the use of new peripherals,
because they weren't "approved by the
manufacturer"<sup><a id="fnr.manufacturer_approve" class="footref" href="#fn.manufacturer_approve" role="doc-backlink">1</a></sup>. Second, the original proprietary BIOS was
made with the intention that the original display would <b>always</b> be connected
via the LVDS bus. Even if it is changed to a new display connected via the
Display Port (or via an extension board soldered to the DP-3 line). An
unfortunate omission, made in the hope that the user doesn't want to modify
his own computer and will be happy just to change the hard drive or RAM!
</p>

<p>
Fortunately, the open source community comes to the rescue! There is the
<a href="https://www.coreboot.org/">coreboot</a> project¬†‚Äî an open source realization of the BIOS for some
motherboards.
</p>
<div class="outline-2">
<h2>Table of Contents&#xa0;&#xa0;&#xa0;<span class="tag"></span></h2>
<div class="outline-text-2">
<ul class="org-ul">
<li><a href="#coreboot">Coreboot</a></li>
<li><a href="#libreboot">Libreboot</a>
<ul class="org-ul">
<li><a href="#libreboot-preparations">Preparations</a></li>
<li><a href="#get-libreboot-binary">Downloading Libreboot binary</a></li>
<li><a href="#prepare-libreboot-binary">Preparing Libreboot binary for flashing</a></li>
<li><a href="#libreboot-flashing">Flashing prepared Libreboot binary</a></li>
<li><a href="#mac-address">MAC address</a></li>
</ul></li>
<li><a href="#libreboot-customization">Libreboot customization</a></li>
<li><a href="#notes">Notes</a></li>
</ul>
</div>
</div>
<div id="outline-container-coreboot" class="outline-2">
<h2 id="coreboot">Coreboot</h2>
<div class="outline-text-2" id="text-coreboot">
<p>
Coreboot was created as a project for computer clusters. At that time it was
called LinuxBIOS. One of it's authors (Ron Minnich) found that he needed to
connect each handmande cluster node to a KVM switch¬†‚Äî to manually press F1 and
continue the boot process if something went wrong. Ron Minnich also wanted to
speed up BIOS loading and remove user interaction as much as
possible<sup><a id="fnr.linuxbios" class="footref" href="#fn.linuxbios" role="doc-backlink">2</a></sup>. Later, support for many <a href="https://doc.coreboot.org/mainboard/index.html">motherboards</a> and <a href="https://doc.coreboot.org/soc/index.html">SoCs</a> was added
to the project. Including the Thinkpad X220 motherboard.
</p>

<p>
I started using coreboot after I found out that the original BIOS only works
with the original laptop display. If I connect an additinal 2K¬†screen via the
soldered expansion board, then the BIOS won't display on that screen.
</p>

<p>
I remembered, that people, who modified Thinkpads, also changed the original
BIOS to coreboot. And on the photos of their laptops after the modification,
there was a framebuffer visible, not the usual text console. I also found that
there are notes about the open source library libgfxinit in the coreboot
documentation. This library is used inside coreboot to initialize video when
the computer is turned on. And I hope that this library will work with my new
display on the DP-3 bus. Especially after reading it's source code&#x2026;
</p>

<p>
Of course, nothing works the first time. First, the coreboot doesn't show up
on the 2K¬†screen, no configuration options matter. Second, I accidentally
burned the motherboard, when I incorrectly disconnected it from the battery.
</p>

<p>
With the new motherboard, I did the broken BIOS dump first. Both binaries have
the same MD5-hash, but the same wrong data inside. How did I notice this?
First, I flashed the old coreboot binary from the old motherboard to see if it
would work? When that program didn't work (as expected), I flashed the
"original" BIOS back. And the laptop <b>suddenly</b> won't turn on. Alas, when I
found this out, the original BIOS was lost.
</p>

<p>
However, I was able to use a corrupted BIOS dump to retrieve binary blobs
needed for coreboot on a Thinkpad¬†X220:
</p>
<ul class="org-ul">
<li>Intel Flash Descriptor¬†‚Äî 4¬†Kb with data about regions on the chip, including
it's read/write flags (for CPU).</li>
<li><p>
Intel¬†ME blob¬†‚Äî there is some unknown data for Intel¬†ME. <a href="https://en.wikipedia.org/wiki/Intel_Management_Engine">It is claimed</a> that
the technology is useful for remote management in data centers. But on a
personal laptop such a <a href="https://www.fsf.org/blogs/sysadmin/the-management-engine-an-attack-on-computer-users-freedom">security hole</a> shouldn't exist. I don't need the CPU
inside the CPU, where unknown program with closed sources is running even
when the laptop is turned off (but while the power is supplied to the
motherboard); with access to DMA controller, with access to network card
(and with its own MAC address), with reserved memory in RAM and embedded JVM
with cryptography classes<sup><a id="fnr.intel_me" class="footref" href="#fn.intel_me" role="doc-backlink">3</a></sup>.
</p>

<p>
Unfortunately, without this blob in the BIOS chip¬†‚Äî the laptop won't start
or will power itself off after some time, for the user's "safety".
</p></li>
<li>GbE blob¬†‚Äî Ethernet controller configuration, including it's MAC address.</li>
</ul>

<p>
The coreboot I built booted successfully on my laptop and even displays itself
on the new 2K¬†screen. As I now understand, everything works because at that
moment the original display module was disconnected from the LVDS bus and the
new display was the one connected to the video core via the DP-3 bus.
</p>

<p>
As I can see without the knowledge of Ada language, the coreboot (if the
motherboard is in good working order) checks each port connected to the video
core and outputs framebuffer to the first display found (if there is no
<code>Primary</code> display, connected to the motherboard):
</p>

<div class="org-src-container">
<label class="org-src-name">List of video outputs for X220 from src/mainboard/lenovo/x220/gma-mainboard.ads</label><pre class="src src-ada">private package GMA.Mainboard is

   ports : constant Port_List :=
     (DP1,
      DP2,
      DP3,
      HDMI1,
      HDMI2,
      HDMI3,
      Analog,
      LVDS,
      others =&gt; Disabled);

end GMA.Mainboard;
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name">Video core initialization from src/drivers/intel/gma/hires_fb/gma-gfx_init.adb</label><pre class="src src-ada">HW.GFX.GMA.Display_Probing.Scan_Ports (configs, ports);

if configs (Primary).Port /= Disabled then
   for i in Pipe_Index loop
      exit when configs (i).Port = Disabled;

      min_h := pos32'min (min_h, configs (i).Mode.H_Visible);
      min_v := pos32'min (min_v, configs (i).Mode.V_Visible);
   end loop;

   fb := configs (Primary).Framebuffer;
   fb.Width    := Width_Type (min_h);
   fb.Height   := Height_Type (min_v);
   fb.Stride   := Div_Round_Up (fb.Width, 16) * 16;
   fb.V_Stride := fb.Height;

   for i in Pipe_Index loop
      exit when configs (i).Port = Disabled;

      configs (i).Framebuffer := fb;
   end loop;
</pre>
</div>

<p>
Therefore, while the original display (<code>Primary</code> display in coreboot
configuration) was connected to LVDS¬†‚Äî the coreboot worked with it and ignored
the new display connected via DP-3. When I disconnected the original display,
the boot log appeared on the new display.
</p>
</div>
</div>
<div id="outline-container-libreboot" class="outline-2">
<h2 id="libreboot">Libreboot</h2>
<div class="outline-text-2" id="text-libreboot">
<p>
I used the laptop with coreboot for a while. But it didn't work stable
enough¬†‚Äî looks like because Intel¬†ME blob was corrupted. Sometimes the laptop
would randomly freeze and reboot was only possible by long pressing the Power
button. Sometimes the laptop doesn't turn on at all¬†‚Äî the LED and the display
backlight are blinking and that's all. These are the symptoms described in the
<a href="https://doc.coreboot.org/northbridge/intel/sandybridge/me_cleaner.html">coreboot documentation</a> and in various guides about "why is it impossible to
completely remove Intel¬†ME from Thinkpad¬†X220?"
</p>

<p>
Also, when configuring coreboot, I set framebuffer resolution to 1366x768 for
my 2K¬†screen. As a result, framebuffer did not use the whole screen (but
X-server did):
</p>


<div class="figure">
<p><img src="/assets/static/broken_framebuffer.jpg" alt="Broken framebuffer due to wrong configuration" align="center" />
</p>
<p class="fignum"><i>Framebuffer used the part of the screen inside the green frame</i></p>
</div>

<p>
As a result, I pissed them all off and it was time for coreboot tinkering. My
main problem was a completely lost BIOS dump¬†‚Äî and I didn't know from where to
get the "right" binary blobs with the necessasry binary code inside.
</p>

<p>
So I start reading about <a href="https://libreboot.org/">libreboot</a>. This is something like a coreboot
distribution with the urge to minimise proprietary blobs usage. If there is an
opensource implementation, for example for memory initialization, it will be
used. Of course, <a href="https://libreboot.org/news/policy.html">for now it is impossible</a> to use opensource realizations for
everything for ThinkPad X220. But, as I understand:
</p>
<ul class="org-ul">
<li>IFD is generated by script during build. Fortunately, the Intel Firmware
Descriptor format is well known.</li>
<li>Intel¬†ME downloaded from vendor and immediately disabled with <a href="https://github.com/corna/me_cleaner">me_cleaner</a>.</li>
<li>GbE¬†‚Äî also generated by special script.</li>
</ul>

<p>
In other words, the original BIOS dump is not required to set up Libreboot on
the Thinkpad¬†X220! All I need is the right serial memory programmer that
doesn't burn the BIOS memory chip and the southern bridge. Fortunately, I have
the Chinese CH341 programmer with a jumper to select the necessary logic level
(5V¬†TTL or 3.3V¬†CMOS):
</p>


<div class="figure">
<p><img src="/assets/static/ch341-1.jpg" alt="CH341 programmer with jumper to select logical level (at the bottom)" align="center" />
</p>
<p class="fignum"><i>CH341 serial programmer with jumper to select logic level (yellow, at the bottom)</i></p>
</div>


<div class="figure">
<p><img src="/assets/static/ch341-2.jpg" alt="1-2 jumper position enables CMOS logical level, 2-3 enables TTL level" align="center" />
</p>
<p class="fignum"><i>Silkscreen printing with Chinese hierogrlyphs on the CH341 PCB (position 1-2 enables CMOS logical level, 2-3: TTL level)</i></p>
</div>

<p>
<b>Disclaimer!</b> All actions, described below, have been tested on my Thinkpad
only. Some actions were performed due to "historical background" of the laptop
modification process. Anyway, you should read the official documentation
first!
</p>

<p>
So, I started to bring my laptop to unattainable perfection, armed with
screwdriver, serial memory programmer and some free time.
</p>
</div>
<div id="outline-container-libreboot-preparations" class="outline-3">
<h3 id="libreboot-preparations">Preparations</h3>
<div class="outline-text-3" id="text-libreboot-preparations">
</div>
<div id="outline-container-reading-docs" class="outline-4">
<h4 id="reading-docs">Careful (haha, no) reading of the documentation</h4>
<div class="outline-text-4" id="text-reading-docs">
<p>
First of all, it is necessary to read a lot of documentation at
<a href="https://libreboot.org">https://libreboot.org</a>. There is a list of useful link that will give you some
knowledge:
</p>
<ul class="org-ul">
<li><a href="https://libreboot.org/docs/install/">https://libreboot.org/docs/install/</a> ‚Äî here it is written, that Libreboot
supports my Thinkpad.</li>
<li><a href="https://libreboot.org/news/safety.html">https://libreboot.org/news/safety.html</a> ‚Äî documentation about the necessary
binary blobs.</li>
<li><a href="https://libreboot.org/docs/install/ivy_has_common.html">https://libreboot.org/docs/install/ivy_has_common.html</a> ‚Äî commands to prepare
the libreboot binary before flashing it.</li>
<li><a href="https://libreboot.org/docs/maintain/#environmental-variables">https://libreboot.org/docs/maintain/#environmental-variables</a>,
<a href="https://libreboot.org/docs/build/">https://libreboot.org/docs/build/</a> and <a href="https://libreboot.org/git.html">https://libreboot.org/git.html</a> ‚Äî lbmk
build system manual.</li>
</ul>
</div>
</div>
<div id="outline-container-mac-addr-saving" class="outline-4">
<h4 id="mac-addr-saving">Storing MAC address of internal Ethernet card</h4>
<div class="outline-text-4" id="text-mac-addr-saving">
<p>
The original MAC address is erased during Libreboot installation, because it
is stored inside GbE blob. So I just recorded the <code>ifconfig em0</code> output to
restore my original MAC address and write it back to the GbE blob before
flashing Libreboot.
</p>
</div>
</div>
<div id="outline-container-coreboot-backup" class="outline-4">
<h4 id="coreboot-backup">Firmware backup</h4>
<div class="outline-text-4" id="text-coreboot-backup">
<p>
Backup of currently running firmware¬†‚Äî may be the one that helps to keep the
laptop from bricking if something goes wrong. In my case, the backup of the
coreboot firmware is necessary.
</p>

<p>
This is why the serial memory programmer is necessary. As I found out, reading
the coreboot dump with the laptop turned on returns different dumps on each
read<sup><a id="fnr.coreboot_readings" class="footref" href="#fn.coreboot_readings" role="doc-backlink">4</a></sup>.
</p>

<p>
Required steps:
</p>
<ol class="org-ol">
<li>Disconnect the laptop from 220V.</li>
<li>Remove the battery.</li>
<li>Remove the 7 screws on the bottom of the laptop to remove the keyboard and
palm rest.</li>
<li>Remove the keyboard and palm rest.</li>
<li>Remove the RTC CMOS battery (and don't forget to check its voltage).</li>
<li>Peel off the corner of the protective waterproof film from the left bottom
corner of the motherboard. The desired chip will be underneath it.</li>
</ol>

<p>
After these steps, the clip from the programmer is connected to the laptop:
</p>


<div class="figure">
<p><img src="/assets/static/ch341_on_winbond.jpg" alt="CH341 programmer connected to Winbond W23Q64CV" align="center" />
</p>
<p class="fignum"><i>CH341 programmer, connected to the Winbond W25Q64CV chip</i></p>
</div>

<p>
Command to read chip contents:
</p>
<pre class="example">
sudo flashrom -p ch341a_spi -c "W25Q64BV/W25Q64CV/W25Q64FV" -r coreboot_original1.rom -V
</pre>

<p>
It should print something like the following lines, not the error messages:
</p>
<pre class="example">
thinkpad/libreboot % sudo flashrom -p ch341a_spi -c "W25Q64BV/W25Q64CV/W25Q64FV" -r coreboot_original1.rom -V

flashrom v1.3.0 on Linux 6.1.57-gentoo-x86_64 (x86_64)
flashrom is free software, get the source code at https://flashrom.org

Using clock_gettime for delay loops (clk_id: 1, resolution: 1ns).
flashrom was built with GCC 13.3.1 20241024, little endian
Command line (7 args): flashrom -p ch341a_spi -c W25Q64BV/W25Q64CV/W25Q64FV -r coreboot_original1.rom -V
Initializing ch341a_spi programmer
Device revision is 3.0.4
The following protocols are supported: SPI.
Probing for Winbond W25Q64BV/W25Q64CV/W25Q64FV, 8192 kB: compare_id: id1 0xef, id2 0x4017
Added layout entry 00000000 - 007fffff named complete flash
Found Winbond flash chip "W25Q64BV/W25Q64CV/W25Q64FV" (8192 kB, SPI) on ch341a_spi.
Chip status register is 0x00.
This chip may contain one-time programmable memory. flashrom cannot read
and may never be able to write it, hence it may not be able to completely
clone the contents of this chip (see man page for details).
Reading flash... done.
</pre>

<p>
I read the chip three times and then compare the resulting files, because I've
already lost a BIOS during a simultaneous process. But the MD5 sums of the
files don't match, because the programmer was plugged into the USB-hub on the
front panel of the PC:
</p>
<pre class="example">
thinkpad/libreboot % md5sum *
115b37ab22dbe43bc7ff746bf174ac1f  coreboot_original1.rom
840cc3456aa5b0b3ba96353165f2ee3e  coreboot_original2.rom
ee978f3ed5fb4aab34b1d0a79cef455c  coreboot_original3.rom
</pre>

<p>
All errors are gone after I plug the programmer directly into the USB port on
the motherboard:
</p>
<pre class="example">
thinkpad/libreboot % md5sum *
ee978f3ed5fb4aab34b1d0a79cef455c  coreboot_original1.rom
ee978f3ed5fb4aab34b1d0a79cef455c  coreboot_original2.rom
ee978f3ed5fb4aab34b1d0a79cef455c  coreboot_original3.rom
</pre>

<p>
This is enough to make a backup. But I go a lot further because of sentimental
considerations. I want the serial memory chip from the old (broken)
motherboard¬†‚Äî Macronix MX25L6406E:
</p>


<div class="figure">
<p><img src="/assets/static/macronix.jpg" alt="Macronix MX25L6406E" align="center" />
</p>
<p class="fignum"><i>Macronix MX25L6406E</i></p>
</div>

<p>
First, I desoldered the chip from the old motherboard in two steps:
</p>
<ol class="org-ol">
<li>I mixed the lead-free solder on the chip contacts with normal lead
solder. The melting temperature of this mixture is lower than the melting
temperature of the lead-free solder.</li>
<li>I removed the serial memory chip with a solder dryer set to 380¬∞C ("chinese
¬∞C", so the temperature was determined by eye, by the speed of melting the
solder rod from the spool).</li>
</ol>

<p>
Place on the motherboard for the chip looks like this:
</p>


<div class="figure">
<p><img src="/assets/static/chip_footprint.jpg" alt="BIOS chip footprint" align="center" />
</p>
</div>

<p>
Four contacts in the middle are obviously not used¬†‚Äî because the BIOS memory
chip is on a SOIC¬†8 package.
</p>

<p>
With the same two steps, I desoldered the Winbond memory chip from the working
motherboard and put it in an antistatic bag. After that I had the reliable
hardware backup for the bad times üôÉ.
</p>

<p>
After that, I checked my backup, just in case. I soldered the Macronix chip to
the working motherboard:
</p>


<div class="figure">
<p><img src="/assets/static/soldered_macronix.jpg" alt="Macronix chip on the working motherboard" align="center" />
</p>
<p class="fignum"><i>Macronix chip on the working motherboard</i></p>
</div>

<p>
And flashed my backup of the coreboot to it using the command:
</p>
<pre class="example">
sudo flashrom -p ch341a_spi -c "MX25L6406E/MX25L6408E" -w coreboot_original1.rom -V
</pre>

<p>
Which successfully writes all necessary bits to the chip:
</p>
<pre class="example">
Erase/write done.
Verifying flash... VERIFIED.
</pre>

<p>
As a result, the laptop booted¬†‚Äî so the new chip has been successfully
soldered and the backup copy of the coreboot has been properly read.
</p>
</div>
</div>
</div>
<div id="outline-container-get-libreboot-binary" class="outline-3">
<h3 id="get-libreboot-binary">Downloading Libreboot binary</h3>
<div class="outline-text-3" id="text-get-libreboot-binary">
<p>
Easy way:
</p>
<ol class="org-ol">
<li>Select the project mirror: <a href="https://libreboot.org/download.html">https://libreboot.org/download.html</a></li>
<li>Download archive with binary from the path
<code>/pub/libreboot/stable/20240612/roms</code> (for now it is the latest release).</li>
</ol>

<p>
The <del>not so easy</del> way for crypto-paranoics:
</p>
<ol class="org-ol">
<li>Download GPG-key from developers to verify the signed archive with the
binary: <a href="https://mirror.math.princeton.edu/pub/libreboot/lbkey.asc">https://mirror.math.princeton.edu/pub/libreboot/lbkey.asc</a></li>
<li><p>
Download the next 3 files from selected project mirror:
</p>
<pre class="example">
libreboot-20240612_x220_8mb.tar.xz
libreboot-20240612_x220_8mb.tar.xz.sha512
libreboot-20240612_x220_8mb.tar.xz.sig
</pre></li>
<li><p>
After that check SHA512 sum of archive:
</p>
<pre class="example">
thinkpad/libreboot % sha512sum -c libreboot-20240612_x220_8mb.tar.xz.sha512
./libreboot-20240612_x220_8mb.tar.xz: OK
</pre></li>
<li><p>
And the last step¬†‚Äî import GPG-key from developers:
</p>
<pre class="example">
thinkpad/libreboot % gpg --show-keys --with-fingerprint lbkey.asc
pub   rsa4096 2023-12-28 [SC] [expires: 2028-12-26]
8BB1 F7D2 8CF7 696D BF4F  7192 5C65 4067 D383 B1FF
uid                      Leah Rowe &lt;info@minifree.org&gt;
sub   rsa4096 2023-12-28 [E] [expires: 2028-12-26]

thinkpad/libreboot % gpg --import lbkey.asc
gpg: key 5C654067D383B1FF: public key "Leah Rowe &lt;info@minifree.org&gt;" imported
gpg: Total number processed: 1
gpg:               imported: 1
</pre>

<p>
After running the first command, I compared the printed key fingerprint
with the fingerprint provided on the <a href="https://libreboot.org/download.html">download page</a>. Both fingerprints
should match. Otherwise, <i>someone</i> gave you a wrong key.
</p>

<p>
If all is OK, it is time to check the sign:
</p>
<pre class="example">
thinkpad/libreboot % gpg --verify libreboot-20240612_x220_8mb.tar.xz.sig libreboot-20240612_x220_8mb.tar.xz
gpg: Signature made Wed 12 Jun 2024 12:55:03 PM MSK
gpg:                using RSA key 8BB1F7D28CF7696DBF4F71925C654067D383B1FF
gpg: Good signature from "Leah Rowe &lt;info@minifree.org&gt;" [unknown]
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: 8BB1 F7D2 8CF7 696D BF4F  7192 5C65 4067 D383 B1FF
</pre></li>
</ol>
</div>
</div>
<div id="outline-container-prepare-libreboot-binary" class="outline-3">
<h3 id="prepare-libreboot-binary">Preparing Libreboot binary for flashing</h3>
<div class="outline-text-3" id="text-prepare-libreboot-binary">
<p>
Obviously, it is impossible to remove all blobs from the Libreboot for X220
motherboard. For example, Intel¬†ME has a cryptographic sign that checked every
CPU startup. And if this sign is wrong, the CPU won't start.
</p>

<p>
At the same time, distributing this proprietary blob within the Libreboot
distribution is impossible because of licensing issues. Developers got around
this situation with a special script that downloads Intel¬†ME binary from a
vendor and insert it into the Libreboot binary with the correct offset. The
process is described on the Libreboot page:
<a href="https://libreboot.org/docs/install/ivy_has_common.html">https://libreboot.org/docs/install/ivy_has_common.html</a>. All the necessary
scripts are included in lbmk¬†‚Äî the build system for coreboot. The lbmk can be
cloned from this repository: <a href="https://codeberg.org/libreboot/lbmk">https://codeberg.org/libreboot/lbmk</a>.
</p>

<p>
After installing the necessary dependencies, the downloaded tarball can be fed
to the script¬†‚Äî it will unpack it and insert the necessary blobs to each
binary:
</p>
<pre class="example">
./vendor inject libreboot-20240612_x220_8mb.tar.xz
</pre>

<p>
The process will not be so fast¬†‚Äî lbmk will clone necessary repositories,
build necessary utilitie, and so on. Successful completion will look like
this:
</p>
<pre class="example">
File tmp/romdir/bin/x220_8mb/seabios_withgrub_x220_8mb_libgfxinit_txtmode_usqwerty_grubfirst.rom is 8388608 bytes
File vendorfiles/xx20/me.bin is 86016 bytes
Adding vendorfiles/xx20/me.bin as the Intel ME section of tmp/romdir/bin/x220_8mb/seabios_withgrub_x220_8mb_libgfxinit_txtmode_usqwerty_grubfirst.rom
Writing new image to tmp/romdir/bin/x220_8mb/seabios_withgrub_x220_8mb_libgfxinit_txtmode_usqwerty_grubfirst.rom
ROM image successfully patched: tmp/romdir/bin/x220_8mb/seabios_withgrub_x220_8mb_libgfxinit_txtmode_usqwerty_grubfirst.rom
</pre>

<p>
Prepared binaries will be inside the lbmk catalog, in this path:
<code>./bin/release/x220_8mb/</code>.
</p>
</div>
</div>
<div id="outline-container-libreboot-flashing" class="outline-3">
<h3 id="libreboot-flashing">Flashing prepared Libreboot binary</h3>
<div class="outline-text-3" id="text-libreboot-flashing">
<p>
Of all the prepared binaries in the archive, the necessary binaries should
match the keyboard type on the laptop:
</p>


<div class="figure">
<p><img src="/assets/static/list-of-binaries.png" alt="List of binaries with added blobs" align="center" />
</p>
<p class="fignum"><i>List of binaries with added blobs</i></p>
</div>

<p>
In my case there is a keyboard with US keymap was installed in the laptop. So,
I need these two files:
</p>
<ul class="org-ul">
<li>seabios_withgrub_x220_8mb_libgfxinit_txtmode_usqwerty.rom</li>
<li>seabios_withgrub_x220_8mb_libgfxinit_corebootfb_usqwerty.rom</li>
</ul>

<p>
Libreboot in the first file will use text mode to display information on the
screen. Highly likely that libreboot will not display on the display from DP-3
bus. And in the second file uses the necessary libgfxinit.
</p>

<p>
It can be flashed to memory chip with command:
</p>
<pre class="example">
sudo flashrom -p ch341a_spi -c "MX25L6406E/MX25L6408E" -w seabios_withgrub_x220_8mb_libgfxinit_corebootfb_usqwerty.rom -V
</pre>


<div class="figure">
<p><img src="/assets/static/libreboot-flashing.jpg" alt="Flashing Libreboot" align="center" />
</p>
</div>

<p>
After this action my laptop finally works without freezing. And the system
loads in fullscreen mode:
</p>


<div class="figure">
<p><img src="/assets/static/framebuffer.jpg" alt="Laptop booting at fullscreen" align="center" />
</p>
</div>

<p>
All other notebook systems worked as before because I had previously
configured everything for coreboot:
<a href="https://eugene-andrienko.com/it/2020/09/26/thinkpad-x220-freebsd#update-2024-04-28">https://eugene-andrienko.com/it/2020/09/26/thinkpad-x220-freebsd#update-2024-04-28</a>
</p>
</div>
</div>
<div id="outline-container-mac-address" class="outline-3">
<h3 id="mac-address">MAC address</h3>
<div class="outline-text-3" id="text-mac-address">
<p>
Those, who read the Libreboot documentation, can see that I didn't add my MAC
address to the binary before flashing. As a result, I has a funny default
address:
</p>


<div class="figure">
<p><img src="/assets/static/default-mac.png" alt="Default Libreboot MAC address" align="center" />
</p>
</div>

<p>
I changed it by patching the binary with script from lbmk:
</p>
<pre class="example">
libreboot/lbmk % ./vendor inject -r bin/release/x220_8mb/seabios_withgrub_x220_8mb_libgfxinit_corebootfb_usqwerty.rom -b x220_8mb -m ‚ñà‚ñà:‚ñà‚ñà:‚ñà‚ñà:‚ñà‚ñà:‚ñà‚ñà:‚ñà‚ñà
</pre>

<p>
After that, I just flashed the modified libreboot to the motherboard again.
</p>
</div>
</div>
</div>
<div id="outline-container-libreboot-customization" class="outline-2">
<h2 id="libreboot-customization">Libreboot customization</h2>
<div class="outline-text-2" id="text-libreboot-customization">
<p>
Now, everything was just right. Almost everything. There is no separate set of
libreboot binaries for the Thinkpad¬†X220 with the Ctrl and Fn keys swapped. I
tried for a while to get used to the standard key layout, but didn't
succeeded.
</p>

<p>
First, I tried to rebuild Libreboot with the necessary option to swap the
keys:
</p>
<pre class="example">
Chipset:
  Swap Fn and Ctrl keys=y
</pre>

<p>
It would seem that since I have already built coreboot and have all the
necessary documentation, there should be no problems. Just set the necessary
settings via the <code>./mk -m coreboot x220_8mb</code> and build the binary:
</p>
<pre class="example">
export XBMK_THREADS=3
./mk -b coreboot x220_8mb
</pre>

<p>
But <b>suddenly</b>, libreboot became the first opensource program in 16 years that I
couldn't build properly. Although the configuration and build process worked,
the binaries were always built with the default configuration (from the
Libreboot developers).
</p>

<p>
Fortunately, <i>some</i> options can be changed with the <code>nvramtool</code> utility. It comes
with coreboot. And in the list of those options there was an option to swap
the Ctrl and Fn keys:
</p>

<pre class="example">
% ../../coreboot/build/util/nvramtool/nvramtool -C seabios_withgrub_x220_8mb_libgfxinit_corebootfb_usqwerty.rom -a
boot_option = Fallback
reboot_counter = 0x0
debug_level = Debug
nmi = Enable
power_on_after_fail = Disable
first_battery = Primary
bluetooth = Enable
wwan = Enable
touchpad = Enable
wlan = Enable
trackpoint = Enable
fn_ctrl_swap = Disable
sticky_fn = Disable
power_management_beeps = Disable
sata_mode = AHCI
usb_always_on = Disable
me_state = Disabled
me_state_prev = 0x0
gfx_uma_size = 224M
volume = 0x3
</pre>

<p>
The next steps were the same as for setting the MAC address:
</p>
<ol class="org-ol">
<li><p>
Binary file with Libreboot should be changed with command:
</p>
<pre class="example">
% ../../coreboot/build/util/nvramtool/nvramtool -C seabios_withgrub_x220_8mb_libgfxinit_corebootfb_usqwerty.rom -w fn_ctrl_swap=Enable
</pre></li>
<li>And the modified file should be flashed to the laptop.</li>
</ol>

<p>
As a result, keys are swapped and the laptop works as intended without
freezing.
</p>
</div>
</div>
<div id="outline-container-notes" class="outline-2">
<h2 id="notes">Notes</h2>
<div class="outline-text-2" id="text-notes">
</div>
</div>
<div id="footnotes">

<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.manufacturer_approve" class="footnum" href="#fnr.manufacturer_approve" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Since IBM sold its own laptop business to the Lenovo,
the soul of the old Thinkpads is slowly but inexorably dissapearing from the
new Lenovo laptops.
</p>

<p class="footpara">
There is nothing surprising in this process¬†‚Äî just a usual corporate
<a href="https://web.archive.org/web/20240208152542/https://www.ft.com/content/6fb1602d-a08b-4a8c-bac0-047b7d64aba5">enshittification</a>. One of it's manifestations¬†‚Äî whitelist in Lenovo X220
BIOS. There are two PCI Express slots on the motherboard, with WiFi and WWAN
cards (or WiFi card and SSD) connected. These peripherals can be removed and
on their place can be installed some other peripherals supporting PCI
Express. The rest of the hardware will work with these new peripherals. But
not a software¬†‚Äî during system startup, BIOS checks what ID of devices on the
bus are not listed in whitelist and refuse to start with system and refuse to
work with "not allowed" devices.
</p>

<p class="footpara">
This is usually justified by the fact that the user is supposedly "protected"
from "low-quality" components. It turns out that even I bought a laptop, I
don't own it completely. Even if I have the necessary technical skills, I
can't replace the WiFi card with a more modern one, because the manufacturer
treats me like an idiot! What's happening is exactly what RMS has written
about many times in his essays¬†‚Äî if your device has proprietary software, then
you don't fully own the computing power of the device you bought and the
manufacturer can dictate its terms to you. For example, forcing you to use
hardware only from an approved list.
</p>

<p class="footpara">
Obviously, from the <del>financial point of view</del> point of view of increasing the
profits of some corporations for the sake of a nice report to the board of
shareholders¬†‚Äî such restrictions are very profitable¬†‚Äî the buyer of a laptop
will be forced to use only those devices whose manufacturers have agreed to
include their devices in the whitelist. And when the hardware becomes
obsolete¬†‚Äî he will have to buy a new laptop instead of a small and replaceable
piece of hardware. If something breaks and the replacement part is off the
market, then¬†&#x2026; again, he'll have to buy a new laptop instead of using a
suitable replacement. No one is thinking about usability, reducing e-waste,
etc. at this point (except maybe <a href="https://frame.work">Framework</a>).
</p>

<p class="footpara">
That's why the battery whitelist was added to the ThinkPad X230
(<a href="http://zmatt.net/unlocking-my-lenovo-laptop-part-1/">http://zmatt.net/unlocking-my-lenovo-laptop-part-1/</a>), the display whitelist
to the ThinkPad¬†X240
(<a href="https://www.reddit.com/r/thinkpad/comments/dgydnf/x240_right_to_repair_no_brightness_control_after/">https://www.reddit.com/r/thinkpad/comments/dgydnf/x240_right_to_repair_no_brightness_control_after/</a>),
and so on. Of course, enshittification process wasn't stopped:
</p>
<ul class="org-ul">
<li>The seven-row keyboard with pyramidal buttons was removed from
ThinkPad¬†X230. It was swapped to six-row keyboard without the next buttons:
<ul class="org-ul">
<li><code>Print Screen/System Request</code> ‚Äî it is impossible for now to make a
screenshot with one key press and the <a href="https://en.wikipedia.org/wiki/Magic_SysRq_key">magic SysRq keys</a> become
unaccessible.</li>
<li><code>Scroll Lock</code> ‚Äî it was used to scroll the text in the text console. For
example, to scroll boot log (obviously, at this point the scrolling with
bash/zsh or tmux is unaccessible).</li>
<li><code>Pause/Break</code> ‚Äî it can be used to pause applications via the <code>kill -17</code>:
<a href="https://vermaden.wordpress.com/2018/09/19/freebsd-desktop-part-16-configuration-pause-any-application/">https://vermaden.wordpress.com/2018/09/19/freebsd-desktop-part-16-configuration-pause-any-application/</a></li>
<li>2 buttons to go forward and backward in Internet browser. They had
<code>XF86Forward</code> and <code>XF86Back</code> keycodes¬†‚Äî and they were very useful for
switching buffers in Emacs.</li>
</ul></li>
<li><p>
The <b>separate</b> buttons for TrackPoint is dissapeared in Thinkpad¬†X240. They
were moved directly to the touchpad. The curved profile of the left and
right buttons, as well as the grooved surface of the middle button, allowed
you to press them without thinking, using muscle memory, knowing that your
finger wouldn't hit the touchpad. With the buttons underneath the flat
surface of the touchpad, there's <i>nothing to stop your finger</i> from sliding
further onto the touchpad.
</p>

<p>
Plus, with gloved hands, it was more comfortable to press just the
individual, <b>physical</b> buttons.
</p>

<p>
Fortunately, users outrage brought these buttons back, but Lenovo tried to
remove them again in the <a href="https://en.wikipedia.org/wiki/ThinkPad_X1_series#/media/File:Gladstone_ready_for_2017_Budget.jpg">Thinkpad X1 Carbon gen 2</a>. However, there were so
many inadequate ‚ÄúiNnOvAtIoNs‚Äù in this laptop model that it would take a
separate list to note them all.
</p></li>
<li><p>
Gradually, starting with the X200, the LEDs on the lid of the notebook
started to disappear. First, in X220 the NumLock indicator disappeared from
the display side (y64 need 5t t6 av65d ty*5ng l52e th5s and then fixing
everything), the sleep indicator (you need it to understand the state of the
notebook if it was left with the lid open) and the battery charging
indicator (you don't need a separate program indicator, the state of which
is visible only after OS booting). Then, in X230 the Bluetooth status
indicator disappeared (by it you can understand that rf killswitch is
switched to the off position), and in X240 they removed all status LEDs from
the display side (but brought back the glowing red dot in the logo).
</p>

<p>
In the end, the latest notebook in the X-series¬†‚Äî ThinkPad X13 Gen¬†4¬†‚Äî
doesn't have a single status LED on either the front or back sideü§∑‚Äç‚ôÇÔ∏è (except
for the CapsLock indicator).
</p></li>
<li><p>
The removable battery was disappeared in X280¬†‚Äî you can not change the
degraded battery to a new one by yourself. You have to take the laptop to a
service center to do it. Also, you will not be able to buy a more capacious
battery and connect it by yourself.
</p>

<p>
The unobvious advantage of using a high-capacity battery is also gone¬†‚Äî the
X220 can be carried with the open lid around the office, simply by placing
it on your forearm and using four fingers to hold it on to the battery, so
the laptop doesn't fall over.
</p></li>
<li><p>
Replaced Display Port with HDMI.
</p>

<div class="figure">
<p><img src="/assets/static/display-port.png" alt="Fun fact. Display port is objectively better than HDMI. Royalty-free, baby" align="center" />
</p>
</div></li>
<li><p>
They replaced the round charging connector with a rectangular one to reduce
the thickness of the laptop, but now the plug has only two positions in
which to plug it in. The backlight for the keyboard was also mocked for a
long time. They're replacing the usual LED, built into the lid, to
retractable construction. Or remove it altogether and put the keyboard
backlight "like in everyone else's laptop". While the LED in the lid had an
undeniable advantage: it could be used to light up the desk if necessary.
</p>

<p>
A similar disaster happened with the ability to strap a docking station or
an extra battery to the bottom of the laptop, with separate buttons for
adjusting the volume, with LEDs to indicate that the speakers or microphone
are on mute and so on&#x2026;
</p></li>
</ul>

<p class="footpara">
As long as it is possible to increase profits by worsening usability of
laptops originally designed by the "engineers for engineers", by simply
increasing GHz and Gb and by copying the exterior of MacBooks, selling all
this to ordinary users as an "innovation"¬†‚Äî such things will happen. There are
already voices in favor of removing TrackPoint from ThinkPads: "<a href="https://www.windowscentral.com/hardware/laptops/sorry-lenovo-but-its-time-to-kill-off-the-thinkpad-trackpoint-forever">Sorry Lenovo,
but it's time to kill off the ThinkPad TrackPoint FOREVER</a>" ‚Äî although from
this article it's clear that the author just doesn't know how to use "blind
typing" and hasn't worked with gloves, so it seems to him that TrackPoint is
"an inconvenient thing that gets in the way".
</p></div></div>

<div class="footdef"><sup><a id="fn.linuxbios" class="footnum" href="#fnr.linuxbios" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://web.archive.org/web/20120916212555/http://www.h-online.com/open/features/The-Open-Source-BIOS-is-Ten-An-interview-with-the-coreboot-developers-746525.html?view=print">https://web.archive.org/web/20120916212555/http://www.h-online.com/open/features/The-Open-Source-BIOS-is-Ten-An-interview-with-the-coreboot-developers-746525.html?view=print</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.intel_me" class="footnum" href="#fnr.intel_me" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Quote from <a href="https://libreboot.org/faq.html">https://libreboot.org/faq.html</a>:
</p>

<blockquote>
<p>
The ME consists of an ARC processor core (replaced with other processor cores
in later generations of the ME), code and data caches, a timer, and a secure
internal bus to which additional devices are connected, including a
cryptography engine, internal ROM and RAM, memory controllers, and a direct
memory access (DMA) engine to access the host operating system‚Äôs memory as
well as to reserve a region of protected external memory to supplement the
ME‚Äôs limited internal RAM. The ME also has network access with its own MAC
address through an Intel Gigabit Ethernet Controller. Its boot program, stored
on the internal ROM, loads a firmware ‚Äúmanifest‚Äù from the PC‚Äôs SPI flash
chip. This manifest is signed with a strong cryptographic key, which differs
between versions of the ME firmware. If the manifest isn‚Äôt signed by a
specific Intel key, the boot ROM won‚Äôt load and execute the firmware and the
ME processor core will be halted.
</p>

<p>
The ME firmware is compressed and consists of modules that are listed in the
manifest along with secure cryptographic hashes of their contents. One module
is the operating system kernel, which is based on a proprietary real-time
operating system (RTOS) kernel called ‚ÄúThreadX‚Äù. The developer, Express Logic,
sells licenses and source code for ThreadX. Customers such as Intel are
forbidden from disclosing or sublicensing the ThreadX source code. Another
module is the Dynamic Application Loader (DAL), which consists of a Java
virtual machine and set of preinstalled Java classes for cryptography, secure
storage, etc. The DAL module can load and execute additional ME modules from
the PC‚Äôs HDD or SSD. The ME firmware also includes a number of native
application modules within its flash memory space, including Intel Active
Management Technology (AMT), an implementation of a Trusted Platform Module
(TPM), Intel Boot Guard, and audio and video DRM systems.
</p>
</blockquote></div></div>

<div class="footdef"><sup><a id="fn.coreboot_readings" class="footnum" href="#fnr.coreboot_readings" role="doc-backlink">4</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Once, I found an explanation of this on Reddit, but now I
can't find the link. The fact that flashrom returns different coreboot dumps
every time when using <code>-p internal</code> on Thinkpad X220 is completely normal and to
get a <i>correct</i> backup you <b>need</b> to use a programmer.
</p></div></div>


</div>
</div>