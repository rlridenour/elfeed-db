<p>Now that I have <a href="https://arnesonium.com/2023/07/emacs-29-1-on-ubuntu-22-04-lts">installed Emacs 29.1</a>, I needed to get it set up for Go development for a project. I was interested in taking advantage of both the new Tree-Sitter integration, and the new Eglot language server client. However, they were mildly tricky to set up! Here is what I did.
<!--more--></p>

<h2 id="configuring-tree-sitter-for-go">Configuring Tree-Sitter for Go</h2>

<p>If you follow the excellent <a href="https://www.masteringemacs.org/article/how-to-get-started-tree-sitter">How to Get Started with Tree-Sitter</a> instructions from Mickey Peterson, you will have a great head-start on getting Tree-Sitter working for most of your favorite languages (and probably Java, too). However, those instructions didn’t cover everything I needed for Go. When I tried running <code class="language-plaintext highlighter-rouge">M-x go-ts-mode</code>, Emacs complained about a missing <code class="language-plaintext highlighter-rouge">gomod</code> module. Baffling!</p>

<p>I couldn’t find any information in the Emacs documentation about where to find this missing module. I looked around on the net and found <a href="https://github.com/camdencheek/tree-sitter-go-mod">Camden Cheek’s tree-sitter-go-mod</a>, and added that to my list of recipes. My <code class="language-plaintext highlighter-rouge">treesit-language-source-alist</code> then looked like this:</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">setq</span> <span class="nv">treesit-language-source-alist</span>
 <span class="o">'</span><span class="p">((</span><span class="nv">bash</span> <span class="s">"https://github.com/tree-sitter/tree-sitter-bash"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">cmake</span> <span class="s">"https://github.com/uyha/tree-sitter-cmake"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">css</span> <span class="s">"https://github.com/tree-sitter/tree-sitter-css"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">elisp</span> <span class="s">"https://github.com/Wilfred/tree-sitter-elisp"</span><span class="p">)</span>
   <span class="p">(</span><span class="k">go</span> <span class="s">"https://github.com/tree-sitter/tree-sitter-go"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">gomod</span> <span class="s">"https://github.com/camdencheek/tree-sitter-go-mod"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">dockerfile</span> <span class="s">"https://github.com/camdencheek/tree-sitter-dockerfile"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">html</span> <span class="s">"https://github.com/tree-sitter/tree-sitter-html"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">javascript</span> <span class="s">"https://github.com/tree-sitter/tree-sitter-javascript"</span> <span class="s">"master"</span> <span class="s">"src"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">json</span> <span class="s">"https://github.com/tree-sitter/tree-sitter-json"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">make</span> <span class="s">"https://github.com/alemuller/tree-sitter-make"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">markdown</span> <span class="s">"https://github.com/ikatyang/tree-sitter-markdown"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">python</span> <span class="s">"https://github.com/tree-sitter/tree-sitter-python"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">toml</span> <span class="s">"https://github.com/tree-sitter/tree-sitter-toml"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">tsx</span> <span class="s">"https://github.com/tree-sitter/tree-sitter-typescript"</span> <span class="s">"master"</span> <span class="s">"tsx/src"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">typescript</span> <span class="s">"https://github.com/tree-sitter/tree-sitter-typescript"</span> <span class="s">"master"</span> <span class="s">"typescript/src"</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">yaml</span> <span class="s">"https://github.com/ikatyang/tree-sitter-yaml"</span><span class="p">)))</span>
</code></pre></div></div>

<p>Note that the package is named <code class="language-plaintext highlighter-rouge">go-mod</code> but <code class="language-plaintext highlighter-rouge">go-ts-mode</code> expects it to be named <code class="language-plaintext highlighter-rouge">gomod</code>. I wish this were documented somewhere! In any case, I was then able to use <code class="language-plaintext highlighter-rouge">M-x treesit-install-language-grammar</code> for both <code class="language-plaintext highlighter-rouge">go</code> and <code class="language-plaintext highlighter-rouge">gomod</code>. Finally, <code class="language-plaintext highlighter-rouge">M-x go-ts-mode</code> worked!</p>

<p>After going through this process, I found <a href="https://robbmann.io/posts/emacs-treesit-auto/">Robert Enzmann’s post about automatically using Tree-Sitter</a>. He has created the <code class="language-plaintext highlighter-rouge">treesit-auto</code> package, now available on MELPA, that does most of this work for you. It is a much faster way of solving the <code class="language-plaintext highlighter-rouge">gomod</code> mystery, so give it a shot!</p>

<h2 id="configuring-eglot-for-go">Configuring Eglot for Go</h2>

<p>I’d been using <a href="https://github.com/emacs-lsp/lsp-mode">lsp-mode</a> for ages, but with Emacs 29.1 including <a href="https://joaotavora.github.io/eglot/">Eglot</a>, I decided to make the switch.</p>

<p>In my Go project, I ran <code class="language-plaintext highlighter-rouge">M-x eglot</code> and was immediately met with an error:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[eglot] Server reports (type=1): Error loading workspace folders (expected 1, got 0)
failed to load view for file:///path/to/my/project: err: go command required, not found: exec: "go": executable file not found in $PATH: stderr: 
</code></pre></div></div>

<p>I’ve got Go installed in <code class="language-plaintext highlighter-rouge">/usr/local/go</code>, and <code class="language-plaintext highlighter-rouge">/usr/local/go/bin</code> is definitely in my <code class="language-plaintext highlighter-rouge">exec-path</code> variable in Emacs. It looked like Eglot wasn’t propagating <code class="language-plaintext highlighter-rouge">exec-path</code> down to its subprocesses. How annoying! I did a quick search through the list of Eglot-related variables and the Eglot documentation and no solution seemed immediately forthcoming.</p>

<p>So I took the cheap way out and made a symlink. In my shell, I ran:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo ln</span> <span class="nt">-sf</span> /usr/local/go/bin/go /usr/local/bin/go
</code></pre></div></div>

<p>It is a dumb trick, and I am sure there is a better way to solve it. Do you know of one? Please comment and let me know!</p>

<h2 id="what-else">What Else?</h2>

<p>My exploration has revealed that there’s a lot of work left to do in the Emacs Tree-Sitter world. There are plenty of languages major modes that don’t yet have a <code class="language-plaintext highlighter-rouge">ts-mode</code> equivalent, and plenty of others that still need a lot of work.</p>

<p>It’s too soon for me to say if this setup is preferrable to my previous configuration. But I am really looking forward to playing around with Eglot’s features and exploring the capabilities of Tree-Sitter.</p>