<p>Back in February, <a href="https://indieweb.social/@xenodium/113962578532697485">I asked folks on the Fediverse if I should try to contribute native macOS sharing to Emacs upstream</a>. While folks were keen on the sharing feature, there were reservations about whether or not a macOS-only patch would be welcome upstream.</p>
<p>While my chances of success sounded fairly low, I figured I had to at least try before giving up… and I have to say, I'm glad I gave it a chance. <a href="https://cgit.git.savannah.gnu.org/cgit/emacs.git/commit/?id=813013691a9997cbdd483e1e5cef39453ac07d6d">Yesterday, my patch was finally merged upstream</a>.</p>
<p><img src="https://xenodium.github.io/images/emacs-send-to-aka-macos-sharing-merged-upstream/context-menu.png" alt=""></p>
<p><img src="https://xenodium.github.io/images/emacs-send-to-aka-macos-sharing-merged-upstream/send-to.png" alt=""></p>
<p>That's not to say the patch did not face its challenges. <a href="https://debbugs.gnu.org/cgi/bugreport.cgi?bug=76120">The proposal sparked quite the discussion</a> (you may need an extra large coffee to get through all messages). Frankly, my hopes of landing the patch after initial feedback quickly shrank to almost non-existent. Having said that, <strong>I really have to give huge credit and thanks to both Eli Zaretskii and Stefan Kangas for their help here.</strong> Without their steering, navigating the more turbulent parts of the discussion, I really would have had no chance of getting anywhere and simply would have just given up.</p>
<p>If you're wondering what was controversial about the patch, <a href="https://www.gnu.org/">GNU</a> guidelines discourage adding features targeting <a href="https://www.gnu.org/philosophy/categories.html">non-free</a> operating systems <a href="https://www.gnu.org/prep/maintain/maintain.html#Non_002dGNU_002donly-Features">before it can be made available for GNU/Linux</a>. While the patch could be easily reworked to expose the native capabilities available for each platform, there's plenty of room for interpretation as to whether a rework is considered enough to satisfy the guideline. Most of the <a href="https://debbugs.gnu.org/cgi/bugreport.cgi?bug=76120">discussion</a> was centered around this topic. Once the thread was refocused around shaping the patch, I received super constructive feedback and the patch was indeed reworked to cater for different platforms. We also agreed to rename the feature from &quot;share&quot; to &quot;send&quot;. To my surprise, even <a href="https://en.wikipedia.org/wiki/Richard_Stallman">RMS</a> also chimed in on the patch discussion. Achievement unlocked?!</p>
<p>While one may or may not agree with GNU's guideline, I'm particularly grateful to the <a href="https://www.fsf.org/">Free Software Foundation</a>, the <a href="https://www.gnu.org/">GNU project</a>, and the wider open source community for building honest software that respects freedom and privacy, especially in this day and age.</p>
<p>I'm a huge <a href="https://www.gnu.org/software/emacs/">Emacs</a> fan. I frequently write about it, share tips/tricks, and even build/publish my own packages. In a perfect world, I would also run GNU/Linux exclusively (I did for many years), but nuance requires that I live in a mixed environment (open source + proprietary software), running macOS. I'm thankful for the parts I can control/modify (including Emacs).</p>
<p>When proposing my patch upstream, my intention was to offer the best possible Emacs experience for this particular feature (via native macOS APIs). In most Emacs patches, native changes aren't necessary. But for the rare instances where I'm unable to carry out all the necessary work for different platforms, I'm hoping I can work with other Emacs enthusiasts with complementary skills and strive to find common ground where my contribution raises the tide in a way that helps lift all boats (even if just a little), so to speak. That is, if I'm allowed to ;)</p>
<p>Emacs <code>send-to</code> is now accessible on the <a href="https://cgit.git.savannah.gnu.org/cgit/emacs.git/log/">master branch</a> via <code>M-x context-menu-mode</code> (right click and select &quot;Send to…&quot;), directly via <code>M-x send-to</code>, and can be applied to dired files, current buffer (with associated file), and selected text region.</p>
<p>File handling is configurable per platform via <code>send-to-handlers</code>.</p>
<pre><code class="language-{.commonlisp">(defvar-local send-to-handlers '(((:supported . send-to--ns-supported-p)
                                  (:collect . send-to--collect-items)
                                  (:send . send-to--ns-send-items))
                                 ((:supported . send-to--open-externally-supported-p)
                                  (:collect . send-to--collect-items)
                                  (:send . send-to--open-externally)))
  &quot;A list of handlers that may be able to send files to applications or services.

Sending is handled by the first supported handler from `send-to-handlers' whose
`:supported' function returns non-nil.

Handlers are of the form:

((:supported . `is-supported-p')
 (:collect . `collect-items')
 (:send . `send-items'))

(defun is-supported-p ()
  \&quot;Return non-nil for platform supporting send capability.\&quot;
  ...)

(defun collect-items ()
  \&quot;Return a list of items to be sent.

Items are strings and will be sent as text unless they are local file
paths known to exist. In these instances, files will be sent instead.\&quot;
  ...)

(defun send-to--send-items (items)
  \&quot;Send ITEMS.\&quot;
  ...)&quot;)
</code></pre>
<p>The merged patch currently ships with two handlers. A native macOS handler, powered by <a href="https://developer.apple.com/documentation/appkit/nssharingservicepicker">NSSharingServicePicker</a>, and a more generic one driven by the <a href="https://github.com/emacs-mirror/emacs/blob/e35e18ac18cfa968978ec7fbfa59432fc1852178/etc/NEWS#L2675">new shell-command-do-open</a>.</p>
<p>With <code>send-to-handlers</code> now configurable, it opens up the possibility to expose all sorts of neat integrations like <a href="https://developer.android.com/training/sharing/send">Android intents</a>, <a href="https://github.com/carldotac/kdeconnect.el">KDE Connect</a>, <a href="https://github.com/GSConnect/gnome-shell-extension-gsconnect">GSConnect</a>, and so on… If you write a <code>send-to-handler</code>, I'd love to hear about it.</p>
<p>If you're on macOS and happen to find the new <code>send-to</code>'s native sharing useful, you now know that exposing that little dialog took a non-trivial amount of effort, a turbulent discussion, and 5 months to land in your beloved Emacs. I'll just <a href="https://github.com/sponsors/xenodium">leave this here</a> ;)</p>
