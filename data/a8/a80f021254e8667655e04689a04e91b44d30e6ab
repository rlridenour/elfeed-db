<p>In this post, as part of my ongoing mission to replace all (or as many as possible) external packages with pure elisp, I’ll demonstrate how to implement a lightweight alternative to the popular <code>rainbow-mode</code> package, which highlights hex colour codes in all their vibrant glory.  I use this quite often, especially when &ldquo;ricing&rdquo; my tiling window setup.</p>
<figure><img src="https://emacs.dyerdwelling.family/ox-hugo/20241209081021-emacs--Emacs-core-rainbow-mode.jpg" width="100%">
</figure>

<p>Instead of relying on <code>rainbow-mode</code>, lets create a custom Emacs function to colourize hex values in the buffer, along with another function to clear these highlights. We&rsquo;ll also bind this functionality to modes like <code>prog-mode</code>, <code>org-mode</code>, and <code>conf-space-mode</code>.</p>
<hr>
<p>Hexadecimal colour codes (like <code>#ff0000</code> for red, <code>#00ff00</code> for green, etc.) often appear in programming, configuration, or document files. Visualizing these colours directly within your buffer makes working with them much easier.</p>
<p>Here&rsquo;s how you can create a simple function to overlay these colours in Emacs:</p>
<p>The following function highlights any 3 or 6 character hex colour codes it finds in the current buffer (e.g., <code>#ff0000</code>, <code>#33aaff</code>, <code>#fff</code>). It uses Emacs overlays to render the colour as the background of the matched text.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elisp" data-lang="elisp"><span style="display:flex;"><span>(defun my/rainbow-mode ()
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Overlay colors represented as hex values in the current buffer.&#34;</span>
</span></span><span style="display:flex;"><span>  (interactive)
</span></span><span style="display:flex;"><span>  (remove-overlays (<span style="color:#a6e22e">point-min</span>) (<span style="color:#a6e22e">point-max</span>))
</span></span><span style="display:flex;"><span>  (let ((hex-color-regex <span style="color:#e6db74">&#34;#[0-9a-fA-F]\\{3,6\\}&#34;</span>))
</span></span><span style="display:flex;"><span>    (save-excursion
</span></span><span style="display:flex;"><span>      (<span style="color:#a6e22e">goto-char</span> (<span style="color:#a6e22e">point-min</span>))
</span></span><span style="display:flex;"><span>      (while (<span style="color:#a6e22e">re-search-forward</span> hex-color-regex <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">t</span>)
</span></span><span style="display:flex;"><span>        (let* ((color (match-string <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>               (overlay (<span style="color:#a6e22e">make-overlay</span> (<span style="color:#a6e22e">match-beginning</span> <span style="color:#ae81ff">0</span>) (<span style="color:#a6e22e">match-end</span> <span style="color:#ae81ff">0</span>))))
</span></span><span style="display:flex;"><span>          (if (string-greaterp color <span style="color:#e6db74">&#34;#888888&#34;</span>)
</span></span><span style="display:flex;"><span>              (<span style="color:#a6e22e">overlay-put</span> overlay <span style="color:#e6db74">&#39;face</span> <span style="color:#f92672">`</span>(:background <span style="color:#f92672">,</span>color :foreground <span style="color:#e6db74">&#34;black&#34;</span>))
</span></span><span style="display:flex;"><span>            (<span style="color:#a6e22e">overlay-put</span> overlay <span style="color:#e6db74">&#39;face</span> <span style="color:#f92672">`</span>(:background <span style="color:#f92672">,</span>color :foreground <span style="color:#e6db74">&#34;white&#34;</span>))))))))
</span></span></code></pre></div><p>As an additional note, I have added a little logic regarding generating a contrasting foreground colour to help the hex text value remain prominent.</p>
<p>Sometimes you may want to remove all colour overlays from the current buffer. The following function clears the overlays applied by <code>my/rainbow-mode</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-elisp" data-lang="elisp"><span style="display:flex;"><span>(defun my/rainbow-mode-clear ()
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Remove all hex color overlays in the current buffer.&#34;</span>
</span></span><span style="display:flex;"><span>  (interactive)
</span></span><span style="display:flex;"><span>  (remove-overlays (<span style="color:#a6e22e">point-min</span>) (<span style="color:#a6e22e">point-max</span>)))
</span></span></code></pre></div><p>Now that we have created <code>my/rainbow-mode</code>, let’s make it automatically activate in relevant modes like <code>prog-mode</code>, <code>org-mode</code>, and <code>conf-space-mode</code>. You can achieve this by adding hooks to these modes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(add-hook <span style="color:#e6db74">&#39;prog-mode-hook</span> <span style="color:#a6e22e">#&#39;</span>my/rainbow-mode)
</span></span><span style="display:flex;"><span>(add-hook <span style="color:#e6db74">&#39;org-mode-hook</span> <span style="color:#a6e22e">#&#39;</span>my/rainbow-mode)
</span></span><span style="display:flex;"><span>(add-hook <span style="color:#e6db74">&#39;conf-space-mode-hook</span> <span style="color:#a6e22e">#&#39;</span>my/rainbow-mode)
</span></span></code></pre></div><p>By doing this, whenever you open a buffer in a programming file, Org file, or certain configuration files, <code>my/rainbow-mode</code> will automatically highlight any hex colour codes present in the file.</p>
<hr>
<p>And there we go!, by defining <code>my/rainbow-mode</code>, you can enjoy the benefits of colour-highlighting hex values in Emacs while staying true to a minimalist, package-free configuration!</p>