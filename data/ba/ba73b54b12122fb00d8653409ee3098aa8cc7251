<p>In my last <a href="https://www.youtube.com/watch?v=77NtPfgr4x0&amp;list=PLudVBwrl_ir84jCQtAzDVtBc_oSIBvdCO&amp;pp=gAQB">Bending Emacs</a> episode, I <a href="https://xenodium.com/bending-emacs-episode-6-overlays">talked about overlays</a> and used them to render link previews in an Emacs buffer.</p>
<p>While the overlays merely render an image, the actual link preview image is generated by <a href="https://github.com/xenodium/rinku">rinku</a>, a tiny command line utility I built recently.</p>
<p><code>Rinku</code> leverages macOS APIs to do the actual heavy lifting, rendering/capturing a view off screen, and saving to disk. Similarly, it can fetch preview metadata, also saving the related thumbnail to disk. In both cases, <code>rinku</code> outputs to JSON.</p>
<p>By default, <code>rinku</code> fetches metadata for you.</p>
<pre><code class="language-{.bash">rinku https://soundcloud.com/shehackedyou
</code></pre>
<p>Returns:</p>
<pre><code class="language-json">{
  &quot;title&quot;: &quot;she hacked you&quot;,
  &quot;url&quot;: &quot;https://soundcloud.com/shehackedyou&quot;,
  &quot;image&quot;: &quot;path/to/preview.png&quot;
}
</code></pre>
<p>In this instance, the image looks a little something like this:</p>
<p><a href="https://soundcloud.com/shehackedyou"><img src="https://github.com/xenodium/rinku/blob/main/thumbnail.png?raw=true" width="300px" alt="Metadata thumbnail of SoundCloud link" /></a></p>
<p>On the other hand, the <code>--render</code> flag generates a preview, very much like the ones you see in native macOS and iOS apps.</p>
<pre><code class="language-{.bash">rinku --render https://soundcloud.com/shehackedyou
</code></pre>
<p>Returns:</p>
<pre><code class="language-json">{
  &quot;image&quot;: &quot;path/to/preview.png&quot;
}
</code></pre>
<p>Similarly, the preview renders as follows:</p>
<p><a href="https://soundcloud.com/shehackedyou"><img src="https://github.com/xenodium/rinku/blob/main/render.png?raw=true" width="300px" alt="Rendered preview of SoundCloud link" /></a></p>
<h2>Eshell superpowers</h2>
<p>While overlays is one way to integrate <code>rinku</code> anywhere in Emacs, I had been meaning to look into what I can do for eshell in particular. <a href="https://xenodium.com/yasnippet-in-emacs-eshell">Eshell is just another buffer</a>, and while overlays could do the job, I wanted a shell-like experience. After all, I already knew we can <a href="https://xenodium.com/wizard-zines-comics-eshell-util">echo images into an eshell buffer</a>.</p>
<p>Before getting to <code>rinku</code> on <code>eshell</code>, there's a related hack I'd been meaning to get to for some timeâ€¦ While we're all likely familiar with the <a href="https://www.man7.org/linux/man-pages/man1/cat.1.html">cat</a> command, I remember being a little surprised to find that <code>eshell</code> offers an alternative <code>cat</code> elisp implementation. Surprised too? Go check it!</p>
<pre><code class="language-{.bash">$ which cat
eshell/cat is a native-comp-function in â€˜em-unix.elâ€™.
</code></pre>
<p>Where am I going with this? Well, if eshell's <code>cat</code> command is an elisp implementation, we know its internals are <a href="https://xenodium.com/its-all-up-for-grabs-and-it-compounds">up for grabs</a>, so we can technically extend it to display images too. <code>eshell/cat</code> is just another function, so we can <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Advising-Functions.html">advice it</a> to add image superpowers.</p>
<p>I was pleasantly surprised at how little code was needed. It basically scans for image arguments to handle within advice and otherwise delegates to <code>eshell</code>'s original <code>cat</code> implementation.</p>
<pre><code class="language-{.commonlisp">(defun adviced:eshell/cat (orig-fun &amp;rest args)
  &quot;Like `eshell/cat' but with image support.&quot;
  (if (seq-every-p (lambda (arg)
                     (and (stringp arg)
                          (file-exists-p arg)
                          (image-supported-file-p arg)))
                   args)
      (with-temp-buffer
        (insert &quot;\n&quot;)
        (dolist (path args)
          (let ((spec (create-image
                       (expand-file-name path)
                       (image-type-from-file-name path)
                       nil :max-width 350
                       :conversion (lambda (data) data))))
            (image-flush spec)
            (insert-image spec))
          (insert &quot;\n&quot;))
        (insert &quot;\n&quot;)
        (buffer-string))
    (apply orig-fun args)))

(advice-add #'eshell/cat :around #'adviced:eshell/cat)
</code></pre>
<p>And with that, we can see our freshly powered-up <code>cat</code> command in action:</p>
<p><img src="https://xenodium.github.io/images/rinku-cli-link-previews/cat.png" alt=""></p>
<p>By now, you may wonder why the <code>cat</code> detour when the post was really about <code>rinku</code>? You see, this is Emacs, and everything compounds! We can now leverage our revamped <code>cat</code> command to give similar <code>eshell</code> superpowers to <code>rinku</code>, by merely adding an <code>eshell/rinku</code> function.</p>
<p>As we now know, <code>rinku</code> outputs things to JSON, so we can use <code>json-read-from-string</code> to parse the process output and subsequently feed the image path to <code>eshell/cat</code>. <code>rinku</code> can also output link titles, so we can show that too whenever possible.</p>
<pre><code class="language-{.commonlisp">(defun eshell/rinku (&amp;rest args)
  &quot;Fetch link preview with rinku and display image inline.

Usage: rinku https://soundcloud.com/shehackedyou
       rinku --render https://soundcloud.com/shehackedyou&quot;
  (unless args
    (error &quot;rinku: no arguments provided&quot;))
  (let* ((output (with-temp-buffer
                   (apply #'call-process &quot;rinku&quot; nil t nil args)
                   (buffer-string)))
         (metadata (condition-case nil
                       (json-read-from-string output)
                     (error nil))))
    (if metadata
        (concat
         (if (map-elt metadata 'image)
             (eshell/cat (map-elt metadata 'image))
           &quot;\n&quot;)
         (when (map-elt metadata 'title)
           (concat (map-elt metadata 'title)
                   &quot;\n\n&quot;)))
      output)))
</code></pre>
<p>With that, we can see the lot in action:</p>
<p><img src="https://xenodium.github.io/images/rinku-cli-link-previews/rinku.gif" alt=""></p>
<p>While non-Emacs users are often puzzled by how frequently we bring user flows and integrations on to our beloved editor, once you learn a little elisp, you start realising how relatively easily things can integrate with one another and pretty much <a href="https://xenodium.com/its-all-up-for-grabs-and-it-compounds">everything is up for grabs</a>.</p>
<h2>Make it all sustainable</h2>
<p>Reckon <code>rinku</code> and these tips will be useful to you? Enjoying this <a href="https://xenodium.com/">blog</a> or <a href="https://github.com/xenodium">my projects</a>? I am an ðŸ‘‰ indie dev ðŸ‘ˆ. Help make it sustainable by âœ¨<a href="https://github.com/sponsors/xenodium">sponsoring</a>âœ¨</p>
<p>Need a blog? <a href="https://lmno.lol">I can help with that</a>. Maybe buy my <a href="https://apps.apple.com/us/developer/xenodium-ltd/id304568690">iOS apps</a> too ;)</p>
