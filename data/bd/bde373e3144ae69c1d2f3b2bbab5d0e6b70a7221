<p>There are a bunch of different ways of writing a macro in Racket. There are also some tricky things around phases to keep in mind. This is to help me keep them all straight.</p>
<h2 id="3-plus-1-ways-to-make-a-macro">
  3+1 ways to make a macro
  <a class="anchor" href="#3-plus-1-ways-to-make-a-macro">#</a>
</h2>
<p>This form:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-racket" data-lang="racket"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">define-syntax-rule</span> <span style="color:#eceff4">(</span>foo args <span style="color:#81a1c1;font-weight:bold">...</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">(</span>use args <span style="color:#81a1c1;font-weight:bold">...</span><span style="color:#eceff4">))</span><span style="color:#bf616a">
</span></span></span></code></pre></div><p>is equivalent to:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-racket" data-lang="racket"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">define-syntax</span> foo
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">syntax-rules</span> <span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">([</span>foo args <span style="color:#81a1c1;font-weight:bold">...</span><span style="color:#eceff4">]</span> <span style="color:#eceff4">(</span>use args <span style="color:#81a1c1;font-weight:bold">...</span><span style="color:#eceff4">))))</span><span style="color:#bf616a">
</span></span></span></code></pre></div><p>Which, is in turn equivalent to:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-racket" data-lang="racket"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">define-syntax</span> foo
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">位</span> <span style="color:#eceff4">(</span>stx<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">syntax-case</span> stx <span style="color:#eceff4">()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#eceff4">[(</span>gensymed-foo args <span style="color:#81a1c1;font-weight:bold">...</span><span style="color:#eceff4">)</span> <span style="color:#81a1c1">#&#39;</span><span style="color:#eceff4">(</span>use args <span style="color:#81a1c1;font-weight:bold">...</span><span style="color:#eceff4">)])))</span>  <span style="color:#616e87;font-style:italic">; gensymed-foo is like foo but doesn&#39;t match in the template</span>
</span></span></code></pre></div><p>because <code>syntax-rules</code> expands to <code>syntax-case</code> with some fancy wrapping around it.</p>
<p>This makes <code>syntax-case</code> the most powerful of them all, and it&rsquo;s here that we&rsquo;re treating syntax as data comes to the forefront: you can bind the syntax object directly (in our example, <code>with the (位 (stx) ...)</code> part), pattern match on it, and finally return new syntax with the <code>#'</code> notation.</p>
<p><code>define-syntax-rule</code> is the weakest of the three, but handles a common case: just a single form that you&rsquo;d like to transform a little bit. This version doesn&rsquo;t allow for writing multiple clauses.</p>
<p><code>define-syntax</code> with <code>syntax-rules</code> is in the middle: the bodies of each of the rule match arms (<code>(use args ...)</code>) are assumed to be syntax objects. This works well for the majority of cases I think. It&rsquo;s only when you need to do really hairy stuff and manually generate code that can&rsquo;t be put together with repeats (<code>...</code>) that you need the full power of <code>syntax-case</code> at your disposal.</p>
<p>Note that there are two forms of <code>define-syntax</code>: <code>(define-syntax (id stx) body ...)</code> is shorthand for <code>(define-syntax id (位 (stx) body ...))</code> much like the shorthand for building functions with <code>define</code>.</p>
<h3 id="bonus-more-power">
  Bonus: more power
  <a class="anchor" href="#bonus-more-power">#</a>
</h3>
<p>A cousin of <code>syntax-case</code> is <code>syntax-parse</code>. I was confused about this one for a bit because the names are so close, and they share a lot of similarities. <code>syntax-case</code>&rsquo;s documentation is in the <a href="https://docs.racket-lang.org/reference/stx-patterns.html">Racket Reference proper</a>, while <code>syntax-parse</code>&rsquo;s documentation lives with the <a href="https://docs.racket-lang.org/syntax/Parsing_Syntax.html">syntax module documentation</a>.</p>
<p>Our previous example would be written like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-racket" data-lang="racket"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">define-syntax</span> <span style="color:#eceff4">(</span>foo stx<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>syntax-parse stx
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">[(</span><span style="color:#81a1c1;font-weight:bold">_</span> args <span style="color:#81a1c1;font-weight:bold">...</span><span style="color:#eceff4">)</span> <span style="color:#81a1c1">#&#39;</span><span style="color:#eceff4">(</span>use args <span style="color:#81a1c1;font-weight:bold">...</span><span style="color:#eceff4">)]))</span><span style="color:#bf616a">
</span></span></span></code></pre></div><p>or equivalently:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-racket" data-lang="racket"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">define-syntax</span> foo
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">位</span> <span style="color:#eceff4">(</span>stx<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#eceff4">(</span>syntax-parse stx
</span></span><span style="display:flex;"><span>      <span style="color:#eceff4">[(</span><span style="color:#81a1c1;font-weight:bold">_</span> args <span style="color:#81a1c1;font-weight:bold">...</span><span style="color:#eceff4">)</span> <span style="color:#81a1c1">#&#39;</span><span style="color:#eceff4">(</span>use args <span style="color:#81a1c1;font-weight:bold">...</span><span style="color:#eceff4">)])))</span><span style="color:#bf616a">
</span></span></span></code></pre></div><p><code>syntax-parse</code> supports keyword arguments like <code>#:with</code> and <code>#:when</code> to do some pattern matching and predicate checking. <code>syntax-parse</code> will backtrack through match arms until it finds a matching and satisfying clause.</p>
<p>As far as I can tell, <code>syntax-parse</code> is strictly the most powerful of the syntax manipulating forms that I&rsquo;ve outlined here.</p>
<h2 id="phases">
  Phases
  <a class="anchor" href="#phases">#</a>
</h2>
<p>It doesn&rsquo;t seem like macros can use the functions in their current module by default. However, if you wrap your function definitions in <code>begin-for-syntax</code>, this shifts the function definitions &ldquo;up&rdquo; a phase, and they can be used at the same level as functions.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-racket" data-lang="racket"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">begin-for-syntax</span>
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">define</span> foo <span style="color:#eceff4">(</span>stx<span style="color:#eceff4">)</span> <span style="color:#eceff4">(</span>add-stx-prop stx <span style="color:#81a1c1">&#39;</span><span style="color:#a3be8c">bar</span> <span style="color:#81a1c1">&#39;</span><span style="color:#a3be8c">baz</span><span style="color:#eceff4">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">define-syntax</span> my-macro
</span></span><span style="display:flex;"><span>  <span style="color:#eceff4">(</span>syntax-parse stx
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1;font-weight:bold">#:with</span> foo-ed <span style="color:#eceff4">(</span>foo stx<span style="color:#eceff4">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#81a1c1">#&#39;</span>foo-ed<span style="color:#eceff4">))</span><span style="color:#bf616a">
</span></span></span></code></pre></div><p>You can also <code>require</code> a module with the <code>for-syntax</code> keyword:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-racket" data-lang="racket"><span style="display:flex;"><span><span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">require</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1;font-weight:bold">for-syntax</span> <span style="color:#a3be8c">&#34;util.rkt&#34;</span><span style="color:#eceff4">))</span><span style="color:#bf616a">
</span></span></span></code></pre></div><p>For more information on phases, see the <a href="https://docs.racket-lang.org/reference/syntax-model.html#%28tech._phase._level%29">Racket Docs</a> on phase levels.</p>