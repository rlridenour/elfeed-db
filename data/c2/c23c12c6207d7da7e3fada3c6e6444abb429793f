<p>[Equations in this post may not look right (or appear at all) in your RSS reader. Go to <a href="https://leancrew.com/all-this/2025/05/mathml-with-pandoc/">the original article</a> to see them rendered properly.]</p>
  <hr />
  <p>Since switching from <a href="https://www.mathjax.org/">MathJax</a> to <a href="https://developer.mozilla.org/en-US/docs/Web/MathML">MathML</a> to render equations here on ANIAT, I’ve tried several approaches to generate the MathML. There are many utilities and libraries that claim to do the conversion, but I’ve found all of them to be limited in one way or another. For a while, I was even writing MathML directly, albeit with the help of some Typinator abbreviations, because I couldn’t trust the converters to generate the correct characters or even understand some LaTeX commands I use regularly. Recently, I began using what I should have started out with: <a href="https://pandoc.org/">Pandoc</a>.</p>
<p>It’s not that I wasn’t aware of Pandoc. Its famous in the Markdown/HTML/LaTeX world, and I probably first heard of it shortly after its release. But I’ve always thought of it as a <em>document</em> converter, not an <em>equation</em> converter. I was wrong. It’s very easy to use with a single equation.</p>
<pre><code>pandoc --mathml &lt;&lt;&lt;'$$T = \frac{1}{2} v_x^2$$'
</code></pre>
<p>produces</p>
<pre><code>&lt;p&gt;
  &lt;math display="block" xmlns="http://www.w3.org/1998/Math/MathML"&gt;
    &lt;semantics&gt;
      &lt;mrow&gt;
        &lt;mi&gt;T&lt;/mi&gt;
        &lt;mo&gt;=&lt;/mo&gt;
        &lt;mfrac&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/mfrac&gt;
        &lt;msubsup&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msubsup&gt;
      &lt;/mrow&gt;
      &lt;annotation encoding="application/x-tex"&gt;
        T = \frac{1}{2} v_x^2
      &lt;/annotation&gt;
    &lt;/semantics&gt;
  &lt;/math&gt;
&lt;/p&gt;
</code></pre>
<p>where I’ve added linebreaks and indentation to the output to make it easier to read. Because it’s delimited by double dollar signs, the equation is rendered in block mode, like this:</p>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><mi>T</mi><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><msubsup><mi>v</mi><mi>x</mi><mn>2</mn></msubsup></math>
<p>Single dollar signs would generate MathML with a <code>display="inline"</code> attribute.</p>
<p>(If you look at the source code for this page, you’ll see that I usually delete some of the code Pandoc generates—we’ll get to that later.)</p>
<p>All the converters handled simple equations, like <math xmlns="http://www.w3.org/1998/Math/MathML"><msubsup><mi>v</mi><mn>0</mn><mn>2</mn></msubsup></math>, well, but more complicated stuff can be troublesome. One of the problems other converters have is dealing with multiline equations, something Pandoc handles with ease. For example, this piecewise function definition,</p>
<pre><code>$$ f(x) = \left\{ \begin{array} {rcl} 
-1 &amp; : &amp; x&lt;0 \\
0 &amp; : &amp; x=0 \\
+1 &amp; : &amp; x&gt;0
\end{array} $$
</code></pre>
<p>is rendered exactly as expected:</p>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><mi>f</mi><mo form="prefix" stretchy="false">(</mo><mi>x</mi><mo form="postfix" stretchy="false">)</mo><mo>=</mo><mrow><mo form="prefix" stretchy="true">{</mo><mtable><mtr><mtd columnalign="right" style="text-align: right"><mi>−</mi><mn>1</mn></mtd><mtd columnalign="center" style="text-align: center"><mo>:</mo></mtd><mtd columnalign="left" style="text-align: left"><mi>x</mi><mo>&lt;</mo><mn>0</mn></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mn>0</mn></mtd><mtd columnalign="center" style="text-align: center"><mo>:</mo></mtd><mtd columnalign="left" style="text-align: left"><mi>x</mi><mo>=</mo><mn>0</mn></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>+</mi><mn>1</mn></mtd><mtd columnalign="center" style="text-align: center"><mo>:</mo></mtd><mtd columnalign="left" style="text-align: left"><mi>x</mi><mo>&gt;</mo><mn>0</mn></mtd></mtr></mtable></mrow></math>
<p>Well, perhaps not <em>exactly</em> as expected. If you’re reading this in Chrome (and, presumably, other Chrome-based browsers), all the cells in the array are aligned left, which puts the zero in the wrong spot, not vertically aligned with the ones. But that’s Chrome’s fault, not Pandoc’s.</p>
<p>Since Pandoc understands the <code>\begin{array}</code> command, it can do matrices, too:</p>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi><mo>=</mo><mfrac><mrow><mi>E</mi><mi>A</mi></mrow><mi>L</mi></mfrac><mspace width="0.278em"></mspace><mrow><mo form="prefix" stretchy="true">[</mo><mtable><mtr><mtd columnalign="right" style="text-align: right"><mn>1</mn></mtd><mtd columnalign="right" style="text-align: right"><mi>−</mi><mn>1</mn></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>−</mi><mn>1</mn></mtd><mtd columnalign="right" style="text-align: right"><mn>1</mn></mtd></mtr></mtable><mo form="postfix" stretchy="true">]</mo></mrow></math>
<p>So far, I’ve found only one small bug in Pandoc’s conversion from LaTeX to MathML. Here’s a simple formula that includes both a summation and a limit:</p>
<pre><code>$$ e^x
= \sum_{n=0}^\infty \frac{x^n}{n!}
= \lim_{n\to\infty} \left( 1+ \frac{x}{n} \right)^n $$
</code></pre>
<p>This is what it should look like, a screenshot of the equation as rendered by LaTeX itself:</p>
<p><img alt="Screenshot of exponential expansion and limit" class="ss" src="https://leancrew.com/all-this/images2025/20250503-Screenshot%20of%20exponential%20expansion%20and%20limit.png" title="Screenshot of exponential expansion and limit" width="50%"/></p>
<p>But here’s how it comes out after passing the equation to Pandoc:</p>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>e</mi><mi>x</mi></msup><mo>=</mo><munderover><mo>∑</mo><mrow><mi>n</mi><mo>=</mo><mn>0</mn></mrow><mo accent="false">∞</mo></munderover><mfrac><msup><mi>x</mi><mi>n</mi></msup><mrow><mi>n</mi><mi>!</mi></mrow></mfrac><mo>=</mo><munder><mi>lim</mi><mo>⁡</mo><mrow><mi>n</mi><mo>→</mo><mi>∞</mi></mrow></munder><msup><mrow><mo form="prefix" stretchy="true">(</mo><mn>1</mn><mo>+</mo><mfrac><mi>x</mi><mi>n</mi></mfrac><mo form="postfix" stretchy="true">)</mo></mrow><mi>n</mi></msup></math>
<p>The summation is fine, but the limit is formatted incorrectly. The <math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><mi>n</mi><mo>→</mo><mi>∞</mi></mrow></math> part should be under the <math xmlns="http://www.w3.org/1998/Math/MathML"><mi>lim</mi></math>, not off to the side like a subscript. That subscript-like formatting is what you’d use for an inline equation, not a block equation.</p>
<p>Let’s see what happened. Here’s the MathML produced by Pandoc:</p>
<pre><code>xml:
 1:  &lt;math display="block" xmlns="http://www.w3.org/1998/Math/MathML"&gt;
 2:    &lt;semantics&gt;
 3:      &lt;mrow&gt;
 4:        &lt;msup&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;/msup&gt;
 5:        &lt;mo&gt;=&lt;/mo&gt;
 6:        &lt;munderover&gt;
 7:          &lt;mo&gt;∑&lt;/mo&gt;
 8:          &lt;mrow&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/mrow&gt;
 9:          &lt;mo accent="false"&gt;∞&lt;/mo&gt;
10:        &lt;/munderover&gt;
11:        &lt;mfrac&gt;
12:          &lt;msup&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msup&gt;
13:          &lt;mrow&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mi&gt;!&lt;/mi&gt;&lt;/mrow&gt;
14:        &lt;/mfrac&gt;
15:        &lt;mo&gt;=&lt;/mo&gt;
16:        &lt;munder&gt;
17:          &lt;mi&gt;lim&lt;/mi&gt;&lt;mo&gt;⁡&lt;/mo&gt;
18:          &lt;mrow&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;→&lt;/mo&gt;&lt;mi&gt;∞&lt;/mi&gt;&lt;/mrow&gt;
19:        &lt;/munder&gt;
20:        &lt;msup&gt;
21:          &lt;mrow&gt;
22:            &lt;mo form="prefix" stretchy="true"&gt;(&lt;/mo&gt;
23:              &lt;mn&gt;1&lt;/mn&gt;&lt;mo&gt;+&lt;/mo&gt;
24:              &lt;mfrac&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mfrac&gt;
25:            &lt;mo form="postfix" stretchy="true"&gt;)&lt;/mo&gt;
26:          &lt;/mrow&gt;
27:          &lt;mi&gt;n&lt;/mi&gt;
28:        &lt;/msup&gt;
29:      &lt;/mrow&gt;
30:      &lt;annotation encoding="application/x-tex"&gt;
31:        e^x
32:        = \sum_{n=0}^\infty \frac{x^n}{n!}
33:        = \lim_{n\to\infty} \left( 1+ \frac{x}{n} \right)^n 
34:      &lt;/annotation&gt;
35:    &lt;/semantics&gt;
36:  &lt;/math&gt;
</code></pre>
<p>The problem with the rendering of the limit is in Line 17. There’s an empty <code>&lt;mo&gt;⁡&lt;/mo&gt;</code> element after the <code>&lt;mi&gt;lim&lt;/mi&gt;</code> element. That’s what’s messing up the formatting. If we remove that empty element, the limit gets formatted the way it should:</p>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>e</mi><mi>x</mi></msup><mo>=</mo><munderover><mo>∑</mo><mrow><mi>n</mi><mo>=</mo><mn>0</mn></mrow><mo accent="false">∞</mo></munderover><mfrac><msup><mi>x</mi><mi>n</mi></msup><mrow><mi>n</mi><mi>!</mi></mrow></mfrac><mo>=</mo><munder><mi>lim</mi><mrow><mi>n</mi><mo>→</mo><mi>∞</mi></mrow></munder><msup><mrow><mo form="prefix" stretchy="true">(</mo><mn>1</mn><mo>+</mo><mfrac><mi>x</mi><mi>n</mi></mfrac><mo form="postfix" stretchy="true">)</mo></mrow><mi>n</mi></msup></math>
<p>Obviously, I’m not going to try to fix Pandoc; I have no idea how to program in Haskell. I’ll send a note to <a href="https://johnmacfarlane.net/tools.html">John McFarlane</a> (can he really still be the sole developer?) about the rendering bug, but in the meantime I’ll just remember to delete the empty <code>&lt;mo&gt;⁡&lt;/mo&gt;</code> whenever I need a limit.</p>
<p>I think I’ve mentioned in the past that one of my favorite features of Markdown is that it allows you to mix HTML with regular Markdown text; it passes the HTML through unchanged. I’m using that here to add MathML equations to my blog posts. I write the equation in LaTeX, select it, and run a Keyboard Maestro that replaces the LaTeX with its MathML equivalent. Because I’m still messing around with the macro (and may change it to an automation that BBEdit runs directly) I won’t post it here, but I do want to include the Python script that runs Pandoc to do the conversion and then cleans up Pandoc’s output to make it more compact.</p>
<p>Here’ the script:</p>
<pre><code>python:
 1:  #!/usr/bin/env python3
 2:  
 3:  import sys
 4:  import subprocess
 5:  from bs4 import BeautifulSoup
 6:  
 7:  # Get LaTeX from stdin, run it through Pandoc, and parse the HTML
 8:  latex = sys.stdin.read()
 9:  process = subprocess.run(['pandoc', '--mathml'], input=latex, text=True, capture_output=True)
10:  html = process.stdout
11:  soup = BeautifulSoup(html, 'lxml')
12:  
13:  # Extract the MathML
14:  math = soup.math
15:  
16:  # Delete the annotation
17:  math.annotation.decompose()
18:  
19:  # Delete the unnecessary &lt;semantics&gt; wrapper
20:  math.semantics.unwrap()
21:  
22:  # Delete the unnecessary top-level &lt;mrow&gt; wrapper in block display
23:  if math['display'] == 'block':
24:    math.mrow.unwrap()
25:  
26:  # Delete the unnecessary attribute for inline display
27:  if math['display'] == 'inline':
28:    del math['display']
29:  
30:  # Print the cleaned-up MathML
31:  print(math)
</code></pre>
<p>Lines 8–10 get the LaTeX equation from standard input, pass it through Pandoc via the <a href="https://docs.python.org/3/library/subprocess.html#using-the-subprocess-module"><code>subprocess.run</code> function</a>, and save the standard output to the <code>html</code> variable. Line 11 then parses <code>html</code> with <a href="https://www.crummy.com/software/BeautifulSoup/">Beautiful Soup</a>, putting it in a form that makes it very easy to change.</p>
<p>Because we don’t need the <code>&lt;p&gt;&lt;/p&gt;</code> tags the MathML is wrapped in, we pull out just the <code>&lt;math&gt;&lt;/math&gt;</code> part in Line 14. The rest of the code removes elements and attributes that can be useful, but which don’t add to the rendering of the equations. You may disagree with my removal of these pieces, but it’s my blog.</p>
<p>First, I don’t want to keep the original LaTeX code, so Line 17 deletes the <code>&lt;annotation&gt;&lt;/annotation&gt;</code> tag and everything inside it. With that gone, <code>&lt;semantics&gt;</code> and <code>&lt;/semantics&gt;</code> are no longer necessary, so I got rid of them, too. Unlike the <code>decompose</code> function, which removes tags <em>and</em> their contents, <code>unwrap</code> removes just the tags, leaving behind what’s between them.</p>
<p>I’ve noticed there’s always an extra <code>&lt;mrow&gt;&lt;/mrow&gt;</code> wrapper around block equations, so Lines 23–24 get rid of that. And because <code>display="inline"</code> is the default, Lines 27–28 deletes that attribute from the <code>&lt;math&gt;</code> tag. When the MathML code is in the middle of a paragraph, it helps readability to make it as small as possible.</p>
<p><img alt="Screenshot of BBEdit with inline equation highlighted" class="ss" src="https://leancrew.com/all-this/images2025/20250503-Screenshot%20of%20BBEdit%20with%20inline%20equation%20highlighted.png" title="Screenshot of BBEdit with inline equation highlighted" width="100%"/></p>
<p>One thing I’m not entirely happy with is the need to select the equation before doing the conversion to MathML. I think I can use BBEdit’s AppleScript library to control the cursor and make the selection before sending the text to the Python script. But I haven’t been using this system long enough to know where my cursor is likely to be when I want to convert the equation. The obvious answer is to assume it’ll be after the final dollar sign, but I’ve been at this long enough to mistrust the obvious.</p>
  
