<p>A quick follow-up to <a href="https://xenodium.com/emacs-macos-share-from-dired-dwim-style/">Emacs: macOS sharing (DWIM style)</a>â€¦ Though functional, the implementation had a couple of drawbacks.</p>
<p>Tohiko <a href="https://www.reddit.com/r/emacs/comments/y1tneh/comment/is0pgkf">noticed fullscreen wasn't working at all</a> while Calvin <a href="https://lobste.rs/s/qga1px/emacs_macos_sharing_dwim_style#c_safiuw">proposed enumeration for tighter Emacs integration</a>.</p>
<p>Calvin's suggestion enables using <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Completion.html">completing-read</a> to pick the sharing service. This makes the integration feel more at home. As a bonus, it also enables sharing from fullscreen Emacs.</p>
<p>As an <a href="https://github.com/abo-abo/swiper">ivy</a> user, you can see a vertical list of sharing services.</p>
<p><img src="https://xenodium.github.io/images/emacs-macos-sharing-dwim-style-improved/share-completing_x1.4.webp" alt=""></p>
<p>Here's the new snippet, now <a href="https://github.com/xenodium/dwim-shell-command/commit/20e782b4bf1ea01fecfce3cc8ac4c5a74518cd80">pushed to dwim-shell-commands.el</a>:</p>
<pre><code class="language-{.commonlisp">(defun dwim-shell-commands--macos-sharing-services ()
  &quot;Return a list of sharing services.&quot;
  (let* ((source (format &quot;import AppKit
                         NSSharingService.sharingServices(forItems: [
                           %s
                         ]).forEach {
                           print(\&quot;\\($0.prompt-title)\&quot;)
                         }&quot;
                         (string-join (mapcar (lambda (file)
                                                (format &quot;URL(fileURLWithPath: \&quot;%s\&quot;)&quot; file))
                                              (dwim-shell-command--files))
                                      &quot;, &quot;)))
         (services (split-string (string-trim (shell-command-to-string (format &quot;echo '%s' | swift -&quot; source)))
                                 &quot;\n&quot;)))
    (when (seq-empty-p services)
      (error &quot;No sharing services available&quot;))
    services))

(defun dwim-shell-commands-macos-share ()
  &quot;Share selected files from macOS.&quot;
  (interactive)
  (let* ((services (dwim-shell-commands--macos-sharing-services))
         (service-name (completing-read &quot;Share via: &quot; services))
         (selection (seq-position services service-name #'string-equal)))
    (dwim-shell-command-on-marked-files
     &quot;Share&quot;
     (format
      &quot;import AppKit

       _ = NSApplication.shared

       NSApp.setActivationPolicy(.regular)

       class MyWindow: NSWindow, NSSharingServiceDelegate {
         func sharingService(
           _ sharingService: NSSharingService,
           didShareItems items: [Any]
         ) {
           NSApplication.shared.terminate(nil)
         }

         func sharingService(
           _ sharingService: NSSharingService, didFailToShareItems items: [Any], error: Error
         ) {
           let error = error as NSError
           if error.domain == NSCocoaErrorDomain &amp;&amp; error.code == NSUserCancelledError {
             NSApplication.shared.terminate(nil)
           }
           exit(1)
         }
       }

       let window = MyWindow(
         contentRect: NSRect(x: 0, y: 0, width: 0, height: 0),
         styleMask: [],
         backing: .buffered,
         defer: false)

       let services = NSSharingService.sharingServices(forItems: [\&quot;&lt;&lt;*&gt;&gt;\&quot;].map{URL(fileURLWithPath:$0)})
       let service = services[%s]
       service.delegate = window
       service.perform(withItems: [\&quot;&lt;&lt;*&gt;&gt;\&quot;].map{URL(fileURLWithPath:$0)})

       NSApp.run()&quot; selection)
     :silent-success t
     :shell-pipe &quot;swift -&quot;
     :join-separator &quot;, &quot;
     :no-progress t
     :utils &quot;swift&quot;)))
</code></pre>
<p><a href="https://github.com/xenodium/dwim-shell-command">dwim-shell-command</a> is available on <a href="https://melpa.org/#/dwim-shell-command">melpa</a>. What other uses can you find for it?</p>
