<p><img src="https://cdn3.brettterpstra.com/uploads/2025/12/apex-header-2-rb.7522.jpg" width="800" height="226" style="margin:0 auto;clear:both;" class="header" /></p>
<p>In my quest to make <a href="https://github.com/ApexMarkdown/apex/">Apex</a> as complete as possible before I integrate it into Marked, I&rsquo;ve added Pandoc-compatible filters, which can be written in Lua for native execution, or in any language using a Pandoc JSON pipeline.</p>

<p>The filter system runs your code on the document <em>after</em> parsing and <em>before</em> rendering. The pipeline is: Markdown → AST → <strong>Pandoc-style JSON</strong> → your filters → JSON → HTML. That means you can transform the document in any language that speaks JSON &mdash; Ruby, Python, Lua, Node, whatever &mdash; using the same <a href="https://pandoc.org/filters.html">Pandoc JSON AST</a> that Pandoc uses. If you&rsquo;ve written a Pandoc filter, the proecess is the same: read one JSON document from stdin, write one JSON document to stdout.</p>

<h3 id="running-filters-from-the-cli">Running filters from the CLI</h3>

<p>Three main options:</p>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">--filter NAME</code></strong> — Run a single filter. Apex looks for an executable named <code class="language-plaintext highlighter-rouge">NAME</code> in your user filters directory (<code class="language-plaintext highlighter-rouge">~/.config/apex/filters</code> or <code class="language-plaintext highlighter-rouge">$XDG_CONFIG_HOME/apex/filters</code>). So <code class="language-plaintext highlighter-rouge">apex --filter title input.md</code> runs <code class="language-plaintext highlighter-rouge">~/.config/apex/filters/title</code>. These can exist inside of subdirectories.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">--filters</code></strong> — Run <em>all</em> executables in that directory, in sorted order. Handy if you keep a fixed pipeline (e.g. <code class="language-plaintext highlighter-rouge">01-title</code>, <code class="language-plaintext highlighter-rouge">10-delink</code>) and just want one flag.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">--lua-filter FILE</code></strong> — Run a Lua script as a filter. Apex calls <code class="language-plaintext highlighter-rouge">lua FILE</code>; the script reads Pandoc JSON from stdin and writes JSON to stdout. You need a JSON library (e.g. <strong>dkjson</strong>: <code class="language-plaintext highlighter-rouge">luarocks install dkjson</code>). No Pandoc Lua runtime required.</p>
  </li>
</ul>

<p>Filters run in sequence. If any filter exits non-zero or outputs invalid JSON, Apex aborts unless you pass <code class="language-plaintext highlighter-rouge">--no-strict-filters</code> (then it skips the bad filter and continues).</p>

<h3 id="the-central-filter-list-install-and-list">The central filter list: install and list</h3>

<p>There&rsquo;s a small index of filters at <a href="https://github.com/ApexMarkdown/apex-filters">ApexMarkdown/apex-filters</a>. It&rsquo;s a single JSON file listing filter id, title, description, author, repo, etc. This will grow as I and others create new filters.</p>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">apex --list-filters</code></strong> — Prints &ldquo;Installed Filters&rdquo; (what&rsquo;s in your <code class="language-plaintext highlighter-rouge">~/.config/apex/filters</code> dir) and &ldquo;Available Filters&rdquo; from that index, with titles and descriptions.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">apex --install-filter ID</code></strong> — Installs a filter by id from the index (e.g. <code class="language-plaintext highlighter-rouge">apex --install-filter unwrap</code>). It clones the repo into your filters directory. You can also install by Git URL or GitHub shorthand (user/repo).</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">apex --uninstall-filter ID</code></strong> — Removes that filter (with a confirmation prompt).</p>
  </li>
</ul>

<p>To add your own filter to the list, open a pull request on <a href="https://github.com/ApexMarkdown/apex-filters">github.com/ApexMarkdown/apex-filters</a>. Once it&rsquo;s merged, everyone can <code class="language-plaintext highlighter-rouge">--list-filters</code> and <code class="language-plaintext highlighter-rouge">--install-filter your-id</code>. <a href="https://github.com/ApexMarkdown/apex-filters?tab=readme-ov-file#how-to-request-adding-a-filter">See the docs</a> for more info on contributing.</p>

<h3 id="example-filters-in-the-wild">Example filters in the wild</h3>

<p>Two good references:</p>

<ul>
  <li>
    <p><strong><a href="https://github.com/ApexMarkdown/apex-filter-uppercase">ApexMarkdown/apex-filter-uppercase</a></strong> — Lua filter that uppercases every <code class="language-plaintext highlighter-rouge">Str</code> inline. Shows how to walk the AST with dkjson and mutate in place.</p>
  </li>
  <li>
    <p><strong><a href="https://github.com/ApexMarkdown/apex-filter-unwrap">ApexMarkdown/apex-filter-unwrap</a></strong> — Lua filter that unwraps elements starting with <code class="language-plaintext highlighter-rouge">&lt; </code> (e.g. custom block markers). More involved AST walking.</p>
  </li>
</ul>

<p>Install them with <code class="language-plaintext highlighter-rouge">apex --install-filter uppercase</code> and <code class="language-plaintext highlighter-rouge">apex --install-filter unwrap</code>, then use <code class="language-plaintext highlighter-rouge">--filter uppercase</code> or <code class="language-plaintext highlighter-rouge">--filter unwrap</code> in your pipeline.</p>

<h3 id="short-ruby-example">Short Ruby example</h3>

<p>A minimal filter that reads Pandoc JSON, does one thing (e.g. prepend an H1 from metadata), and writes JSON back. Ruby&rsquo;s stdlib <code class="language-plaintext highlighter-rouge">json</code> is enough.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight fixed"><code><span class="c1">#!/usr/bin/env ruby</span>
<span class="nb">require</span> <span class="s2">"json"</span>

<span class="n">doc</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="vg">$stdin</span><span class="p">.</span><span class="nf">read</span><span class="p">)</span>
<span class="n">blocks</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">"blocks"</span><span class="p">]</span> <span class="o">||</span> <span class="p">[]</span>
<span class="n">meta</span>   <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">"meta"</span><span class="p">]</span> <span class="o">||</span> <span class="p">{}</span>

<span class="c1"># Get title from meta if present (simplified)</span>
<span class="n">title</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"c"</span><span class="p">)</span> <span class="o">||</span> <span class="s2">"Untitled"</span>
<span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">String</span><span class="p">)</span> <span class="p">?</span> <span class="n">title</span> <span class="p">:</span> <span class="n">title</span><span class="p">.</span><span class="nf">to_s</span>

<span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">"t"</span> <span class="o">=&gt;</span> <span class="s2">"Header"</span><span class="p">,</span>
  <span class="s2">"c"</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s2">""</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]],</span> <span class="p">[{</span> <span class="s2">"t"</span> <span class="o">=&gt;</span> <span class="s2">"Str"</span><span class="p">,</span> <span class="s2">"c"</span> <span class="o">=&gt;</span> <span class="n">title</span> <span class="p">}]]</span>
<span class="p">}</span>
<span class="n">doc</span><span class="p">[</span><span class="s2">"blocks"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="o">+</span> <span class="n">blocks</span>

<span class="nb">puts</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span></code></pre></div></div>

<p>Save as <code class="language-plaintext highlighter-rouge">~/.config/apex/filters/title</code>, <code class="language-plaintext highlighter-rouge">chmod +x</code>, then <code class="language-plaintext highlighter-rouge">apex --filter title doc.md &gt; out.html</code>.</p>

<h3 id="short-lua-example">Short Lua example</h3>

<p>Same idea in Lua: read JSON, tweak <code class="language-plaintext highlighter-rouge">doc.blocks</code> (or <code class="language-plaintext highlighter-rouge">doc.meta</code>), write JSON. Requires <code class="language-plaintext highlighter-rouge">dkjson</code>.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight fixed"><code><span class="kd">local</span> <span class="n">json</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"dkjson"</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">input</span> <span class="o">=</span> <span class="nb">io.read</span><span class="p">(</span><span class="s2">"*a"</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span> <span class="k">then</span>
  <span class="nb">io.stderr</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="s2">"Invalid JSON\n"</span><span class="p">)</span>
  <span class="nb">os.exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1">-- Optional: transform doc.blocks or doc.meta</span>
<span class="c1">-- doc.blocks = ...</span>

<span class="nb">io.write</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span></code></pre></div></div>

<p>Run it with <code class="language-plaintext highlighter-rouge">apex --lua-filter myfilter.lua input.md &gt; output.html</code>.</p>

<h3 id="is-this-feature-complete">Is This Feature Complete?</h3>

<p>No, but close. I can&rsquo;t get to 100% Pandoc compatibility at this point
without some restructuring of the AST generated by cmark-gfm. I&rsquo;m not
sure 100% parity is the goal at this point. So some existing Pandoc Lua
filters require some updates to work with Apex. Additionally, this
feature is literally what I came up with in two days and has a lot of
testing ahead. If you&rsquo;re willing to help, especially if you have Pandoc
filters you&rsquo;d like to port, please keep me posted on
<a href="https://github.com/ApexMarkdown/apex/issues">GitHub</a>.</p>

<h3 id="am-i-trying-to-replace-pandoc">Am I Trying to Replace Pandoc?</h3>

<p>No, really I&rsquo;m not. I&rsquo;m not trying to replicate Pandoc&rsquo;s amazing export abilities, or many of its extensions.</p>

<p>However, Pandoc&rsquo;s relatively vast compatibility with various flavors of Markdown is similar to what I want to do in Apex, so supporting many of its extensions makes sense, and supporting filters means users who&rsquo;ve written their own pipelines can easily switch to using Apex as a primary renderer. That&rsquo;s going to be important if I want Marked to have Pandoc capabilities without using Pandoc as an external dependency.</p>

<h3 id="learn-more">Learn more</h3>

<ul>
  <li><a href="https://pandoc.org/filters.html">Pandoc filters</a> — The JSON AST format and filter contract Apex follows.</li>
  <li><a href="https://github.com/ApexMarkdown/apex.wiki/blob/master/Filters.md">Apex wiki: Filters</a> — Full protocol, block/inline types, Lua details, and more examples.</li>
</ul>

<p>Like or share this post <a title="This post on Mastodon" target="_blank" href="https://hachyderm.io/users/ttscoff/statuses/116030178973650794">on Mastodon</a>, <a title="Share on Bluesky" target="_blank" href="https://bsky.app/intent/compose?text=Pandoc-style+filters+for+Apex%0A%0Ahttps%3A%2F%2Fbrettterpstra.com%2F2026%2F02%2F07%2Fpandoc-style-filters-for-apex%2F">Bluesky</a>, or <a class="twitter" target="_blank" rel="nofollow" href="https://twitter.com/intent/tweet?original_referer=https%3A%2F%2Fbrettterpstra.com%2F2026%2F02%2F07%2Fpandoc-style-filters-for-apex%2F&text=Pandoc-style+filters+for+Apex&url=https%3A%2F%2Fbrettterpstra.com%2F2026%2F02%2F07%2Fpandoc-style-filters-for-apex%2F&via=ttscoff" title="Tweet this post">Twitter</a>.</p>
<hr style="margin:40px 0">

<p>BrettTerpstra.com is supported by readers like you. <a href="https://brettterpstra.com/support/">Click here if you'd
        like to help out.</a></p>
<p>Find Brett on <a rel="me" href="https://hachyderm.io/@ttscoff">Mastodon</a>, <a
        href="https://bsky.app/profile/ttscoff.bsky.social">Bluesky</a>, <a
        href="https://github.com/ttscoff">GitHub</a>, and <a href="https://brettterpstra.com/elsewhere">everywhere
        else</a>.</p><img src="https://brett.trpstra.net/link/535/17272052.gif" height="1" width="1"/>