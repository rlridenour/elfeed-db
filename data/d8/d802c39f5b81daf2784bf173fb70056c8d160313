
	
<p>
The <a href="https://www.unidata.ucar.edu/software/netcdf/">netCDF</a> format is popular in sciences that analyse sequential spatial data. It is a self-describing and machine-independent data format for creating, accessing and sharing array-oriented information. The netCDF format provides spatial time series such as meteorological or environmental data. This article shows how to load this data type with the ncdf4 library. This article also shows how to visualise and analyse this data format by reviewing soil moisture data published by the Australian Bureau of Meteorology.</p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
Soil Moisture data
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>The <a href="https://awo.bom.gov.au/products/historical/soilMoisture-rootZone/7,-37.405,144.635/nat,-25.609,134.362/r/d/2025-06-22">Australian Bureau of Meteorology</a> publishes hydrological data in the NetCDF format on their <em>Australian Water Outlook</em>. The NetCDF format provides a three-dimensional matrix of spatial data over time. You need to download the monthly time aggregation, which is approximately 1GB large.</p>
<figure>
<img src="https://lucidmanager.org/images/hydroinformatics/soil-moisture.jpg" alt="Australian Landscape Water Balance (Bureau of Meteorology)" title="Australian Landscape Water Balance (Bureau of Meteorology)" width="300"/>
<figcaption>
Australian Landscape Water Balance (Bureau of Meteorology).
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
Reading, Extracting and Transforming with the ncdf4 library
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>The <a href="https://cran.r-project.org/web/packages/ncdf4/index.html">ncdf4 library</a>, developed by David W. Pierce, provides the necessary functionality to manage this data. To install this R library on a non-Windows system, you must first install the NetCDF package for your relevant operating system. </p>
<p>
The first step is to load the data, extract the relevant information and transform the data for visualisation and analysis. The data forms a complex list containing the metadata and measurements. The <code class="verbatim">ncvar_get()</code> function extracts  data from the list.</p>
<p>
The time data is stored as the number of days since 1 January 1900. The spatial coordinates are stored in decimal degrees with 0.05-decimal degree intervals. The moisture data is transformed to a three-dimensional matrix with dimensions of longitude, latitude, and time.</p>
<p>
<a href = "https://github.com/pprevos/r4h2o/" target="_blank"
   title="Download r4h2o from GitHub"
   alt="Download r4h2o from GitHub">
  <button class="button is-medium is-primary">
    <span class="icon is-large">
      <i class="fab fa-github"></i>
    </span>
    <span style="font-family: monospace">r4h2o</span>
  </button>
</a>

</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#888">## Analysing soil moisture data with the ncdf4 library</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">## Reading, Extracting and Transforming with the ncdf4 library</span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">library</span>(ncdf4)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  bom <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">nc_open</span>(<span style="background-color:#fff0f0">&#34;data/sm_pct.nc&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">## Generate matrix</span>
</span></span><span style="display:flex;"><span>  longitude <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">ncvar_get</span>(bom, <span style="background-color:#fff0f0">&#34;longitude&#34;</span>)
</span></span><span style="display:flex;"><span>  latitude <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">ncvar_get</span>(bom, <span style="background-color:#fff0f0">&#34;latitude&#34;</span>)
</span></span><span style="display:flex;"><span>  month <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">as.Date</span>(<span style="background-color:#fff0f0">&#34;1900-01-01&#34;</span>) <span style="color:#333">+</span> <span style="color:#06b;font-weight:bold">ncvar_get</span>(bom, <span style="background-color:#fff0f0">&#34;time&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  moisture <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">ncvar_get</span>(bom, <span style="background-color:#fff0f0">&#34;sm_pct&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">dimnames</span>(moisture) <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">list</span>(longitude, latitude, month)</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-3" class="outline-2">
<h2 id="headline-3">
Visualising the data with ggplot
</h2>
<div id="outline-text-headline-3" class="outline-text-2">
<p>This first code snippet extracts and plots a matrix from the cube for 31 May 2025. This code creates a data frame with the grid for the required date. Although I use the Tidyverse, I still need reshape2 because the <code>pivot_longer</code> function does not like matrices.</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#888">## Visualising the data with ggplot</span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">library</span>(ggplot2)
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">library</span>(dplyr)
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">library</span>(reshape2)
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">library</span>(ozmaps)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  plot_date <span style="color:#333">&lt;-</span> <span style="background-color:#fff0f0">&#34;2025-05-31&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">## Generate data frame</span>
</span></span><span style="display:flex;"><span>  soil_moisture <span style="color:#333">&lt;-</span> moisture[, , <span style="color:#06b;font-weight:bold">which</span>(month <span style="color:#333">==</span> plot_date)] <span style="color:#333">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">melt</span>(varnames <span style="color:#333">=</span> <span style="color:#06b;font-weight:bold">c</span>(<span style="background-color:#fff0f0">&#34;longitude&#34;</span>, <span style="background-color:#fff0f0">&#34;latitude&#34;</span>)) <span style="color:#333">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">subset</span>(<span style="color:#333">!</span><span style="color:#06b;font-weight:bold">is.na</span>(value))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">## State boundaries</span>
</span></span><span style="display:flex;"><span>  sf_aus <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">ozmap</span>(<span style="background-color:#fff0f0">&#34;states&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">ggplot</span>(soil_moisture) <span style="color:#333">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">geom_tile</span>(<span style="color:#06b;font-weight:bold">aes</span>(x <span style="color:#333">=</span> longitude, y <span style="color:#333">=</span> latitude, fill <span style="color:#333">=</span> value)) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">scale_fill_gradient</span>(low <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;chocolate4&#34;</span>, high <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;dodgerblue&#34;</span>, name <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">NULL</span>) <span style="color:#333">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">geom_sf</span>(data <span style="color:#333">=</span> sf_aus, fill <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">NA</span>, col <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;white&#34;</span>) <span style="color:#333">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">labs</span>(title <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;Relative Total rootzone soil moisture (0-100 cm)&#34;</span>,
</span></span><span style="display:flex;"><span>         subtitle <span style="color:#333">=</span> <span style="color:#06b;font-weight:bold">format</span>(<span style="color:#06b;font-weight:bold">as.Date</span>(plot_date), <span style="background-color:#fff0f0">&#34;%d %B %Y&#34;</span>),
</span></span><span style="display:flex;"><span>         caption <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;Source: Australian Landscape Water Balance AWRA-L Model&#34;</span>) <span style="color:#333">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">theme_void</span>()</span></span></code></pre></div>
</div>
<figure>
<img src="https://lucidmanager.org/images/hydroinformatics/soil-moisture-australia.jpg" alt="Relative soil moisture in Australia, May 2025" title="Relative soil moisture in Australia, May 2025"/>
<figcaption>
Relative soil moisture in Australia, May 2025.
</figcaption>
</figure>
<p>
With the ggmap package we can add some mapping tiles. You will need a <a href="https://lucidmanager.org/data-science/geocoding-with-ggmap/">Google Maps API</a> to enable this functionality.</p>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#888">## Plot on Google Maps</span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">library</span>(ggmap)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  api <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">readLines</span>(<span style="background-color:#fff0f0">&#34;case-studies/google-maps.api&#34;</span>) <span style="color:#888"># Text file with the API key</span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">register_google</span>(key <span style="color:#333">=</span> api)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">ggmap</span>(<span style="color:#06b;font-weight:bold">get_map</span>(<span style="background-color:#fff0f0">&#34;Australia&#34;</span>, zoom <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">4</span>, color <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;bw&#34;</span>)) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">geom_tile</span>(data <span style="color:#333">=</span> soil_moisture, 
</span></span><span style="display:flex;"><span>              <span style="color:#06b;font-weight:bold">aes</span>(x <span style="color:#333">=</span> longitude, y <span style="color:#333">=</span> latitude, fill <span style="color:#333">=</span> value), alpha <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">0.5</span>) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">scale_fill_gradient</span>(low <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;chocolate4&#34;</span>, high <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;dodgerblue&#34;</span>, name <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">NULL</span>) <span style="color:#333">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">labs</span>(title <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;Relative Total rootzone soil moisture (0-100 cm)&#34;</span>,
</span></span><span style="display:flex;"><span>         subtitle <span style="color:#333">=</span> <span style="color:#06b;font-weight:bold">format</span>(<span style="color:#06b;font-weight:bold">as.Date</span>(plot_date), <span style="background-color:#fff0f0">&#34;%d %B %Y&#34;</span>),
</span></span><span style="display:flex;"><span>         caption <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;Source: Australian Landscape Water Balance AWRA-L Model&#34;</span>) <span style="color:#333">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">theme_void</span>()</span></span></code></pre></div>
</div>
<figure>
<img src="https://lucidmanager.org/images/hydroinformatics/soil-moisture-google-maps.jpg" alt="Relative soil moisture in Australia, May 2025" title="Relative soil moisture in Australia, May 2025" width="500"/>
<figcaption>
Relative soil moisture in Australia, May 2025.
</figcaption>
</figure>
</div>
</div>
<div id="outline-container-headline-4" class="outline-2">
<h2 id="headline-4">
Analysing the data
</h2>
<div id="outline-text-headline-4" class="outline-text-2">
<p>For my analysis, I am interested in the time series of moisture data for a specific point on the map. The previous code slices the data for all location at a specific month.</p>
<p>
We can also pierce the data vertically for a particular coordinate to create a time series. The coordinate needs to be rounded to  the nearest 0.05 decimal degrees to match the source data.</p>
<p>
This time series was used to investigate the relationship between sewer main blockages and deep soil data, which can be a topic for a future post.</p>
<figure>
<img src="https://lucidmanager.org/images/hydroinformatics/soil-moisture-time-series.png" alt="Soil moisture time series for Bendigo" title="Soil moisture time series for Bendigo"/>
<figcaption>
Soil moisture time series for Bendigo.
</figcaption>
</figure>
<div class="src src-r">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>  <span style="color:#888">## Time series</span>
</span></span><span style="display:flex;"><span>  location <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">round</span>(<span style="color:#06b;font-weight:bold">geocode</span>(<span style="background-color:#fff0f0">&#34;Bendigo, Australia&#34;</span>) <span style="color:#333">/</span> <span style="color:#60e;font-weight:bold">0.05</span>) <span style="color:#333">*</span> <span style="color:#60e;font-weight:bold">0.05</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  soil_moisture_time <span style="color:#333">&lt;-</span> <span style="color:#06b;font-weight:bold">tibble</span>(month,
</span></span><span style="display:flex;"><span>                               moisture <span style="color:#333">=</span> moisture<span style="color:#06b;font-weight:bold">[as.character</span>(location<span style="color:#333">$</span>lon), 
</span></span><span style="display:flex;"><span>                                                   <span style="color:#06b;font-weight:bold">as.character</span>(location<span style="color:#333">$</span>lat), ]) <span style="color:#333">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">filter</span>(month <span style="color:#333">&gt;=</span> <span style="background-color:#fff0f0">&#34;2000-01-01&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">ggplot</span>(soil_moisture_time) <span style="color:#333">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">geom_line</span>(<span style="color:#06b;font-weight:bold">aes</span>(x <span style="color:#333">=</span> month, y <span style="color:#333">=</span> moisture)) <span style="color:#333">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">labs</span>(title <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;Relative Total rootzone soil moisture (0-100 cm)&#34;</span>,
</span></span><span style="display:flex;"><span>         subtitle <span style="color:#333">=</span> <span style="color:#06b;font-weight:bold">paste</span>(<span style="color:#06b;font-weight:bold">as.character</span>(location), collapse <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;, &#34;</span>),
</span></span><span style="display:flex;"><span>         caption <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;Source: Australian Landscape Water Balance AWRA-L Model&#34;</span>,
</span></span><span style="display:flex;"><span>         x <span style="color:#333">=</span> <span style="color:#080;font-weight:bold">NULL</span>, y <span style="color:#333">=</span> <span style="background-color:#fff0f0">&#34;Relative Soil Moisture&#34;</span>) <span style="color:#333">+</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#06b;font-weight:bold">theme_minimal</span>(base_size <span style="color:#333">=</span> <span style="color:#60e;font-weight:bold">16</span>)</span></span></code></pre></div>
</div>
<p>

  <div class="box">
    <div class="media">
      <figure class="media-left">
        <p class="image is-128x128">
          <img src="https://lucidmanager.org/images/books/2023_ds4wu.jpg" alt = "Data Science for Water Utilities" title = "Data Science for Water Utilities">
        </p>
      </figure>
      <div class="media-content">
        <div class="content">
          <p class="is-size-5 has-text-weight-bold">Data Science for Water Utilities</p>
          <p class="mb-2">Data Science for Water Utilities published by CRC Press is an applied, practical guide that shows water professionals how to use data science to solve urban water management problems using the R language for statistical computing.</p>
          <div class="buttons">
            <a class="button is-info" href="https://routledge.com/9781032354545" target="_blank">
              <span class="icon">
                <i class="fas fa-shopping-cart"></i>
              </span>
              <span>Routledge</span>
            </a>
            <a class="button is-info" href="https://www.amazon.com/Data-Science-Water-Utilities-Chapman/dp/1032354550" target="_blank">
              <span class="icon">
                <i class="fas fa-shopping-cart"></i>
              </span>
              <span>Amazon</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</p>
<p>
<a href = "https://www.r-bloggers.com/" target="_blank" title="Proudly associated with R-Bloggers">
  <button class="button is-link is-medium">
    <span class="icon is-large">
      <i class="fab fa-r-project"></i>
    </span>
    <span>As seen on R Bloggers</span>
  </button>
</a>
</p>
</div>
</div>

      