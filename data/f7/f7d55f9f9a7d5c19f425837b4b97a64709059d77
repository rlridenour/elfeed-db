<p>macOS apps typically benefit from built-in voice dictation input (included as a macOS freebie), with little to no additional work required from app developers.</p>
<p><img src="https://xenodium.github.io/images/macos-dictation-returns-to-emacs-fix-merged/dictation.webp" alt=""></p>
<p>Emacs had supported this capability until relatively recently, when we began seeing reports that <a href="https://lists.gnu.org/archive/html/bug-gnu-emacs/2025-03/msg00585.html">dictation was no longer available as of Emacs 30</a>.</p>
<p>While I have no direct experience with macOS dictation-related APIs, I bisected Emacs 30 changes affecting macOS-related code (typically Objective-C code with .m file extensions). This led me to a seemingly harmless change introducing NSTextInputClient, intended to remove a deprecation warning. From that change onwards, dictation stopped working.</p>
<p>Reverting the change did indeed bring dictation back, but at the cost of re-introducing the deprecation warning. Looking closer at the current NSTextInputClient implementation, I noticed some stubbed-out methods. In particular, <code>selectedRange</code> stood out:</p>
<pre><code class="language-objc">- (NSRange)selectedRange
{
  if (NS_KEYLOG)
    NSLog (@&quot;selectedRange request&quot;);
  return NSMakeRange (NSNotFound, 0);
}
</code></pre>
<p>Turns out implementing <code>selectedRange</code> is all it took to bring dictation back:</p>
<pre><code class="language-diff">diff --git a/src/nsterm.m b/src/nsterm.m
index 003aadb9782..2b34894f36e 100644
--- a/src/nsterm.m
+++ b/src/nsterm.m
@@ -7413,7 +7413,24 @@ - (NSRange)selectedRange
 {
   if (NS_KEYLOG)
     NSLog (@&quot;selectedRange request&quot;);
-  return NSMakeRange (NSNotFound, 0);
+
+  struct window *w = XWINDOW (FRAME_SELECTED_WINDOW (emacsframe));
+  struct buffer *buf = XBUFFER (w-&gt;contents);
+  ptrdiff_t point = BUF_PT (buf);
+
+  if (NILP (BVAR (buf, mark_active)))
+    {
+      NSUInteger selection_location = point - BUF_BEGV (buf);
+      return NSMakeRange (selection_location, 0);
+    }
+
+  ptrdiff_t mark = marker_position (BVAR (buf, mark));
+  ptrdiff_t region_start = min (point, mark);
+  ptrdiff_t region_end = max (point, mark);
+  NSUInteger selection_location = region_start - BUF_BEGV (buf);
+  NSUInteger selection_length = region_end - region_start;
+
+  return NSMakeRange (selection_location, selection_length);
 }
</code></pre>
<p>Implementing <code>selectedRange</code> didn't just bring dictation back, but now leverages a newer macOS dictation implementation. You can see the slight differences in UI.</p>
<h2>Before</h2>
<p><img src="https://xenodium.github.io/images/macos-dictation-returns-to-emacs-fix-merged/before.jpg" alt=""></p>
<h2>After</h2>
<p><img src="https://xenodium.github.io/images/macos-dictation-returns-to-emacs-fix-merged/after.jpg" alt=""></p>
<h2>Merged upstream</h2>
<p>I've since <a href="https://debbugs.gnu.org/cgi/bugreport.cgi?bug=79070">submitted a patch upstream</a>. I'm happy to report that as of today, the patch is now <a href="https://cgit.git.savannah.gnu.org/cgit/emacs.git/commit/?id=6e64e0bd26b6c0f1c4e90c9bc0df37a2a9ac72da">merged into master</a>. Thank you Gerd MÃ¶llmann and Eli Zaretskii for your help! Also big thanks to Stephen Englen, Fritz Grabo, @veer66 and @dotemacs on the fediverse who <a href="https://indieweb.social/@xenodium/114891280426640026">quickly jumped in to help validate the fix</a>.</p>
<p>While we've yet to find out when the next Emacs release will ship, we at least know the fix is coming! If like me, you'd like to get the fix backported to Emacs 30, I've <a href="https://xenodium.com/patching-your-homebrews-emacs-plus-macos">shown you how to do just that on Emacs Plus</a> (my favourite macOS build).</p>
<h2>Make it all sustainable</h2>
<p>Glad macOS dictation is fixed? Enjoying this <a href="https://xenodium.com/">blog</a> or <a href="https://github.com/xenodium">my projects</a>? I am an ðŸ‘‰ indie dev ðŸ‘ˆ. Help make my work sustainable by âœ¨<a href="https://github.com/sponsors/xenodium">sponsoring</a>âœ¨</p>
<p>Need a blog? <a href="https://lmno.lol">I can help with that</a>. Maybe buy my <a href="https://apps.apple.com/us/developer/xenodium-ltd/id304568690">macOS/iOS apps</a> too ;)</p>
