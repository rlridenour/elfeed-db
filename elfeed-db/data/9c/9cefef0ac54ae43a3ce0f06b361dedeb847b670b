<div class="subtitle">
<p>TL;DR: Get LLMs to do things from Emacs, with gptel <a href="#testing-tool-use">and your help</a>.</p>
</div>
<p>A short one today, without the usual flourishes.  <a href="https://github.com/karthink/gptel">gptel</a> is a large language model (LLM) client for Emacs.  At its core is a wrapper around the HTTP APIs provided by all LLM providers, including the <a href="https://en.wikipedia.org/wiki/Llama.cpp">smaller language models</a> you can run locally on your machine.  At its surface&hellip; well, it tries not to have a surface at all, and blend in with Emacs&rsquo; design metaphors and affordances instead.</p>
<p>What does that mean?  For one, it&rsquo;s available at any time and in any buffer, even in places where it probably shouldn&rsquo;t, like tooltips and the minibuffer.  It treats text &ndash; yours or that generated by LLMs &ndash; as Emacs treats text.  You can sling it around, propertize it, redirect it, shove it into buffers and more.  You can save LLM conversation states by just saving the buffer, treat hierarchical Org documents as parallel conversation threads, and so on.  Second, it&rsquo;s programmable: you can use a <a href="https://github.com/karthink/gptel/wiki/Defining-custom-gptel-commands">simple API</a> to script gptel into your tools instead of adapting your tools to gptel
<span class="sidenote-number"><small class="sidenote">
Unfortunately, one caveat is that gptel is presently async-only, so you&rsquo;ll have to write a callback instead of just inserting a call to <code>gptel-request</code> in the middle of your code.
</small></span>
.</p>
<p>This year old video, while significantly behind the current state of the project, illustrates some aspects of the design.</p>
<iframe width="704" height="396" src="https://www.youtube-nocookie.com/embed/bsRnh_brggM?si=0Kn7GM4qbowIRzXA" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
<p>A generalist tool like an LLM can be used in more ways than can be captured by any rigid design, and we&rsquo;re some distance away from answering this simple question: <strong>Can the most flexible text editor ever written provide a generic interface to the most flexible text generator ever created?</strong>  I am puzzled.</p>
<p>And at some point &ndash; not today &ndash; I will write in detail about gptel&rsquo;s evolving design and the challenges therein.  Today, however, I need <em>your</em> help!</p>
<h2 id="tool-use-the-layman-s-version">Tool use: the layman&rsquo;s version</h2>
<p>At some point folks realized that instead of training LLMs to do every task, it&rsquo;s easier to train them to delegate actions to specialized tools.</p>
<p>You can think of these tools as capabilities you equip the model with: the ability to look up information, run actions that modify the state of your computer, and so on.  This solves two common problems with using LLMs:</p>
<ul>
<li>Their knowledge of the world is limited to their training corpus &ndash; and then further compressed in their internal representation.  With access to better information in the mix, it&rsquo;s no longer just a game of asking a frustratingly cheerful oracle a question and wondering if it&rsquo;s making up a load of hogwash.</li>
<li>They can generate text (or other multi-media formats) but not actually <em>do</em> anything useful, assuming you can trust them to not trip over themselves.</li>
</ul>
<p>Of course, the downside is that now <em>you&rsquo;re</em> responsible for providing these &ldquo;capabilities&rdquo;, and defining the interface and levers that the LLM can choose to pull.  So tool use, or &ldquo;function calling&rdquo; is LLM usage where</p>
<ol>
<li>you include a function specification along with your task/question to the LLM.  This includes a detailed listing of the function&rsquo;s arguments, their types and so on.</li>
<li>The LLM optionally decides to call the function, and supplies the arguments.</li>
<li>You run the function call, and (optionally) feed the results back to the LLM.</li>
<li>The LLM completes the task based on the information received.</li>
</ol>
<p>You can use this to give the LLM awareness of the world, by providing access to APIs, your filesystem, web search, Emacs etc.  You can get it to control your Emacs frame, for instance.</p>
<p>And speaking of the Emacs frame&hellip;</p>
<h2 id="tool-use-in-gptel">Tool use in gptel</h2>
<p>gptel supports tool use, but it&rsquo;s not ready for primetime yet.  Here are a couple of illustrations.</p>
<p>You can get it to write boilerplate so you don&rsquo;t have to.  In this demo I provide an LLM with some basic filesystem capabilities, and get it to set up a Nix flake integrated with direnv:</p>
<video preload="metadata" style="center" width="700" controls>
<source src="https://i.imgur.com/kn13qmU.mp4" type="video/mp4">
<a href=https://karthinks.com/img/gptel-tool-use-filesystem-demo.mp4">[VIDEO: An LLM task with filesystem access]</a></video>
<details open>
<summary>Play by play</summary>
<div class="details">
<p>Unlike the usual video narration on this blog this one&rsquo;s going to be rather high level, as the tool use UI isn&rsquo;t final.</p>
<ol>
<li>Type in the query, with a reasonable amount of detail.</li>
<li>Ensure that the filesystem tools are available to the LLM.  (The &ldquo;scope&rdquo; switch sets the tools buffer-locally.)</li>
<li>Run <code>M-x gptel-send</code>.</li>
<li>In the lower window, run the <code>watch</code> command so we can see the <code>~/Desktop/ghostty</code> directory being populated.</li>
<li>After the LLM is done creating the directory and files we asked for, it opens the directory in <code>dired</code> and reports its actions.</li>
<li>Examine the <code>flake.nix</code> and <code>.envrc</code> files to make sure they look okay.</li>
</ol>
</div>
</details>
<p>Here I give the LLM the ability to query my Elfeed and Wallabag databases, which covers most of the things I&rsquo;ve read or watched on the Internet for the past twenty years.  I access both of them from Emacs
<span class="sidenote-number"><small class="sidenote">
via the <a href="https://github.com/skeeto/elfeed">elfeed</a> and <a href="https://github.com/karthink/wombag">wombag</a> Emacs packages respectively.
</small></span>
and they are only available locally on my computer.  I ask the LLM for details about something I vaguely remember watching a while ago:</p>
<video preload="metadata" style="center" width="700" controls>
<source src="https://i.imgur.com/CskRHGZ.mp4" type="video/mp4">
<a href=https://karthinks.com/img/gptel-tool-use-feed-search-demo.mp4">[VIDEO: An LLM task with local search capability]</a></video>
<details open>
<summary>Play by play</summary>
<div class="details">
<p>Unlike the usual video narration on this blog this one&rsquo;s going to be rather high level, as the tool use UI isn&rsquo;t final.</p>
<ol>
<li>Type in the query, with as much detail as I can remember.</li>
<li>Ensure that the local search and web tools are available to the LLM.</li>
<li>Run <code>M-x gptel-send</code>.</li>
<li>It finds the most likely search result from Elfeed, which is a Youtube video.</li>
<li>It fetches the description and a transcript for the video, then summarizes it with links to some references.</li>
</ol>
</div>
</details>
<p>I wouldn&rsquo;t get too excited by this second example &ndash; there is no fancy vector embedding or similarity search going on.  The LLM just runs a standard keyword search against the Elfeed database, and we were fortunate that the result we were looking for contained the word &ldquo;derivative&rdquo; that I asked for.</p>
<p>But you get the idea, I hope.</p>
<details class="details implementation">
<summary>A sample tool definition</summary>
<div class="details">
<p>If you were curious, &ldquo;tools&rdquo; as used in the above demos are elisp functions coupled with descriptions of the schema.  Here is an example.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-emacs-lisp" data-lang="emacs-lisp"><span style="display:flex;"><span>(<span style="color:#963">gptel-make-tool</span>
</span></span><span style="display:flex;"><span> <span style="color:#007020">:function</span> (<span style="color:#007020">lambda</span> (<span style="color:#963">path</span> <span style="color:#963">filename</span> <span style="color:#963">content</span>)
</span></span><span style="display:flex;"><span>             (<span style="color:#007020">let</span> ((<span style="color:#963">full-path</span> (<span style="color:#06b;font-weight:bold">expand-file-name</span> <span style="color:#963">filename</span> <span style="color:#963">path</span>)))
</span></span><span style="display:flex;"><span>               (<span style="color:#007020">with-temp-buffer</span>
</span></span><span style="display:flex;"><span>                 (<span style="color:#06b;font-weight:bold">insert</span> <span style="color:#963">content</span>)
</span></span><span style="display:flex;"><span>                 (<span style="color:#963">write-file</span> <span style="color:#963">full-path</span>))
</span></span><span style="display:flex;"><span>               (<span style="color:#06b;font-weight:bold">format</span> <span style="background-color:#fff0f0">&#34;Created file %s in %s&#34;</span> <span style="color:#963">filename</span> <span style="color:#963">path</span>)))
</span></span><span style="display:flex;"><span> <span style="color:#007020">:name</span> <span style="background-color:#fff0f0">&#34;create_file&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#007020">:description</span> <span style="background-color:#fff0f0">&#34;Create a new file with the specified content&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#007020">:args</span> (<span style="color:#06b;font-weight:bold">list</span> <span style="color:#333">&#39;</span>(<span style="color:#007020">:name</span> <span style="background-color:#fff0f0">&#34;path&#34;</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#007020">:type</span> <span style="background-color:#fff0f0">&#34;string&#34;</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#007020">:description</span> <span style="background-color:#fff0f0">&#34;The directory where to create the file&#34;</span>)
</span></span><span style="display:flex;"><span>             <span style="color:#333">&#39;</span>(<span style="color:#007020">:name</span> <span style="background-color:#fff0f0">&#34;filename&#34;</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#007020">:type</span> <span style="background-color:#fff0f0">&#34;string&#34;</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#007020">:description</span> <span style="background-color:#fff0f0">&#34;The name of the file to create&#34;</span>)
</span></span><span style="display:flex;"><span>             <span style="color:#333">&#39;</span>(<span style="color:#007020">:name</span> <span style="background-color:#fff0f0">&#34;content&#34;</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#007020">:type</span> <span style="background-color:#fff0f0">&#34;string&#34;</span>
</span></span><span style="display:flex;"><span>	       <span style="color:#007020">:description</span> <span style="background-color:#fff0f0">&#34;The content to write to the file&#34;</span>))
</span></span><span style="display:flex;"><span> <span style="color:#007020">:category</span> <span style="background-color:#fff0f0">&#34;filesystem&#34;</span>)
</span></span></code></pre></div></div>
</details>
<h2 id="testing-tool-use">Testing tool use</h2>
<p>There are dozens of uses for this kind of LLM usage, and dozens of ways in which this can break.  That&rsquo;s where you come in.  If you&rsquo;re interested in this kind of thing, please try out the <code>feature-tool-use</code> branch of gptel &ndash; kick the tires a bit.  Write your own tools for tasks you&rsquo;d like to automate, and let me know what breaks, and what&rsquo;s missing!</p>
<p>You can find detailed instructions for testing tool use <a href="https://github.com/karthink/gptel/issues/514">on gptel&rsquo;s issue tracker</a>, which is also the best place to report issues or suggestions.  gptel does not currently ship with any tools, and the issue page includes the collection of tools that I used in the above demos.</p>
<h2 id="scratching-the-surface">Scratching the surface</h2>
<p>Following the theme of general befuddlement, I&rsquo;m not sure yet about how any of this should work. The most I can confidently say is that as an Emacs-native LLM interface, gptel is quite far from any kind of optimum.  So here&rsquo;s hoping we can inch our way there.</p>
